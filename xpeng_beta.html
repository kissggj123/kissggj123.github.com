<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é¹P7+ å……ç”µè®¡ç®—å™¨ v3.9.3 - ç½—ä¼Šå®‰å“¥æ‹‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒ CSS å˜é‡ --- */
        :root {
            /* å­—ä½“ */
            --font-main: 'VT323', monospace;
            
            /* TRON é£æ ¼ - å¤œé—´æ¨¡å¼ (é»˜è®¤) */
            --bg-dark: #0d0e1b;
            --bg-panel: rgba(18, 25, 50, 0.6);
            --border-neon: #00e5ff; /* é’è‰² */
            --border-neon-alt: #ff00ff; /* æ´‹çº¢è‰² */
            --text-primary: #00e5ff; /* v3.9.3 æ›´æ–°ï¼šå­—ä½“æ”¹ä¸ºTRONè“è‰²ï¼Œæå‡å¯è¯»æ€§ */
            --text-neon-cyan: #00e5ff;
            --text-neon-green: #39ff14;
            --text-neon-pink: #ff00ff;
            --shadow-neon: 0 0 5px var(--border-neon), 0 0 10px var(--border-neon), 0 0 15px var(--border-neon-alt);
            --button-bg: rgba(0, 229, 255, 0.1);
            --button-hover-bg: rgba(0, 229, 255, 0.3);
            --input-bg: rgba(0, 0, 0, 0.4);

            /* å›¾è¡¨é¢œè‰² */
            --chart-grid-color: rgba(0, 229, 255, 0.2);
            --chart-tick-color: #a0a0a0;
            --chart-color-1: #00e5ff;
            --chart-color-2: #ff00ff;
            --chart-color-3: #39ff14;
            --chart-color-4: #f8f8f2;
            --chart-color-5: #ffca28;
            --chart-color-6: #9e6eff;

            /* åƒç´ /å­—ç¬¦ç”»å…”å­ SVG (å¤œé—´æ¨¡å¼) */
            --bunny-svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Crect fill='%2300e5ff' x='1' y='1' width='1' height='2'/%3E%3Crect fill='%2300e5ff' x='6' y='1' width='1' height='2'/%3E%3Crect fill='%23e0e0e0' x='2' y='3' width='4' height='3'/%3E%3Crect fill='%23ff00ff' x='3' y='4' width='1' height='1'/%3E%3Crect fill='%23ff00ff' x='5' y='4' width='1' height='1'/%3E%3C/svg%3E");
        }

        /* äºŒæ¬¡å…ƒå½©è‰²è·³è„±é£æ ¼ - æ—¥é—´æ¨¡å¼ */
        .light-mode {
            --bg-dark: #f0f8ff;
            --bg-panel: rgba(255, 255, 255, 0.85);
            --border-neon: #ff4081; /* äº®ç²‰è‰² */
            --border-neon-alt: #7b1fa2; /* æ·±ç´«è‰² */
            --text-primary: #5e35b1; /* v3.9.3 æ›´æ–°ï¼šå­—ä½“æ”¹ä¸ºäºŒæ¬¡å…ƒç´«è‰²ï¼Œæ›´æ´»æ³¼ */
            --text-neon-cyan: #007bff;
            --text-neon-green: #28a745;
            --text-neon-pink: #f50057;
            --shadow-neon: 0 0 10px rgba(255, 64, 129, 0.6);
            --button-bg: rgba(0, 123, 255, 0.1);
            --button-hover-bg: rgba(0, 123, 255, 0.2);
            --input-bg: rgba(255, 255, 255, 0.7);

            /* å›¾è¡¨é¢œè‰² - æ—¥é—´ */
            --chart-grid-color: rgba(0, 0, 0, 0.08);
            --chart-tick-color: #495057;
            --chart-color-1: #1e88e5;
            --chart-color-2: #d81b60;
            --chart-color-3: #43a047;
            --chart-color-4: #5e35b1;
            --chart-color-5: #fdd835;
            --chart-color-6: #fb8c00;

            /* åƒç´ /å­—ç¬¦ç”»å…”å­ SVG (æ—¥é—´æ¨¡å¼) */
            --bunny-svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Crect fill='%23007bff' x='1' y='1' width='1' height='2'/%3E%3Crect fill='%23007bff' x='6' y='1' width='1' height='2'/%3E%3Crect fill='%23495057' x='2' y='3' width='4' height='3'/%3E%3Crect fill='%23f50057' x='3' y='4' width='1' height='1'/%3E%3Crect fill='%23f50057' x='5' y='4' width='1' height='1'/%3E%3C/svg%3E");
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            transition: background-color 0.5s, color 0.5s;
            background-image: linear-gradient(rgba(0, 229, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 229, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .panel {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-neon);
            box-shadow: var(--shadow-neon);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .neon-text { color: var(--text-neon-cyan); }
        .neon-text-green { color: var(--text-neon-green); }
        .neon-text-pink { color: var(--text-neon-pink); }
        
        input, select, button {
            font-family: var(--font-main);
            background-color: var(--input-bg);
            border: 1px solid var(--border-neon-alt);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--border-neon);
            box-shadow: var(--shadow-neon);
        }
        button {
            background-color: var(--button-bg);
            border-color: var(--border-neon);
        }
        button:hover {
            background-color: var(--button-hover-bg);
            box-shadow: var(--shadow-neon);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        input[type="checkbox"] {
            accent-color: var(--border-neon-alt);
        }

        @keyframes random-move {
            0%, 100% { transform: translate(var(--x1), var(--y1)); }
            10% { transform: translate(var(--x2), var(--y2)); }
            20% { transform: translate(var(--x3), var(--y3)); }
            30% { transform: translate(var(--x4), var(--y4)); }
            40% { transform: translate(var(--x5), var(--y5)); }
            50% { transform: translate(var(--x6), var(--y6)); }
            60% { transform: translate(var(--x7), var(--y7)); }
            70% { transform: translate(var(--x8), var(--y8)); }
            80% { transform: translate(var(--x9), var(--y9)); }
            90% { transform: translate(var(--x10), var(--y10)); }
        }
        .pixel-bunny {
            position: fixed;
            width: 48px;
            height: 48px;
            background-image: var(--bunny-svg);
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 1000;
            animation: random-move 30s infinite alternate;
            image-rendering: pixelated;
            pointer-events: none;
            bottom: 10px; right: 10px;
        }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content { max-height: 80vh; overflow-y: auto; }

        .toast-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 1rem 2rem; border-radius: 0.5rem; opacity: 0;
            visibility: hidden; transition: opacity 0.5s, visibility 0.5s, transform 0.5s;
            z-index: 3000;
        }
        .toast-notification.show { opacity: 1; visibility: visible; transform: translate(-50%, 10px); }

        .loading-indicator {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 4000;
            display: none;
        }
        .loader {
            border: 4px solid rgba(255,255,255,0.2); border-left-color: var(--border-neon);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="pixel-bunny" class="pixel-bunny"></div>

    <!-- æ ‡é¢˜ä¸æ§åˆ¶æŒ‰é’® -->
    <header class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold title-color tracking-wider">âš¡ å°é¹P7+ å……ç”µè®¡ç®—å™¨ ğŸ”‹</h1>
        <p class="text-slate-400 mt-2 text-xl neon-text-pink">v3.9.3 - ç½—ä¼Šå®‰å“¥æ‹‰ (Roy Angora)</p>
        <p class="text-sm text-slate-500 mt-1">/* èåˆã€Šé“¶ç¿¼æ€æ‰‹ã€‹æ ¸å¿ƒå¤åˆ¶äººç½—ä¼Šä¸å®‰å“¥æ‹‰å…”ï¼Œè±¡å¾ç§‘æŠ€ä¸ç”Ÿå‘½æ„Ÿçš„è§†è§‰å¹³è¡¡ã€‚ */</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <!-- å·¦ä¾§ï¼šè¾“å…¥é¢æ¿ (2/5å®½åº¦) -->
        <section id="input-panel" class="panel p-6 rounded-xl lg:col-span-2 space-y-4">
            <h2 class="text-2xl neon-text-pink border-b border-b-[var(--border-neon-alt)] pb-2">ğŸ”Œ å……ç”µå‚æ•°è®¾å®š</h2>
            
            <div>
                <label for="car-model" class="block mb-1">ğŸš— è½¦è¾†å‹å· (800Vå¹³å°):</label>
                <select id="car-model" class="w-full p-2 rounded-md">
                    <option value="long_range">é•¿ç»­èˆª (60.7 kWh, 3C)</option>
                    <option value="super_long_range">è¶…é•¿ç»­èˆª (76.3 kWh, 3C)</option>
                    <option value="flagship">æ——èˆ° (74.9 kWh, 5C)</option>
                </select>
            </div>

            <div>
                <label for="charger-type" class="block mb-1">â›½ å……ç”µæ¡©ç±»å‹:</label>
                <select id="charger-type" class="w-full p-2 rounded-md">
                    <option value="s5_super_plus">S5 æ¶²å†·è¶…å…… (720kW ç«™)</option>
                    <option value="s4_super">S4 è¶…å…… (480kW ç«™)</option>
                    <option value="s2_fast">S2 å¿«å…… (90kW æ¡©)</option>
                    <option value="third_party_fast">ç¬¬ä¸‰æ–¹å¿«å…… (120kW æ¡©)</option>
                    <option value="home_charger">å®¶ç”¨å……ç”µæ¡© (7kW æ¡©)</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="start-soc" class="block mb-1">ğŸ“‰ èµ·å§‹ç”µé‡ (%):</label>
                    <input type="number" id="start-soc" min="0" max="100" class="w-full p-2 rounded-md">
                </div>
                <div>
                    <label for="end-soc" class="block mb-1">ğŸ“ˆ ç›®æ ‡ç”µé‡ (%):</label>
                    <input type="number" id="end-soc" min="0" max="100" class="w-full p-2 rounded-md">
                </div>
                <div>
                    <label for="charged-kwh" class="block mb-1">âš¡ å®é™…å……ç”µé‡ (kWh):</label>
                    <input type="number" id="charged-kwh" step="0.1" class="w-full p-2 rounded-md" placeholder="é€‰å¡«ï¼Œç²¾ç®—æŸè€—">
                </div>
                <div>
                    <label for="station-occupancy" class="block mb-1">ğŸ”¢ åŒç«™å ç”¨æ¡©æ•°:</label>
                    <input type="number" id="station-occupancy" min="1" class="w-full p-2 rounded-md">
                </div>
            </div>

            <h3 class="text-xl neon-text-pink pt-2 border-b border-b-[var(--border-neon-alt)] pb-2">âš™ï¸ æŸè€—å› å­ (å¯é€‰)</h3>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                <div class="flex items-center"><input type="checkbox" id="ac-loss" class="mr-2 h-4 w-4 rounded"><label for="ac-loss">ç©ºè°ƒ ğŸŒ¬ï¸ (+4%)</label></div>
                <div class="flex items-center"><input type="checkbox" id="preheat-loss" class="mr-2 h-4 w-4 rounded"><label for="preheat-loss">ç”µæ± é¢„çƒ­ ğŸ”¥ (+6%)</label></div>
                <div class="flex items-center"><input type="checkbox" id="cold-loss" class="mr-2 h-4 w-4 rounded"><label for="cold-loss">ä½æ¸©ç¯å¢ƒ â„ï¸ (+5%)</label></div>
                <div class="flex items-center"><input type="checkbox" id="hot-loss" class="mr-2 h-4 w-4 rounded"><label for="hot-loss">é«˜æ¸©é…·çƒ­ â˜€ï¸ (+7%)</label></div>
                <div class="flex items-center"><input type="checkbox" id="autopilot-loss" class="mr-2 h-4 w-4 rounded"><label for="autopilot-loss">æ™ºé©¾è€—ç”µ ğŸ§  (+2%)</label></div>
                <div class="flex items-center"><input type="checkbox" id="load-loss" class="mr-2 h-4 w-4 rounded"><label for="load-loss">è½¦è¾†è½½é‡ ğŸšš (+3%)</label></div>
                <div class="flex items-center col-span-2"><input type="checkbox" id="s5-cooling" class="mr-2 h-4 w-4 rounded"><label for="s5-cooling">å¯ç”¨ S5 æ¶²å†·æªçº¿ ğŸ’§</label></div>
            </div>

            <div class="flex flex-col space-y-3 pt-4">
                <button id="calculate-btn" class="w-full p-3 rounded-lg text-lg neon-text-green border-[var(--text-neon-green)] hover:bg-green-500/20">>> å¼€å§‹è®¡ç®—å®Œæ•´æŠ¥å‘Š</button>
                <div class="flex space-x-2">
                    <button id="theme-toggle-btn" class="w-full p-2 rounded-lg border text-lg">ğŸŒ— åˆ‡æ¢æ¨¡å¼</button>
                    <button id="fullscreen-btn" class="w-full p-2 rounded-lg border text-lg">ğŸ–¥ï¸ å…¨å±å¹•</button>
                    <button id="changelog-btn" class="w-full p-2 rounded-lg border text-lg">ğŸ“œ æ›´æ–°æ—¥å¿—</button>
                </div>
            </div>
        </section>

        <!-- å³ä¾§ï¼šç»“æœä¸å›¾è¡¨ (3/5å®½åº¦) -->
        <section id="results-and-charts-panel" class="lg:col-span-3 space-y-6">
            <!-- ç»“æœæ±‡æ€» -->
            <div class="panel p-6 rounded-xl">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl neon-text-pink">ğŸ“Š è®¡ç®—ç»“æœ</h2>
                    <button id="copy-report-btn" class="p-2 rounded-lg border text-base" disabled>ğŸ“‹ å¤åˆ¶è¯¦ç»†æŠ¥å‘Š</button>
                </div>
                <pre id="results-output" class="whitespace-pre-wrap text-lg leading-relaxed bg-black/20 p-4 rounded-md min-h-[150px]"></pre>
                 <button id="ai-suggest-btn" class="w-full p-3 rounded-lg text-lg neon-text-pink border-[var(--text-neon-pink)] hover:bg-pink-500/20 mt-4" disabled>ğŸ¤– è·å–æ™ºèƒ½å……ç”µå»ºè®® (AI)</button>
            </div>
            
            <!-- è¯¦ç»†æŠ¥å‘Š -->
            <div id="detailed-report-container" class="panel p-4 rounded-xl hidden">
                 <h3 class="text-xl neon-text-pink mb-3 border-b border-b-[var(--border-neon-alt)] pb-2">ğŸ§¾ å……ç”µè¿‡ç¨‹è¯¦ç»†ä¼°ç®—</h3>
                 <pre id="detailedReport" class="text-xs whitespace-pre overflow-x-auto h-64 bg-black/20 p-2 rounded-md"></pre>
            </div>

            <!-- å›¾è¡¨ç½‘æ ¼ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="panel p-4 rounded-xl aspect-video"><canvas id="socChart"></canvas></div>
                <div class="panel p-4 rounded-xl aspect-video"><canvas id="ivChart"></canvas></div>
                <div class="panel p-4 rounded-xl aspect-video"><canvas id="lossChart"></canvas></div>
                <div class="panel p-4 rounded-xl aspect-video"><canvas id="effChart"></canvas></div>
                <div class="md:col-span-2 panel p-4 rounded-xl aspect-video"><canvas id="tempChart"></canvas></div>
            </div>
        </section>

    </main>

    <!-- æ›´æ–°æ—¥å¿— Modal -->
    <div id="changelog-modal" class="modal-backdrop">
        <div class="panel p-6 rounded-xl w-11/12 md:w-2/3 lg:w-1/2 relative">
            <button id="close-changelog-btn" class="absolute top-4 right-4 text-2xl neon-text-pink">Ã—</button>
            <h2 class="text-2xl neon-text-pink mb-4">ğŸ“œ æ›´æ–°æ—¥å¿—</h2>
            <div class="modal-content pr-4 text-base space-y-4">
                <p class="neon-text-green">ä¸€ä¸ªæŒç»­è¿­ä»£ï¼Œè¿½æ±‚ç²¾å‡†ä¸ç¾å­¦çš„å……ç”µæ¨¡æ‹Ÿå™¨é¡¹ç›®ã€‚</p>
                
                <div class="space-y-2">
                    <h3 class="text-xl neon-text-cyan">v3.9.3 - ç½—ä¼Šå®‰å“¥æ‹‰ (Roy Angora)</h3>
                    <p class="ml-4">è§†è§‰ä¿®å¤ï¼šå¤œé—´æ¨¡å¼å­—ä½“ç»Ÿä¸€ä¸ºTRONè“è‰²ï¼Œæ—¥é—´æ¨¡å¼ç»Ÿä¸€ä¸ºäºŒæ¬¡å…ƒç´«è‰²ï¼Œæå‡å¯è¯»æ€§ä¸é£æ ¼æ„Ÿã€‚</p>
                </div>
                
                <div class="space-y-2">
                    <h3 class="text-xl neon-text-cyan">v3.9.2 - ç‹„å¡å¥‘å…‹å·¨å…” (Deckard Checkered Giant)</h3>
                    <p class="ml-4">æ¨¡å‹ä¼˜åŒ–ï¼šåŸºäºå¤§é‡çœŸå®å……ç”µæ•°æ®ï¼Œç²¾æ ¡å„SOCåŒºé—´çš„åŠŸç‡å› å­ï¼Œå¤§å¹…æå‡å…¨æ®µä¼°ç®—å‡†ç¡®æ€§ã€‚</p>
                    <p class="ml-4">UIä¼˜åŒ–ï¼šç•Œé¢èå…¥æ›´å¤šEmojiï¼Œæ›´æ–°æ ‡é¢˜æ ¼å¼ï¼Œå¢å¼ºè§†è§‰å‹å¥½åº¦ã€‚</p>
                </div>
                
                <div class="space-y-2">
                    <h3 class="text-xl neon-text-cyan">v3.9.1 - æ•™çˆ¶ä¾å„’å…” (Godfather Netherland Dwarf)</h3>
                    <p class="ml-4">ä¿®å¤ï¼šå¤œé—´æ¨¡å¼ä¸‹æŒ‰é’®å’Œå›¾æ ‡å­—ä½“é¢œè‰²æ˜¾ç¤ºä¸æ­£ç¡®çš„é—®é¢˜ã€‚</p>
                    <p class="ml-4">ä¼˜åŒ–ï¼šå…¨é¢ç»Ÿä¸€ä½¿ç”¨VT323åƒç´ å­—ä½“ï¼Œå¢å¼ºé£æ ¼ä¸€è‡´æ€§ã€‚</p>
                </div>

                <div class="space-y-2">
                    <h3 class="text-xl neon-text-cyan">v3.9.0 - å´”å°¼è’‚å‚è€³å…” (Trinity Holland Lop)</h3>
                    <p class="ml-4">æ ¸å¿ƒæ¨¡å‹ä¸åŠŸèƒ½æ•´åˆï¼Œç»Ÿä¸€ç‰ˆæœ¬å‘½åè§„èŒƒã€‚</p>
                </div>
                
                <div class="space-y-2">
                    <h3 class="text-xl neon-text-cyan">v3.8.9 - ç”µä¼è·ƒè¿ï¼šé“¶æ²³ä¹‹é”š</h3>
                    <p class="ml-4">æ ¸å¿ƒæ¨¡å‹ä¼˜åŒ–ï¼šä¿®æ­£å®¶å……ç”µå‹ä¸ç”µæµç¨³å®šæ€§ã€‚</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è‡ªå®šä¹‰è­¦å‘Šæ¡† Modal -->
    <div id="custom-alert" class="modal-backdrop">
        <div class="panel p-8 rounded-xl w-11/12 md:w-1/2 lg:w-1/3 text-center relative">
             <h3 id="custom-alert-title" class="text-2xl neon-text-pink mb-4">æç¤º</h3>
             <p id="custom-alert-message" class="text-lg mb-6 whitespace-pre-wrap"></p>
             <button id="custom-alert-close-btn" class="px-8 py-2 rounded-lg text-lg">ç¡®è®¤</button>
        </div>
    </div>
    
    <!-- Toast é€šçŸ¥ -->
    <div id="toast-notification" class="toast-notification panel">Toast æ¶ˆæ¯</div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loading-indicator" class="loading-indicator">
        <div class="loader"></div>
    </div>

    <script>
        // IIFE (Immediately Invoked Function Expression) å°è£…æ‰€æœ‰ä»£ç ï¼Œé¿å…æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸ
        (() => {
            'use strict';

            // --- Gemini API å¯†é’¥ ---
            const apiKey = "";

            // --- DOM å…ƒç´ è·å– ---
            const dom = {
                body: document.body,
                carModelSelect: document.getElementById('car-model'),
                chargerTypeSelect: document.getElementById('charger-type'),
                startSocInput: document.getElementById('start-soc'),
                endSocInput: document.getElementById('end-soc'),
                chargedKwhInput: document.getElementById('charged-kwh'),
                stationOccupancyInput: document.getElementById('station-occupancy'),
                lossCheckboxes: {
                    ac: document.getElementById('ac-loss'),
                    preheat: document.getElementById('preheat-loss'),
                    cold: document.getElementById('cold-loss'),
                    hot: document.getElementById('hot-loss'),
                    autopilot: document.getElementById('autopilot-loss'),
                    load: document.getElementById('load-loss'),
                    s5Cooling: document.getElementById('s5-cooling'),
                },
                buttons: {
                    calculate: document.getElementById('calculate-btn'),
                    aiSuggest: document.getElementById('ai-suggest-btn'),
                    copyReport: document.getElementById('copy-report-btn'),
                    themeToggle: document.getElementById('theme-toggle-btn'),
                    fullscreen: document.getElementById('fullscreen-btn'),
                    changelog: document.getElementById('changelog-btn'),
                    closeChangelog: document.getElementById('close-changelog-btn'),
                    customAlertClose: document.getElementById('custom-alert-close-btn'),
                },
                displays: {
                    resultsOutput: document.getElementById('results-output'),
                    loadingIndicator: document.getElementById('loading-indicator'),
                    detailedReportContainer: document.getElementById('detailed-report-container'),
                    detailedReport: document.getElementById('detailedReport'),
                },
                modals: {
                    changelog: document.getElementById('changelog-modal'),
                    customAlert: document.getElementById('custom-alert'),
                },
                customAlert: {
                    title: document.getElementById('custom-alert-title'),
                    message: document.getElementById('custom-alert-message'),
                },
                toast: document.getElementById('toast-notification'),
                pixelBunny: document.getElementById('pixel-bunny'),
            };

            // --- Chart.js å®ä¾‹ç®¡ç† ---
            let chartInstances = {};

            // --- æ ¸å¿ƒæ•°æ®æ¨¡å‹ ---
            const carData = {
                long_range: { name: 'é•¿ç»­èˆª', batteryKwh: 60.7, chargeRate: '3C', platform: 800, carMaxAchievablePower: 265 },
                super_long_range: { name: 'è¶…é•¿ç»­èˆª', batteryKwh: 76.3, chargeRate: '3C', platform: 800, carMaxAchievablePower: 265 },
                flagship: { name: 'æ——èˆ°', batteryKwh: 74.9, chargeRate: '5C', platform: 800, carMaxAchievablePower: 335 }
            };

            const chargerData = {
                s5_super_plus: { name: 'S5 æ¶²å†·è¶…å……', stationPower: 720, isStation: true },
                s4_super: { name: 'S4 è¶…å……', stationPower: 480, isStation: true },
                s2_fast: { name: 'S2 å¿«å……', stationPower: 90, isStation: false },
                third_party_fast: { name: 'ç¬¬ä¸‰æ–¹å¿«å……', stationPower: 120, isStation: false },
                home_charger: { name: 'å®¶ç”¨å……ç”µæ¡©', stationPower: 7, isStation: false }
            };

            let lastCalculationResult = null;
            
            // --- æ ¸å¿ƒè®¡ç®—é€»è¾‘ ---
            /**
             * v3.9.2 ä¼°ç®—çœŸå®å……ç”µæ—¶é—´å’Œå„é¡¹æ•°æ® (çœŸå®æ•°æ®æ ¡å‡†æ¨¡å‹)
             * @returns {object|null} åŒ…å«è¯¦ç»†è®¡ç®—ç»“æœçš„å¯¹è±¡ï¼Œæˆ–åœ¨è¾“å…¥æ— æ•ˆæ—¶è¿”å› null
             */
            function estimateRealisticChargeTime() {
                // 1. æ•°æ®è¯»å–ä¸éªŒè¯
                const startSoc = parseFloat(dom.startSocInput.value);
                const endSoc = parseFloat(dom.endSocInput.value);
                const carModel = carData[dom.carModelSelect.value];
                const charger = chargerData[dom.chargerTypeSelect.value];
                const occupancy = parseInt(dom.stationOccupancyInput.value);

                if (isNaN(startSoc) || isNaN(endSoc) || isNaN(occupancy) || startSoc >= endSoc || occupancy < 1) {
                    showCustomAlert("è¾“å…¥é”™è¯¯", "è¯·æ£€æŸ¥è¾“å…¥å€¼ã€‚\nèµ·å§‹ç”µé‡å¿…é¡»å°äºç›®æ ‡ç”µé‡ï¼Œä¸”å ç”¨æ¡©æ•°è‡³å°‘ä¸º 1ã€‚");
                    return null;
                }

                // 2. è®¡ç®—æœ‰æ•ˆæœ€å¤§åŠŸç‡
                const sessionMaxPower = charger.isStation ? Math.min(charger.stationPower / occupancy, carModel.carMaxAchievablePower) : Math.min(charger.stationPower, carModel.carMaxAchievablePower);
                const effectiveMaxPower = sessionMaxPower;

                // 3. å®šä¹‰å……ç”µåŠŸç‡æ›²çº¿ (socZones) - v3.9.2 åŸºäºçœŸå®æ•°æ®æ ¡å‡†
                let socZones;
                if (carModel.chargeRate === '5C') { // æ——èˆ° (5C)
                     socZones = [
                        { soc: 10, factor: 0.99 },
                        { soc: 40, factor: 0.90 },
                        { soc: 70, factor: 0.70 },
                        { soc: 85, factor: 0.50 },
                        { soc: 95, factor: 0.25 },
                        { soc: 100, factor: 0.10 }
                    ];
                } else { // é•¿ç»­èˆª/è¶…é•¿ç»­èˆª (3C)
                     socZones = [
                        { soc: 15, factor: 0.98 },
                        { soc: 50, factor: 0.85 },
                        { soc: 80, factor: 0.60 },
                        { soc: 90, factor: 0.40 },
                        { soc: 97, factor: 0.20 },
                        { soc: 100, factor: 0.08 }
                    ];
                }
                
                if (dom.lossCheckboxes.s5Cooling.checked && charger.name.includes('S5')) {
                    socZones.forEach(zone => {
                        if (zone.soc > 15 && zone.soc <= 80) zone.factor = Math.min(1.0, zone.factor * 1.05);
                    });
                }
                
                // 4. åˆ†æ®µè®¡ç®—
                let totalTimeMinutes = 0, energyAddedKwh = 0, lastSoc = startSoc;
                const chargeProfile = []; 

                for (const zone of socZones) {
                    if (startSoc >= zone.soc || lastSoc >= endSoc) continue;
                    const socStartOfZone = Math.max(lastSoc, (socZones.find(z => z.soc < zone.soc)?.soc || 0));
                    const socEndOfZone = Math.min(endSoc, zone.soc);
                    const socInZone = socEndOfZone - socStartOfZone;
                    if (socInZone <= 0) continue;
                    
                    const avgPower = effectiveMaxPower * zone.factor;
                    const energyForZone = (socInZone / 100) * carModel.batteryKwh;
                    totalTimeMinutes += (energyForZone / avgPower) * 60;
                    energyAddedKwh += energyForZone;

                    for(let currentSoc = socStartOfZone; currentSoc < socEndOfZone; currentSoc += 1) {
                         const baseVoltage = 770 + (currentSoc / 100) * 50;
                         const voltage = baseVoltage + (Math.random() - 0.5) * 20;
                         const current = Math.min((avgPower * 1000) / voltage, carModel.chargeRate === '3C' ? 340 : 450);
                         chargeProfile.push({ soc: currentSoc, power: avgPower, current, voltage });
                    }
                    lastSoc = socEndOfZone;
                }
                 const lastZone = socZones.find(z => endSoc <= z.soc) || socZones[socZones.length-1];
                 const finalPower = effectiveMaxPower * lastZone.factor;
                 const finalVoltage = 770 + (endSoc / 100) * 50;
                 chargeProfile.push({ soc: endSoc, power: finalPower, current: (finalPower * 1000) / finalVoltage, voltage: finalVoltage });

                // 5. è®¡ç®—æŸè€—
                const baseLoss = 0.08;
                let extraLossFactor = 0;
                const lossFactors = {
                    ac: { checked: dom.lossCheckboxes.ac.checked, value: 0.04, name: 'ç©ºè°ƒ' },
                    preheat: { checked: dom.lossCheckboxes.preheat.checked, value: 0.06, name: 'ç”µæ± é¢„çƒ­' },
                    cold: { checked: dom.lossCheckboxes.cold.checked, value: 0.05, name: 'ä½æ¸©ç¯å¢ƒ' },
                    hot: { checked: dom.lossCheckboxes.hot.checked, value: 0.07, name: 'é«˜æ¸©é…·çƒ­' },
                    autopilot: { checked: dom.lossCheckboxes.autopilot.checked, value: 0.02, name: 'æ™ºé©¾è€—ç”µ' },
                    load: { checked: dom.lossCheckboxes.load.checked, value: 0.03, name: 'è½¦è¾†è½½é‡' },
                };
                const appliedLosses = {};
                for (const key in lossFactors) {
                    if (lossFactors[key].checked) {
                        extraLossFactor += lossFactors[key].value;
                        appliedLosses[lossFactors[key].name] = lossFactors[key].value;
                    }
                }
                const totalLossFactor = baseLoss + extraLossFactor;
                const theoreticalKwhFromGrid = energyAddedKwh / (1 - totalLossFactor);
                const totalLossKwh = theoreticalKwhFromGrid - energyAddedKwh;
                
                // 6. è®¡ç®—å®é™…æŸè€—
                let actualLossKwh = null, actualEfficiency = null;
                const chargedKwh = parseFloat(dom.chargedKwhInput.value);
                if (!isNaN(chargedKwh) && chargedKwh > 0) {
                    actualLossKwh = chargedKwh - energyAddedKwh;
                    actualEfficiency = (energyAddedKwh / chargedKwh) * 100;
                }

                return { totalTimeMinutes, energyAddedKwh, effectiveMaxPower, chargeProfile, totalLossKwh, totalLossFactor, appliedLosses, baseLoss, actualLossKwh, actualEfficiency, carModel, charger, startSoc, endSoc };
            }

            // --- ä¸»åè°ƒä¸æ˜¾ç¤º ---
            function calculateAndDisplay() {
                populateDefaultsIfEmpty();
                const result = estimateRealisticChargeTime();
                if (!result) {
                    dom.buttons.aiSuggest.disabled = true;
                    dom.buttons.copyReport.disabled = true;
                    return;
                }
                lastCalculationResult = result;

                const hours = Math.floor(result.totalTimeMinutes / 60);
                const minutes = Math.round(result.totalTimeMinutes % 60);
                const timeString = `${hours > 0 ? hours + ' å°æ—¶ ' : ''}${minutes} åˆ†é’Ÿ`;
                
                let output = `é¢„è®¡å……ç”µæ—¶é—´: ${timeString} ğŸ•’\n`;
                output += `é¢„è®¡å……å…¥ç”µé‡: ${result.energyAddedKwh.toFixed(2)} kWh âš¡\n`;
                output += `æœ€é«˜æœ‰æ•ˆåŠŸç‡: ${result.effectiveMaxPower.toFixed(0)} kW ğŸš€\n`;
                output += `é¢„ä¼°æ€»æŸè€—: ${result.totalLossKwh.toFixed(2)} kWh (çº¦ ${(result.totalLossFactor * 100).toFixed(1)}%) ğŸ”¥\n`;
                if (result.actualLossKwh !== null) {
                    output += `\n>> æ ¹æ®è¾“å…¥çš„ ${dom.chargedKwhInput.value} kWh è®¡ç®—:\n`;
                    output += `   å®é™…æ€»æŸè€—: ${result.actualLossKwh.toFixed(2)} kWh\n`;
                    output += `   å®é™…ç»¼åˆæ•ˆç‡: ${result.actualEfficiency.toFixed(1)} %\n`;
                }

                dom.displays.resultsOutput.textContent = output;
                dom.buttons.aiSuggest.disabled = false;
                dom.buttons.copyReport.disabled = false;

                generateAndDisplayDetailedReport(result.chargeProfile);
                dom.displays.detailedReportContainer.classList.remove('hidden');

                updateAllCharts(result);
            }

            function generateAndDisplayDetailedReport(profile) {
                 let reportContent = "SoC (%) | åŠŸç‡ (kW) | ç”µæµ (A) | ç”µå‹ (V)\n";
                 reportContent += "--------|-----------|----------|----------\n";
                 profile.forEach(p => {
                     reportContent += `${p.soc.toFixed(1).padEnd(7)}| ${p.power.toFixed(2).padEnd(9)}| ${p.current.toFixed(2).padEnd(8)}| ${p.voltage.toFixed(0)}\n`;
                 });
                 dom.displays.detailedReport.textContent = reportContent;
            }

            function generateDetailedReportText() {
                if (!lastCalculationResult) return "æ²¡æœ‰å¯ç”¨çš„æŠ¥å‘Šã€‚";
                const r = lastCalculationResult;
                const hours = Math.floor(r.totalTimeMinutes / 60);
                const minutes = Math.round(r.totalTimeMinutes % 60);
                let report = `--- å°é¹P7+ å……ç”µæŠ¥å‘Š (v3.9.3) ---\n\n`;
                report += `[å……ç”µè®¾å®š]\nè½¦å‹: ${r.carModel.name}\nå……ç”µæ¡©: ${r.charger.name}\nå……ç”µåŒºé—´: ${r.startSoc}% -> ${r.endSoc}%\n\n`;
                report += `[æ ¸å¿ƒç»“æœ]\né¢„è®¡æ€»è€—æ—¶: ${hours} å°æ—¶ ${minutes} åˆ†é’Ÿ\nå……å…¥ç”µæ± ç”µé‡: ${r.energyAddedKwh.toFixed(2)} kWh\nå³°å€¼å……ç”µåŠŸç‡: ${r.effectiveMaxPower.toFixed(0)} kW\n\n`;
                report += `[æŸè€—åˆ†æ]\né¢„ä¼°æ€»æŸè€—: ${r.totalLossKwh.toFixed(2)} kWh\nåŸºç¡€æŸè€— (8%): ${(r.energyAddedKwh / (1 - r.baseLoss) - r.energyAddedKwh).toFixed(2)} kWh\n`;
                Object.entries(r.appliedLosses).forEach(([name]) => { report += `é¢å¤–æŸè€— - ${name}\n`; });
                if (r.actualEfficiency) report += `\nå®é™…ç»¼åˆæ•ˆç‡: ${r.actualEfficiency.toFixed(1)}%\n`;
                report += `\n--- æŠ¥å‘Šç”Ÿæˆäº ${new Date().toLocaleString('zh-CN')} ---\n`;
                return report;
            }

            // --- å›¾è¡¨ç®¡ç† ---
            function destroyAllCharts() {
                Object.values(chartInstances).forEach(chart => chart?.destroy());
                chartInstances = {};
            }
            
            function updateAllCharts(result) {
                destroyAllCharts();
                const colors = getThemeColors();
                chartInstances.soc = createSoCChart(result, colors);
                chartInstances.iv = createIVChart(result, colors);
                chartInstances.loss = createLossChart(result, colors);
                chartInstances.eff = createEffChart(result, colors);
                chartInstances.temp = createTempChart(colors);
            }
            
            function getThemeColors() {
                const styles = getComputedStyle(document.documentElement);
                return ['gridColor', 'tickColor', 'color1', 'color2', 'color3', 'color4', 'color5', 'color6']
                    .reduce((acc, name) => ({ ...acc, [name]: styles.getPropertyValue(`--chart-${name}`).trim() }), {});
            }
            
            function getChartOptions(title, xLabel, yLabel, y1Label = null, colors = getThemeColors(), hasDualAxis = false) {
                const options = {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: title, color: colors.tickColor, font: { size: 16, family: "'VT323', monospace" } },
                        legend: { position: 'top', labels: { color: colors.tickColor, font: { family: "'VT323', monospace" } } },
                        tooltip: { backgroundColor: 'rgba(0,0,0,0.7)', titleColor: colors.color1, titleFont: { family: "'VT323', monospace" }, bodyFont: { family: "'VT323', monospace" } }
                    },
                    scales: {
                        x: { title: { display: !!xLabel, text: xLabel, color: colors.tickColor, font: { family: "'VT323', monospace" } }, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor, font: { family: "'VT323', monospace" } } },
                        y: { title: { display: true, text: yLabel, color: colors.tickColor, font: { family: "'VT323', monospace" } }, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor, font: { family: "'VT323', monospace" } }, beginAtZero: true }
                    }
                };
                if (hasDualAxis && y1Label) {
                    options.scales.y1 = { type: 'linear', position: 'right', title: { display: true, text: y1Label, color: colors.tickColor, font: { family: "'VT323', monospace" } }, grid: { drawOnChartArea: false }, ticks: { color: colors.tickColor, font: { family: "'VT323', monospace" } }, beginAtZero: true };
                }
                return options;
            }

            function createSoCChart(result, colors) {
                const options = getChartOptions('ğŸ”‹ SoC å˜åŒ–æ›²çº¿', 'æ—¶é—´ (åˆ†é’Ÿ)', 'SoC (%)', null, colors, false);
                const data = result.chargeProfile;
                const totalMinutes = result.totalTimeMinutes;
                return new Chart('socChart', {
                    type: 'line', data: {
                        labels: data.map(p => (p.soc / 100 * totalMinutes).toFixed(1)), // Approximate time mapping
                        datasets: [{ label: 'SoC', data: data.map(p => p.soc), borderColor: colors.color1, tension: 0.1 }]
                    }, options
                });
            }

            function createIVChart(result, colors) {
                const data = result.chargeProfile;
                const options = getChartOptions('ğŸ“‰ æ¨¡æ‹Ÿç”µæµ/ç”µå‹', 'SoC (%)', 'ç”µæµ(A)', 'ç”µå‹(V)', colors, true);
                 options.scales.y1.min = (result.charger.name === 'å®¶ç”¨å……ç”µæ¡©') ? 200 : 750;
                 options.scales.y1.max = (result.charger.name === 'å®¶ç”¨å……ç”µæ¡©') ? 240 : 850;
                return new Chart('ivChart', {
                    type: 'line', data: {
                        labels: data.map(p => p.soc.toFixed(0)), datasets: [
                            { label: 'ç”µæµ (A)', data: data.map(p => p.current), borderColor: colors.color2, yAxisID: 'y' },
                            { label: 'ç”µå‹ (V)', data: data.map(p => p.voltage), borderColor: colors.color3, yAxisID: 'y1' }
                        ]
                    }, options
                });
            }

            function createLossChart(result, colors) {
                return new Chart('lossChart', { type: 'doughnut', data: { labels: ['æœ‰æ•ˆå……ç”µ', 'æ€»æŸè€—'], datasets: [{ data: [result.energyAddedKwh, result.totalLossKwh], backgroundColor: [colors.color4, colors.color5], borderColor: '#0d0e1b', borderWidth: 4 }] },
                    options: getChartOptions('âš¡ ç”µé‡æŸè€—åˆ†å¸ƒ', null, null, null, colors, false)
                });
            }

            function createEffChart(result, colors) {
                 const data = [100 * (1-result.totalLossFactor)];
                 const labels = ['é¢„ä¼°æ•ˆç‡'];
                 if(result.actualEfficiency) {
                     data.push(result.actualEfficiency);
                     labels.push('å®é™…æ•ˆç‡');
                 }
                return new Chart('effChart', { type: 'bar', data: { labels: labels, datasets: [{ label: 'æ•ˆç‡ (%)', data: data, backgroundColor: [colors.color1, colors.color6] }] },
                    options: getChartOptions('ğŸ“Š å……ç”µæ•ˆç‡å¯¹æ¯”', null, 'æ•ˆç‡ (%)', null, colors, false)
                });
            }

            function createTempChart(colors) {
                const temps = Array.from({ length: 11 }, (_, i) => i * 5 - 10);
                const effs = temps.map(t => (98 - Math.pow(t - 22, 2) * 0.05));
                return new Chart('tempChart', { type: 'line', data: { labels: temps.map(t => `${t}Â°C`), datasets: [{ label: 'æ•ˆç‡ (%)', data: effs, fill: true, borderColor: '#66ccff', backgroundColor: 'rgba(102, 204, 255, 0.2)', tension: 0.4 }] },
                    options: getChartOptions('ğŸŒ¡ï¸ æ¸©åº¦ vs å……ç”µæ•ˆç‡', 'ç¯å¢ƒæ¸©åº¦', 'æ•ˆç‡ (%)', null, colors, false)
                });
            }

            // --- UI/UX äº¤äº’å‡½æ•° ---
            function toggleTheme() {
                dom.body.classList.toggle('light-mode');
                const isLight = dom.body.classList.contains('light-mode');
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
                dom.buttons.themeToggle.textContent = isLight ? 'ğŸŒ‘ å¤œé—´æ¨¡å¼' : 'ğŸŒ“ æ—¥é—´æ¨¡å¼';
                if (lastCalculationResult) {
                    updateAllCharts(lastCalculationResult);
                }
            }
            
            function toggleFullscreen() {
                if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => showCustomAlert("é”™è¯¯", `æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼: ${err.message}`)); } 
                else { document.exitFullscreen(); }
            }
            
            function toggleModal(modal, show) { modal.classList.toggle('show', show); }
            
            function showCustomAlert(title, message) {
                dom.customAlert.title.textContent = title;
                dom.customAlert.message.textContent = message;
                toggleModal(dom.modals.customAlert, true);
            }
            
            function showToast(message) {
                dom.toast.textContent = message;
                dom.toast.classList.add('show');
                setTimeout(() => dom.toast.classList.remove('show'), 3000);
            }
            
            function copyReportToClipboard() {
                navigator.clipboard.writeText(generateDetailedReportText()).then(() => showToast('æŠ¥å‘Šå·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')).catch(() => showCustomAlert("å¤åˆ¶å¤±è´¥", "æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒæ­¤åŠŸèƒ½æˆ–æœªæˆäºˆæƒé™ã€‚"));
            }

            function populateDefaultsIfEmpty() {
                if (!dom.startSocInput.value) dom.startSocInput.value = Math.floor(Math.random() * 15) + 5;
                if (!dom.endSocInput.value) dom.endSocInput.value = Math.floor(Math.random() * 21) + 80;
                if (!dom.stationOccupancyInput.value) dom.stationOccupancyInput.value = Math.floor(Math.random() * 3) + 1;
                if (!dom.chargedKwhInput.value) dom.chargedKwhInput.value = ((parseFloat(dom.endSocInput.value) - parseFloat(dom.startSocInput.value)) / 100 * carData[dom.carModelSelect.value].batteryKwh / 0.9).toFixed(1);
            }
            
            // --- AI å»ºè®®åŠŸèƒ½ ---
            async function getAIChargeSuggestion() {
                if (!lastCalculationResult) { showCustomAlert("æç¤º", "è¯·å…ˆè¿›è¡Œä¸€æ¬¡è®¡ç®—ã€‚"); return; }
                if (!apiKey) { showCustomAlert("API å¯†é’¥ç¼ºå¤±", "æ— æ³•è¿æ¥åˆ° AI æœåŠ¡ã€‚"); return; }
                dom.displays.loadingIndicator.style.display = 'block';
                dom.buttons.aiSuggest.disabled = true;
                const r = lastCalculationResult;
                const prompt = `ä½œä¸ºä¸€åç”µåŠ¨è½¦å……ç”µä¸“å®¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹å°é¹P7+çš„å……ç”µè®¡ç®—æ•°æ®ï¼Œä¸ºè½¦ä¸»æä¾›3åˆ°5æ¡ä¸“ä¸šã€ç²¾ç®€ä¸”æ˜“äºç†è§£çš„å……ç”µå»ºè®®ã€‚è¦æ±‚ï¼šç®€ä½“ä¸­æ–‡ã€ç‚¹åˆ—å¼ã€æ¯æ¡ä¸è¶…è¿‡50å­—ã€‚æ•°æ®ï¼šè½¦å‹: ${r.carModel.name}ï¼Œå……ç”µåŒºé—´: ${r.startSoc}%-${r.endSoc}%ï¼Œå……ç”µæ¡©: ${r.charger.name}ï¼Œè€—æ—¶: ${Math.round(r.totalTimeMinutes)}åˆ†é’Ÿï¼Œå³°å€¼åŠŸç‡: ${r.effectiveMaxPower.toFixed(0)}kWï¼ŒæŸè€—ç‡: ${(r.totalLossFactor*100).toFixed(1)}%ï¼Œæ¿€æ´»æŸè€—: ${Object.keys(r.appliedLosses).join(', ')||'æ— '}`;
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!response.ok) throw new Error((await response.json()).error.message);
                    const data = await response.json();
                    showCustomAlert("æ™ºèƒ½å……ç”µå»ºè®®", data.candidates[0].content.parts[0].text);
                } catch (error) { showCustomAlert("AI å»ºè®®å‡ºé”™", `æ— æ³•è·å–å»ºè®®: ${error.message}`); } 
                finally { dom.displays.loadingIndicator.style.display = 'none'; dom.buttons.aiSuggest.disabled = false; }
            }

            // --- åƒç´ å…”å­åŠ¨ç”» ---
            function updateBunnyAnimation() {
                const { innerWidth: vw, innerHeight: vh } = window;
                for (let i = 1; i <= 10; i++) {
                    dom.pixelBunny.style.setProperty(`--x${i}`, `${Math.random() * (vw - 100)}px`);
                    dom.pixelBunny.style.setProperty(`--y${i}`, `${Math.random() * (vh - 100)}px`);
                }
            }

            // --- åˆå§‹åŒ– ---
            function initialize() {
                // æ³¨å†Œäº‹ä»¶ç›‘å¬
                dom.buttons.calculate.addEventListener('click', calculateAndDisplay);
                dom.buttons.aiSuggest.addEventListener('click', getAIChargeSuggestion);
                dom.buttons.themeToggle.addEventListener('click', toggleTheme);
                dom.buttons.fullscreen.addEventListener('click', toggleFullscreen);
                dom.buttons.changelog.addEventListener('click', () => toggleModal(dom.modals.changelog, true));
                dom.buttons.closeChangelog.addEventListener('click', () => toggleModal(dom.modals.changelog, false));
                dom.buttons.copyReport.addEventListener('click', copyReportToClipboard);
                dom.buttons.customAlertClose.addEventListener('click', () => toggleModal(dom.modals.customAlert, false));

                // è§¦å‘é‡æ–°è®¡ç®—çš„äº‹ä»¶
                const recalcTriggers = [dom.carModelSelect, dom.chargerTypeSelect, dom.startSocInput, dom.endSocInput, dom.stationOccupancyInput, ...Object.values(dom.lossCheckboxes)];
                recalcTriggers.forEach(el => el.addEventListener('change', calculateAndDisplay));
                
                // è®¾ç½®ä¸»é¢˜
                const savedTheme = localStorage.getItem('theme');
                const isLight = savedTheme === 'light';
                if (isLight) dom.body.classList.add('light-mode');
                dom.buttons.themeToggle.textContent = isLight ? 'ğŸŒ‘ å¤œé—´æ¨¡å¼' : 'ğŸŒ“ æ—¥é—´æ¨¡å¼';
                
                calculateAndDisplay();
                updateBunnyAnimation();
                setInterval(updateBunnyAnimation, 30000);
            }

            document.addEventListener('DOMContentLoaded', initialize);
        })();
    </script>
</body>
</html>
