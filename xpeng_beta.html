<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>小鹏P7+ 充电损耗计算器 v4.0</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  :root {
    --color-cold: #00cfff;
    --color-warm: #ff6a00;
    --color-green: #39ff14;
    --color-text: #eee;
    --color-bg: #121212;
    --color-bg-cold: #001f3f;
    --color-bg-warm: #3f1f00;
  }
  body {
    font-family: 'Press Start 2P', monospace, monospace;
    background: var(--color-bg);
    color: var(--color-text);
    margin: 0; padding: 1rem 1.2rem;
    user-select: none;
    transition: background 0.6s ease, color 0.6s ease;
  }
  h1 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    text-align: center;
    color: var(--color-green);
    letter-spacing: 0.05em;
  }
  label {
    display: inline-block;
    margin: 0.25rem 0.5rem 0.25rem 0;
    cursor: pointer;
  }
  select, input[type=number] {
    font-family: monospace;
    font-size: 0.85rem;
    padding: 0.15rem 0.3rem;
    background: #222;
    border: 1.5px solid var(--color-green);
    color: var(--color-green);
    border-radius: 3px;
    width: 130px;
    transition: border-color 0.3s ease;
  }
  select:hover, input[type=number]:hover {
    border-color: #3fff5c;
  }
  input[type=checkbox] {
    transform: scale(1.2);
    margin-right: 0.3rem;
    cursor: pointer;
  }
  .form-row {
    margin-bottom: 0.7rem;
    display: flex; align-items: center; flex-wrap: wrap;
    gap: 1rem;
  }
  button {
    background: var(--color-green);
    border: none;
    color: var(--color-bg);
    padding: 0.5rem 1.2rem;
    cursor: pointer;
    font-family: 'Press Start 2P', monospace;
    font-size: 0.9rem;
    border-radius: 5px;
    transition: background 0.3s ease, transform 0.15s ease;
    user-select: none;
  }
  button:hover {
    background: #2bc600;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.95);
  }
  #result {
    margin-top: 1.4rem;
    font-size: 1rem;
    color: var(--color-green);
    white-space: pre-line;
    user-select: text;
    min-height: 3.5em;
  }
  canvas {
    margin-top: 1.2rem;
    background: #000;
    border: 2px solid var(--color-green);
    border-radius: 6px;
    max-width: 100%;
    height: 220px !important;
  }
  footer {
    margin-top: 2.5rem;
    font-size: 0.65rem;
    color: #555;
    text-align: center;
    user-select: none;
  }
  /* 响应式 */
  @media (max-width: 650px) {
    .form-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.4rem;
    }
    select, input[type=number] {
      width: 100%;
      max-width: 300px;
    }
    button {
      width: 100%;
      max-width: 300px;
    }
  }
  /* 进度条样式 */
  #progressContainer {
    width: 100%;
    background: #222;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 1rem;
    height: 18px;
  }
  #progressBar {
    height: 18px;
    width: 0%;
    background: linear-gradient(90deg, #39ff14 0%, #2bc600 100%);
    transition: width 0.3s ease;
  }
  #timeRemaining {
    margin-top: 0.4rem;
    font-size: 0.95rem;
    color: #39ff14;
    font-weight: bold;
  }
  /* tooltip */
  [data-tooltip] {
    position: relative;
    cursor: help;
  }
  [data-tooltip]::after {
    content: attr(data-tooltip);
    position: absolute;
    white-space: nowrap;
    background: #39ff14;
    color: #121212;
    font-size: 0.65rem;
    padding: 3px 7px;
    border-radius: 3px;
    bottom: 120%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }
  [data-tooltip]:hover::after {
    opacity: 1;
  }
</style>
</head>
<body>

<h1>小鹏P7+ 充电损耗计算器 v4.0</h1>

<div class="form-row">
  <label for="model" data-tooltip="选择您的小鹏P7车型">车型:</label>
  <select id="model" title="车型">
    <option>旗舰版</option>
    <option>超长续航</option>
    <option>长续航</option>
  </select>

  <label for="charger" data-tooltip="选择充电桩型号和功率">充电桩:</label>
  <select id="charger" title="充电桩">
    <option>S5（800kW）</option>
    <option>S4（400kW峰值）</option>
    <option>S2（90kW单枪）</option>
  </select>
</div>

<div class="form-row" title="勾选以模拟额外的能耗或损耗">
  <label><input type="checkbox" id="acOn" /> 空调开启</label>
  <label><input type="checkbox" id="preheat" /> 预热</label>
  <label><input type="checkbox" id="lowTemp" /> 低温模式</label>
  <label><input type="checkbox" id="autopilotOn" /> 智驾开启</label>
  <label><input type="checkbox" id="passengers" /> 乘客2人</label>
</div>

<div class="form-row">
  <label for="temp" data-tooltip="输入当前环境温度，单位摄氏度">环境温度 (°C):</label>
  <input type="number" id="temp" value="25" min="-30" max="50" step="1" />
</div>

<button id="calcBtn" title="点击计算充电时间和效率曲线">计算充电时间与效率曲线</button>

<div id="progressContainer" aria-label="充电进度条" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
  <div id="progressBar"></div>
</div>
<div id="timeRemaining" aria-live="polite" aria-atomic="true">等待计算...</div>

<div id="result" aria-live="polite" aria-atomic="true"></div>

<canvas id="powerChart" width="600" height="220" aria-label="充电功率曲线图" role="img"></canvas>
<canvas id="efficiencyChart" width="600" height="220" aria-label="充电效率曲线图" role="img"></canvas>

<footer>Powered by ChatGPT · 适合 GitHub Pages 部署</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  // 车型参数
  const modelSpecs = {
    "旗舰版": { maxC: 5, maxBatteryKWh: 75 },
    "超长续航": { maxC: 3, maxBatteryKWh: 70 },
    "长续航": { maxC: 3, maxBatteryKWh: 65 },
  };
  // 充电桩参数
  const chargerSpecs = {
    "S5（800kW）": { maxPowerKW: 800, coolingStrategy: true },
    "S4（400kW峰值）": { maxPowerKW: 400, coolingStrategy: false },
    "S2（90kW单枪）": { maxPowerKW: 90, coolingStrategy: false },
  };

  // 损耗因子计算
  function calculateExtraLosses({ acOn, preheat, lowTemp, autopilotOn, passengers, cooling }) {
    let lossFactor = 1.0;
    if (acOn) lossFactor += 0.03;
    if (preheat) lossFactor += 0.02;
    if (lowTemp) lossFactor += 0.05;
    if (autopilotOn) lossFactor += 0.01;
    if (passengers) lossFactor += 0.01; // 固定2人乘客
    if (cooling) lossFactor += 0.04;
    return lossFactor;
  }

  // 充电功率衰减模型
  function calculateChargingPower(soc, maxPowerKW) {
    if (soc < 0.2) return maxPowerKW;
    else if (soc < 0.5) return maxPowerKW * 0.8;
    else if (soc < 0.8) return maxPowerKW * 0.5;
    else return maxPowerKW * 0.3;
  }

  // 时间格式化
  function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    return [h, m, s].map(v => v.toString().padStart(2, '0')).join(':');
  }

  // 充电效率估算
  function estimateEfficiency(soc, tempC, powerKW, extraLossFactor) {
    let baseEff = 0.95 - (powerKW / 1000) * 0.05;
    if (tempC < 10) baseEff -= 0.05;
    if (soc > 0.8) baseEff -= 0.1;
    return Math.max(0.7, baseEff / extraLossFactor);
  }

  // 充电计算主函数，支持逐步返回进度（用于动画）
  function runChargeSimulation({
    modelName,
    chargerName,
    acOn,
    preheat,
    lowTemp,
    autopilotOn,
    passengers,
    ambientTempC,
    startSoc = 0.05,
    endSoc = 0.95,
    onStep = null,  // 每一步回调
  }) {
    const model = modelSpecs[modelName];
    const charger = chargerSpecs[chargerName];
    const maxC = model.maxC;
    const maxBatteryKWh = model.maxBatteryKWh;
    const maxChargerPower = charger.maxPowerKW;
    const maxPossiblePowerKW = Math.min(maxC * maxBatteryKWh, maxChargerPower);
    const extraLossFactor = calculateExtraLosses({
      acOn,
      preheat,
      lowTemp,
      autopilotOn,
      passengers,
      cooling: charger.coolingStrategy,
    });
    let soc = startSoc;
    const socStep = 0.01;
    let timeSeconds = 0;
    let socHistory = [];
    let powerHistory = [];
    let efficiencyHistory = [];
    while (soc < endSoc) {
      let powerKW = calculateChargingPower(soc, maxPossiblePowerKW);
      let efficiency = estimateEfficiency(soc, ambientTempC, powerKW, extraLossFactor);
      let effectivePowerKW = powerKW * efficiency;
      let energyAdded = socStep * maxBatteryKWh;
      let stepTimeH = energyAdded / effectivePowerKW;
      let stepTimeS = stepTimeH * 3600;
      timeSeconds += stepTimeS;
      soc += socStep;
      socHistory.push(soc);
      powerHistory.push(powerKW);
      efficiencyHistory.push(efficiency);
      if (onStep) onStep({
        soc,
        powerKW,
        efficiency,
        elapsedSeconds: timeSeconds,
        extraLossFactor,
      });
    }
    return {
      totalChargeTime: formatTime(timeSeconds),
      socHistory,
      powerHistory,
      efficiencyHistory,
      extraLossFactor,
      totalSeconds: timeSeconds,
    };
  }

  // 主题颜色切换：根据温度自动切换背景色
  function applyThemeByTemp(tempC) {
    if (tempC <= 10) {
      document.body.style.background = 'var(--color-bg-cold)';
      document.body.style.color = 'var(--color-cold)';
    } else if (tempC >= 25) {
      document.body.style.background = 'var(--color-bg-warm)';
      document.body.style.color = 'var(--color-warm)';
    } else {
      document.body.style.background = 'var(--color-bg)';
      document.body.style.color = 'var(--color-text)';
    }
  }

  // 渐变颜色生成 (SoC曲线分三段颜色渐变)
  function getSocGradientColor(soc) {
    if (soc < 0.2) return '#39ff14'; // 绿
    else if (soc < 0.5) return '#ffff00'; // 黄
    else if (soc < 0.8) return '#ff9900'; // 橙
    else return '#ff3300'; // 红
  }

  // Chart.js 创建充电功率渐变色（基于soc位置）
  function createGradient(ctx, chartArea) {
    const gradient = ctx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
    gradient.addColorStop(0.0, '#39ff14'); // 绿
    gradient.addColorStop(0.4, '#ffff00'); // 黄
    gradient.addColorStop(0.7, '#ff9900'); // 橙
    gradient.addColorStop(1.0, '#ff3300'); // 红
    return gradient;
  }

  // 页面元素引用
  const modelSelect = document.getElementById('model');
  const chargerSelect = document.getElementById('charger');
  const acOnCheckbox = document.getElementById('acOn');
  const preheatCheckbox = document.getElementById('preheat');
  const lowTempCheckbox = document.getElementById('lowTemp');
  const autopilotCheckbox = document.getElementById('autopilotOn');
  const passengersCheckbox = document.getElementById('passengers');
  const tempInput = document.getElementById('temp');
  const calcBtn = document.getElementById('calcBtn');
  const resultDiv = document.getElementById('result');
  const progressBar = document.getElementById('progressBar');
  const timeRemainingText = document.getElementById('timeRemaining');

  // 初始化Chart.js图表
  const powerCtx = document.getElementById('powerChart').getContext('2d');
  const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');

  let powerChart, efficiencyChart;

  function initCharts() {
    if (powerChart) powerChart.destroy();
    if (efficiencyChart) efficiencyChart.destroy();

    powerChart = new Chart(powerCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: '充电功率 (kW)',
          data: [],
          borderColor: '#39ff14',
          backgroundColor: 'rgba(57,255,20,0.3)',
          fill: true,
          tension: 0.25,
          pointRadius: 0,
          borderWidth: 2,
        }]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: {
            title: { display: true, text: 'SOC' },
            min: 0, max: 1,
            ticks: {
              callback: v => (v * 100).toFixed(0) + '%'
            }
          },
          y: {
            title: { display: true, text: '功率 (kW)' },
            min: 0
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        }
      },
      plugins: [{
        id: 'gradientStroke',
        beforeDatasetDraw(chart) {
          const ctx = chart.ctx;
          const chartArea = chart.chartArea;
          const gradient = createGradient(ctx, chartArea);
          chart.data.datasets[0].borderColor = gradient;
          chart.data.datasets[0].backgroundColor = gradient;
        }
      }]
    });

    efficiencyChart = new Chart(efficiencyCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: '充电效率',
          data: [],
          borderColor: '#14ffff',
          backgroundColor: 'rgba(20,255,255,0.3)',
          fill: true,
          tension: 0.25,
          pointRadius: 0,
          borderWidth: 2,
        }]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: {
            title: { display: true, text: 'SOC' },
            min: 0, max: 1,
            ticks: {
              callback: v => (v * 100).toFixed(0) + '%'
            }
          },
          y: {
            title: { display: true, text: '效率' },
            min: 0.6, max: 1
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        }
      }
    });
  }

  // 主函数运行与动画显示
  function runAndAnimate() {
    const modelName = modelSelect.value;
    const chargerName = chargerSelect.value;
    const acOn = acOnCheckbox.checked;
    const preheat = preheatCheckbox.checked;
    const lowTemp = lowTempCheckbox.checked;
    const autopilotOn = autopilotCheckbox.checked;
    const passengers = passengersCheckbox.checked;
    const tempC = Number(tempInput.value);

    applyThemeByTemp(tempC);

    resultDiv.textContent = "计算中...";
    timeRemainingText.textContent = "准备中...";

    initCharts();

    let frame = 0;
    let soc = 0.05;
    let socStep = 0.01;

    // 预计算所有数据
    const simData = runChargeSimulation({
      modelName,
      chargerName,
      acOn,
      preheat,
      lowTemp,
      autopilotOn,
      passengers,
      ambientTempC: tempC,
      startSoc: soc,
      endSoc: 0.95,
      onStep: null,
    });

    const totalSeconds = simData.totalSeconds;
    const totalSteps = simData.socHistory.length;

    function updateUI(step) {
      if (step >= totalSteps) {
        resultDiv.textContent = `总充电时间约为: ${simData.totalChargeTime}\n` +
          `额外能耗因子: ${(simData.extraLossFactor * 100).toFixed(1)}%\n` +
          `适用车型: ${modelName}，充电桩: ${chargerName}`;
        timeRemainingText.textContent = `充电完成！`;
        progressBar.style.width = `100%`;
        return;
      }
      const socNow = simData.socHistory[step];
      const powerNow = simData.powerHistory[step];
      const efficiencyNow = simData.efficiencyHistory[step];
      const timeElapsed = simData.totalSeconds * (step / totalSteps);
      const timeLeft = simData.totalSeconds - timeElapsed;

      // 进度条更新
      const progressPercent = Math.floor((socNow - 0.05) / (0.95 - 0.05) * 100);
      progressBar.style.width = `${progressPercent}%`;
      progressBar.parentElement.setAttribute('aria-valuenow', progressPercent);

      // 剩余时间倒计时
      timeRemainingText.textContent = `剩余时间估算: ${formatTime(timeLeft)}`;

      // 更新图表
      powerChart.data.labels = simData.socHistory.map(v => v.toFixed(2));
      powerChart.data.datasets[0].data = simData.powerHistory;
      efficiencyChart.data.labels = simData.socHistory.map(v => v.toFixed(2));
      efficiencyChart.data.datasets[0].data = simData.efficiencyHistory;

      powerChart.update('none');
      efficiencyChart.update('none');

      frame++;
      requestAnimationFrame(() => updateUI(step + 1));
    }

    updateUI(0);
  }

  calcBtn.addEventListener('click', runAndAnimate);

  // 初始主题色
  applyThemeByTemp(Number(tempInput.value));

})();
</script>

</body>
</html>
