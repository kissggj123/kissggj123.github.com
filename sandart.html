<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¨ Sand Studio V38 (Omniverse)</title>
    
    <!-- æ ¸å¿ƒåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.2/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
    
    <!-- æ ·å¼ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* é»˜è®¤æš—å¤œä¸»é¢˜ */
            --bg: #121212;
            --panel: rgba(30, 30, 30, 0.95);
            --accent: #00e5ff;
            --border: #444;
            --text: #eee;
            --text-dim: #888;
        }

        body { 
            margin: 0; overflow: hidden; 
            background-color: var(--bg); /* åŒæ­¥èƒŒæ™¯è‰² */
            font-family: 'Noto Sans SC', sans-serif; color: var(--text); 
            user-select: none; -webkit-user-select: none; 
            transition: background-color 0.3s, color 0.3s;
        }
        #stage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; cursor: crosshair; }
        
        /* é¢æ¿é€šç”¨ */
        .panel {
            position: fixed; background: var(--panel); border: 1px solid var(--border);
            border-radius: 8px; backdrop-filter: blur(12px); z-index: 100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); display: flex; flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .header {
            padding: 10px 15px; background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; cursor: move;
            font-size: 13px; font-weight: 700; color: var(--accent); letter-spacing: 1px;
        }

        .content { padding: 15px; overflow-y: auto; max-height: 80vh; scrollbar-width: thin; }
        
        /* å·¦ä¾§å·¥å…·æ  */
        #tools { top: 20px; left: 20px; width: 46px; align-items: center; padding-bottom: 10px; overflow: hidden; transition: height 0.3s; }
        #tools.collapsed .tool-btn:not(#btn-collapse) { display: none; }
        #tools.collapsed { height: 46px; padding-bottom: 0; }

        .tool-btn {
            width: 36px; height: 36px; margin-bottom: 6px; border-radius: 6px;
            background: transparent; border: 1px solid transparent; color: var(--text-dim);
            cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s;
            position: relative; font-size: 14px;
        }
        .tool-btn:hover { color: var(--text); background: rgba(255,255,255,0.1); }
        .tool-btn.active { color: #000; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .tool-btn:hover::after { 
            content: attr(data-tip); position: absolute; left: 115%; top: 50%; transform: translateY(-50%); 
            background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 4px 8px; 
            font-size: 11px; border-radius: 4px; pointer-events: none; opacity: 1; white-space: nowrap; z-index: 200; 
        }
        .tool-btn::after { opacity: 0; transition: 0.2s; }

        /* å³ä¾§è®¾ç½® */
        #settings { top: 20px; right: 20px; width: 290px; }
        .section { margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
        .sec-title { font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; font-weight: bold; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 8px; }
        label { font-size: 12px; color: var(--text-dim); white-space: nowrap; }
        
        input[type="range"] { flex: 1; height: 4px; background: var(--border); border-radius: 2px; appearance: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer; border: 2px solid var(--panel); }
        select { background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text); padding: 4px; border-radius: 4px; flex: 1; outline: none; }
        .val { font-size: 10px; width: 24px; text-align: right; color: var(--text-dim); font-family: monospace; }

        /* å›¾å±‚ */
        #layer-list { list-style: none; padding: 0; margin: 0; max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.1); border: 1px solid var(--border); border-radius: 4px; }
        .layer-li { padding: 8px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 12px; color: var(--text); }
        .layer-li.active { background: rgba(255,255,255,0.1); border-left: 3px solid var(--accent); }
        .layer-li:hover { background: rgba(255,255,255,0.05); }

        /* é€šç”¨ */
        .btn { width: 100%; padding: 8px; margin-top: 5px; background: var(--accent); color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-sec { background: rgba(255,255,255,0.1); color: var(--text); }
        .grid-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .grid-btn { height: 30px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 4px; color: var(--text-dim); cursor: pointer; transition:0.2s; }
        .grid-btn:hover { color: var(--text); border-color: var(--accent); }

        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--panel); width: 320px; padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.7); color: var(--text); }
        
        .pickr .pcr-button { width: 100% !important; height: 30px !important; border-radius: 4px; border: 1px solid var(--border); }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--panel); color: var(--accent); padding: 8px 20px; border-radius: 20px; font-size: 12px; border: 1px solid var(--accent); opacity: 0; transition: 0.3s; pointer-events: none; z-index: 3000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        #toast.show { opacity: 1; bottom: 40px; }
    </style>
</head>
<body>

    <div id="stage"></div>
    <div id="toast">é€šçŸ¥</div>

    <!-- å·¦ä¾§å·¥å…·æ  -->
    <div class="panel" id="tools">
        <div class="tool-btn" id="btn-collapse" data-tip="æŠ˜å "><i class="fas fa-chevron-left"></i></div>
        <button class="tool-btn active" data-tool="brush" data-tip="ç”»ç¬”"><i class="fas fa-paint-brush"></i></button>
        <button class="tool-btn" data-tool="eraser" data-tip="æ©¡çš®"><i class="fas fa-eraser"></i></button>
        <button class="tool-btn" data-tool="line" data-tip="ç›´çº¿"><i class="fas fa-slash"></i></button>
        <button class="tool-btn" data-tool="text" data-tip="æ–‡å­—"><i class="fas fa-font"></i></button>
        <button class="tool-btn" data-tool="stencil" data-tip="æ¨¡å…·"><i class="fas fa-shapes"></i></button>
        <button class="tool-btn" data-tool="eyedropper" data-tip="å¸ç®¡"><i class="fas fa-eye-dropper"></i></button>
        <button class="tool-btn" data-tool="move" data-tip="ç§»åŠ¨"><i class="fas fa-arrows-alt"></i></button>
        <div style="width:20px; height:1px; background:var(--border); margin:5px 0"></div>
        <button class="tool-btn" id="act-undo" data-tip="æ’¤é”€"><i class="fas fa-undo"></i></button>
        <button class="tool-btn" id="act-redo" data-tip="é‡åš"><i class="fas fa-redo"></i></button>
        <button class="tool-btn" id="act-save-temp" data-tip="ä¿å­˜"><i class="fas fa-save"></i></button>
        <button class="tool-btn" id="act-clear" data-tip="æ¸…ç©º" style="color:#ff4757"><i class="fas fa-trash"></i></button>
    </div>

    <!-- å³ä¾§è®¾ç½®é¢æ¿ -->
    <div class="panel" id="settings">
        <div class="header" id="drag-h">
            <span>SAND STUDIO V38</span>
            <div style="display:flex; gap:10px">
                <i class="fas fa-info-circle" id="btn-log" style="cursor:pointer; opacity:0.7" title="æ—¥å¿—"></i>
                <i class="fas fa-bars" style="opacity:0.5"></i>
            </div>
        </div>
        <div class="content">
            
            <!-- ä¸»é¢˜ä¸æ¨¡å¼ -->
            <div class="section">
                <div class="sec-title">ä¸»é¢˜ & æ¨¡å¼</div>
                <div class="row">
                    <label>UIä¸»é¢˜</label>
                    <select id="theme-select">
                        <option value="dark">ğŸŒ‘ æš—å¤œ (Dark)</option>
                        <option value="light">â˜€ï¸ æ˜äº® (Light)</option>
                        <option value="cyber">ğŸ¤– èµ›åš (Cyber)</option>
                        <option value="retro">ğŸ“œ å¤å¤ (Retro)</option>
                    </select>
                </div>
                <div id="pickr-container"></div>
                <button class="btn btn-sec" style="margin-top:10px; font-size:11px" id="btn-light-table"><i class="fas fa-lightbulb"></i> åˆ‡æ¢æ²™ç›˜/ç¯å…‰å°</button>
            </div>

            <!-- ç¬”åˆ·å¼•æ“ -->
            <div class="section">
                <div class="sec-title">ç¬”åˆ·å‚æ•°</div>
                <div class="row">
                    <label>ç±»å‹</label>
                    <select id="brush-type">
                        <option value="sand">ğŸœï¸ ç»†æ²™ (Sand)</option>
                        <option value="gravel">ğŸª¨ ç²—ç ¾ (Gravel)</option>
                        <option value="neon">âœ¨ éœ“è™¹ (Neon)</option>
                        <option value="fire">ğŸ”¥ ç«ç„° (Fire)</option>
                        <option value="ice">â„ï¸ å†°é›ª (Ice)</option>
                        <option value="rainbow">ğŸŒˆ å½©è™¹ (Rainbow)</option>
                        <option value="charcoal">âœï¸ æœ¨ç‚­ (Charcoal)</option>
                    </select>
                </div>
                <div class="row"><label>å°ºå¯¸</label><input type="range" id="p-size" min="2" max="150" value="20"><span class="val" id="v-size">20</span></div>
                <div class="row"><label>æµé‡</label><input type="range" id="p-flow" min="1" max="50" value="10"><span class="val" id="v-flow">10</span></div>
                <div class="row"><label>è½å·®</label><input type="range" id="p-height" min="0" max="150" value="50"><span class="val" id="v-height">50</span></div>
                
                <!-- é«˜çº§ç‰©ç† -->
                <div style="margin-top:8px; padding-top:8px; border-top:1px dashed var(--border)">
                    <div class="row"><label>æŠ–åŠ¨</label><input type="range" id="p-stab" min="0" max="20" value="5" title="å¹³æ»‘"><span class="val" id="v-stab">5</span></div>
                    <div class="row"><label>æ‚è‰²</label><input type="range" id="p-jitter" min="0" max="100" value="10"><span class="val" id="v-jitter">10</span></div>
                    <div class="row"><label>é‡åŠ›</label><input type="range" id="p-gravity" min="1" max="20" value="8"><span class="val" id="v-gravity">0.8</span></div>
                    <div class="row"><label>æ•£å¸ƒ</label><input type="range" id="p-scatter" min="0" max="50" value="0"><span class="val" id="v-scatter">0</span></div>
                </div>

                <div class="row" style="margin-top:8px"><label>æ¨¡å¼</label><select id="p-mode"><option value="physics">ç‰©ç†è½æ²™</option><option value="instant">é™æ€é€Ÿç»˜</option></select></div>
            </div>

            <!-- æ¨¡å…· (éšè—) -->
            <div class="section" id="stencil-sec" style="display:none">
                <div class="sec-title">æ¨¡å…·é®ç½©</div>
                <div class="grid-btns">
                    <button class="grid-btn" onclick="Stencil.set('circle')"><i class="far fa-circle"></i></button>
                    <button class="grid-btn" onclick="Stencil.set('square')"><i class="far fa-square"></i></button>
                    <button class="grid-btn" onclick="Stencil.set('star')"><i class="far fa-star"></i></button>
                    <button class="grid-btn" onclick="Stencil.set('heart')"><i class="far fa-heart"></i></button>
                </div>
                <div class="row" style="margin-top:8px"><label>ç¼©æ”¾</label><input type="range" id="s-scale" min="20" max="200" value="100"></div>
                <div class="row"><label>æ—‹è½¬</label><input type="range" id="s-rot" min="0" max="360" value="0"></div>
                <button class="btn btn-sec" style="margin-top:5px; color:#ff4757" onclick="Stencil.clear()">å…³é—­æ¨¡å…·</button>
            </div>

            <!-- å›¾å±‚ -->
            <div class="section">
                <div class="sec-title" style="display:flex; justify-content:space-between">
                    å›¾å±‚ <i class="fas fa-plus" style="cursor:pointer; color:var(--accent)" id="act-add-layer"></i>
                </div>
                <ul id="layer-list"></ul>
                <div style="display:flex; gap:5px; margin-top:10px">
                    <button class="btn btn-sec" style="flex:1; margin:0" id="act-save"><i class="fas fa-download"></i> å¯¼å‡º</button>
                    <button class="btn btn-sec" style="flex:1; margin:0" id="act-img"><i class="fas fa-image"></i> å›¾ç‰‡</button>
                </div>
                <input type="file" id="file-input" style="display:none" accept="image/*">
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå›¾ç‰‡ -->
    <div id="img-modal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--accent)">æ’å…¥å›¾ç‰‡</h3>
            <p style="font-size:12px; color:var(--text-dim); margin-bottom:15px;">è¯·é€‰æ‹©ç”¨é€”ï¼š</p>
            <button class="btn" id="img-bg-btn">è®¾ä¸ºèƒŒæ™¯ (æ›¿æ¢åº•å›¾)</button>
            <button class="btn btn-sec" id="img-layer-btn" style="margin-top:8px">ä½œä¸ºå›¾å±‚æ’å…¥</button>
            <button class="btn btn-sec" style="margin-top:15px" onclick="document.getElementById('img-modal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šæ–‡æœ¬ -->
    <div id="text-modal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--accent)">æ·»åŠ æ–‡å­—</h3>
            <input type="text" id="tm-input" placeholder="è¾“å…¥æ–‡å­—..." style="width:92%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:var(--text); margin-bottom:10px; border-radius:4px;">
            <div class="row"><label>å¤§å°</label><input type="number" id="tm-size" value="80" style="width:60px"></div>
            <div class="row"><label>å­—ä½“</label><select id="tm-font" style="flex:1"><option value="ZCOOL KuaiLe">å¿«ä¹ä½“</option><option value="Noto Sans SC">é»‘ä½“</option></select></div>
            <div style="display:flex; gap:10px; margin-top:15px">
                <button class="btn btn-sec" onclick="document.getElementById('text-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn" id="tm-confirm">ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šæ—¥å¿— -->
    <div id="changelog-modal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--accent); margin-top:0;">ğŸš€ V38.0 å…¨ç»´ç‰ˆ</h3>
            <ul style="font-size:12px; color:var(--text-dim); padding-left:20px; line-height:1.6">
                <li><strong>ğŸ¨ ä¸»é¢˜å›å½’ï¼š</strong>æš—å¤œã€æ˜äº®ã€èµ›åšã€å¤å¤ä¸»é¢˜åˆ‡æ¢ã€‚</li>
                <li><strong>ğŸ–Œï¸ ç¬”åˆ·å…¨å®¶æ¡¶ï¼š</strong>ç»†æ²™/ç²—ç ¾/éœ“è™¹/ç«ç„°/å†°é›ª/å½©è™¹/æœ¨ç‚­ã€‚</li>
                <li><strong>ğŸ–¼ï¸ é«˜çº§å›¾å±‚ï¼š</strong>æ”¯æŒæ’å…¥å›¾ç‰‡ä¸ºèƒŒæ™¯æˆ–ç‹¬ç«‹å›¾å±‚ã€‚</li>
                <li><strong>âš™ï¸ ç‰©ç†å‚æ•°ï¼š</strong>é‡åŠ›ã€æ‚è‰²ã€æ•£å¸ƒã€é«˜åº¦å…¨é¢å¯æ§ã€‚</li>
                <li><strong>ğŸš« ä¿®å¤ï¼š</strong>æ©¡çš®æ“¦ã€æ¨¡å…·åæ ‡ã€æ’¤é”€åŠŸèƒ½å·²å®Œç¾ã€‚</li>
            </ul>
            <button class="btn" onclick="document.getElementById('changelog-modal').style.display='none'">å¼€å§‹åˆ›ä½œ</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. é…ç½®ä¸ä¸»é¢˜æ•°æ®
        // ==========================================
        const Config = { width: 3000, height: 2000, maxParticles: 40000 };
        const Themes = {
            dark: { bg:'#121212', panel:'rgba(30,30,30,0.95)', accent:'#00e5ff', text:'#eee', border:'#444', canvas:0x121212 },
            light: { bg:'#e0e0e0', panel:'rgba(255,255,255,0.95)', accent:'#ff9800', text:'#333', border:'#ccc', canvas:0xe0e0e0 },
            cyber: { bg:'#0a0a12', panel:'rgba(10,10,30,0.92)', accent:'#ff00ff', text:'#0ff', border:'#00aaaa', canvas:0x0a0a12 },
            retro: { bg:'#3e2723', panel:'rgba(62,39,35,0.95)', accent:'#ffccbc', text:'#d7ccc8', border:'#5d4037', canvas:0x3e2723 }
        };

        const State = {
            tool: 'brush', color: '#00e5ff', colorInt: 0x00e5ff,
            brush: { size: 20, flow: 10, height: 50, stab: 5, mode: 'physics', jitter: 10, gravity: 8, scatter: 0 },
            brushType: 'sand',
            stencil: { active: false, type: null, scale: 1, rot: 0 },
            layers: [], activeLayer: null, history: [], historyPtr: -1,
            isLightTable: false, currentTheme: 'dark', tempImgData: null
        };

        // ==========================================
        // 2. Pixi åˆå§‹åŒ–
        // ==========================================
        const app = new PIXI.Application({
            resizeTo: window, backgroundColor: Themes.dark.canvas,
            antialias: false, resolution: window.devicePixelRatio || 1,
            preserveDrawingBuffer: true, autoDensity: true
        });
        document.getElementById('stage').appendChild(app.view);

        const viewport = new PIXI.Container();
        app.stage.addChild(viewport);
        viewport.position.set(window.innerWidth/2, window.innerHeight/2);

        const bgSprite = new PIXI.Sprite(PIXI.Texture.WHITE);
        bgSprite.width = Config.width; bgSprite.height = Config.height;
        bgSprite.anchor.set(0.5); bgSprite.tint = Themes.dark.canvas;
        bgSprite.filters = [new PIXI.filters.NoiseFilter(0.1)];
        viewport.addChild(bgSprite);

        const layerContainer = new PIXI.Container();
        layerContainer.position.set(-Config.width/2, -Config.height/2);
        viewport.addChild(layerContainer);

        const previewLayer = new PIXI.Container();
        viewport.addChild(previewLayer);

        const particleContainer = new PIXI.ParticleContainer(Config.maxParticles, {
            position:true, scale:true, alpha:true, tint:true
        });
        particleContainer.position.set(-Config.width/2, -Config.height/2);
        viewport.addChild(particleContainer);

        const pixelTex = app.renderer.generateTexture(new PIXI.Graphics().beginFill(0xffffff).drawCircle(0,0,2).endFill());

        // ==========================================
        // 3. æ ¸å¿ƒç³»ç»Ÿ (Baker, Physics, Theme)
        // ==========================================
        
        // ä¸»é¢˜åˆ‡æ¢
        function applyTheme(key) {
            const t = Themes[key];
            const s = document.documentElement.style;
            s.setProperty('--bg', t.bg); s.setProperty('--panel', t.panel);
            s.setProperty('--accent', t.accent); s.setProperty('--text', t.text); s.setProperty('--border', t.border);
            document.body.style.backgroundColor = t.bg;
            app.renderer.background.color = t.canvas;
            if(!State.isLightTable) bgSprite.tint = t.canvas;
        }

        // çƒ˜ç„™
        const Baker = {
            q: [], eq: [],
            add(x, y, c, s, b) {
                if (State.stencil.active && !Stencil.contains(x,y)) return;
                if (State.tool === 'eraser') this.eq.push({x, y, s});
                else this.q.push({x, y, c, s, b});
            },
            flush() {
                const l = State.activeLayer;
                if (!l) { this.q=[]; this.eq=[]; return; }
                // Eraser Fix: Set BlendMode on Graphics directly
                if (this.eq.length) {
                    const g = new PIXI.Graphics();
                    g.blendMode = PIXI.BLEND_MODES.ERASE;
                    this.eq.forEach(p => { g.beginFill(0xffffff); g.drawCircle(p.x, p.y, State.brush.size*0.6); g.endFill(); });
                    app.renderer.render(g, {renderTexture: l.tex, clear: false});
                    this.eq = [];
                }
                if (this.q.length) {
                    const c = new PIXI.Container();
                    const lim = Math.min(this.q.length, 2000);
                    for (let i=0; i<lim; i++) {
                        const d = this.q[i];
                        const s = new PIXI.Sprite(pixelTex);
                        s.width = s.height = 4; s.anchor.set(0.5);
                        s.position.set(d.x, d.y); s.tint = d.c; s.scale.set(d.s * 0.6); s.blendMode = d.b;
                        c.addChild(s);
                    }
                    this.q.splice(0, lim);
                    app.renderer.render(c, {renderTexture: l.tex, clear: false});
                    c.destroy({children:true});
                }
            }
        };

        // è¾…åŠ©
        function hexToHsl(hex){let r=(hex>>16)&255,g=(hex>>8)&255,b=hex&255;r/=255;g/=255;b/=255;let max=Math.max(r,g,b),min=Math.min(r,g,b),h,s,l=(max+min)/2;if(max==min)h=s=0;else{let d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return{h,s,l}}
        function hslToHex(h,s,l){let r,g,b;if(s==0)r=g=b=l;else{const q=l<0.5?l*(1+s):l+s-l*s;const p=2*l-q;const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3)}return((r*255)<<16)+((g*255)<<8)+(b*255)}

        // ç‰©ç†å¼•æ“
        const Physics = {
            active: [], pool: [],
            spawn(x, y) {
                const p = this.pool.pop() || new PIXI.Sprite(pixelTex);
                p.width = p.height = 4; p.anchor.set(0.5);
                
                const h = State.brush.height;
                const type = State.brushType;
                const spread = h * (type==='ice'?0.4:0.2);
                const scatter = State.brush.scatter * 2;
                
                p.tx = x + (Math.random()-0.5)*scatter; 
                p.ty = y + (Math.random()-0.5)*scatter;
                p.x = p.tx + (Math.random()-0.5)*spread;
                p.y = p.ty + (Math.random()-0.5)*spread;
                p.z = h + Math.random() * 20;
                p.vz = 0;
                
                // é¢œè‰² & æ··åˆ
                if (type === 'rainbow') p.tint = hslToHex((Date.now()%2000)/2000, 1, 0.5);
                else if (State.brush.jitter > 0) {
                    const hsl = hexToHsl(State.colorInt);
                    const jit = State.brush.jitter/200;
                    if (type==='fire') { hsl.h=0.05+(Math.random()-0.5)*0.1; hsl.s=1; hsl.l=0.5+Math.random()*0.4; }
                    else hsl.l = Math.max(0, Math.min(1, hsl.l + (Math.random()-0.5)*jit));
                    p.tint = hslToHex(hsl.h, hsl.s, hsl.l);
                } else p.tint = State.colorInt;

                if (type==='neon'||type==='fire'||type==='ice') p.blendMode = PIXI.BLEND_MODES.ADD;
                else if (type==='charcoal') p.blendMode = PIXI.BLEND_MODES.MULTIPLY;
                else p.blendMode = PIXI.BLEND_MODES.NORMAL;

                // ç‰©ç†ä¿®æ­£
                let g = State.brush.gravity * 0.1; 
                if (type==='fire') g *= 0.2; if (type==='ice') g *= 0.5; if (type==='gravel') g *= 1.5;

                const t = Math.sqrt(2*p.z/g);
                p.vx = (p.tx - p.x)/t; p.vy = (p.ty - p.y)/t; p.grav = g; p.alpha = 0.6;
                
                particleContainer.addChild(p);
                this.active.push(p);
            },
            update() {
                for (let i=this.active.length-1; i>=0; i--) {
                    const p = this.active[i];
                    p.vz += p.grav; p.z -= p.vz;
                    p.x += p.vx; p.y += p.vy;
                    p.scale.set(Math.max(0.5, 1 + p.z*0.01));
                    if (p.z <= 0) {
                        Baker.add(p.tx, p.ty, p.tint, p.scale.x, p.blendMode);
                        this.kill(i);
                    }
                }
            },
            kill(i) {
                const p = this.active[i];
                this.active.splice(i, 1);
                particleContainer.removeChild(p);
                this.pool.push(p);
            }
        };

        // æ¨¡å…·
        const Stencil = {
            guide: new PIXI.Graphics(),
            init() { previewLayer.addChild(this.guide); this.guide.visible=false; },
            set(t) { State.stencil.active=true; State.stencil.type=t; document.getElementById('stencil-sec').style.display='block'; this.draw(); },
            clear() { State.stencil.active=false; this.guide.visible=false; document.getElementById('stencil-sec').style.display='none'; },
            draw() {
                const g=this.guide; g.clear(); g.lineStyle(2, 0xffffff, 0.5); g.beginFill(0x000000, 0.3);
                const s=200*(State.stencil.scale/100); g.rotation=State.stencil.rot*Math.PI/180;
                if(State.stencil.type==='circle')g.drawCircle(0,0,s);
                else if(State.stencil.type==='square')g.drawRect(-s,-s,s*2,s*2);
                else if(State.stencil.type==='star')this.drawStar(g,0,0,5,s,s/2);
                else if(State.stencil.type==='heart')this.drawHeart(g,0,0,s);
                g.endFill(); g.visible=true;
            },
            drawStar(g,x,y,p,o,i){g.moveTo(0,-o);for(let j=0;j<2*p;j++){const r=(j%2===0)?o:i;const a=(Math.PI/p)*j-Math.PI/2;g.lineTo(x+Math.cos(a)*r,y+Math.sin(a)*r)}g.closePath()},
            drawHeart(g,x,y,s){g.moveTo(x,y-s/2);g.bezierCurveTo(x+s/2,y-s,x+s,y,x,y+s);g.bezierCurveTo(x-s,y,x-s/2,y-s,x,y-s/2)},
            contains(x,y){ return this.guide.geometry.containsPoint(this.guide.toLocal(layerContainer.toGlobal({x,y}))); }
        };

        // å·¥å…·
        const Tools = {
            lineStart: null, linePreview: new PIXI.Graphics(),
            init() { previewLayer.addChild(this.linePreview); },
            onDown(x,y) { if(State.tool==='line') this.lineStart={x,y}; },
            onMove(x,y) {
                if(State.tool==='line'&&this.lineStart) {
                    const p1 = previewLayer.toLocal(layerContainer.toGlobal(this.lineStart));
                    const p2 = previewLayer.toLocal(layerContainer.toGlobal({x,y}));
                    this.linePreview.clear().lineStyle(2, State.colorInt).moveTo(p1.x,p1.y).lineTo(p2.x,p2.y);
                }
            },
            onUp(x,y) {
                if(State.tool==='line'&&this.lineStart) {
                    History.push(); this.linePreview.clear();
                    const d=Math.hypot(x-this.lineStart.x, y-this.lineStart.y); const s=Math.ceil(d/2);
                    for(let i=0;i<s;i++) {
                        const t=i/s; processStroke(this.lineStart.x+(x-this.lineStart.x)*t, this.lineStart.y+(y-this.lineStart.y)*t, i===0);
                    }
                    this.lineStart=null;
                }
            },
            createText(txt, size, font) {
                History.push();
                const t = new PIXI.Text(txt, { fontFamily: font, fontSize: parseInt(size), fill: State.colorInt });
                t.anchor.set(0.5); t.position.set(Config.width/2, Config.height/2);
                if(State.activeLayer) app.renderer.render(t, {renderTexture:State.activeLayer.tex, clear:false});
            }
        };

        const LayerManager = {
            add(name) {
                const tex = PIXI.RenderTexture.create({width:Config.width, height:Config.height});
                const spr = new PIXI.Sprite(tex);
                const l = {id:Date.now(), name, tex, spr, vis:true};
                State.layers.push(l);
                layerContainer.addChild(spr);
                this.setActive(l);
                return l;
            },
            setActive(l) { State.activeLayer=l; renderUI(); },
            clearActive(ph=true) {
                if(State.activeLayer) {
                    if(ph) History.push();
                    app.renderer.render(new PIXI.Graphics().beginFill(0,0).drawRect(0,0,Config.width,Config.height), {renderTexture:State.activeLayer.tex, clear:true});
                }
            }
        };

        const History = {
            s:[], ptr:-1,
            push() {
                const l = State.activeLayer; if(!l) return;
                if(this.ptr < this.s.length-1) this.s = this.s.slice(0, this.ptr+1);
                this.s.push({id:l.id, d:app.renderer.extract.canvas(l.tex).toDataURL()});
                if(this.s.length>15) this.s.shift(); else this.ptr++;
            },
            undo() { if(this.ptr<0) return; this.ptr--; this.restore(this.s[this.ptr]); },
            redo() { if(this.ptr>=this.s.length-1) return; this.ptr++; this.restore(this.s[this.ptr]); },
            restore(snap) {
                if(!snap) return;
                const l = State.layers.find(x=>x.id===snap.id);
                if(l) {
                    const i=new Image(); i.src=snap.d;
                    i.onload=()=>{
                        app.renderer.render(new PIXI.Graphics().beginFill(0,0).drawRect(0,0,Config.width,Config.height), {renderTexture:l.tex, clear:true});
                        app.renderer.render(new PIXI.Sprite(PIXI.Texture.from(i)), {renderTexture:l.tex});
                    }
                }
            }
        };

        // DB AutoSave
        const DB={db:null,init(){return new Promise(r=>{const q=indexedDB.open('SandV38',1);q.onupgradeneeded=e=>{if(!e.target.result.objectStoreNames.contains('s'))e.target.result.createObjectStore('s')};q.onsuccess=e=>{this.db=e.target.result;r()}})},save(k,d){if(this.db)this.db.transaction('s','readwrite').objectStore('s').put(d,k)},load(k){return new Promise(r=>{if(!this.db)r(null);else{const q=this.db.transaction('s','readonly').objectStore('s').get(k);q.onsuccess=()=>r(q.result);q.onerror=()=>r(null)}})},async auto(){if(State.layers.length){const d={bg:bgSprite.tint,ls:State.layers.map(l=>({n:l.name,v:l.vis,i:app.renderer.extract.canvas(l.tex).toDataURL()}))};await this.save('auto',d);UI.toast("å·²è‡ªåŠ¨ä¿å­˜")}}};
        setInterval(()=>DB.auto(),60000);

        // äº¤äº’
        function getLocalPos(e) { return layerContainer.toLocal({x:e.clientX, y:e.clientY}); }
        let pts=[], lastPos=null;
        function processStroke(x,y,start) {
            if(start) { pts=[]; lastPos={x,y}; History.push(); }
            pts.push({x,y}); if(pts.length>State.brush.stab) pts.shift();
            let ax=0, ay=0; pts.forEach(p=>{ax+=p.x;ay+=p.y}); ax/=pts.length; ay/=pts.length;
            if(start) { lastPos={x:ax,y:ay}; return; }
            const d=Math.hypot(ax-lastPos.x, ay-lastPos.y), step=Math.max(1, State.brush.size/3), steps=Math.ceil(d/step);
            for(let i=0; i<steps; i++) {
                const t=i/steps, ix=lastPos.x+(ax-lastPos.x)*t, iy=lastPos.y+(ay-lastPos.y)*t;
                if(State.tool==='eraser') { Baker.add(ix, iy, 0, 1); continue; }
                const count=State.brush.flow, r=State.brush.size/2;
                for(let j=0; j<count; j++) {
                    const ang=Math.random()*Math.PI*2, rad=Math.sqrt(Math.random())*r;
                    const px=ix+Math.cos(ang)*rad, py=iy+Math.sin(ang)*rad;
                    if(State.brush.mode==='physics') Physics.spawn(px,py);
                    else {
                        let tint=State.colorInt, blend=PIXI.BLEND_MODES.NORMAL;
                        if(State.brushType==='fire'||State.brushType==='neon')blend=PIXI.BLEND_MODES.ADD;
                        if(State.brushType==='charcoal')blend=PIXI.BLEND_MODES.MULTIPLY;
                        Baker.add(px, py, tint, 1, blend);
                    }
                }
            }
            lastPos={x:ax,y:ay};
        }

        const pickr = Pickr.create({ el: '#pickr-container', theme: 'nano', default: State.color, components: { preview: true, opacity: true, hue: true, interaction: { input: true, save: true } } });
        pickr.on('save', (c,i) => { State.color = c.toHEXA().toString(); State.colorInt = parseInt(State.color.replace('#','0x')); i.hide(); });

        function renderUI() {
            const ul=document.getElementById('layer-list'); ul.innerHTML='';
            [...State.layers].reverse().forEach(l => {
                const li=document.createElement('li'); li.className=`layer-li ${l===State.activeLayer?'active':''}`;
                li.innerHTML=`<span>${l.name}</span><i class="fas fa-eye" style="opacity:${l.vis?1:0.5}"></i>`;
                li.onclick=()=>LayerManager.setActive(l);
                li.querySelector('i').onclick=(e)=>{e.stopPropagation(); l.vis=!l.vis; l.spr.visible=l.vis; renderUI();};
                ul.appendChild(li);
            });
        }

        // Events
        let isDrag=false, dragOff={x:0,y:0};
        window.addEventListener('pointerdown', e => {
            if(e.target!==app.view) return;
            if(e.button===1 || State.tool==='move' || e.ctrlKey) { isDrag=true; dragOff={x:e.clientX-viewport.x, y:e.clientY-viewport.y}; document.body.style.cursor='grabbing'; }
            else if(State.tool==='eyedropper') {
                const p=app.renderer.plugins.extract.pixels(viewport,new PIXI.Rectangle(e.clientX,e.clientY,1,1));
                const hex="#"+((1<<24)+(p[0]<<16)+(p[1]<<8)+p[2]).toString(16).slice(1);
                pickr.setColor(hex); State.tool='brush'; UI.updateTools();
            } else if(State.tool==='line') { Tools.onDown(getLocalPos(e).x, getLocalPos(e).y); }
            else { State.isDrawing=true; processStroke(getLocalPos(e).x, getLocalPos(e).y, true); }
        });
        window.addEventListener('pointermove', e => {
            if(isDrag) { viewport.x=e.clientX-dragOff.x; viewport.y=e.clientY-dragOff.y; }
            else if(State.tool==='line') Tools.onMove(getLocalPos(e).x, getLocalPos(e).y);
            else if(State.isDrawing) processStroke(getLocalPos(e).x, getLocalPos(e).y, false);
        });
        window.addEventListener('pointerup', e => {
            isDrag=false; State.isDrawing=false; document.body.style.cursor='default';
            if(State.tool==='line') Tools.onUp(getLocalPos(e).x, getLocalPos(e).y);
        });
        window.addEventListener('wheel', e => { if(e.target===app.view){e.preventDefault(); const s=viewport.scale.x*(e.deltaY>0?0.9:1.1); viewport.scale.set(Math.max(0.1, Math.min(5,s)));} }, {passive:false});
        
        // UI Bindings
        const UI = {
            updateTools(){ document.querySelectorAll('.tool-btn').forEach(b=>b.classList.toggle('active', b.dataset.tool===State.tool)); },
            toast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
        };

        document.querySelectorAll('.tool-btn').forEach(b=>{
            b.onclick=()=>{ if(b.dataset.tool==='text')document.getElementById('text-modal').style.display='flex'; else if(b.dataset.tool){State.tool=b.dataset.tool; UI.updateTools(); if(State.tool!=='stencil')Stencil.clear(); }};
        });
        
        const bind=(id,k,v)=>document.getElementById(id).oninput=e=>{State.brush[k]=parseFloat(e.target.value);if(v)document.getElementById(v).innerText=e.target.value; if(id.includes('s-'))Stencil.draw();};
        bind('p-size','size','v-size'); bind('p-flow','flow'); bind('p-height','height'); bind('p-stab','stab'); 
        bind('p-jitter','jitter'); bind('p-gravity','gravity'); bind('p-scatter','scatter'); bind('s-scale','scale'); bind('s-rot','rot');
        
        document.getElementById('p-mode').onchange=e=>State.brush.mode=e.target.value;
        document.getElementById('brush-type').onchange=e=>State.brushType=e.target.value;
        document.getElementById('theme-select').onchange=e=>applyTheme(e.target.value);
        document.getElementById('btn-collapse').onclick=()=>{document.getElementById('tools').classList.toggle('collapsed');};
        document.getElementById('act-add-layer').onclick=()=>LayerManager.add(`å›¾å±‚ ${State.layers.length+1}`);
        document.getElementById('act-undo').onclick=()=>History.undo();
        document.getElementById('act-redo').onclick=()=>History.redo();
        document.getElementById('act-clear').onclick=()=>LayerManager.clearActive();
        document.getElementById('act-save-temp').onclick=()=>DB.auto();
        document.getElementById('act-save').onclick=()=>app.renderer.extract.canvas(viewport).toBlob(b=>{const a=document.createElement('a');a.download='sand.png';a.href=URL.createObjectURL(b);a.click()});
        document.getElementById('tm-confirm').onclick=()=>{const v=document.getElementById('tm-input').value;if(v)Tools.createText(v,document.getElementById('tm-size').value,document.getElementById('tm-font').value);document.getElementById('text-modal').style.display='none'};
        
        document.getElementById('btn-light-table').onclick=()=>{
            State.isLightTable=!State.isLightTable;
            bgSprite.tint=State.isLightTable?0xffffff:Themes[State.currentTheme].canvas;
            State.colorInt=State.isLightTable?0x111111:0x00e5ff;
            pickr.setColor(State.isLightTable?'#111111':'#00e5ff');
        };

        document.getElementById('act-img').onclick=()=>document.getElementById('file-input').click();
        document.getElementById('file-input').onchange=e=>{
            if(e.target.files[0]){
                const r=new FileReader();
                r.onload=v=>{ State.tempImgData=v.target.result; document.getElementById('img-modal').style.display='flex'; };
                r.readAsDataURL(e.target.files[0]);
            }
        };
        document.getElementById('img-bg-btn').onclick=()=>{
            const img=new Image(); img.src=State.tempImgData;
            img.onload=()=>{ 
                const tex=PIXI.Texture.from(img); bgSprite.texture=tex; bgSprite.tint=0xffffff; 
                const ratio = Math.max(Config.width/tex.width, Config.height/tex.height);
                bgSprite.scale.set(ratio);
            };
            document.getElementById('img-modal').style.display='none';
        };
        document.getElementById('img-layer-btn').onclick=()=>{
            const l=LayerManager.add("å›¾ç‰‡å±‚");
            const img=new Image(); img.src=State.tempImgData;
            img.onload=()=>{
                const s=new PIXI.Sprite(PIXI.Texture.from(img));
                const scale=Math.min(Config.width/s.width, Config.height/s.height)*0.8;
                s.scale.set(scale); s.anchor.set(0.5); s.position.set(Config.width/2, Config.height/2);
                app.renderer.render(s, {renderTexture:l.tex});
            };
            document.getElementById('img-modal').style.display='none';
        };
        document.getElementById('btn-log').onclick=()=>document.getElementById('changelog-modal').style.display='flex';

        const h=document.getElementById('drag-h'), p=document.getElementById('settings');
        let d=false,o={x:0,y:0};
        h.onmousedown=e=>{d=true;o={x:e.clientX-p.offsetLeft,y:e.clientY-p.offsetTop}};
        window.onmousemove=e=>{if(d){p.style.left=(e.clientX-o.x)+'px';p.style.top=(e.clientY-o.y)+'px'}};
        window.onmouseup=()=>d=false;

        // Boot
        Stencil.init(); Tools.init(); LayerManager.add('å›¾å±‚ 1'); DB.init().then(async()=>{const d=await DB.load('auto');if(d&&confirm('æ¢å¤å­˜æ¡£?')){bgSprite.tint=d.bg;State.layers=[];for(const ld of d.ls){const l=LayerManager.add(ld.n);l.vis=ld.v;l.spr.visible=ld.v;const i=new Image();i.src=ld.i;await new Promise(r=>i.onload=r);app.renderer.render(new PIXI.Sprite(PIXI.Texture.from(i)),{renderTexture:l.tex})}}});
        app.ticker.add(()=>{Physics.update(); Baker.flush();});
        document.getElementById('changelog-modal').style.display = 'flex';

    </script>
</body>
</html>
