<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ å°é¹P7+ å……ç”µè®¡ç®—å™¨ v4.2.6 - ğŸŒŒ è¶…ç¶­æ˜Ÿç©¹å…” (Hyperdimensional Stellar Rabbit)</title>
    <!-- PWA: Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization - Loaded at the end of body for performance -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- VT323 for pixel font aesthetic. Chinese fallback is monospace. -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* Base styles using VT323 pixel font */
        body {
            font-family: 'VT323', monospace; /* Apply pixel font globally */
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.5s ease, color 0.3s ease;
        }
        input, select, button, pre, textarea { /* Apply to all form elements and pre-formatted text */
            font-family: 'VT323', monospace;
            color: var(--text-color);
        }

        /* CSS Variables for theming (Default: Night Mode) */
        :root {
            --bg-color: linear-gradient(180deg, #0a0a0a 0%, #000005 100%);
            --text-color: #00eaff;
            --title-color: #00eaff;
            --label-color: #33ffff;
            --input-bg: rgba(0, 0, 10, 0.7);
            --input-border: #00eaff;
            --panel-bg: rgba(0, 0, 15, 0.8);
            --panel-border: #00eaff;
            --button-primary-bg: linear-gradient(45deg, #00bfff 0%, #0077ff 100%);
            --button-primary-hover-bg: linear-gradient(45deg, #00aadd 0%, #0066ee 100%);
            --button-primary-border: #00eaff;
            --button-secondary-bg: linear-gradient(45deg, #ff9900 0%, #ff6600 100%);
            --button-secondary-hover-bg: linear-gradient(45deg, #ee8800 0%, #ee5500 100%);
            --button-secondary-border: #ff9900;
            --button-success-bg: linear-gradient(45deg, #00ee00 0%, #00bb00 100%);
            --button-success-hover-bg: linear-gradient(45deg, #00dd00 0%, #00aa00 100%);
            --button-success-border: #00ee00;
            --button-info-bg: linear-gradient(45deg, #666666 0%, #333333 100%);
            --button-info-hover-bg: linear-gradient(45deg, #555555 0%, #222222 100%);
            --button-info-border: #888888;
            --button-accent-bg: linear-gradient(45deg, #ff00ff 0%, #cc00cc 100%);
            --button-accent-hover-bg: linear-gradient(45deg, #ee00ee 0%, #bb00bb 100%);
            --button-accent-border: #ff00ff;
            --changelog-modal-bg: rgba(0, 0, 20, 0.9);
            --changelog-text-color: #ccffff;
            --changelog-border-color: #00eaff;
            --changelog-h-color: #00eaff;
            --changelog-h-border: #33ffff;
            --progress-bg: #00eaff;
            --progress-text: #0a0a0a;
            --cooling-color: #ff00ff;
            --gemini-button-bg: linear-gradient(45deg, #6200ea 0%, #aa00ff 100%);
            --gemini-button-hover-bg': linear-gradient(45deg, #5000cc 0%, #8800cc 100%)',
            --gemini-button-border: #bb00ff;
            --pixel-rabbit-icon-fill: currentColor; /* Inherit color from text-color */
            --pixel-rabbit-shadow-color: rgba(255, 255, 255, 0.8);
        }

        body.day-mode {
            --bg-color: linear-gradient(135deg, #e0faff 0%, #fffde7 50%, #e3f2fd 100%);
            --text-color: #5e35b1;
            --title-color: #ff4081;
            --label-color: #64dd17;
            --input-bg: rgba(255, 255, 255, 0.95);
            --input-border: #ff4081;
            --panel-bg: rgba(255, 255, 255, 0.9);
            --panel-border: #ff4081;
            --button-primary-bg: linear-gradient(45deg, #ff80ab 0%, #82b1ff 100%);
            --button-primary-hover-bg: linear-gradient(45deg, #ff6090 0%, #6090ff 100%);
            --button-primary-border: #82b1ff;
            --button-secondary-bg: linear-gradient(45deg, #ffd740 0%, #ff8a80 100%);
            --button-secondary-hover-bg: linear-gradient(45deg, #ffcc30 0%, #ff7070 100%);
            --button-secondary-border: #ff8a80;
            --button-success-bg: linear-gradient(45deg, #69f0ae 0%, #18ffff 100%);
            --button-success-hover-bg: linear-gradient(45deg, #50e090 0%, #00e0e0 100%);
            --button-success-border: #18ffff;
            --button-info-bg: linear-gradient(45deg, #b388ff 0%, #8c9eff 100%);
            --button-info-hover-bg: linear-gradient(45deg, #a070e0 0%, #7080ff 100%);
            --button-info-border: #8c9eff;
            --button-accent-bg: linear-gradient(45deg, #ff1744 0%, #f50057 100%);
            --button-accent-hover-bg: linear-gradient(45deg, #e00030 0%, #d00040 100%);
            --button-accent-border: #f50057;
            --changelog-modal-bg: rgba(255, 255, 255, 0.98);
            --changelog-text-color: #333333;
            --changelog-border-color: var(--button-secondary-border);
            --changelog-h-color: var(--title-color);
            --changelog-h-border: var(--label-color);
            --progress-bg: var(--title-color);
            --progress-text: #ffffff;
            --cooling-color: #00bcd4;
            --gemini-button-bg: linear-gradient(45deg, #6200ea 0%, #aa00ff 100%);
            --gemini-button-hover-bg': linear-gradient(45deg, #5000cc 0%, #8800cc 100%)',
            --gemini-button-border: #bb00ff;
            --pixel-rabbit-shadow-color: rgba(0, 0, 0, 0.6);
        }

        /* Apply CSS variables */
        .title-color { 
            color: var(--title-color); 
            text-shadow: 0 0 10px var(--title-color), 0 0 20px rgba(255,255,255,0.5); /* Neon glow effect */
            transition: text-shadow 0.3s ease;
        }
        .label-color { color: var(--label-color); }
        .input-bg { background-color: var(--input-bg); }
        .input-border { border-color: var(--input-border); }
        .panel-bg { 
            background-color: var(--panel-bg); 
            border-color: var(--panel-border);
            box-shadow: 0 0 15px var(--panel-border), inset 0 0 8px rgba(255,255,255,0.1); /* Subtle glow + inner shadow */
            transition: box-shadow 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            position: relative; /* Ensure z-index works correctly for content */
            overflow: hidden; /* Hide anything going beyond panel bounds */
        }
        body.day-mode .panel-bg {
            box-shadow: 0 0 15px var(--panel-border), inset 0 0 8px rgba(0,0,0,0.1);
        }

        /* Randomly moving pixel rabbit */
        #wandering-rabbit {
            position: fixed;
            width: 72px; /* Slightly larger for "bolder" look */
            height: 72px; /* Maintain aspect ratio */
            z-index: 100;
            pointer-events: none;
            transition: left 1s ease-in-out, top 1s ease-in-out;
            fill: var(--pixel-rabbit-icon-fill); /* Use CSS variable for fill */
            filter: drop-shadow(0 0 15px var(--pixel-rabbit-shadow-color)); /* Enhanced shadow for "bolder" look */
        }

        /* Rabbit Droppings (Chocolate Beans) */
        .rabbit-dropping {
            position: absolute;
            width: 6px; /* Pixelated size */
            height: 6px;
            background-color: #4a2c2a; /* Chocolate brown */
            border-radius: 1px; /* Slightly rounded pixel look */
            transform: scale(1);
            opacity: 1;
            transition: transform 2s ease-out, opacity 2s ease-out; /* Fade and shrink over 2 seconds */
            z-index: 99; /* Below rabbit, above background */
            pointer-events: none; /* Don't interfere with clicks */
            box-shadow: 0 0 2px rgba(0,0,0,0.5); /* Small shadow */
        }

        .rabbit-dropping.fade-out {
            transform: scale(0.2);
            opacity: 0;
        }

        /* Button styling using CSS variables */
        .btn-primary, .btn-secondary, .btn-success, .btn-info, .btn-accent, .btn-gemini {
            background: var(--button-primary-bg);
            border-bottom: 4px solid var(--button-primary-border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,0.2);
            transition: all 0.2s ease;
            color: white; /* Ensure text is always white on gradient buttons */
        }
        .btn-primary:hover, .btn-secondary:hover, .btn-success:hover, .btn-info:hover, .btn-accent:hover, .btn-gemini:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4), inset 0 2px 8px rgba(255,255,255,0.3);
        }
        .btn-primary:active, .btn-secondary:active, .btn-success:active, .btn-info:active, .btn-accent:active, .btn-gemini:active {
            transform: translateY(2px);
            border-bottom-width: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4), inset 0 1px 3px rgba(255,255,255,0.1);
        }

        /* Specific button background overrides (these will be set by JS dynamically) */
        /* They are here as fallbacks or for initial render */
        .btn-primary { background: var(--button-primary-bg); border-bottom-color: var(--button-primary-border); }
        .btn-primary:hover { background: var(--button-primary-hover-bg); }
        .btn-secondary { background: var(--button-secondary-bg); border-bottom-color: var(--button-secondary-border); }
        .btn-secondary:hover { background: var(--button-secondary-hover-bg); }
        .btn-success { background: var(--button-success-bg); border-bottom-color: var(--button-success-border); }
        .btn-success:hover { background: var(--button-success-hover-bg); }
        .btn-info { background: var(--button-info-bg); border-bottom-color: var(--button-info-border); }
        .btn-info:hover { background: var(--button-info-hover-bg); }
        .btn-accent { background: var(--button-accent-bg); border-bottom-color: var(--button-accent-border); }
        .btn-accent:hover { background: var(--button-accent-hover-bg); }
        .btn-gemini { background: var(--gemini-button-bg); border-bottom-color: var(--gemini-button-border); }
        .btn-gemini:hover { background: var(--gemini-button-hover-bg); }

        /* Changelog modal specific styling */
        #changelog-modal-content {
            background-color: var(--changelog-modal-bg);
            color: var(--changelog-text-color);
            border-color: var(--changelog-border-color);
            box-shadow: 0 0 20px var(--changelog-border-color);
            transition: box-shadow 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }
        #changelog-modal-content h3, #changelog-modal-content h4 {
            color: var(--changelog-h-color);
            border-bottom-color: var(--changelog-h-border);
            text-shadow: 0 0 5px var(--changelog-h-color);
            transition: color 0.3s ease, border-bottom-color 0.3s ease, text-shadow 0.3s ease;
        }
        /* No bullet points for changelog */
        #changelog-modal-content p {
            margin-bottom: 0.5rem;
            padding-left: 1rem; /* Indent for clarity */
        }
    </style>
</head>
<body class="antialiased">
    <!-- Wandering Rabbit Character -->
    <div id="wandering-rabbit">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" fill="currentColor">
            <rect x="1" y="0" width="1" height="1"/><rect x="3" y="0" width="1" height="1"/>
            <rect x="0" y="1" width="1" height="1"/><rect x="4" y="1" width="1" height="1"/>
            <rect x="0" y="2" width="1" height="1"/><rect x="6" y="2" width="1" height="1"/>
            <rect x="0" y="3" width="1" height="1"/><rect x="6" y="3" width="1" height="1"/>
            <rect x="0" y="4" width="1" height="1"/><rect x="6" y="4" width="1" height="1"/>
            <rect x="2" y="2" width="1" height="1"/><rect x="3" y="2" width="1" height="1"/>
            <rect x="2" y="3" width="1" height="1"/><rect x="3" y="3" width="1" height="1"/>
            <rect x="1" y="5" width="1" height="1"/><rect x="2" y="5" width="1" height="1"/>
            <rect x="3" y="5" width="1" height="1"/><rect x="4" y="5" width="1" height="1"/><rect x="5" y="5" width="1" height="1"/>
        </svg>
    </div>

    <div class="container mx-auto max-w-7xl p-4 md:p-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold title-color tracking-wider">ğŸ”‹ å°é¹P7+ å……ç”µè®¡ç®—å™¨</h1>
            <p class="text-slate-400 mt-2 text-lg">v4.2.6 - ğŸŒŒ è¶…ç¶­æ˜Ÿç©¹å…” (Hyperdimensional Stellar Rabbit)</p>
            <p class="text-sm text-slate-500 mt-1">/* è¶…ç¶­ï¼ˆHyperdimensionalï¼‰è±¡å¾µè‘—å°å……é›»è¤‡é›œæ€§çš„æ·±å…¥ç†è§£å’Œå°å¤šç¶­å› ç´ çš„ç²¾ç¢ºå»ºæ¨¡ï¼›æ˜Ÿç©¹ï¼ˆStellarï¼‰å‰‡ä»£è¡¨è‘—ç„¡é™çš„æ½›åŠ›èˆ‡å°æœ€ä½³å……é›»é«”é©—çš„è¿½æ±‚ã€‚æ­¤å‘½åæ—¨åœ¨çªå‡ºæ‡‰ç”¨ç¨‹å¼åœ¨æ•¸æ“šç²¾æº–åº¦ã€æ¨¡å‹è¤‡é›œæ€§ä»¥åŠæœªä¾†æ“´å±•æ€§æ–¹é¢çš„é‡å¤§é€²å±•ã€‚*/</p>
            <p class="text-sm text-slate-500 mt-2">ç”± CanguroMIO å‘ˆç°</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- Left Panel: Inputs & Controls -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Main Calculator Panel -->
                <div class="panel-bg p-6 rounded-2xl border-2 panel-border shadow-lg">
                    <div class="space-y-4">
                        <div>
                            <label for="model" class="block text-lg label-color mb-1">ğŸš˜ è½¦å‹ (P7+ å…¨ç³»æ ‡é…800Vå¹³å°)</label>
                            <select id="model" class="w-full text-lg input-bg border-2 input-border rounded-md p-2">
                                <option value="60.7" data-c="3" data-volt="800">é•¿ç»­èˆª (60.7 kWh)</option>
                                <option value="76.3" data-c="3" data-volt="800">è¶…é•¿ç»­èˆª (76.3 kWh)</option>
                                <option value="74.9" data-c="5" data-volt="800">æ——èˆ° (74.9 kWh)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="start" class="block text-lg label-color mb-1">ğŸ“Š èµ·å§‹ç”µé‡ (%)</label>
                                <input type="number" id="start" value="20" step="0.001" class="w-full text-lg input-bg border-2 input-border rounded-md p-2">
                            </div>
                            <div>
                                <label for="end" class="block text-lg label-color mb-1">ğŸ“ˆ ç»“æŸç”µé‡ (%)</label>
                                <input type="number" id="end" value="80" step="0.001" class="w-full text-lg input-bg border-2 input-border rounded-md p-2">
                            </div>
                        </div>
                        <div>
                            <label for="actual" class="block text-lg label-color mb-1">âš¡ å®é™…å……ç”µé‡ (kWh)</label>
                            <input type="number" id="actual" value="45" step="0.001" class="w-full text-lg input-bg border-2 input-border rounded-md p-2">
                        </div>
                        <div>
                            <label for="charger" class="block text-lg label-color mb-1">ğŸ› ï¸ å……ç”µæ¡©ç±»å‹</label>
                            <select id="charger" class="w-full text-lg input-bg border-2 input-border rounded-md p-2">
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        <!-- NewåŒç«™å ç”¨å……ç”µæ¡©æ•°é‡ section -->
                        <div>
                            <label class="block text-lg label-color mb-1">ğŸš— åŒç«™å ç”¨å……ç”µæ¡©è¯¦æƒ… (å…¶ä»–è½¦è¾†)</label>
                            <div class="space-y-2 text-base panel-bg p-3 rounded-md border border-gray-700">
                                <div class="flex items-center justify-between">
                                    <label>å°é¹P7+é•¿ç»­èˆª (60.7 kWh) 800V:</label>
                                    <input type="number" id="p7p_long_range_800v_count" value="0" min="0" class="w-24 text-lg input-bg border-2 input-border rounded-md p-1 text-right">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label>å°é¹P7+è¶…é•¿ç»­èˆª (76.3 kWh) 800V:</label>
                                    <input type="number" id="p7p_super_long_range_800v_count" value="0" min="0" class="w-24 text-lg input-bg border-2 input-border rounded-md p-1 text-right">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label>å°é¹P7+æ——èˆ° (74.9 kWh) 800V:</label>
                                    <input type="number" id="p7p_flagship_800v_count" value="0" min="0" class="w-24 text-lg input-bg border-2 input-border rounded-md p-1 text-right">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label>å…¶ä»–å°é¹400Vè½¦:</label>
                                    <input type="number" id="xp400vCount" value="0" min="0" class="w-24 text-lg input-bg border-2 input-border rounded-md p-1 text-right">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label>ç¬¬ä¸‰æ–¹800Vè½¦:</label>
                                    <input type="number" id="thirdParty800vCount" value="0" min="0" class="w-24 text-lg input-bg border-2 input-border rounded-md p-1 text-right">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label>ç¬¬ä¸‰æ–¹400Vè½¦:</label>
                                    <input type="number" id="thirdParty400vCount" value="0" min="0" class="w-24 text-lg input-bg border-2 input-border rounded-md p-1 text-right">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label>BMSæµæ°“è½¦å‹:</label>
                                    <input type="number" id="rogueBMSCount" value="0" min="0" class="w-24 text-lg input-bg border-2 input-border rounded-md p-1 text-right">
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">ï¼ˆä¸Šè¿°è½¦è¾†æ•°é‡å°†å½±å“æ€»åŠŸç‡åˆ†é…æ•ˆç‡ã€‚BMSæµæ°“è½¦å‹ä¼šé¢å¤–é™ä½æ•ˆç‡ã€‚ï¼‰</p>
                            <label for="totalSharingVehicles" class="block text-lg label-color mt-3 mb-1">æ€»è®¡å ç”¨è½¦è¾†æ•° (ä¸å«æœ¬è½¦):</label>
                            <input type="number" id="totalSharingVehicles" value="0" readonly class="w-full text-lg input-bg border-2 input-border rounded-md p-2 cursor-not-allowed">
                        </div>
                        <!-- End NewåŒç«™å ç”¨å……ç”µæ¡©æ•°é‡ section -->
                        <div>
                            <label class="block text-lg label-color mb-2">âš™ï¸ é¢å¤–æŸè€—å› å­</label>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-base">
                                <label class="flex items-center space-x-2"><input type="checkbox" id="ac" class="h-4 w-4"><span>ç©ºè°ƒğŸŒ¬ï¸(+4%)</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="preheat" class="h-4 w-4"><span>é¢„çƒ­ğŸ”¥(+6%)</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="cold" class="h-4 w-4"><span>ä½æ¸©â„ï¸(+5%)</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="hot" class="h-4 w-4"><span>é«˜æ¸©é…·çƒ­â˜€ï¸(+7%)</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="autopilot" class="h-4 w-4"><span>æ™ºé©¾ğŸ§ (+2%)</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="load" class="h-4 w-4"><span>è½½äººğŸšš(+3%)</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="enableCooling" checked class="h-4 w-4"><span>S5å†·å´ğŸŒ€</span></label>
                            </div>
                        </div>
                        <div class="pt-2">
                             <button id="calculateBtn" class="w-full text-xl text-black font-bold py-3 px-4 rounded-lg btn-primary">
                                ğŸ“ è®¡ç®—å®Œæ•´æŠ¥å‘Š
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Quick Estimator Panel -->
                <div class="panel-bg p-6 rounded-2xl border-2 panel-border shadow-lg">
                    <h3 class="text-xl title-color mb-3 border-b border-cyan-700 pb-2">â±ï¸ å¿«é€Ÿæ—¶é—´ä¼°ç®—</h3>
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="quickStart" class="block text-lg label-color mb-1">èµ·å§‹(%)</label>
                            <input type="number" id="quickStart" value="20" class="w-full text-lg input-bg border-2 input-border rounded-md p-2">
                        </div>
                        <div>
                            <label for="quickEnd" class="block text-lg label-color mb-1">ç»“æŸ(%)</label>
                            <input type="number" id="quickEnd" value="80" class="w-full text-lg input-bg border-2 input-border rounded-md p-2">
                        </div>
                    </div>
                    <button id="quickEstimateBtn" class="w-full text-lg text-black font-bold py-2 px-4 rounded-lg mt-4 btn-secondary">ä¼°ç®—æ—¶é—´</button>
                    <p id="quickResult" class="text-center text-xl title-color mt-3 h-6"></p>
                </div>
            </div>

            <!-- Right Panel: Results & Charts -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Smart Charging Advice Section -->
                <div id="smart-advice-container" class="panel-bg p-4 rounded-xl border-2 panel-border mt-6 hidden">
                    <h3 class="text-xl title-color mb-3 border-b border-purple-700 pb-2">âœ¨ æ™ºèƒ½å……ç”µå»ºè®®</h3>
                    <pre id="smartAdvice" class="text-base whitespace-pre-wrap min-h-[100px]"></pre>
                </div>

                <div id="result-container" class="panel-bg p-4 rounded-xl border-2 panel-border hidden">
                    <pre id="result" class="text-base whitespace-pre-wrap"></pre>
                </div>
                 <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 text-lg">ğŸ“‹ ç»“æœå·²å¤åˆ¶ï¼</div>
                
                <!-- Detailed Data Table -->
                <div id="table-container" class="panel-bg p-4 rounded-xl border-2 panel-border mt-6 hidden">
                    <h3 class="text-xl title-color mb-3 border-b border-cyan-700 pb-2">ğŸ“Š å……ç”µè¿‡ç¨‹è¯¦ç»†ä¼°ç®— (æ¯ 1% SoC)</h3>
                    <div class="data-table-container">
                        <table id="dataTable" class="w-full text-lg"><thead></thead><tbody></tbody></table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="panel-bg p-4 rounded-xl border-2 panel-border"><canvas id="lossChart"></canvas></div>
                    <div class="panel-bg p-4 rounded-xl border-2 panel-border"><canvas id="effChart"></canvas></div>
                    <div class="panel-bg p-4 rounded-xl border-2 panel-border"><canvas id="ivChart"></canvas></div>
                    <div class="panel-bg p-4 rounded-xl border-2 panel-border"><canvas id="socChart"></canvas></div>
                    <div class="md:col-span-2 panel-bg p-4 rounded-xl border-2 panel-border"><canvas id="tempChart"></canvas></div>
                </div>
                <div class="flex flex-wrap gap-4 justify-center">
                    <button id="smartAdviceBtn" class="flex-1 min-w-[150px] text-xl text-white font-bold py-3 px-4 rounded-lg btn-gemini">âœ¨ æ™ºèƒ½å……ç”µå»ºè®®</button>
                    <button id="copyResultBtn" class="flex-1 min-w-[150px] text-xl text-white font-bold py-3 px-4 rounded-lg btn-success">ğŸ“‹ å¤åˆ¶æŠ¥å‘Š</button>
                    <button id="changelogModalBtn" class="flex-1 min-w-[150px] text-xl text-white font-bold py-3 px-4 rounded-lg btn-info">ğŸ“œ æ›´æ–°æ—¥å¿—</button>
                    <button id="fullscreenToggleBtn" class="flex-1 min-w-[150px] text-xl text-white font-bold py-3 px-4 rounded-lg btn-accent">ğŸ–¥ï¸ å…¨å±å¹•</button>
                    <button id="themeToggleBtn" class="flex-1 min-w-[150px] text-xl text-white font-bold py-3 px-4 rounded-lg btn-info">ğŸŒ“ å¤œé—´æ¨¡å¼</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading-indicator">
        <div class="spinner"></div>
        <p>æ­£åœ¨è®¡ç®—å’Œç»˜åˆ¶å›¾è¡¨...</p>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden" onclick="toggleChangelogModal(false)">
        <div id="changelog-modal-content" class="max-w-2xl w-full p-6 rounded-2xl border-2 border-amber-400 shadow-lg relative" onclick="event.stopPropagation()">
            <button onclick="toggleChangelogModal(false)" class="absolute top-4 right-4 text-2xl text-red-500">&times;</button>
            <div id="changelog-list">
                <!-- Changelog content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // --- Constants and Global Variables ---
        const S5_LIMIT_KW = 720; // S5 charger theoretical limit (total station power)
        const S4_LIMIT_KW = 480; // S4 charger theoretical limit (total station power)
        const S2_LIMIT_KW = 90;  // S2 charger limit (per stall, typically not shared at station level)
        const THIRD_PARTY_LIMIT_KW = 120; // Generic third-party fast charger limit (per stall)
        const HOME_CHARGER_KW = 7; // Home charger power
        const HOME_CHARGER_VOLTAGE = 220; // Chinese household voltage for home charger
        let charts = {}; // Object to hold Chart instances
        let lastResultText = ""; // To store the last calculated report for copying
        window.lastCalculatedData = null; // To store calculation data for LLM call

        // --- DOM Element References ---
        const ui = {
            model: document.getElementById("model"),
            charger: document.getElementById("charger"),
            enableCooling: document.getElementById("enableCooling"),
            startSoC: document.getElementById("start"),
            endSoC: document.getElementById("end"),
            actualKWh: document.getElementById("actual"),
            resultContainer: document.getElementById("result-container"),
            resultText: document.getElementById("result"),
            smartAdviceContainer: document.getElementById("smart-advice-container"),
            smartAdvice: document.getElementById("smartAdvice"),
            ac: document.getElementById('ac'),
            preheat: document.getElementById('preheat'),
            cold: document.getElementById('cold'),
            hot: document('hot'),
            autopilot: document.getElementById('autopilot'),
            load: document.getElementById('load'),
            quickStart: document.getElementById('quickStart'),
            quickEnd: document.getElementById('quickEnd'),
            quickResult: document.getElementById('quickResult'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            loadingIndicator: document.getElementById('loading-indicator'),
            tableContainer: document.getElementById('table-container'),
            dataTableBody: document.querySelector('#dataTable tbody'),
            dataTableHead: document.querySelector('#dataTable thead'),
            changelogList: document.getElementById('changelog-list'),
            // New button references
            calculateBtn: document.getElementById('calculateBtn'),
            quickEstimateBtn: document.getElementById('quickEstimateBtn'),
            smartAdviceBtn: document.getElementById('smartAdviceBtn'),
            copyResultBtn: document.getElementById('copyResultBtn'),
            changelogModalBtn: document.getElementById('changelogModalBtn'),
            fullscreenToggleBtn: document.getElementById('fullscreenToggleBtn'),
            // New sharing vehicle inputs
            p7p_long_range_800v_count: document.getElementById('p7p_long_range_800v_count'),
            p7p_super_long_range_800v_count: document.getElementById('p7p_super_long_range_800v_count'),
            p7p_flagship_800v_count: document.getElementById('p7p_flagship_800v_count'),
            xp400vCount: document.getElementById('xp400vCount'),
            thirdParty800vCount: document.getElementById('thirdParty800vCount'),
            thirdParty400vCount: document.getElementById('thirdParty400vCount'),
            rogueBMSCount: document.getElementById('rogueBMSCount'),
            totalSharingVehicles: document.getElementById('totalSharingVehicles'),
        };

        // --- Color Palettes for Dynamic Theming ---
        const nightModePalettes = [
            { // TRON Blue/Cyan
                '--bg-color': 'linear-gradient(180deg, #0a0a0a 0%, #000005 100%)',
                '--text-color': '#00eaff',
                '--title-color': '#00eaff',
                '--label-color': '#33ffff',
                '--input-bg': 'rgba(0, 0, 10, 0.7)',
                '--input-border': '#00eaff',
                '--panel-bg': 'rgba(0, 0, 15, 0.8)',
                '--panel-border': '#00eaff',
                '--button-primary-bg': 'linear-gradient(45deg, #00bfff 0%, #0077ff 100%)',
                '--button-primary-hover-bg': 'linear-gradient(45deg, #00aadd 0%, #0066ee 100%)',
                '--button-primary-border': '#00eaff',
                '--button-secondary-bg': 'linear-gradient(45deg, #ff9900 0%, #ff6600 100%)',
                '--button-secondary-hover-bg': 'linear-gradient(45deg, #ee8800 0%, #ee5500 100%)',
                '--button-secondary-border': '#ff9900',
                '--button-success-bg': 'linear-gradient(45deg, #00ee00 0%, #00bb00 100%)',
                '--button-success-hover-bg': 'linear-gradient(45deg, #00dd00 0%, #00aa00 100%)',
                '--button-success-border': '#00ee00',
                '--button-info-bg': 'linear-gradient(45deg, #666666 0%, #333333 100%)',
                '--button-info-hover-bg': 'linear-gradient(45deg, #555555 0%, #222222 100%)',
                '--button-info-border': '#888888',
                '--button-accent-bg': 'linear-gradient(45deg, #ff00ff 0%, #cc00cc 100%)',
                '--button-accent-hover-bg': 'linear-gradient(45deg, #ee00ee 0%, #bb00bb 100%)',
                '--button-accent-border': '#ff00ff',
                '--changelog-modal-bg': 'rgba(0, 0, 20, 0.9)',
                '--changelog-text-color': '#ccffff',
                '--changelog-border-color': '#00eaff',
                '--changelog-h-color': '#00eaff',
                '--changelog-h-border': '#33ffff',
                '--progress-bg': '#00eaff',
                '--progress-text': '#0a0a0a',
                '--cooling-color': '#ff00ff',
                '--gemini-button-bg': 'linear-gradient(45deg, #6200ea 0%, #aa00ff 100%)',
                '--gemini-button-hover-bg': 'linear-gradient(45deg, #5000cc 0%, #8800cc 100%)',
                '--gemini-button-border': '#bb00ff',
                '--pixel-rabbit-shadow-color': 'rgba(255, 255, 255, 0.8)',
            },
            { // Dark Forest Green
                '--bg-color': 'linear-gradient(180deg, #102010 0%, #050505 100%)',
                '--text-color': '#00ff7f', /* Neon Green */
                '--title-color': '#00ff7f',
                '--label-color': '#66ff99',
                '--input-bg': 'rgba(0, 5, 0, 0.7)',
                '--input-border': '#00ff7f',
                '--panel-bg': 'rgba(0, 8, 0, 0.8)',
                '--panel-border': '#00ff7f',
                '--button-primary-bg': 'linear-gradient(45deg, #32cd32 0%, #008000 100%)',
                '--button-primary-hover-bg': 'linear-gradient(45deg, #22bb22 0%, #006600 100%)',
                '--button-primary-border': '#00ff7f',
                '--button-secondary-bg': 'linear-gradient(45deg, #ffcc00 0%, #e0a000 100%)',
                '--button-secondary-hover-bg': 'linear-gradient(45deg, #eebb00 0%, #cc9000 100%)',
                '--button-secondary-border': '#ffcc00',
                '--button-success-bg': 'linear-gradient(45deg, #00ee00 0%, #00bb00 100%)',
                '--button-success-hover-bg': 'linear-gradient(45deg, #00dd00 0%, #00aa00 100%)',
                '--button-success-border': '#00ee00',
                '--button-info-bg': 'linear-gradient(45deg, #708090 0%, #405060 100%)',
                '--button-info-hover-bg': 'linear-gradient(45deg, #607080 0%, #304050 100%)',
                '--button-info-border': '#90a0b0',
                '--button-accent-bg': 'linear-gradient(45deg, #ff69b4 0%, #c71585 100%)',
                '--button-accent-hover-bg': 'linear-gradient(45deg, #ee59a4 0%, #b00070 100%)',
                '--button-accent-border': '#ff69b4',
                '--changelog-modal-bg': 'rgba(0, 10, 0, 0.9)',
                '--changelog-text-color': '#d0ffe0',
                '--changelog-border-color': '#00ff7f',
                '--changelog-h-color': '#00ff7f',
                '--changelog-h-border': '#66ff99',
                '--progress-bg': '#00ff7f',
                '--progress-text': '#0a0a0a',
                '--cooling-color': '#ffd700', /* Gold for cooling */
                '--gemini-button-bg': 'linear-gradient(45deg, #4b0082 0%, #8a2be2 100%)',
                '--gemini-button-hover-bg': 'linear-gradient(45deg, #3a006f 0%, #701fd0 100%)',
                '--gemini-button-border': '#9932cc',
                '--pixel-rabbit-shadow-color': 'rgba(255, 255, 255, 0.8)',
            },
            { // Deep Purple/Magenta
                '--bg-color': 'linear-gradient(180deg, #150015 0%, #000000 100%)',
                '--text-color': '#ff00ff', /* Neon Magenta */
                '--title-color': '#ff00ff',
                '--label-color': '#ff66ff',
                '--input-bg': 'rgba(10, 0, 10, 0.7)',
                '--input-border': '#ff00ff',
                '--panel-bg': 'rgba(15, 0, 15, 0.8)',
                '--panel-border': '#ff00ff',
                '--button-primary-bg': 'linear-gradient(45deg, #8a2be2 0%, #4b0082 100%)',
                '--button-primary-hover-bg': 'linear-gradient(45deg, #7a1be2 0%, #3b0072 100%)',
                '--button-primary-border': '#ff00ff',
                '--button-secondary-bg': 'linear-gradient(45deg, #00ffff 0%, #00aaff 100%)',
                '--button-secondary-hover-bg': 'linear-gradient(45deg, #00dddd 0%, #0099ee 100%)',
                '--button-secondary-border': '#00ffff',
                '--button-success-bg': 'linear-gradient(45deg, #00ff00 0%, #00aa00 100%)',
                '--button-success-hover-bg': 'linear-gradient(45deg, #00ee00 0%, #009900 100%)',
                '--button-success-border': '#00ff00',
                '--button-info-bg': 'linear-gradient(45deg, #aaaaaa 0%, #777777 100%)',
                '--button-info-hover-bg': 'linear-gradient(45deg, #999999 0%, #666666 100%)',
                '--button-info-border': '#cccccc',
                '--button-accent-bg': 'linear-gradient(45deg, #ffd700 0%, #ffa500 100%)',
                '--button-accent-hover-bg': 'linear-gradient(45deg, #eec700 0%, #ee9500 100%)',
                '--button-accent-border': '#ffd700',
                '--changelog-modal-bg': 'rgba(10, 0, 10, 0.9)',
                '--changelog-text-color': '#ffeeff',
                '--changelog-border-color': '#ff00ff',
                '--changelog-h-color': '#ff00ff',
                '--changelog-h-border': '#ff66ff',
                '--progress-bg': '#ff00ff',
                '--progress-text': '#0a0a0a',
                '--cooling-color': '#00ffff',
                '--gemini-button-bg': 'linear-gradient(45deg, #6200ea 0%, #aa00ff 100%)',
                '--gemini-button-hover-bg': 'linear-gradient(45deg, #5000cc 0%, #8800cc 100%)',
                '--gemini-button-border': '#bb00ff',
                '--pixel-rabbit-shadow-color': 'rgba(255, 255, 255, 0.8)',
            },
        ];

        const dayModePalettes = [
            { // Soft Pastel Blue/Pink
                '--bg-color': 'linear-gradient(135deg, #e0faff 0%, #fffde7 50%, #e3f2fd 100%)',
                '--text-color': '#5e35b1',
                '--title-color': '#ff4081',
                '--label-color': '#64dd17',
                '--input-bg': 'rgba(255, 255, 255, 0.95)',
                '--input-border': '#ff4081',
                '--panel-bg': 'rgba(255, 255, 255, 0.9)',
                '--panel-border': '#ff4081',
                '--button-primary-bg': 'linear-gradient(45deg, #ff80ab 0%, #82b1ff 100%)',
                '--button-primary-hover-bg': 'linear-gradient(45deg, #ff6090 0%, #6090ff 100%)',
                '--button-primary-border': '#82b1ff',
                '--button-secondary-bg': 'linear-gradient(45deg, #ffd740 0%, #ff8a80 100%)',
                '--button-secondary-hover-bg': 'linear-gradient(45deg, #ffcc30 0%, #ff7070 100%)',
                '--button-secondary-border': '#ff8a80',
                '--button-success-bg': 'linear-gradient(45deg, #69f0ae 0%, #18ffff 100%)',
                '--button-success-hover-bg': 'linear-gradient(45deg, #50e090 0%, #00e0e0 100%)',
                '--button-success-border': '#18ffff',
                '--button-info-bg': 'linear-gradient(45deg, #b388ff 0%, #8c9eff 100%)',
                '--button-info-hover-bg': 'linear-gradient(45deg, #a070e0 0%, #7080ff 100%)',
                '--button-info-border': '#8c9eff',
                '--button-accent-bg': 'linear-gradient(45deg, #ff1744 0%, #f50057 100%)',
                '--button-accent-hover-bg': 'linear-gradient(45deg, #e00030 0%, #d00040 100%)',
                '--button-accent-border': '#f50057',
                '--changelog-modal-bg': 'rgba(255, 255, 255, 0.98)',
                '--changelog-text-color': '#333333',
                '--changelog-border-color': 'var(--button-secondary-border)',
                '--changelog-h-color': 'var(--title-color)',
                '--changelog-h-border': 'var(--label-color)',
                '--progress-bg': 'var(--title-color)',
                '--progress-text': '#ffffff',
                '--cooling-color': '#00bcd4',
                '--gemini-button-bg': 'linear-gradient(45deg, #6200ea 0%, #aa00ff 100%)',
                '--gemini-button-hover-bg': 'linear-gradient(45deg, #5000cc 0%, #8800cc 100%)',
                '--gemini-button-border': '#bb00ff',
                '--pixel-rabbit-shadow-color': 'rgba(0, 0, 0, 0.6)',
            },
            { // Warm Autumn Hues
                '--bg-color': 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)',
                '--text-color': '#8b4513', /* Saddle Brown */
                '--title-color': '#d2691e', /* Chocolate */
                '--label-color': '#a0522d', /* Sienna */
                '--input-bg': 'rgba(255, 255, 255, 0.95)',
                '--input-border': '#d2691e',
                '--panel-bg': 'rgba(255, 255, 255, 0.9)',
                '--panel-border': '#d2691e',
                '--button-primary-bg': 'linear-gradient(45deg, #ff8c00 0%, #ff4500 100%)', /* Dark Orange to Orange Red */
                '--button-primary-hover-bg': 'linear-gradient(45deg, #ee7c00 0%, #ee3500 100%)',
                '--button-primary-border': '#ff4500',
                '--button-secondary-bg': 'linear-gradient(45deg, #8b4513 0%, #a0522d 100%)', /* Saddle Brown to Sienna */
                '--button-secondary-hover-bg': 'linear-gradient(45deg, #7b3503 0%, #90421d 100%)',
                '--button-secondary-border': '#a0522d',
                '--button-success-bg': 'linear-gradient(45deg, #3cb371 0%, #2e8b57 100%)', /* Medium Sea Green to Sea Green */
                '--button-success-hover-bg': 'linear-gradient(45deg, #2c9361 0%, #1e7b47 100%)',
                '--button-success-border': '#2e8b57',
                '--button-info-bg': 'linear-gradient(45deg, #b0c4de 0%, #87ceeb 100%)', /* Light Steel Blue to Sky Blue */
                '--button-info-hover-bg': 'linear-gradient(45deg, #a0b4ce 0%, #77bdeb 100%)',
                '--button-info-border': '#87ceeb',
                '--button-accent-bg': 'linear-gradient(45deg, #dc143c 0%, #b22222 100%)', /* Crimson to Firebrick */
                '--button-accent-hover-bg': 'linear-gradient(45deg, #cc042c 0%, #a21212 100%)',
                '--button-accent-border': '#b22222',
                '--changelog-modal-bg': 'rgba(255, 255, 255, 0.98)',
                '--changelog-text-color': '#555555',
                '--changelog-border-color': 'var(--button-secondary-border)',
                '--changelog-h-color': 'var(--title-color)',
                '--changelog-h-border': 'var(--label-color)',
                '--progress-bg': 'var(--title-color)',
                '--progress-text': '#ffffff',
                '--cooling-color': '#00aaff', /* Blue for cooling */
                '--gemini-button-bg': 'linear-gradient(45deg, #6200ea 0%, #aa00ff 100%)',
                '--gemini-button-hover-bg': 'linear-gradient(45deg, #5000cc 0%, #8800cc 100%)',
                '--gemini-button-border': '#bb00ff',
                '--pixel-rabbit-shadow-color': 'rgba(0, 0, 0, 0.6)',
            },
            { // Fresh Spring Greens
                '--bg-color': 'linear-gradient(135deg, #d4edda 0%, #f0fff0 100%)',
                '--text-color': '#2e8b57', /* Sea Green */
                '--title-color': '#3cb371', /* Medium Sea Green */
                '--label-color': '#66cdaa', /* Medium Aquamarine */
                '--input-bg': 'rgba(255, 255, 255, 0.95)',
                '--input-border': '#3cb371',
                '--panel-bg': 'rgba(255, 255, 255, 0.9)',
                '--panel-border': '#3cb371',
                '--button-primary-bg': 'linear-gradient(45deg, #66cdaa 0%, #4682b4 100%)', /* Medium Aquamarine to Steel Blue */
                '--button-primary-hover-bg': 'linear-gradient(45deg, #56bda0 0%, #3672a4 100%)',
                '--button-primary-border': '#4682b4',
                '--button-secondary-bg': 'linear-gradient(45deg, #f0e68c 0%, #ffd700 100%)', /* Khaki to Gold */
                '--button-secondary-hover-bg': 'linear-gradient(45deg, #e0d67c 0%, #eec700 100%)',
                '--button-secondary-border': '#ffd700',
                '--button-success-bg': 'linear-gradient(45deg, #98fb98 0%, #32cd32 100%)', /* Pale Green to Lime Green */
                '--button-success-hover-bg': 'linear-gradient(45deg, #88ea88 0%, #22bb22 100%)',
                '--button-success-border': '#32cd32',
                '--button-info-bg': 'linear-gradient(45deg, #add8e6 0%, #87ceeb 100%)', /* Light Blue to Sky Blue */
                '--button-info-hover-bg': 'linear-gradient(45deg, #99c8d6 0%, #77bdea 100%)',
                '--button-info-border': '#87ceeb',
                '--button-accent-bg': 'linear-gradient(45deg, #ff6347 0%, #ff4500 100%)', /* Tomato to Orange Red */
                '--button-accent-hover-bg': 'linear-gradient(45deg, #ee5337 0%, #ee3500 100%)',
                '--button-accent-border': '#ff4500',
                '--changelog-modal-bg': 'rgba(255, 255, 255, 0.98)',
                '--changelog-h-color': 'var(--title-color)',
                '--changelog-h-border': 'var(--label-color)',
                '--progress-bg': 'var(--title-color)',
                '--progress-text': '#ffffff',
                '--cooling-color': '#ff6347', /* Tomato for cooling */
                '--gemini-button-bg': 'linear-gradient(45deg, #6200ea 0%, #aa00ff 100%)',
                '--gemini-button-hover-bg': 'linear-gradient(45deg, #5000cc 0%, #8800cc 100%)',
                '--gemini-button-border': '#bb00ff',
                '--pixel-rabbit-shadow-color': 'rgba(0, 0, 0, 0.6)',
            },
        ];

        /**
         * Utility to apply a given color palette to CSS variables.
         * @param {Object} palette - An object containing CSS variable names and their values.
         */
        function applyColorPalette(palette) {
            const root = document.documentElement;
            for (const key in palette) {
                root.style.setProperty(key, palette[key]);
            }
        }

        /**
         * Displays the loading indicator.
         * @param {string} message - The message to display in the loading indicator.
         */
        function showLoadingIndicator(message = "æ­£åœ¨è®¡ç®—å’Œç»˜åˆ¶å›¾è¡¨...") {
            ui.loadingIndicator.querySelector('p').textContent = message;
            ui.loadingIndicator.style.display = 'flex';
        }

        /**
         * Hides the loading indicator.
         */
        function hideLoadingIndicator() {
            ui.loadingIndicator.style.display = 'none';
        }

        /**
         * Generates a random float within a specified range.
         * @param {number} min - The minimum value.
         * @param {number} max - The maximum value.
         * @returns {number} A random float.
         */
        function getRandomFloat(min, max) {
            return Math.random() * (max - min) + min;
        }

        /**
         * Formats total seconds into a human-readable time string (e.g., "1 å°æ—¶ 30 åˆ† 45 ç§’").
         * @param {number} totalSeconds - The total time in seconds.
         * @returns {string} The formatted time string.
         */
        function formatChargeTime(totalSeconds) {
            if (totalSeconds === Infinity) return "æ— æ³•å……ç”µ";
            if (totalSeconds < 0) return "è®¡ç®—é”™è¯¯";

            const hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);

            let timeStr = "";
            if (hours > 0) timeStr += `${hours} å°æ—¶ `;
            if (minutes > 0 || hours > 0) timeStr += `${minutes} åˆ† `;
            timeStr += `${seconds} ç§’`;

            return timeStr.trim();
        }

        /**
         * Displays a custom alert modal instead of the native alert().
         * @param {string} message - The message to display.
         */
        function showCustomAlert(message) {
            const alertModal = document.createElement('div');
            alertModal.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50';
            alertModal.innerHTML = `
                <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg border-2 border-red-500 max-w-sm w-full text-center">
                    <p class="text-xl mb-4">${message}</p>
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" onclick="this.closest('.fixed').remove()">ç¡®å®š</button>
                </div>
            `;
            document.body.appendChild(alertModal);
        }

        /**
         * Toggles between day and night themes, randomly selecting a color palette.
         */
        function toggleTheme() {
            const isDayMode = document.body.classList.contains('day-mode');
            setTheme(!isDayMode);
        }

        /**
         * Sets the theme (day or night) and updates button text and random color palette.
         * @param {boolean} enableDayMode - True for day mode, false for night mode.
         */
        function setTheme(enableDayMode) {
            if (enableDayMode) {
                document.body.classList.add('day-mode');
                localStorage.setItem('theme', 'day');
                ui.themeToggleBtn.textContent = 'ğŸŒ‘ å¤œé—´æ¨¡å¼';
                const randomPalette = dayModePalettes[Math.floor(Math.random() * dayModePalettes.length)];
                applyColorPalette(randomPalette);
            } else {
                document.body.classList.remove('day-mode');
                localStorage.setItem('theme', 'night');
                ui.themeToggleBtn.textContent = 'ğŸŒ“ æ—¥é—´æ¨¡å¼';
                const randomPalette = nightModePalettes[Math.floor(Math.random() * nightModePalettes.length)];
                applyColorPalette(randomPalette);
            }
            // Update Chart.js default colors immediately after theme switch
            Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
            // Recalculate and redraw charts to apply new theme colors
            if (lastResultText) { 
                calculate(); 
            }
        }
        
        /**
         * Destroys a single Chart.js instance by its ID.
         * @param {string} chartId - The ID of the chart to destroy.
         */
        function destroyChart(chartId) {
            if (charts[chartId] && typeof charts[chartId].destroy === 'function') {
                charts[chartId].destroy();
                charts[chartId] = null; 
            }
        }

        /**
         * Destroys all existing Chart.js instances.
         */
        function destroyAllCharts() { 
            Object.keys(charts).forEach(chartId => destroyChart(chartId));
            charts = {}; 
        }

        /**
         * Estimates realistic charging time based on SoC decay and cooling status.
         * This algorithm is optimized based on actual data provided by the user for all LFP and NCM models.
         * Factors represent the average power ratio relative to the session's maximum power within each SoC zone.
         * Returns total time in seconds.
         * @param {number} startSoC - Starting SoC (%).
         * @param {number} endSoC - Ending SoC (%).
         * @param {number} batteryCapacity - Battery capacity (kWh).
         * @param {number} sessionMaxPower - Maximum power for the charging session (kW).
         * @param {boolean} isCoolingEnabled - True if S5 cooling is enabled.
         * @param {number} maxCRate - C-rate of the selected model (e.g., 3 for 3C, 5 for 5C).
         * @param {boolean} isHomeCharger - True if it's a home charger.
         * @param {number} platformVoltage - Platform voltage (e.g., 800 or 400).
         * @returns {number} Estimated time in seconds. Returns Infinity if effective power is zero.
         */
        function estimateRealisticChargeTime(startSoC, endSoC, batteryCapacity, sessionMaxPower, isCoolingEnabled, maxCRate, isHomeCharger, platformVoltage) {
            let socZones;

            // For home chargers, power is stable and does not decay with SoC.
            if (isHomeCharger) {
                // Simplified "zone" for home charger with constant power.
                socZones = [{ upto: 100, factor: 1.0 }]; 
            } else if (maxCRate === 5) { // Flagship (74.9 kWh, 5C) model factors (NCM)
                if (isCoolingEnabled) {
                    // Optimized for 442kW peak
                    socZones = [
                        { upto: 2, factor: 0.98 }, 
                        { upto: 10, factor: 0.95 }, 
                        { upto: 30, factor: 0.90 }, 
                        { upto: 50, factor: 0.75 }, 
                        { upto: 70, factor: 0.65 }, 
                        { upto: 85, factor: 0.50 }, 
                        { upto: 90, factor: 0.35 }, 
                        { upto: 95, factor: 0.20 }, 
                        { upto: 100, factor: 0.08 } 
                    ];
                } else { // No cooling - slightly lower factors
                    socZones = [
                        { upto: 2, factor: 0.90 }, 
                        { upto: 10, factor: 0.85 },
                        { upto: 30, factor: 0.78 },
                        { upto: 50, factor: 0.65 },
                        { upto: 70, factor: 0.50 },
                        { upto: 85, factor: 0.35 },
                        { upto: 90, factor: 0.25 },
                        { upto: 95, factor: 0.15 },
                        { upto: 100, factor: 0.05 }
                    ];
                }
            } else if (maxCRate === 3) { // Long/Super Long Range (3C) model factors (LFP)
                 if (platformVoltage === 800) { // Specific factors for 800V 3C models
                    if (batteryCapacity === 60.7) { // é•¿ç»­èˆª 800V
                        if (isCoolingEnabled) {
                            socZones = [
                                { upto: 2, factor: 0.995 }, 
                                { upto: 10, factor: 0.97 }, 
                                { upto: 30, factor: 0.83 }, 
                                { upto: 50, factor: 0.68 }, 
                                { upto: 70, factor: 0.53 }, 
                                { upto: 85, factor: 0.40 }, 
                                { upto: 90, factor: 0.30 }, 
                                { upto: 95, factor: 0.22 }, 
                                { upto: 98, factor: 0.12 }, 
                                { upto: 100, factor: 0.05 } 
                            ];
                        } else { // No cooling
                            socZones = [
                                { upto: 2, factor: 0.96 },
                                { upto: 10, factor: 0.92 },
                                { upto: 30, factor: 0.75 },
                                { upto: 50, factor: 0.58 },
                                { upto: 70, factor: 0.42 },
                                { upto: 85, factor: 0.28 },
                                { upto: 90, factor: 0.20 },
                                { upto: 95, factor: 0.12 },
                                { upto: 98, factor: 0.05 },
                                { upto: 100, factor: 0.02 }
                            ];
                        }
                    } else if (batteryCapacity === 76.3) { // è¶…é•¿ç»­èˆª 800V
                        if (isCoolingEnabled) {
                            socZones = [
                                { upto: 2, factor: 0.995 },
                                { upto: 10, factor: 0.98 }, 
                                { upto: 30, factor: 0.97 },
                                { upto: 50, factor: 0.93 },
                                { upto: 70, factor: 0.82 },
                                { upto: 85, factor: 0.65 },
                                { upto: 90, factor: 0.45 },
                                { upto: 95, factor: 0.25 },
                                { upto: 98, factor: 0.08 },
                                { upto: 100, factor: 0.03 }
                            ];
                        } else { // No cooling
                            socZones = [
                                { upto: 2, factor: 0.96 },
                                { upto: 10, factor: 0.93 },
                                { upto: 30, factor: 0.88 },
                                { upto: 50, factor: 0.75 },
                                { upto: 70, factor: 0.60 },
                                { upto: 85, factor: 0.40 },
                                { upto: 90, factor: 0.25 },
                                { upto: 95, factor: 0.15 },
                                { upto: 98, factor: 0.06 },
                                { upto: 100, factor: 0.025 }
                            ];
                        }
                    }
                } else if (platformVoltage === 400) { // Specific factors for 400V 3C models (older P7)
                    if (batteryCapacity === 60.7) { // é•¿ç»­èˆª 400V
                        if (isCoolingEnabled) { // Assumes some form of thermal management
                            socZones = [
                                { upto: 2, factor: 0.90 }, 
                                { upto: 10, factor: 0.85 }, 
                                { upto: 30, factor: 0.70 }, 
                                { upto: 50, factor: 0.55 }, 
                                { upto: 70, factor: 0.40 }, 
                                { upto: 85, factor: 0.25 }, 
                                { upto: 90, factor: 0.18 }, 
                                { upto: 95, factor: 0.10 }, 
                                { upto: 98, factor: 0.06 }, 
                                { upto: 100, factor: 0.02 } 
                            ];
                        } else { // No cooling
                            socZones = [
                                { upto: 2, factor: 0.85 },
                                { upto: 10, factor: 0.80 },
                                { upto: 30, factor: 0.65 },
                                { upto: 50, factor: 0.50 },
                                { upto: 70, factor: 0.35 },
                                { upto: 85, factor: 0.20 },
                                { upto: 90, factor: 0.12 },
                                { upto: 95, factor: 0.08 },
                                { upto: 98, factor: 0.04 },
                                { upto: 100, factor: 0.015 }
                            ];
                        }
                    } else if (batteryCapacity === 76.3) { // è¶…é•¿ç»­èˆª 400V
                        if (isCoolingEnabled) {
                            socZones = [
                                { upto: 2, factor: 0.95 },
                                { upto: 10, factor: 0.90 }, 
                                { upto: 30, factor: 0.85 },
                                { upto: 50, factor: 0.70 },
                                { upto: 70, factor: 0.55 },
                                { upto: 85, factor: 0.40 },
                                { upto: 90, factor: 0.28 },
                                { upto: 95, factor: 0.18 },
                                { upto: 98, factor: 0.07 },
                                { upto: 100, factor: 0.025 }
                            ];
                        } else { // No cooling
                            socZones = [
                                { upto: 2, factor: 0.90 },
                                { upto: 10, factor: 0.85 },
                                { upto: 30, factor: 0.78 },
                                { upto: 50, factor: 0.65 },
                                { upto: 70, factor: 0.48 },
                                { upto: 85, factor: 0.35 },
                                { upto: 90, factor: 0.20 },
                                { upto: 95, factor: 0.10 },
                                { upto: 98, factor: 0.05 },
                                { upto: 100, factor: 0.01 }
                            ];
                        }
                    }
                }
            } else {
                // Default or fallback factors (should not occur with current options)
                socZones = [
                    { upto: 60, factor: 0.88 }, 
                    { upto: 80, factor: 0.58 }, 
                    { upto: 95, factor: 0.33 }, 
                    { upto: 100, factor: 0.15 } 
                ];
            }
            
            let totalTimeSeconds = 0;
            let currentSoC = startSoC;

            for (const zone of socZones) {
                if (currentSoC >= endSoC) break; 
                
                const currentZoneStartSoC = socZones.indexOf(zone) === 0 ? 0 : socZones[socZones.indexOf(zone) - 1].upto;
                const segmentStart = Math.max(currentSoC, currentZoneStartSoC);
                const segmentEnd = Math.min(endSoC, zone.upto);
                
                if (segmentStart >= segmentEnd) {
                    continue;
                }

                const socInThisSegment = segmentEnd - segmentStart;
                
                // If home charger, effective power is constant sessionMaxPower, no decay factor.
                const effectivePower = isHomeCharger ? sessionMaxPower : sessionMaxPower * zone.factor;
                
                if (effectivePower <= 0) { 
                    console.warn("Effective power is zero or negative, cannot estimate charge time for this region.");
                    return Infinity; 
                }
                
                const kWhNeeded = (socInThisSegment / 100) * batteryCapacity;
                totalTimeSeconds += (kWhNeeded / effectivePower) * 3600;
                currentSoC = segmentEnd;
            }
            return totalTimeSeconds;
        }

        /**
         * Populates the charger selection dropdown based on the selected car model's C-rate.
         */
        function updateChargerOptions() {
            // No longer dependent on model C-rate, as all P7+ are 800V platform in the selector
            
            ui.charger.innerHTML = "";

            const chargers = [
                { name: `S5ï¼ˆæ¶²å†·è¶…å……ï¼‰`, power: S5_LIMIT_KW },
                { name: `S4ï¼ˆè¶…å……ï¼‰`, power: S4_LIMIT_KW },
                { name: "S2ï¼ˆæ™®é€šå¿«å……ï¼‰", power: S2_LIMIT_KW },
                { name: "ç¬¬ä¸‰æ–¹å¿«å……", power: THIRD_PARTY_LIMIT_KW, note: " (é€šå¸¸80-120 kW)" },
                { name: "å®¶ç”¨å……ç”µæ¡©", power: HOME_CHARGER_KW } 
            ];

            chargers.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.power;
                opt.textContent = `${c.name} - ${c.power.toFixed(0)} kW${c.note || ''}`;
                ui.charger.appendChild(opt);
            });
        }
        
        /**
         * Main calculation function that computes results and updates all charts.
         */
        function calculate() {
            showLoadingIndicator(); // Show loading indicator at the start

            // Use a short timeout to allow the loading indicator to render before heavy calculations
            setTimeout(() => {
                try {
                    // --- Input Validation and Autofill ---
                    let startSoC = parseFloat(ui.startSoC.value);
                    let endSoC = parseFloat(ui.endSoC.value);
                    let actualKWh = parseFloat(ui.actualKWh.value);
                    
                    // Get individual counts of *other* vehicles
                    const p7p_long_range_800v_count = parseInt(ui.p7p_long_range_800v_count.value) || 0;
                    const p7p_super_long_range_800v_count = parseInt(ui.p7p_super_long_range_800v_count.value) || 0;
                    const p7p_flagship_800v_count = parseInt(ui.p7p_flagship_800v_count.value) || 0;
                    const xp400vCount = parseInt(ui.xp400vCount.value) || 0;
                    const thirdParty800vCount = parseInt(ui.thirdParty800vCount.value) || 0;
                    const thirdParty400vCount = parseInt(ui.thirdParty400vCount.value) || 0;
                    const rogueBMSCount = parseInt(ui.rogueBMSCount.value) || 0;

                    // Calculate total *other* sharing vehicles for display
                    const totalOtherSharingVehicles = p7p_long_range_800v_count + p7p_super_long_range_800v_count + p7p_flagship_800v_count + xp400vCount + thirdParty800vCount + thirdParty400vCount + rogueBMSCount;
                    ui.totalSharingVehicles.value = totalOtherSharingVehicles;

                    // numTotalVehicles represents the total vehicles at the station, including the user's car
                    let numTotalVehicles = 1 + totalOtherSharingVehicles; // User's car + other cars

                    const capacity = parseFloat(ui.model.value);

                    // Autofill and validate startSoC
                    if (isNaN(startSoC) || startSoC < 0 || startSoC >= 100) {
                        startSoC = getRandomFloat(10, 30);
                        ui.startSoC.value = startSoC.toFixed(2);
                    }

                    // Autofill and validate endSoC
                    if (isNaN(endSoC) || endSoC <= startSoC || endSoC > 100) {
                        endSoC = Math.min(100, startSoC + getRandomFloat(50, 70)); // Ensure endSoC > startSoC and max 100
                        ui.endSoC.value = endSoC.toFixed(2);
                    }

                    // Autofill and validate actualKWh based on theoretical value for selected SoC range
                    if (isNaN(actualKWh) || actualKWh <= 0) {
                        const theoreticalForRange = capacity * ((endSoC - startSoC) / 100);
                        actualKWh = theoreticalForRange * getRandomFloat(1.05, 1.15); // Add a small loss factor for random fill
                        ui.actualKWh.value = actualKWh.toFixed(3);
                    }

                    const selectedModelOption = ui.model.selectedOptions[0];
                    const { volt: modelPlatformVolt, c: maxCRate } = selectedModelOption.dataset; // Rename 'volt' to 'modelPlatformVolt' to avoid clash
                    const modelName = selectedModelOption.textContent.trim();
                    const selectedChargerOption = ui.charger.selectedOptions[0];
                    const selectedChargerNominalPower = parseFloat(selectedChargerOption.value);
                    const chargerTypeName = selectedChargerOption.textContent.split(' - ')[0].trim();

                    // Determine if the selected charger is a home charger
                    const isHomeCharger = selectedChargerNominalPower === HOME_CHARGER_KW;

                    // Determine the maximum power the car can accept, considering its C-rate and specific model
                    let carMaxAchievablePower = capacity * maxCRate; 
                    if (parseInt(modelPlatformVolt) === 800) { // For 800V platform models
                        if (maxCRate == 5) { // Flagship (74.9 kWh)
                            carMaxAchievablePower = Math.min(carMaxAchievablePower, 442); // New cap for 5C flagship 800V
                        } else if (maxCRate == 3) { // Long/Super Long Range (800V P7+)
                            if (capacity === 60.7) { // é•¿ç»­èˆª (60.7 kWh)
                                carMaxAchievablePower = Math.min(carMaxAchievablePower, 215); // Cap at 215kW for 800V
                            } else if (capacity === 76.3) { // è¶…é•¿ç»­èˆª (76.3 kWh)
                                carMaxAchievablePower = Math.min(carMaxAchievablePower, 265); // Cap at 265kW for 800V
                            }
                        }
                    } else if (parseInt(modelPlatformVolt) === 400) { // For 400V platform models (older P7) - though removed from selector, logic remains for robustness
                         if (maxCRate == 3) {
                            if (capacity === 60.7) { // é•¿ç»­èˆª (60.7 kWh, 400V) - older P7
                                carMaxAchievablePower = Math.min(carMaxAchievablePower, 180); // Typical max for 400V P7 Long Range
                            } else if (capacity === 76.3) { // è¶…é•¿ç»­èˆª (76.3 kWh, 400V) - older P7
                                carMaxAchievablePower = Math.min(carMaxAchievablePower, 220); // Typical max for 400V P7 Super Long Range
                            }
                        }
                    }


                    // Determine the total shared available power at the station
                    let stationTotalSharedPower;
                    if (selectedChargerNominalPower === S5_LIMIT_KW) {
                        stationTotalSharedPower = S5_LIMIT_KW;
                    } else if (selectedChargerNominalPower === S4_LIMIT_KW) {
                        stationTotalSharedPower = S4_LIMIT_KW;
                    } else {
                        stationTotalSharedPower = selectedChargerNominalPower;
                    }

                    // Calculate the effective power available per vehicle at the station, considering uneven distribution factor
                    let effectiveStationPowerPerVehicle;
                    if (isHomeCharger) { // For home charger, power is not shared or affected by other vehicles at a station
                        effectiveStationPowerPerVehicle = HOME_CHARGER_KW;
                    } else if (selectedChargerNominalPower === S5_LIMIT_KW || selectedChargerNominalPower === S4_LIMIT_KW) {
                        effectiveStationPowerPerVehicle = stationTotalSharedPower / numTotalVehicles;
                        // If number of vehicles sharing the station is greater than 2, introduce an additional impact factor
                        if (numTotalVehicles > 2) {
                            effectiveStationPowerPerVehicle *= 0.9; // 10% additional loss factor due to uneven distribution
                        }
                        // Apply specific rogue BMS penalty
                        if (rogueBMSCount > 0) {
                            effectiveStationPowerPerVehicle *= 0.85; // 15% additional loss factor
                        }
                        // Apply additional specific penalties for P7+ 800V models sharing the station
                        if (p7p_long_range_800v_count > 0 || p7p_super_long_range_800v_count > 0 || p7p_flagship_800v_count > 0) {
                             effectiveStationPowerPerVehicle *= 0.95; // 5% additional loss if any of these specific 800V P7+ models are present
                        }

                    } else {
                        effectiveStationPowerPerVehicle = selectedChargerNominalPower; // For S2 or third-party chargers, usually single-stall power, no station sharing distribution
                        // Apply specific rogue BMS penalty
                        if (rogueBMSCount > 0) {
                            effectiveStationPowerPerVehicle *= 0.85; // 15% additional loss factor
                        }
                        // Apply additional specific penalties for P7+ 800V models sharing the station (even if not S4/S5)
                        if (p7p_long_range_800v_count > 0 || p7p_super_long_range_800v_count > 0 || p7p_flagship_800v_count > 0) {
                             effectiveStationPowerPerVehicle *= 0.95; // 5% additional loss if any of these specific 800V P7+ models are present
                        }
                    }

                    let sessionMaxPower;
                    let applied3CLimit = false; // Flag to track if the 3C limit was applied

                    if (isHomeCharger) {
                        sessionMaxPower = HOME_CHARGER_KW;
                    } else {
                        sessionMaxPower = Math.min(carMaxAchievablePower, effectiveStationPowerPerVehicle);
                        
                        // Apply specific 3C/400V vehicle sharing cap if present AND it's a shared charger (S4/S5)
                        // This logic is now based on 'xp400vCount' from the "åŒç«™å ç”¨å……ç”µæ¡©è¯¦æƒ…" section
                        if ((selectedChargerNominalPower === S5_LIMIT_KW || selectedChargerNominalPower === S4_LIMIT_KW) && xp400vCount > 0) {
                            const originalSessionMaxPower = sessionMaxPower; // Store original session max power before applying this cap
                            sessionMaxPower = Math.min(sessionMaxPower, 190); // Cap at 190kW if other 400V XPeng vehicles are present at a shared station
                            if (sessionMaxPower < originalSessionMaxPower) { // Check if the cap actually reduced power
                                applied3CLimit = true;
                            }
                        }
                    }
                    
                    let chargeTimeSeconds = estimateRealisticChargeTime(startSoC, endSoC, capacity, sessionMaxPower, ui.enableCooling.checked, parseInt(maxCRate), isHomeCharger, parseInt(modelPlatformVolt));
                    
                    let extraLossFactor = 1.0;
                    const activeLossFactors = [];
                    if (ui.ac.checked) { extraLossFactor += 0.04; activeLossFactors.push('ç©ºè°ƒğŸŒ¬ï¸'); }
                    if (ui.preheat.checked) { extraLossFactor += 0.06; activeLossFactors.push('é¢„çƒ­ğŸ”¥'); }
                    if (ui.cold.checked) { extraLossFactor += 0.05; activeLossFactors.push('ä½æ¸©â„ï¸'); }
                    if (ui.hot.checked) { extraLossFactor += 0.07; activeLossFactors.push('é«˜æ¸©é…·çƒ­â˜€ï¸(+7%)'); } 
                    if (ui.autopilot.checked) { extraLossFactor += 0.02; activeLossFactors.push('æ™ºé©¾ğŸ§ (+2%)'); }
                    if (ui.load.checked) { extraLossFactor += 0.03; activeLossFactors.push('è½½äººğŸšš(+3%)'); }

                    chargeTimeSeconds *= extraLossFactor;

                    const calculatedChartDurationSeconds = chargeTimeSeconds > 0 ? chargeTimeSeconds : 1; 
                    const calculatedChartDurationMinutes = calculatedChartDurationSeconds / 60;

                    const deltaSoC = endSoC - startSoC;
                    const theoreticalKWh = capacity * (deltaSoC / 100);
                    const totalLossKWh = actualKWh - theoreticalKWh;
                    const lossRate = (totalLossKWh / theoreticalKWh) * 100;
                    const overallEfficiency = (theoreticalKWh / actualKWh) * 100;
                    
                    const theoreticalKWhPerPercent = theoreticalKWh / deltaSoC;
                    const actualKWhPerPercent = actualKWh / deltaSoC;

                    lastResultText = `
--- å……ç”µæŠ¥å‘Š ---
è½¦å‹: ${modelName}
å¹³å°ç”µå‹: ${isHomeCharger ? HOME_CHARGER_VOLTAGE : modelPlatformVolt}V
èµ·å§‹ç”µé‡: ${startSoC.toFixed(2)}%
ç»“æŸç”µé‡: ${endSoC.toFixed(2)}%
æ‹ŸçœŸä¼°ç®—æ—¶é•¿: ${formatChargeTime(chargeTimeSeconds)}
ç†è®ºå……ç”µé‡: ${theoreticalKWh.toFixed(3)} kWh
å®é™…å……ç”µé‡: ${actualKWh.toFixed(3)} kWh
æ€»è®¡æŸè€—é‡: ${totalLossKWh.toFixed(3)} kWh
å……ç”µæŸè€—ç‡: ${lossRate.toFixed(2)} %
ç»¼åˆå……ç”µæ•ˆç‡: ${overallEfficiency.toFixed(2)} %
å……ç”µæ¡©ç±»å‹: ${chargerTypeName}
åŒç«™å ç”¨è½¦è¾†æ€»æ•° (å«æœ¬è½¦): ${numTotalVehicles}
å…¶ä¸­P7+é•¿ç»­èˆª (60.7 kWh) 800Væ•°é‡: ${p7p_long_range_800v_count}
å…¶ä¸­P7+è¶…é•¿ç»­èˆª (76.3 kWh) 800Væ•°é‡: ${p7p_super_long_range_800v_count}
å…¶ä¸­P7+æ——èˆ° (74.9 kWh) 800Væ•°é‡: ${p7p_flagship_800v_count}
å…¶ä¸­å…¶ä»–å°é¹400Vè½¦æ•°é‡: ${xp400vCount}
å…¶ä¸­ç¬¬ä¸‰æ–¹800Vè½¦æ•°é‡: ${thirdParty800vCount}
å…¶ä¸­ç¬¬ä¸‰æ–¹400Vè½¦æ•°é‡: ${thirdParty400vCount}
å…¶ä¸­BMSæµæ°“è½¦å‹æ•°é‡: ${rogueBMSCount}
${applied3CLimit ? `ç‰¹åˆ«é™åˆ¶: è‹¥åŒç«™å­˜åœ¨å°é¹400Vè½¦å‹å……ç”µï¼Œå……ç”µåŠŸç‡ä¸Šé™å·²é™åˆ¶åœ¨ 190kWã€‚\n` : ''}é¢å¤–æŸè€—å› å­: ${activeLossFactors.length > 0 ? activeLossFactors.join('ã€') : 'æ— '}
S5å†·å´æ˜¯å¦å¯ç”¨: ${ui.enableCooling.checked ? 'æ˜¯' : 'å¦'}
`;
                    ui.resultText.innerText = lastResultText;
                    ui.resultContainer.classList.remove('hidden');

                    // Store all relevant data for LLM call
                    window.lastCalculatedData = { 
                        modelName,
                        platformVoltage: isHomeCharger ? HOME_CHARGER_VOLTAGE : parseFloat(modelPlatformVolt),
                        startSoC: startSoC,
                        endSoC: endSoC,
                        formattedChargeTime: formatChargeTime(chargeTimeSeconds),
                        theoreticalKWh: theoreticalKWh,
                        actualKWh: actualKWh,
                        totalLossKWh: totalLossKWh,
                        lossRate: lossRate,
                        overallEfficiency: overallEfficiency,
                        chargerTypeName: chargerTypeName,
                        totalVehiclesAtStation: numTotalVehicles, 
                        p7p_long_range_800v_count: p7p_long_range_800v_count,
                        p7p_super_long_range_800v_count: p7p_super_long_range_800v_count,
                        p7p_flagship_800v_count: p7p_flagship_800v_count,
                        xp400vCount: xp400vCount,
                        thirdParty800vCount: thirdParty800vCount,
                        thirdParty400vCount: thirdParty400vCount,
                        rogueBMSCount: rogueBMSCount, 
                        activeLossFactors: activeLossFactors,
                        isCoolingEnabled: ui.enableCooling.checked,
                        is3CLimitApplied: applied3CLimit // Add this flag
                    };

                    const detailedData = generateDetailedData(startSoC, endSoC, capacity, sessionMaxPower, ui.enableCooling.checked, parseInt(maxCRate), isHomeCharger ? HOME_CHARGER_VOLTAGE : parseFloat(modelPlatformVolt), isHomeCharger, parseInt(modelPlatformVolt));
                    displayDetailedTable(detailedData); 
                    ui.tableContainer.classList.remove('hidden'); 
                    ui.smartAdviceContainer.classList.add('hidden'); 

                    destroyAllCharts(); 

                    updateLossChart(theoreticalKWh, totalLossKWh);
                    updateEfficiencyChart(theoreticalKWhPerPercent, actualKWhPerPercent); 
                    updateIVChart(sessionMaxPower, isHomeCharger ? HOME_CHARGER_VOLTAGE : parseFloat(modelPlatformVolt), calculatedChartDurationMinutes, isHomeCharger, startSoC, endSoC); 
                    updateSoCChart(startSoC, endSoC, calculatedChartDurationMinutes);
                    updateTempEfficiencyChart();

                } catch (error) {
                    console.error("Error during calculation:", error);
                    showCustomAlert(`Error during calculation: ${error.message}. Please check your inputs or contact the developer.`);
                } finally {
                    hideLoadingIndicator(); // Always hide loading indicator
                }
            }, 100); // Small delay to allow loading indicator to show
        }
        
        /**
         * Generates detailed report data for charge current, voltage, and power per 1% SoC.
         * @param {number} startSoC - Starting SoC.
         * @param {number} endSoC - Ending SoC.
         * @param {number} batteryCapacity - Battery capacity.
         * @param {number} sessionMaxPower - Max power for the session.
         * @param {boolean} isCoolingEnabled - Is cooling enabled.
         * @param {number} maxCRate - Max C-rate.
         * @param {number} displayedPlatformVoltage - Voltage displayed in UI (e.g., 800V or 220V).
         * @param {boolean} isHomeCharger - Is it a home charger.
         * @param {number} modelPlatformVoltage - The actual platform voltage of the selected model (e.g., 800 or 400).
         * @returns {Array<Object>} Array of data points with SoC, power, voltage, and amps.
         */
        function generateDetailedData(startSoC, endSoC, batteryCapacity, sessionMaxPower, isCoolingEnabled, maxCRate, displayedPlatformVoltage, isHomeCharger, modelPlatformVoltage) {
            const data = [];
            const socStep = 1; 
            let currentSoC = Math.floor(startSoC); 
            let currentZoneIndex = 0;

            let socZonesModel;
            // For home chargers, power is stable and does not decay with SoC.
            if (isHomeCharger) {
                // Simplified "zone" for home charger with constant power.
                socZonesModel = [{ upto: 100, factor: 1.0 }]; 
            } else if (maxCRate === 5) { // Flagship (74.9 kWh, 5C) model factors (NCM)
                if (isCoolingEnabled) {
                    // Optimized for 442kW peak
                    socZonesModel = [
                        { upto: 2, factor: 0.98 }, 
                        { upto: 10, factor: 0.95 }, 
                        { upto: 30, factor: 0.90 }, 
                        { upto: 50, factor: 0.75 }, 
                        { upto: 70, factor: 0.65 }, 
                        { upto: 85, factor: 0.50 }, 
                        { upto: 90, factor: 0.35 }, 
                        { upto: 95, factor: 0.20 }, 
                        { upto: 100, factor: 0.08 } 
                    ];
                } else { // No cooling - slightly lower factors
                    socZonesModel = [
                        { upto: 2, factor: 0.90 }, 
                        { upto: 10, factor: 0.85 },
                        { upto: 30, factor: 0.78 },
                        { upto: 50, factor: 0.65 },
                        { upto: 70, factor: 0.50 },
                        { upto: 85, factor: 0.35 },
                        { upto: 90, factor: 0.25 },
                        { upto: 95, factor: 0.15 },
                        { upto: 100, factor: 0.05 }
                    ];
                }
            } else if (maxCRate === 3) { // Long/Super Long Range (3C) model factors (LFP)
                if (modelPlatformVoltage === 800) { // Specific factors for 800V 3C models
                    if (batteryCapacity === 60.7) { // é•¿ç»­èˆª 800V
                        if (isCoolingEnabled) {
                            socZonesModel = [
                                { upto: 2, factor: 0.995 }, 
                                { upto: 10, factor: 0.97 }, 
                                { upto: 30, factor: 0.83 }, 
                                { upto: 50, factor: 0.68 }, 
                                { upto: 70, factor: 0.53 }, 
                                { upto: 85, factor: 0.40 }, 
                                { upto: 90, factor: 0.30 }, 
                                { upto: 95, factor: 0.22 }, 
                                { upto: 98, factor: 0.12 }, 
                                { upto: 100, factor: 0.05 } 
                            ];
                        } else { // No cooling
                            socZonesModel = [
                                { upto: 2, factor: 0.96 },
                                { upto: 10, factor: 0.92 },
                                { upto: 30, factor: 0.75 },
                                { upto: 50, factor: 0.58 },
                                { upto: 70, factor: 0.42 },
                                { upto: 85, factor: 0.28 },
                                { upto: 90, factor: 0.20 },
                                { upto: 95, factor: 0.12 },
                                { upto: 98, factor: 0.05 },
                                { upto: 100, factor: 0.02 }
                            ];
                        }
                    } else if (batteryCapacity === 76.3) { // è¶…é•¿ç»­èˆª 800V
                        if (isCoolingEnabled) {
                            socZonesModel = [
                                { upto: 2, factor: 0.995 },
                                { upto: 10, factor: 0.98 }, 
                                { upto: 30, factor: 0.97 },
                                { upto: 50, factor: 0.93 },
                                { upto: 70, factor: 0.82 },
                                { upto: 85, factor: 0.65 },
                                { upto: 90, factor: 0.45 },
                                { upto: 95, factor: 0.25 },
                                { upto: 98, factor: 0.08 },
                                { upto: 100, factor: 0.03 }
                            ];
                        } else { // No cooling
                            socZonesModel = [
                                { upto: 2, factor: 0.96 },
                                { upto: 10, factor: 0.93 },
                                { upto: 30, factor: 0.88 },
                                { upto: 50, factor: 0.75 },
                                { upto: 70, factor: 0.60 },
                                { upto: 85, factor: 0.40 },
                                { upto: 90, factor: 0.25 },
                                { upto: 95, factor: 0.15 },
                                { upto: 98, factor: 0.06 },
                                { upto: 100, factor: 0.025 }
                            ];
                        }
                    }
                } else if (modelPlatformVoltage === 400) { // Specific factors for 400V 3C models (older P7)
                    if (batteryCapacity === 60.7) { // é•¿ç»­èˆª 400V
                        if (isCoolingEnabled) { // Assumes some form of thermal management
                            socZonesModel = [
                                { upto: 2, factor: 0.90 }, 
                                { upto: 10, factor: 0.85 }, 
                                { upto: 30, factor: 0.70 }, 
                                { upto: 50, factor: 0.55 }, 
                                { upto: 70, factor: 0.40 }, 
                                { upto: 85, factor: 0.25 }, 
                                { upto: 90, factor: 0.18 }, 
                                { upto: 95, factor: 0.10 }, 
                                { upto: 98, factor: 0.06 }, 
                                { upto: 100, factor: 0.02 } 
                            ];
                        } else { // No cooling
                            socZonesModel = [
                                { upto: 2, factor: 0.85 },
                                { upto: 10, factor: 0.80 },
                                { upto: 30, factor: 0.65 },
                                { upto: 50, factor: 0.50 },
                                { upto: 70, factor: 0.35 },
                                { upto: 85, factor: 0.20 },
                                { upto: 90, factor: 0.12 },
                                { upto: 95, factor: 0.08 },
                                { upto: 98, factor: 0.04 },
                                { upto: 100, factor: 0.015 }
                            ];
                        }
                    } else if (batteryCapacity === 76.3) { // è¶…é•¿ç»­èˆª 400V
                        if (isCoolingEnabled) {
                            socZonesModel = [
                                { upto: 2, factor: 0.95 },
                                { upto: 10, factor: 0.90 }, 
                                { upto: 30, factor: 0.85 },
                                { upto: 50, factor: 0.70 },
                                { upto: 70, factor: 0.55 },
                                { upto: 85, factor: 0.40 },
                                { upto: 90, factor: 0.28 },
                                { upto: 95, factor: 0.18 },
                                { upto: 98, factor: 0.07 },
                                { upto: 100, factor: 0.025 }
                            ];
                        } else { // No cooling
                            socZonesModel = [
                                { upto: 2, factor: 0.90 },
                                { upto: 10, factor: 0.85 },
                                { upto: 30, factor: 0.78 },
                                { upto: 50, factor: 0.65 },
                                { upto: 70, factor: 0.48 },
                                { upto: 85, factor: 0.35 },
                                { upto: 90, factor: 0.20 },
                                { upto: 95, factor: 0.10 },
                                { upto: 98, factor: 0.05 },
                                { upto: 100, factor: 0.01 }
                            ];
                        }
                    }
                }
            } else {
                // Default or fallback factors (should not occur with current options)
                socZonesModel = [
                    { upto: 60, factor: 0.88 }, 
                    { upto: 80, factor: 0.58 }, 
                    { upto: 95, factor: 0.33 }, 
                    { upto: 100, factor: 0.15 } 
                ];
            }


            while (currentSoC < endSoC) {
                const nextSoC = Math.min(currentSoC + socStep, endSoC);

                // Advance currentZoneIndex if needed
                while (currentZoneIndex < socZonesModel.length && currentSoC >= socZonesModel[currentZoneIndex].upto) {
                    currentZoneIndex++;
                }

                let canProcessSoC = true; // Flag to control processing this SoC step
                let effectivePowerAtSoC = 0;
                let simulatedVoltageAtSoC = 0;
                let estimatedCurrentAtSoC = 0;

                if (currentZoneIndex >= socZonesModel.length) {
                    // No valid zone found for currentSoC, just advance SoC
                    canProcessSoC = false;
                } else {
                    const currentZone = socZonesModel[currentZoneIndex];
                    
                    if (!currentZone || typeof currentZone.factor === 'undefined') {
                        console.error("Error: Invalid charging zone data or factor found at SoC segment", currentSoC, ". Index:", currentZoneIndex, "Zone Model Length:", socZonesModel.length, "Current Zone:", currentZone);
                        canProcessSoC = false;
                    } else {
                        // If home charger, effective power is constant sessionMaxPower, no decay factor.
                        effectivePowerAtSoC = isHomeCharger ? sessionMaxPower : sessionMaxPower * currentZone.factor;

                        if (effectivePowerAtSoC <= 0) {
                            canProcessSoC = false;
                        } else {
                            if (isHomeCharger) {
                                simulatedVoltageAtSoC = HOME_CHARGER_VOLTAGE; // Fixed 220V for home charger
                            } else {
                                // Use the modelPlatformVoltage for realistic voltage simulation
                                const voltageBase = modelPlatformVoltage; 
                                const simulatedSoCForVoltage = currentSoC + (socStep / 2); // Use midpoint for voltage simulation
                                if (simulatedSoCForVoltage < 20) {
                                    simulatedVoltageAtSoC = voltageBase * getRandomFloat(0.970, 0.990);
                                } else if (simulatedSoCForVoltage < 50) {
                                    simulatedVoltageAtSoC = voltageBase * getRandomFloat(0.985, 1.005);
                                } else {
                                    simulatedVoltageAtSoC = voltageBase * getRandomFloat(0.995, 1.015);
                                }
                                // Clamp for 800V platform
                                if (modelPlatformVoltage === 800) {
                                     simulatedVoltageAtSoC = Math.max(750, Math.min(850, simulatedVoltageAtSoC));
                                } else { // Clamp for 400V platform (adjust as needed for typical 400V behavior)
                                    simulatedVoltageAtSoC = Math.max(380, Math.min(420, simulatedVoltageAtSoC));
                                }
                            }
                            estimatedCurrentAtSoC = (effectivePowerAtSoC * 1000) / simulatedVoltageAtSoC;
                        }
                    }
                }
                
                if (canProcessSoC) {
                    data.push({ soc: currentSoC, power: effectivePowerAtSoC, voltage: simulatedVoltageAtSoC, amps: estimatedCurrentAtSoC });
                }
                
                currentSoC = nextSoC; // Always advance SoC for the next iteration
            }
            return data;
        }

        /**
         * Displays the detailed data table.
         * @param {Array<Object>} data - Data containing SoC, power, voltage, and current.
         */
        function displayDetailedTable(data) {
            const tableHead = document.querySelector('#dataTable thead');
            if (tableHead) {
                tableHead.innerHTML = `<tr><th>SoC(%)</th><th>åŠŸç‡(kW)</th><th>ç”µå‹(V)</th><th>ç”µæµ(A)</th></tr>`;
            } else {
                console.error("Could not find #dataTable thead element.");
            }
            ui.dataTableBody.innerHTML = data.map(d => `<tr><td>${d.soc.toFixed(2)}</td><td>${d.power.toFixed(2)}</td><td>${d.voltage.toFixed(0)}</td><td>${d.amps.toFixed(2)}</td></tr>`).join('');
            ui.tableContainer.classList.remove('hidden');
        }

        /**
         * Quickly estimates charging time.
         */
        function quickEstimate() {
            const capacity = parseFloat(ui.model.value);
            const selectedModelOption = ui.model.selectedOptions[0];
            const { volt: modelPlatformVolt, c: maxCRate } = selectedModelOption.dataset;
            const selectedChargerNominalPower = parseFloat(ui.charger.value);
            
            // Get individual counts of *other* vehicles
            const p7p_long_range_800v_count = parseInt(ui.p7p_long_range_800v_count.value) || 0;
            const p7p_super_long_range_800v_count = parseInt(ui.p7p_super_long_range_800v_count.value) || 0;
            const p7p_flagship_800v_count = parseInt(ui.p7p_flagship_800v_count.value) || 0;
            const xp400vCount = parseInt(ui.xp400vCount.value) || 0;
            const thirdParty800vCount = parseInt(ui.thirdParty800vCount.value) || 0;
            const thirdParty400vCount = parseInt(ui.thirdParty400vCount.value) || 0;
            const rogueBMSCount = parseInt(ui.rogueBMSCount.value) || 0;

            // numTotalVehicles represents the total vehicles at the station, including the user's car
            let numTotalVehicles = 1 + p7p_long_range_800v_count + p7p_super_long_range_800v_count + p7p_flagship_800v_count + xp400vCount + thirdParty800vCount + thirdParty400vCount + rogueBMSCount;

            const start = parseFloat(ui.quickStart.value);
            const end = parseFloat(ui.quickEnd.value);

            if (isNaN(start) || isNaN(end) || start >= end || capacity <= 0 || selectedChargerNominalPower <= 0 || isNaN(numTotalVehicles)) {
                showCustomAlert("Invalid input. Please check start and end SoC, and ensure start SoC is less than end SoC.");
                ui.quickResult.textContent = "è¾“å…¥æ— æ•ˆ";
                return;
            }

            const isHomeCharger = selectedChargerNominalPower === HOME_CHARGER_KW; // Determine if home charger

            let carMaxAchievablePower = capacity * maxCRate;
            if (parseInt(modelPlatformVolt) === 800) { // For 800V platform models
                if (maxCRate == 5) { // Flagship (74.9 kWh)
                    carMaxAchievablePower = Math.min(carMaxAchievablePower, 442); // Cap at 442kW for 800V
                } else if (maxCRate == 3) { // Long/Super Long Range (800V P7+)
                    if (capacity === 60.7) { // é•¿ç»­èˆª (60.7 kWh)
                        carMaxAchievablePower = Math.min(carMaxAchievablePower, 215); // Cap at 215kW for 800V
                    } else if (capacity === 76.3) { // è¶…é•¿ç»­èˆª (76.3 kWh)
                        carMaxAchievablePower = Math.min(carMaxAchievablePower, 265); // Cap at 265kW for 800V
                    }
                }
            } else if (parseInt(modelPlatformVolt) === 400) { // For 400V platform models
                if (maxCRate == 3) {
                    if (capacity === 60.7) { // é•¿ç»­èˆª (60.7 kWh, 400V) - older P7
                        carMaxAchievablePower = Math.min(carMaxAchievablePower, 180); // Typical max for 400V P7 Long Range
                    } else if (capacity === 76.3) { // è¶…é•¿ç»­èˆª (76.3 kWh, 400V) - older P7
                        carMaxAchievablePower = Math.min(carMaxAchievablePower, 220); // Typical max for 400V P7 Super Long Range
                    }
                }
            }
            
            let stationTotalSharedPower;
            if (selectedChargerNominalPower === S5_LIMIT_KW) {
                stationTotalSharedPower = S5_LIMIT_KW;
            } else if (selectedChargerNominalPower === S4_LIMIT_KW) {
                stationTotalSharedPower = S4_LIMIT_KW;
            } else {
                stationTotalSharedPower = selectedChargerNominalPower;
            }

            let effectiveStationPowerPerVehicle;
            if (isHomeCharger) { // For home charger, power is not shared or affected by other vehicles at a station
                effectiveStationPowerPerVehicle = HOME_CHARGER_KW;
            } else if (selectedChargerNominalPower === S5_LIMIT_KW || selectedChargerNominalPower === S4_LIMIT_KW) {
                effectiveStationPowerPerVehicle = stationTotalSharedPower / numTotalVehicles;
                // If number of vehicles sharing the station is greater than 2, introduce an additional impact factor
                if (numTotalVehicles > 2) {
                    effectiveStationPowerPerVehicle *= 0.9; // 10% additional loss factor due to uneven distribution
                }
                // Apply specific rogue BMS penalty
                if (rogueBMSCount > 0) {
                    effectiveStationPowerPerVehicle *= 0.85; // 15% additional loss factor
                }
                // Apply additional specific penalties for P7+ 800V models sharing the station
                if (p7p_long_range_800v_count > 0 || p7p_super_long_range_800v_count > 0 || p7p_flagship_800v_count > 0) {
                     effectiveStationPowerPerVehicle *= 0.95; // 5% additional loss if any of these specific 800V P7+ models are present
                }

            } else {
                effectiveStationPowerPerVehicle = selectedChargerNominalPower; // For S2 or third-party chargers, usually single-stall power, no station sharing distribution
                // Apply specific rogue BMS penalty
                if (rogueBMSCount > 0) {
                    effectiveStationPowerPerVehicle *= 0.85; // 15% additional loss factor
                }
                 // Apply additional specific penalties for P7+ 800V models sharing the station (even if not S4/S5)
                if (p7p_long_range_800v_count > 0 || p7p_super_long_range_800v_count > 0 || p7p_flagship_800v_count > 0) {
                     effectiveStationPowerPerVehicle *= 0.95; // 5% additional loss if any of these specific 800V P7+ models are present
                }
            }
            
            let sessionMaxPower;
            if (isHomeCharger) {
                sessionMaxPower = HOME_CHARGER_KW;
            } else {
                sessionMaxPower = Math.min(carMaxAchievablePower, effectiveStationPowerPerVehicle);
                if ((selectedChargerNominalPower === S5_LIMIT_KW || selectedChargerNominalPower === S4_LIMIT_KW) && xp400vCount > 0) {
                    sessionMaxPower = Math.min(sessionMaxPower, 190); 
                }
            }


            let timeSeconds = estimateRealisticChargeTime(start, end, capacity, sessionMaxPower, ui.enableCooling.checked, parseInt(maxCRate), isHomeCharger, parseInt(modelPlatformVolt));
            
            let extraLossFactor = 1.0;
            if (ui.ac.checked) extraLossFactor += 0.04;
            if (ui.preheat.checked) extraLossFactor += 0.06;
            if (ui.cold.checked) extraLossFactor += 0.05;
            if (ui.hot.checked) extraLossFactor += 0.07; 
            if (ui.autopilot.checked) extraLossFactor += 0.02;
            if (ui.load.checked) extraLossFactor += 0.03;
            timeSeconds *= extraLossFactor;

            ui.quickResult.textContent = `â‰ˆ ${formatChargeTime(timeSeconds)}`;
        }

        /**
         * Calls the Gemini API to get smart charging advice.
         */
        async function getSmartChargingAdvice() {
            if (!window.lastCalculatedData) { 
                showCustomAlert("Please calculate a charging report first to get smart advice.");
                return;
            }

            showLoadingIndicator("æ­£åœ¨ç”Ÿæˆæ™ºèƒ½å……ç”µå»ºè®®...");
            ui.smartAdviceContainer.classList.remove('hidden');
            ui.smartAdvice.textContent = "AI is thinking, please wait..."; // Clear previous advice and show loading message

            try {
                const {
                    modelName, platformVoltage, startSoC, endSoC, formattedChargeTime,
                    theoreticalKWh, actualKWh, totalLossKWh, lossRate, overallEfficiency,
                    chargerTypeName, totalVehiclesAtStation, rogueBMSCount, activeLossFactors, isCoolingEnabled, is3CLimitApplied
                } = window.lastCalculatedData; 

                const prompt = `
You are an expert in electric vehicle charging. Based on the following charging data and scenario for Xpeng P7+, please provide specific charging recommendations for the owner.
Vehicle Model: ${modelName}
Platform Voltage: ${platformVoltage}V
Starting SoC: ${startSoC.toFixed(2)}%
Ending SoC: ${endSoC.toFixed(2)}%
Estimated Duration: ${formattedChargeTime}
Theoretical Charge Amount: ${theoreticalKWh.toFixed(3)} kWh
Actual Charge Amount: ${actualKWh.toFixed(3)} kWh
Total Loss Amount: ${totalLossKWh.toFixed(3)} kWh
Charging Loss Rate: ${lossRate.toFixed(2)} %
Overall Charging Efficiency: ${overallEfficiency.toFixed(2)} %
Charger Type: ${chargerTypeName}
Total Occupied Chargers at Station (including this vehicle): ${totalVehiclesAtStation}
Number of BMS Rogue Models: ${rogueBMSCount}
Special Limit Applied: ${is3CLimitApplied ? 'Yes (capped at 190kW due to other 400V XPeng vehicles)' : 'No'}
Additional Loss Factors: ${activeLossFactors.length > 0 ? activeLossFactors.join('ã€') : 'None'}
S5 Cooling Enabled: ${isCoolingEnabled ? 'Yes' : 'No'}

Please provide at least 3 but no more than 5 recommendations from the following aspects, with each recommendation not exceeding 50 characters:
1. How to further optimize charging efficiency or speed.
2. Recommendations for the current charging scenario (e.g., long charging times, specific SoC range recommendations).
3. General advice on battery health or charging habits.
4. If there is significant loss, suggest possible causes and mitigation advice.
Please answer in Simplified Chinese, present the recommendations as bullet points, and maintain a professional and easy-to-understand tone.
`;
                
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // API key should be handled by the Canvas environment for gemini-2.0-flash
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData); // Log the full error response
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    ui.smartAdvice.textContent = text;
                } else {
                    ui.smartAdvice.textContent = "Could not get smart advice. Please try again later or adjust your input.";
                    console.error("LLM response structure anomaly:", result);
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                ui.smartAdvice.textContent = `Failed to get advice: ${error.message}`;
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Copies the result text to the clipboard and shows a toast notification.
         */
        function copyResult() {
            if (!lastResultText) return;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = lastResultText.trim();
            tempTextArea.style.position = "fixed"; 
            tempTextArea.style.left = "-9999px"; 
            document.body.appendChild(tempTextArea);
            tempTextArea.select(); 

            try {
                document.execCommand('copy'); 
                const toast = document.getElementById('toast');
                toast.classList.remove('opacity-0');
                setTimeout(() => toast.classList.add('opacity-0'), 2000); 
            } catch (err) {
                console.error('Failed to copy content:', err); 
                showCustomAlert('Copy failed, please copy manually.');
            } finally {
                document.body.removeChild(tempTextArea); 
            }
        }

        /**
         * Toggles the visibility of the changelog modal.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleChangelogModal(show) { 
            document.getElementById('changelog-modal').classList.toggle('hidden', !show); 
        }

        /**
         * Toggles fullscreen mode for the document.
         */
        function toggleFullscreen() {
            const docElem = document.documentElement;
            const requestFn = docElem.requestFullscreen ||
                              docElem.webkitRequestFullscreen || 
                              docElem.mozRequestFullScreen ||    
                              docElem.msRequestFullscreen;       

            if (requestFn) {
                if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                    requestFn.call(docElem).catch(err => showCustomAlert(`Could not enter fullscreen: ${err.message}`));
                } else {
                    const exitFn = document.exitFullscreen ||
                                   document.webkitExitFullscreen || 
                                   document.mozCancelFullScreen ||    
                                   document.msExitFullscreen;       
                    if (exitFn) {
                        exitFn.call(document).catch(err => showCustomAlert(`Could not exit fullscreen: ${err.message}`));
                    } else {
                        showCustomAlert("Your browser or current environment does not support exiting fullscreen mode.");
                    }
                }
            } else {
                showCustomAlert("Your browser or current environment does not support fullscreen mode.");
            }
        }
        
        // --- Chart Configuration Defaults ---
        Chart.defaults.font.family = "'VT323', monospace";
        Chart.defaults.font.size = 16;
        Object.defineProperty(Chart.defaults, 'color', {
            get: () => getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim() || '#00ffcc',
            set: () => {}
        });

        // --- Chart Options Template ---
        const chartOptionsTemplate = (title, displayLegend = false) => ({
            responsive: true,
            maintainAspectRatio: true,
            plugins: { 
                title: { 
                    display: true, 
                    text: title, 
                    color: getComputedStyle(document.documentElement).getPropertyValue('--title-color').trim() || '#00ffff', 
                    font: { size: 20 } 
                }, 
                legend: { 
                    display: displayLegend, 
                    labels: { 
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim() || '#00ffcc' 
                    } 
                },
                tooltip: { 
                    mode: 'index', 
                    intersect: false, 
                    callbacks: { 
                        title: function(context) { return context[0].label; },
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed && typeof context.parsed.y !== 'undefined' && context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(2);
                            } else if (context.parsed && typeof context.parsed.value !== 'undefined' && context.parsed.value !== null) {
                                label += context.parsed.value.toFixed(2);
                            }
                            return label;
                        }
                    }
                }
            },
            hover: { 
                mode: 'index',
                intersect: false
            },
            scales: { 
                x: { 
                    ticks: { 
                        color: getComputedStyle(document.documentElement).getPropertyValue('--label-color').trim() || '#00ffaa' 
                    }, 
                    grid: { 
                        color: getComputedStyle(document.documentElement).getPropertyValue('--panel-border').trim() || 'rgba(0, 255, 170, 0.2)' 
                    } 
                }, 
                y: { 
                    ticks: { 
                        color: getComputedStyle(document.documentElement).getPropertyValue('--label-color').trim() || '#00ffaa' 
                    }, 
                    grid: { 
                        color: getComputedStyle(document.documentElement).getPropertyValue('--panel-border').trim() || 'rgba(0, 255, 170, 0.2)' 
                    }, 
                    beginAtZero: true 
                } 
            }
        });

        // --- Chart Update Functions ---

        /**
         * Updates the loss distribution chart (doughnut chart).
         * @param {number} theoretical - Theoretical kWh.
         * @param {number} loss - Total loss kWh.
         */
        function updateLossChart(theoretical, loss) {
            destroyChart('loss');
            const ctx = document.getElementById('lossChart').getContext('2d');
            if (!ctx) { console.error("Loss chart context not found!"); return; }

            charts['loss'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['æœ‰æ•ˆå……ç”µ', 'å……ç”µæŸè€—'],
                    datasets: [{
                        data: [theoretical, loss],
                        backgroundColor: [
                            getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
                            '#ff3366' /* Fixed red for loss */
                        ],
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-color').includes('linear-gradient') ? 'transparent' : getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim(),
                        borderWidth: 4
                    }]
                },
                options: chartOptionsTemplate('âš¡ ç”µé‡æŸè€—åˆ†å¸ƒ', true)
            });
        }

        /**
         * Updates the efficiency comparison chart (bar chart).
         * @param {number} theoreticalRate - Theoretical kWh per 1% SoC.
         * @param {number} actualRate - Actual kWh per 1% SoC.
         */
        function updateEfficiencyChart(theoreticalRate, actualRate) {
            destroyChart('eff');
            const ctx = document.getElementById('effChart').getContext('2d');
            if (!ctx) { console.error("Efficiency chart context not found!"); return; }

            charts['eff'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ç†è®ºå•ä½ç”µè€—', 'å®é™…å•ä½ç”µè€—'],
                    datasets: [{
                        label: 'å•ä½ç”µè€— (kWh/%)',
                        backgroundColor: [
                             getComputedStyle(document.documentElement).getPropertyValue('--button-primary-bg').split('), ')[0].replace('linear-gradient(45deg, ', '') || '#00bfff', 
                             getComputedStyle(document.documentElement).getPropertyValue('--button-secondary-bg').split('), ')[0].replace('linear-gradient(45deg, ', '') || '#ff9900', 
                        ],
                        data: [theoreticalRate, actualRate],
                        borderRadius: 8, 
                        borderWidth: 2,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--panel-border').trim()
                    }]
                },
                options: chartOptionsTemplate('ğŸ“Š å•ä½ç”µè€—æ•ˆç‡å¯¹æ¯”')
            });
        }
        
        /**
         * Updates the simulated current/voltage chart (line chart).
         * @param {number} powerKW - Max session power (kW).
         * @param {number} nominalVoltage - Nominal battery voltage (e.g., 800V or 220V).
         * @param {number} minutes - Total charge duration in minutes (must be > 0).
         * @param {boolean} isHomeCharger - True if it's a home charger.
         * @param {number} startSoC - Starting SoC (for simulating voltage fluctuations).
         * @param {number} endSoC - Ending SoC (for simulating voltage fluctuations).
         */
        function updateIVChart(powerKW, nominalVoltage, minutes, isHomeCharger, startSoC, endSoC) {
            destroyChart('iv');
            const ctx = document.getElementById('ivChart').getContext('2d');
            if (!ctx) { console.error("IV chart context not found!"); return; }

            const totalDurationSeconds = minutes * 60;
            const maxPoints = 100;
            const intervalSeconds = totalDurationSeconds > maxPoints ? Math.round(totalDurationSeconds / maxPoints) : 1; 
            const timeLabels = Array.from({ length: Math.floor(totalDurationSeconds / intervalSeconds) + 1 }, (_, i) => formatChargeTime(i * intervalSeconds));
            const currentData = [], voltageData = [];

            timeLabels.forEach((_, index) => {
                let currentPower = powerKW; 
                let currentVoltage; 

                if (isHomeCharger) {
                    currentPower = HOME_CHARGER_KW; // Home charger power is constant
                    currentVoltage = HOME_CHARGER_VOLTAGE; // Fixed 220V for home charger
                } else {
                    const s = index * intervalSeconds;
                    const progressRatio = s / totalDurationSeconds; 
                    // Simulate power tapering for the IV chart (more aggressive drop than actual charge time model)
                    if (progressRatio > 0.8) currentPower *= 0.4;
                    else if (progressRatio > 0.6) currentPower *= 0.6;
                    else if (progressRatio > 0.3) currentPower *= 0.8;

                    const simulatedSoC = startSoC + (endSoC - startSoC) * progressRatio;
                    // For the chart, use the nominalVoltage passed in (which is `modelPlatformVolt` from calculate())
                    const voltageBase = nominalVoltage; 
                    if (simulatedSoC < 20) {
                        currentVoltage = voltageBase * getRandomFloat(0.970, 0.990);
                    } else if (simulatedSoC < 50) {
                        currentVoltage = voltageBase * getRandomFloat(0.985, 1.005);
                    } else {
                        currentVoltage = voltageBase * getRandomFloat(0.995, 1.015);
                    }
                    // Clamp voltage based on platform
                    if (voltageBase === 800) {
                        currentVoltage = Math.max(750, Math.min(850, currentVoltage));
                    } else if (voltageBase === 400) {
                        currentVoltage = Math.max(380, Math.min(420, currentVoltage));
                    }
                }

                if (currentPower <= 0) {
                    // If current power is zero or negative, skip this point (current and voltage would be invalid)
                } else {
                    const estimatedCurrent = (currentPower * 1000) / currentVoltage;
                    currentData.push(estimatedCurrent);
                    voltageData.push(currentVoltage);
                }
            });

            const options = chartOptionsTemplate(`ğŸ“‰ æ¨¡æ‹Ÿç”µæµ/ç”µå‹ (${nominalVoltage}V å¹³å°)`, true);
            options.scales.y1 = { 
                type: 'linear', 
                position: 'left', 
                ticks: { 
                    color: getComputedStyle(document.documentElement).getPropertyValue('--label-color').trim() 
                }, 
                title: { display: true, text: 'ç”µæµ (A)', color: getComputedStyle(document.documentElement).getPropertyValue('--label-color').trim() } 
            };
            options.scales.y2 = { 
                type: 'linear', 
                position: 'right', 
                ticks: { 
                    color: getComputedStyle(document.documentElement).getPropertyValue('--button-secondary-border').trim(),
                    callback: function(value) { 
                        return value.toFixed(0);
                    }
                }, 
                grid: { drawOnChartArea: false }, 
                title: { display: true, text: 'ç”µå‹ (V)', color: getComputedStyle(document.documentElement).getPropertyValue('--button-secondary-border').trim() } 
            };
            // Adjust Y2 (Voltage) axis limits based on charger type
            if (nominalVoltage === HOME_CHARGER_VOLTAGE) { // Home charger
                options.scales.y2.min = 200; 
                options.scales.y2.max = 240;
                options.scales.y2.beginAtZero = false; 
            } else if (nominalVoltage === 800) { // 800V platform
                options.scales.y2.min = 750; 
                options.scales.y2.max = 850;
                options.scales.y2.beginAtZero = false;
            } else if (nominalVoltage === 400) { // 400V platform
                options.scales.y2.min = 380; 
                options.scales.y2.max = 420;
                options.scales.y2.beginAtZero = false;
            }

            delete options.scales.y; // Remove default 'y' axis if y1 and y2 are defined

            charts['iv'] = new Chart(ctx, {
                type: 'line', 
                data: { 
                    labels: timeLabels, 
                    datasets: [
                        { label: 'ç”µæµ (A)', data: currentData, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--button-primary-border').trim(), yAxisID: 'y1', tension: 0.4, fill: false, pointRadius: 2 },
                        { label: 'ç”µå‹ (V)', data: voltageData, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--button-secondary-border').trim(), yAxisID: 'y2', tension: 0.4, fill: false, pointRadius: 2 }
                    ]
                }, 
                options: options
            });
        }
        
        /**
         * Updates the SoC chart (line chart).
         * @param {number} startSoC - Starting SoC (%).
         * @param {number} endSoC - Ending SoC (%).
         * @param {number} durationMinutes - Total charge duration in minutes (must be > 0).
         */
        function updateSoCChart(startSoC, endSoC, durationMinutes) {
            destroyChart('soc');
            const ctx = document.getElementById('socChart').getContext('2d');
            if (!ctx) { console.error("SoC chart context not found!"); return; }

            const totalDurationSeconds = durationMinutes * 60;
            const maxPoints = 100;
            const intervalSeconds = totalDurationSeconds > maxPoints ? Math.round(totalDurationSeconds / maxPoints) : 1; 
            const timeLabels = Array.from({ length: Math.floor(totalDurationSeconds / intervalSeconds) + 1 }, (_, i) => formatChargeTime(i * intervalSeconds));
            const socData = [];

            timeLabels.forEach((_, index) => {
                const s = index * intervalSeconds;
                const progress = s / totalDurationSeconds;
                const soc = startSoC + (endSoC - startSoC) * progress;
                socData.push(soc); 
            });
            
            const datasets = [
                {
                    label: 'SoC (%)', 
                    data: socData, 
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(), 
                    tension: 0.1, /* Lower tension for a slightly straighter line */
                    fill: true, 
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--panel-border').includes('rgba') ? getComputedStyle(document.documentElement).getPropertyValue('--panel-border').replace(/[^,]+(?=\)$)/, '0.15)') : getComputedStyle(document.documentElement).getPropertyValue('--panel-border').trim() + '33',
                    pointRadius: 0, /* Removed point radius for smoother curve */
                    borderWidth: 3, /* Increased border width for "bolder" line */
                    segment: {
                        borderColor: c => {
                            const y = c.p1.parsed.y;
                            if (y > 80) return '#ff3366'; // Red for high SoC
                            if (y > 60) return '#ffaa00'; // Orange for mid-high SoC
                            return getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(); // Default theme color
                        }
                    }
                }
            ];

            const options = chartOptionsTemplate('ğŸ”‹ SoC å˜åŒ–æ›²çº¿', true);
            // Ensure y-axis title is correct for SoC only
            options.scales.y.title = { display: true, text: 'SoC (%)', color: getComputedStyle(document.documentElement).getPropertyValue('--label-color').trim() };


            charts['soc'] = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: timeLabels, 
                    datasets: datasets 
                }, 
                options: options 
            });
        }
        
        /**
         * Updates the temperature vs. charging efficiency chart (line chart).
         */
        function updateTempEfficiencyChart() {
            destroyChart('temp');
            const ctx = document.getElementById('tempChart').getContext('2d');
            if (!ctx) { console.error("Temperature chart context not found!"); return; }

            const temps = Array.from({ length: 11 }, (_, i) => i * 5 - 10); // -10Â°C to 40Â°C
            const effs = temps.map(t => {
                const efficiency = 98 - Math.pow(t - 22, 2) * 0.05;
                return Math.max(80, efficiency); 
            });

            charts['temp'] = new Chart(ctx, { 
                type: 'line', 
                data: {
                    labels: temps.map(t => `${t}Â°C`),
                    datasets: [{
                        label: 'å……ç”µæ•ˆç‡ (%)', 
                        data: effs, 
                        fill: true, 
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--button-accent-border').trim(), 
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--panel-border').includes('rgba') ? getComputedStyle(document.documentElement).getPropertyValue('--panel-border').replace(/[^,]+(?=\)$)/, '0.15)') : getComputedStyle(document.documentElement).getPropertyValue('--panel-border').trim() + '33',
                        tension: 0.4,
                        pointRadius: 3 
                    }]
                }, 
                options: chartOptionsTemplate('ğŸŒ¡ï¸ æ¸©åº¦ vs å……ç”µæ•ˆç‡', true)
            });
        }

        // --- Event Listeners and Initial Setup ---

        // Attach change listeners to input elements that should trigger recalculation
        ['model', 'charger', 'enableCooling', 'ac', 'preheat', 'cold', 'hot', 'autopilot', 'load', 'start', 'end', 'actual',
         'p7p_long_range_800v_count', 'p7p_super_long_range_800v_count', 'p7p_flagship_800v_count', 'xp400vCount', 'thirdParty800vCount', 'thirdParty400vCount', 'rogueBMSCount'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', calculate);
            }
        });

        const droppingsPool = [];
        const MAX_DROPPINGS = 70; // Max number of droppings visible at once
        let currentDroppingIndex = 0;
        let lastDropTime = 0;
        const DROP_INTERVAL_MS = 150; // Drop a chocolate bean every X milliseconds

        // Initialize UI and calculate on page load
        window.addEventListener('load', () => {
            updateChargerOptions();
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'day') {
                setTheme(true); // Apply saved day theme, which will also pick a random palette
            } else {
                setTheme(false); // Apply saved night theme, which will also pick a random palette
            }
            populateChangelog(); 
            calculate(); // Initial calculation on load

            // Attach event listeners programmatically for buttons
            if (ui.calculateBtn) ui.calculateBtn.addEventListener('click', calculate);
            if (ui.quickEstimateBtn) ui.quickEstimateBtn.addEventListener('click', quickEstimate);
            if (ui.smartAdviceBtn) ui.smartAdviceBtn.addEventListener('click', getSmartChargingAdvice);
            if (ui.copyResultBtn) ui.copyResultBtn.addEventListener('click', copyResult);
            if (ui.changelogModalBtn) ui.changelogModalBtn.addEventListener('click', () => toggleChangelogModal(true));
            if (ui.fullscreenToggleBtn) ui.fullscreenToggleBtn.addEventListener('click', toggleFullscreen);
            if (ui.themeToggleBtn) ui.themeToggleBtn.addEventListener('click', toggleTheme);

            // Initialize droppings pool
            for (let i = 0; i < MAX_DROPPINGS; i++) {
                const dropping = document.createElement('div');
                dropping.className = 'rabbit-dropping';
                document.body.appendChild(dropping);
                droppingsPool.push(dropping);
            }

            // Set initial rabbit position and start animation
            const initialX = Math.random() * (window.innerWidth - 72); // Adjusted for new rabbit size
            const initialY = Math.random() * (window.innerHeight - 72); // Adjusted for new rabbit size
            wanderingRabbit.style.left = `${initialX}px`;
            wanderingRabbit.style.top = `${initialY}px`;
            animateRabbit();
        });

        document.addEventListener('copy', (e) => {
            if (lastResultText && !e.clipboardData.getData('text/plain')) {
                e.clipboardData.setData('text/plain', lastResultText.trim());
                e.preventDefault(); 
            }
        });

        // --- Wandering Rabbit Animation Logic ---
        const wanderingRabbit = document.getElementById('wandering-rabbit');

        let targetX = Math.random() * (window.innerWidth - 72); // Adjusted for new rabbit size
        let targetY = Math.random() * (window.innerHeight - 72); // Adjusted for new rabbit size
        let currentX = parseFloat(wanderingRabbit.style.left || '0');
        let currentY = parseFloat(wanderingRabbit.style.top || '0');

        function animateRabbit() {
            const speed = 2; // Pixels per frame
            
            // Store previous position before updating
            const prevX = currentX; 
            const prevY = currentY;

            const distanceX = targetX - currentX;
            const distanceY = targetY - currentY;
            const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);

            if (distance < speed || distance > 500) { // If very close or too far (reset target)
                currentX = targetX;
                currentY = targetY;
                targetX = Math.random() * (window.innerWidth - 72); // Adjusted for new rabbit size
                targetY = Math.random() * (window.innerHeight - 72); // Adjusted for new rabbit size
            } else {
                currentX += (distanceX / distance) * speed;
                currentY += (distanceY / distance) * speed;
            }

            // Clamp position to window bounds
            currentX = Math.max(0, Math.min(currentX, window.innerWidth - 72)); // Adjusted for new rabbit size
            currentY = Math.max(0, Math.min(currentY, window.innerHeight - 72)); // Adjusted for new rabbit size

            wanderingRabbit.style.left = `${currentX}px`;
            wanderingRabbit.style.top = `${currentY}px`;

            // Drop chocolate beans
            if (performance.now() - lastDropTime > DROP_INTERVAL_MS) {
                const dropping = droppingsPool[currentDroppingIndex];
                // Adjust to center under rabbit slightly (72px rabbit, 6px dropping)
                dropping.style.left = `${prevX + (72 - 6) / 2}px`; 
                dropping.style.top = `${prevY + (72 - 6) / 2 + 10}px`;  // Slightly offset down from center
                
                // Force reflow to restart animation
                dropping.classList.remove('fade-out');
                void dropping.offsetWidth; // Trigger reflow
                dropping.classList.add('fade-out');

                currentDroppingIndex = (currentDroppingIndex + 1) % MAX_DROPPINGS;
                lastDropTime = performance.now();
            }

            requestAnimationFrame(animateRabbit);
        }

        window.addEventListener('resize', () => {
            currentX = Math.min(Math.max(0, currentX), window.innerWidth - 72); // Adjusted for new rabbit size
            currentY = Math.min(Math.max(0, currentY), window.innerHeight - 72); // Adjusted for new rabbit size
            wanderingRabbit.style.left = `${currentX}px`;
            wanderingRabbit.style.top = `${currentY}px`;

            targetX = Math.random() * (window.innerWidth - 72); // Adjusted for new rabbit size
            targetY = Math.random() * (window.innerHeight - 72); // Adjusted for new rabbit size
        });

        // --- Changelog Population ---
        function populateChangelog() {
            const changelogContent = `
                <h4>v4.2.6 - è¶…ç¶­æ˜Ÿç©¹å…” (Hyperdimensional Stellar Rabbit)</h4>
                <p>è½¦å‹é€‰æ‹©å™¨ä¼˜åŒ–: ç°åœ¨åªæä¾›ä¸‰ä¸ªç‰¹å®šçš„å°é¹ P7+ 800V å¹³å°è½¦å‹ï¼ˆé•¿ç»­èˆª 60.7 kWhï¼Œè¶…é•¿ç»­èˆª 76.3 kWhï¼Œæ——èˆ° 74.9 kWhï¼‰ï¼Œä¸”è¿™äº›è½¦å‹åœ¨åŒç«™å……ç”µæ—¶å¯ä½œä¸ºæŸè€—å› å­çº³å…¥è®¡ç®—ï¼Œä¸å†æœ‰å…¶ä»–è½¦å‹é€‰æ‹©ã€‚</p>
                <p>åŒç«™å…±äº«æŸè€—å› å­ç»†åŒ–: æ–°å¢ P7+ å„å‹å·ä½œä¸ºåŒç«™æŸè€—å› å­é€‰é¡¹ï¼Œä½¿åŠŸç‡åˆ†é…æ¨¡æ‹Ÿæ›´ç²¾ç¡®ã€‚</p>
                <p>æ——èˆ°ç‰ˆåŠŸç‡æå‡: æ——èˆ°ç‰ˆï¼ˆ5Cï¼‰æœ€å¤§å……ç”µåŠŸç‡æå‡è‡³ 442kWï¼Œå¹¶å¤§å¹…ä¼˜åŒ–äº†ç®—æ³•ç²¾åº¦ï¼ŒåŠ›æ±‚å°†è¯¯å·®æ§åˆ¶åœ¨ 1 åˆ†é’Ÿä»¥å†…ã€‚</p>
                <p>ç‰ˆæœ¬ä»£å·æ›´æ–°: æ›´æ–°ä¸ºâ€œè¶…ç¶­æ˜Ÿç©¹å…”â€ï¼Œå¹¶æ·»åŠ äº†è¯¦ç»†çš„åˆ›ä½œåŸå› å’Œå‡ºå¤„è§£é‡Šã€‚</p>

                <h4>v4.2.5 - è¶…ç¶­æ˜Ÿç©¹å…” (Hyperdimensional Stellar Rabbit)</h4>
                <p>è½¦å‹é€‰æ‹©å™¨ä¼˜åŒ–: è½¦å‹é€‰æ‹©å™¨ç°åœ¨ç»Ÿä¸€æ˜¾ç¤º 800V å¹³å°è½¦å‹ï¼Œ400V å½±å“å·²é›†æˆåˆ°â€œåŒç«™å ç”¨å……ç”µæ¡©è¯¦æƒ…â€ä¸­ã€‚</p>
                <p>æ——èˆ°ç‰ˆåŠŸç‡æå‡: æ——èˆ°ç‰ˆï¼ˆ5Cï¼‰æœ€å¤§å……ç”µåŠŸç‡æå‡è‡³ 442kWï¼Œå¹¶å¤§å¹…ä¼˜åŒ–äº†ç®—æ³•ç²¾åº¦ï¼ŒåŠ›æ±‚å°†è¯¯å·®æ§åˆ¶åœ¨ 1 åˆ†é’Ÿä»¥å†…ã€‚</p>
                <p>ç‰ˆæœ¬ä»£å·æ›´æ–°: æ›´æ–°ä¸ºâ€œè¶…ç¶­æ˜Ÿç©¹å…”â€ï¼Œå¹¶æ·»åŠ äº†è¯¦ç»†çš„åˆ›ä½œåŸå› å’Œå‡ºå¤„è§£é‡Šã€‚</p>

                <h4>v4.2.4 - æ˜Ÿæ²³æ¼«æ¸¸å…” (Stellar Wanderer Rabbit)</h4>
                <p>ç®—æ³•ä¼˜åŒ–: æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œç²¾ç¡®æ ¡å‡†äº† 3C è½¦å‹ï¼ˆé•¿ç»­èˆª 60.7 kWh å’Œè¶…é•¿ç»­èˆª 76.3 kWhï¼‰çš„æœ€å¤§å……ç”µåŠŸç‡ï¼Œåˆ†åˆ«ä¸º 215kW å’Œ 265kWã€‚</p>
                <p>æŸè€—å› å­æ”¹è¿›: ä¼˜åŒ–äº†â€œå…¶ä»– 3C è½¦è¾†å……ç”µâ€æŸè€—å› å­çš„æ˜¾ç¤ºï¼Œåœ¨æŠ¥å‘Šä¸­æ›´æ¸…æ™°åœ°å±•ç¤ºæ­¤é™åˆ¶æ˜¯å¦è§¦å‘ã€‚</p>
                <p>ç‰ˆæœ¬ä»£å·æ›´æ–°: æ›´æ–°ä¸ºâ€œæ˜Ÿæ²³æ¼«æ¸¸å…”â€ï¼Œå¹¶æ·»åŠ äº†è¯¦ç»†çš„åˆ›ä½œåŸå› å’Œå‡ºå¤„è§£é‡Šã€‚</p>

                <h4>v3.6.8 - å“ˆåˆ©æ–‘ç‚¹å…” (Harry Spot)</h4>
                <p>æ ¸å¿ƒä¼˜åŒ–: è¿›ä¸€æ­¥åŒºåˆ†äº† 3C è½¦å‹ï¼ˆé•¿ç»­èˆª 60.7 kWh å’Œè¶…é•¿ç»­èˆª 76.3 kWhï¼‰çš„å……ç”µç®—æ³•ï¼Œä½¿å…¶å„è‡ªçš„ä¼°ç®—æ›²çº¿æ›´ç²¾ç¡®åœ°æ‹Ÿåˆå®é™…æƒ…å†µã€‚</p>
                <p>ç•Œé¢ä¼˜åŒ–: ä¼˜åŒ–äº†æ—¥é—´æ¨¡å¼ä¸‹çš„å­—ä½“é¢œè‰²ï¼Œä½¿å…¶åœ¨æµ…è‰²èƒŒæ™¯ä¸‹æ›´æ¸…æ™°æ˜“è¯»ã€‚</p>
                <p>å‘½å: é‡‡ç”¨æ–°çš„ç‰ˆæœ¬å‘½åè§„åˆ™ï¼ˆ90å¹´ä»£æ¬§ç¾ç”µå½±äººç‰©åä¸å…”å­ç§ç±»äºŒæ¬¡èåˆï¼‰ï¼Œå¹¶åœ¨ç‰ˆæœ¬å·ä¸‹æ–¹å¢åŠ ç®€çŸ­è§£é‡Šã€‚</p>

                <h4>v3.6.7 - å°¼å¥¥è·å…°å…” (Neo Dutch)</h4>
                <p>æ ¸å¿ƒä¼˜åŒ–: ç®—æ³•å†…éƒ¨æ”¹è¿›ï¼ŒåŸºäºç”¨æˆ·æä¾›çš„çœŸå®æ•°æ®ï¼Œè¿›ä¸€æ­¥æ ¡å‡†äº†ä¸åŒ C ç‡è½¦å‹ï¼ˆ3C å’Œ 5Cï¼‰åœ¨å„ä¸ª SoC åŒºé—´çš„æ‹ŸçœŸå……ç”µæ—¶é—´ä¼°ç®—ç®—æ³•ï¼Œä½¿ç»“æœæ›´ç²¾å‡†ã€‚</p>
                <p>æ–°åŠŸèƒ½: æ–°å¢â€œåŒç«™å ç”¨å……ç”µæ¡©æ•°é‡â€è¾“å…¥é¡¹ï¼Œæ¨¡æ‹Ÿå……ç”µç«™åŠŸç‡åˆ†æµæƒ…å†µï¼Œä½¿ä¼°ç®—æ›´è´´è¿‘å®é™…å¤šè½¦å…±äº«å……ç”µåœºæ™¯ã€‚</p>
                <p>å‘½å: é‡‡ç”¨æ–°çš„ç‰ˆæœ¬å‘½åè§„åˆ™ï¼ˆ90å¹´ä»£æ¬§ç¾ç”µå½±äººç‰©åä¸å…”å­ç§ç±»äºŒæ¬¡èåˆï¼‰ï¼Œå¹¶åœ¨ç‰ˆæœ¬å·ä¸‹æ–¹å¢åŠ ç®€çŸ­è§£é‡Šã€‚</p>
            `;
            ui.changelogList.innerHTML = changelogContent;
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // For root-level deployment like so.menglolita.com/xpeng.html where xpeng.html is in repo root
                // The scope should be '/' and the service worker script path should be '/service-worker.js'
                const baseUrl = '/'; // For root-level deployment of the HTML file

                navigator.serviceWorker.register(`${baseUrl}service-worker.js`, { scope: baseUrl })
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
