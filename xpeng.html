<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全国小鹏充电站地图</title>
    <script src="https://webapi.amap.com/maps?v=2.0&key=f5be8cdf1391fe2323abc034220d2676&plugin=AMap.CitySearch"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #map { width: 100%; height: 600px; }
        .controls { margin: 10px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        .info-window { max-width: 250px; }
        .photo-pagination { margin: 5px 0; display: flex; justify-content: space-between; }
        .copy-btn { cursor: pointer; color: #1890ff; }
    </style>
</head>
<body>
    <h2>全国小鹏充电站地图</h2>
    <div class="controls">
        <select id="citySelect" style="padding: 5px;">
            <option value="">-- 选择城市 --</option>
            <!-- 通过API动态加载城市列表 -->
        </select>
        <input type="text" id="searchInput" placeholder="输入城市名称" style="padding: 5px;">
        <button onclick="searchCity()">🔍 搜索</button>
        <button onclick="getUserLocation()">📍 获取定位</button>
        <button onclick="map.zoomIn()">➕</button>
        <button onclick="map.zoomOut()">➖</button>
    </div>
    <div id="map"></div>

<script>
let currentCity = '';
let currentPage = 1;
let totalPages = 1;
let markers = [];

// 初始化地图
const map = new AMap.Map("map", {
    zoom: 5,
    center: [104.195397, 35.86166]
});

// 动态加载城市列表‌:ml-citation{ref="4" data="citationList"}
function loadCityList() {
    new AMap.CitySearch().getLocalCity((status, result) => {
        if (status === 'complete') {
            const provinceList = result.provinceList;
            const select = document.getElementById('citySelect');
            provinceList.forEach(province => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = province.name;
                province.districts.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.name;
                    option.textContent = city.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            });
        }
    });
}

// 获取充电站数据
function fetchPOIData() {
    clearMarkers();
    
    $.getJSON("https://restapi.amap.com/v3/place/text", {
        key: "f5be8cdf1391fe2323abc034220d2676",
        city: currentCity,
        keywords: "小鹏充电",
        types: "011100|011102|011103|073000|073001|073002",
        offset: 20,
        page: currentPage,
        extensions: "all",
        citylimit: true,
        output: "json"
    }).done(data => {
        if (data.pois?.length) {
            totalPages = Math.ceil(data.count / 20);
            renderMarkers(data.pois);
        }
    });
}

// 渲染标记点
function renderMarkers(pois) {
    pois.forEach((poi, index) => {
        const marker = new AMap.Marker({
            position: poi.location.split(','),
            map: map,
            content: `<div class="marker">${index + 1}</div>`
        });

        let currentPhotoIndex = 0;
        const infoWindow = new AMap.InfoWindow({
            content: createInfoContent(poi, currentPhotoIndex)
        });

        marker.on('click', () => {
            infoWindow.open(map, marker.getPosition());
        });
        markers.push(marker);
    });
}

// 创建信息窗口内容
function createInfoContent(poi, photoIndex) {
    const photos = poi.photos || [];
    return `
        <div class="info-window">
            <h4>${poi.name}</h4>
            <p>地址：<span class="copy-btn" onclick="copyAddress('${poi.address}')">${poi.address}</span></p>
            ${photos.length ? `
                <div class="photo-pagination">
                    <button ${photoIndex <= 0 ? 'disabled' : ''} 
                        onclick="updatePhoto(${poi.id}, ${photoIndex - 1})">←</button>
                    <span>${photoIndex + 1}/${photos.length}</span>
                    <button ${photoIndex >= photos.length - 1 ? 'disabled' : ''}
                        onclick="updatePhoto(${poi.id}, ${photoIndex + 1})">→</button>
                </div>
                <img src="${photos[photoIndex]?.url}" style="max-width:200px;">
            ` : '<p>暂无图片</p>'}
        </div>
    `;
}

// 功能函数
function updatePhoto(poiId, newIndex) {
    markers.forEach(marker => {
        if (marker.getExtData().id === poiId) {
            marker.setContent(createInfoContent(marker.getExtData(), newIndex));
        }
    });
}

function copyAddress(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('地址已复制：' + text);
    }).catch(err => console.error(err));
}

function searchCity() {
    const city = document.getElementById('searchInput').value;
    if (city) {
        currentCity = city;
        currentPage = 1;
        fetchPOIData();
        map.setCity(city);
    }
}

function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            map.setCenter([pos.coords.longitude, pos.coords.latitude]);
        }, err => alert("定位失败：" + err.message));
    } else {
        alert("浏览器不支持定位功能");
    }
}

function clearMarkers() {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
}

// 初始化
loadCityList();
document.getElementById('citySelect').addEventListener('change', function() {
    currentCity = this.value;
    fetchPOIData();
});
</script>
</body>
</html>
