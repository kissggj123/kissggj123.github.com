<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡£æ¡ˆï¼šBunny CC v2.0</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for the graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts for a retro-pixel feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for theming */
        :root {
            --primary-rgb: 34, 211, 238; /* cyan-400 */
            --primary-light-rgb: 103, 232, 249; /* cyan-300 */
            --primary-dark-rgb: 13, 148, 136; /* teal-700 */
            --bg-color: #111827; /* gray-900 */
            --surface-color: rgba(17, 24, 39, 0.5); /* gray-900/50 */
            --text-color: #d1d5db; /* gray-300 */
            --text-muted-color: #6b7280; /* gray-500 */
        }
        [data-theme="amber"] {
            --primary-rgb: 251, 191, 36; /* amber-400 */
            --primary-light-rgb: 252, 211, 77; /* amber-300 */
            --primary-dark-rgb: 180, 83, 9; /* amber-700 */
        }
        [data-theme="pink"] {
            --primary-rgb: 244, 114, 182; /* pink-400 */
            --primary-light-rgb: 249, 168, 212; /* pink-300 */
            --primary-dark-rgb: 190, 24, 93; /* pink-700 */
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s;
        }
        .font-pixel {
            font-family: 'Press Start 2P', cursive;
        }
        /* Custom styles for the chart tooltip */
        .chartjs-tooltip {
            background: rgba(31, 41, 55, 0.9);
            border-radius: 0.5rem;
            color: white;
            padding: 0.5rem 0.75rem;
            pointer-events: none;
            transition: all .1s ease;
            box-shadow: 0 0 10px rgba(var(--primary-rgb), 0.5);
            border: 1px solid rgba(var(--primary-rgb), 0.5);
            font-family: 'Noto Sans SC', sans-serif;
        }
        /* Custom scrollbar for record list */
        .record-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .record-scrollbar::-webkit-scrollbar-track {
            background: rgba(var(--primary-dark-rgb), 0.1);
            border-radius: 4px;
        }
        .record-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(var(--primary-rgb), 0.5);
            border-radius: 4px;
        }
        .record-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(var(--primary-rgb), 0.8);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main container -->
    <div class="w-full max-w-7xl bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-2xl overflow-hidden transition-all duration-300" 
         style="border: 1px solid rgba(var(--primary-rgb), 0.3); box-shadow: 0 0 25px rgba(var(--primary-rgb), 0.1);">
        <!-- Header bar -->
        <div class="bg-gray-900/80 px-4 py-2 flex items-center justify-between"
             style="border-bottom: 1px solid rgba(var(--primary-rgb), 0.3);">
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 rounded-full animate-pulse" style="background-color: rgba(var(--primary-light-rgb), 1)"></span>
                <span class="w-3 h-3 rounded-full" style="background-color: rgba(var(--primary-light-rgb), 0.5)"></span>
                <span class="w-3 h-3 rounded-full" style="background-color: rgba(var(--primary-light-rgb), 0.2)"></span>
            </div>
            <p class="font-pixel text-xs sm:text-sm tracking-widest" style="color: rgba(var(--primary-light-rgb), 1)">BCC_ARCHIVE_SYSTEM_v2</p>
            <!-- Controls: Theme, Fullscreen -->
            <div class="flex items-center space-x-2">
                <button title="ä¸»é¢˜: èµ›åšè“" onclick="changeTheme('cyan')" class="w-5 h-5 bg-cyan-400 rounded-full border-2 border-transparent focus:border-white"></button>
                <button title="ä¸»é¢˜: ç¥ç€é»„" onclick="changeTheme('amber')" class="w-5 h-5 bg-amber-400 rounded-full border-2 border-transparent focus:border-white"></button>
                <button title="ä¸»é¢˜: åƒç´ ç²‰" onclick="changeTheme('pink')" class="w-5 h-5 bg-pink-400 rounded-full border-2 border-transparent focus:border-white"></button>
                <button title="å…¨å±åˆ‡æ¢" onclick="toggleFullscreen()" class="ml-2 w-5 h-5 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>
                </button>
            </div>
        </div>

        <!-- Main content grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
            
            <!-- Left Panel: Profile and Anniversaries -->
            <div class="lg:col-span-1 bg-black/20 p-6 rounded-lg" style="border: 1px solid rgba(var(--primary-rgb), 0.2)">
                <div class="text-center">
                    <div class="relative w-40 h-40 mx-auto mb-4">
                         <img id="profile-pic" src="https://placehold.co/160x160/1f2937/7dd3fc?text=Loading..." 
                             onerror="this.onerror=null; this.src='https://placehold.co/160x160/1f2937/7dd3fc?text=Error';"
                             class="w-full h-full rounded-full object-cover shadow-lg"
                             style="border: 4px solid rgba(var(--primary-rgb), 0.5); box-shadow: 0 0 15px rgba(var(--primary-rgb), 0.2)">
                         <div class="absolute inset-0 rounded-full border-2 animate-spin-slow" style="border-color: rgba(var(--primary-light-rgb), 0.7); border-top-color: transparent;"></div>
                    </div>
                    <h1 class="font-pixel text-2xl font-bold" style="color: rgba(var(--primary-light-rgb), 1)">BUNNY CC</h1>
                    <p class="text-sm font-pixel" style="color: rgba(var(--text-muted-color))">ID: B-20240312</p>
                </div>

                <div class="mt-8">
                    <h2 class="font-pixel text-base pb-2 mb-4" style="color: rgba(var(--primary-light-rgb), 1); border-bottom: 2px solid rgba(var(--primary-rgb), 0.2)">MILESTONES</h2>
                    <div id="timing" class="space-y-2 text-sm whitespace-pre-line leading-relaxed">
                        <p>æ­£åœ¨è¿æ¥åˆ°æ—¶é—´åºåˆ—...</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Chart and All Records -->
            <div class="lg:col-span-2 bg-black/20 p-6 rounded-lg space-y-6" style="border: 1px solid rgba(var(--primary-rgb), 0.2)">
                <div>
                    <h2 class="font-pixel text-base pb-2 mb-4" style="color: rgba(var(--primary-light-rgb), 1); border-bottom: 2px solid rgba(var(--primary-rgb), 0.2)">WEIGHT TRACKING</h2>
                    <div><canvas id="weightChart"></canvas></div>
                    <div id="weight-change-info" class="mt-4 text-center bg-gray-900/50 p-3 rounded-lg h-12 flex items-center justify-center text-sm" style="border: 1px solid rgba(var(--primary-rgb), 0.15)">
                        <p class="text-gray-400">ç‚¹å‡»å›¾è¡¨ä¸Šçš„æ•°æ®ç‚¹ä»¥æŸ¥çœ‹ä½“é‡å˜åŒ–</p>
                    </div>
                </div>
                <div>
                    <h2 class="font-pixel text-base pb-2 mb-4" style="color: rgba(var(--primary-light-rgb), 1); border-bottom: 2px solid rgba(var(--primary-rgb), 0.2)">ARCHIVE LOG</h2>
                    <div id="all-records-container" class="record-scrollbar h-64 overflow-y-auto pr-2 space-y-3 text-sm">
                        <p>æ­£åœ¨åŠ è½½æ¡£æ¡ˆ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const PROFILE_PIC_PATH = './dist/Bunny CC_Profile.JPG';
        const PET_RECORDS_PATH = './dist/bunnycc/PetRecords.json';
        const START_DATE = '2024/03/12 00:00:00';

        // --- GLOBAL STATE ---
        let weightChart = null;
        let weightChartData = []; // Store processed weight data
        let allRecordsData = []; // Store all records

        // --- DOM ELEMENTS ---
        const timingEl = document.getElementById('timing');
        const profilePicEl = document.getElementById('profile-pic');
        const weightChangeInfoEl = document.getElementById('weight-change-info');
        const chartCanvas = document.getElementById('weightChart');
        const allRecordsContainer = document.getElementById('all-records-container');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            profilePicEl.src = PROFILE_PIC_PATH;
            setInterval(updateTiming, 100);
            loadAndProcessData();
        });

        // --- UI FUNCTIONS (THEME, FULLSCREEN) ---
        function changeTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            // Re-render chart with new theme colors
            if (weightChartData.length > 0) {
                renderWeightChart(weightChartData);
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // --- TIMING & ANNIVERSARY LOGIC ---
        function updateTiming() {
            const startDate = new Date(START_DATE);
            const currentDate = new Date();
            const elapsedMilliseconds = currentDate.getTime() - startDate.getTime();

            const elapsedDays = (elapsedMilliseconds / (1000 * 60 * 60 * 24)).toFixed(3);
            const totalSeconds = Math.floor(elapsedMilliseconds / 1000);
            const elapsedHours = Math.floor(totalSeconds / 3600);
            const elapsedMinutes = Math.floor((totalSeconds % 3600) / 60);
            const elapsedSeconds = totalSeconds % 60;
            
            const formatDate = (date) => `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

            const getNextAnniversary = (baseDate, daysInterval) => {
                let count = 0;
                let nextDate;
                do {
                    count++;
                    nextDate = new Date(baseDate.getTime() + count * daysInterval * 24 * 60 * 60 * 1000);
                } while (nextDate < currentDate);
                return { date: nextDate, count: count };
            };
            
            const getNextYearlyAnniversary = (baseDate) => {
                let count = 0;
                let nextDate;
                 do {
                    count++;
                    nextDate = new Date(baseDate);
                    nextDate.setFullYear(baseDate.getFullYear() + count);
                } while (nextDate < currentDate);
                return { date: nextDate, count: count };
            };
            
            const next100 = getNextAnniversary(startDate, 100);
            const next180 = getNextAnniversary(startDate, 180);
            const next300 = getNextAnniversary(startDate, 300);
            const nextYear = getNextYearlyAnniversary(startDate);
            
            // New display format as requested
            timingEl.innerHTML = `
                <p>ğŸ°å…”å¯å¯å·²ç»åˆ°æ¥ ${elapsedDays} å¤©å•¦</p>
                <p>ğŸŒ±ä¸‹ä¸€ä¸ª100å¤©çºªå¿µæ—¥æ˜¯ ${formatDate(next100.date)}ï¼ˆç¬¬${next100.count}ä¸ª100å¤©ï¼‰</p>
                <p>ğŸŒ¿ä¸‹ä¸€ä¸ª180å¤©çºªå¿µæ—¥æ˜¯ ${formatDate(next180.date)}ï¼ˆç¬¬${next180.count}ä¸ª180å¤©ï¼‰</p>
                <p>ğŸ€ä¸‹ä¸€ä¸ª300å¤©çºªå¿µæ—¥æ˜¯ ${formatDate(next300.date)}ï¼ˆç¬¬${next300.count}ä¸ª300å¤©ï¼‰</p>
                <p>ğŸ‰ä¸‹ä¸€ä¸ªä¸€å‘¨å¹´çºªå¿µæ—¥æ˜¯ ${formatDate(nextYear.date)}ï¼ˆç¬¬${nextYear.count}å‘¨å¹´ï¼‰</p>
                <p>ğŸ‚ç›®å‰å·²ç»åˆ°æ¥ ${elapsedHours}å°æ—¶${elapsedMinutes}åˆ†é’Ÿ${elapsedSeconds}ç§’</p>
            `;
        }

        // --- DATA PROCESSING & RENDERING ---
        async function loadAndProcessData() {
            try {
                const response = await fetch(PET_RECORDS_PATH);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const records = await response.json();
                
                // Process and sort ALL records first
                allRecordsData = records.map(r => {
                    const ts = Math.floor(r.date);
                    const d = new Date(ts * 1000);
                    d.setFullYear(d.getFullYear() + 31);
                    return { ...r, processedDate: d };
                }).sort((a, b) => b.processedDate - a.processedDate); // Sort descending for display

                // Filter for weight chart data (sorted ascending)
                weightChartData = allRecordsData
                    .filter(r => r.activity === 'ä½“é‡æµ‹é‡' && r.weight > 0)
                    .sort((a, b) => a.processedDate - b.processedDate);

                if (weightChartData.length > 0) renderWeightChart(weightChartData);
                else weightChangeInfoEl.innerHTML = `<p class="text-yellow-400">æœªæ‰¾åˆ°ä½“é‡æµ‹é‡æ•°æ®ã€‚</p>`;
                
                if (allRecordsData.length > 0) renderAllRecords(allRecordsData);
                else allRecordsContainer.innerHTML = `<p class="text-yellow-400">æœªæ‰¾åˆ°ä»»ä½•æ¡£æ¡ˆè®°å½•ã€‚</p>`;

            } catch (error) {
                console.error("æ— æ³•åŠ è½½æˆ–è§£ææ•°æ®:", error);
                weightChangeInfoEl.innerHTML = `<p class="text-red-400">é”™è¯¯: åŠ è½½æ•°æ®å¤±è´¥ã€‚</p>`;
                allRecordsContainer.innerHTML = `<p class="text-red-400">é”™è¯¯: åŠ è½½æ•°æ®å¤±è´¥ã€‚</p>`;
            }
        }
        
        function renderAllRecords(records) {
            let html = '';
            const formatDate = (date) => `${date.getFullYear()}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')}`;
            
            for (const record of records) {
                html += `
                    <div class="bg-gray-900/50 p-3 rounded-md" style="border-left: 3px solid rgba(var(--primary-rgb), 0.5)">
                        <div class="flex justify-between items-center">
                            <strong class="font-bold" style="color: rgba(var(--primary-light-rgb), 1)">${record.activity}</strong>
                            <time class="text-xs text-gray-400">${formatDate(record.processedDate)}</time>
                        </div>
                        <p class="text-gray-300 mt-1">${record.notes || 'æ— å¤‡æ³¨'}</p>
                    </div>
                `;
            }
            allRecordsContainer.innerHTML = html;
        }

        function renderWeightChart(data) {
            const labels = data.map(d => d.processedDate.toLocaleDateString('zh-CN'));
            const weights = data.map(d => d.weight);

            if (weightChart) weightChart.destroy();
            
            const style = getComputedStyle(document.documentElement);
            const primaryColor = `rgb(${style.getPropertyValue('--primary-rgb').trim()})`;
            const primaryLightColor = `rgb(${style.getPropertyValue('--primary-light-rgb').trim()})`;
            const primaryColorTransparent = `rgba(${style.getPropertyValue('--primary-rgb').trim()}, 0.2)`;

            weightChart = new Chart(chartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ä½“é‡ (g)',
                        data: weights,
                        borderColor: primaryColor,
                        backgroundColor: primaryColorTransparent,
                        borderWidth: 2,
                        pointBackgroundColor: primaryLightColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: primaryColor,
                        tension: 0.3,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false, // Use custom HTML tooltip
                            external: function(context) {
                                let tooltipEl = document.getElementById('chartjs-tooltip');
                                if (!tooltipEl) {
                                    tooltipEl = document.createElement('div');
                                    tooltipEl.id = 'chartjs-tooltip';
                                    tooltipEl.classList.add('chartjs-tooltip');
                                    document.body.appendChild(tooltipEl);
                                }
                                const tooltipModel = context.tooltip;
                                if (tooltipModel.opacity === 0) {
                                    tooltipEl.style.opacity = 0;
                                    return;
                                }
                                if (tooltipModel.body) {
                                    const pointData = data[tooltipModel.dataPoints[0].dataIndex];
                                    tooltipEl.innerHTML = `
                                        <div class="font-bold">${pointData.processedDate.toLocaleDateString('zh-CN')}</div>
                                        <div>ä½“é‡: ${pointData.weight}g</div>
                                        <div class="text-xs text-gray-300 mt-1">å¤‡æ³¨: ${pointData.notes}</div>
                                    `;
                                }
                                const position = context.chart.canvas.getBoundingClientRect();
                                tooltipEl.style.opacity = 1;
                                tooltipEl.style.position = 'absolute';
                                tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                                tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
                                tooltipEl.style.transform = 'translate(-50%, -120%)';
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(209, 213, 219, 0.1)' },
                            ticks: { color: 'rgb(156, 163, 175)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgb(156, 163, 175)' }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            if (index > 0) {
                                const currentWeight = data[index].weight;
                                const previousWeight = data[index - 1].weight;
                                const difference = currentWeight - previousWeight;
                                const sign = difference >= 0 ? '+' : '-';
                                const colorClass = difference >= 0 ? 'text-green-400' : 'text-red-400';
                                weightChangeInfoEl.innerHTML = `<p>ä¸ä¸Šæ¬¡ç›¸æ¯”: <span class="font-bold ${colorClass}">${sign}${Math.abs(difference.toFixed(1))}g</span></p>`;
                            } else {
                                weightChangeInfoEl.innerHTML = `<p>è¿™æ˜¯ç¬¬ä¸€æ¬¡æµ‹é‡è®°å½•</p>`;
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
