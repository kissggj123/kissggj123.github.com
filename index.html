<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐰 Bunny CC Archive v8.0.2 - 🌟 Grand Revival Rabbit</title>
    <!-- Tailwind CSS CDN - 注意：用於生產環境時，請作為 PostCSS 插件安裝或使用 Tailwind CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Press Start 2P 用於像素化標題, Noto Sans SC 用於主要內容 -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS 變數用於 TRON 主題 (顏色透過 JS 動態設置) */
        :root {
            --glow-rgb: 34, 211, 238; /* 青色 - 預設 */
            --glow-light-rgb: 103, 232, 249; /* 淺青色 - 預設 */
            --bg-color: #010409; /* 深藍色 - 預設基礎背景 */
            /* 面板表面顏色現在動態使用 glow-rgb 並帶有透明度 */
            --surface-color: rgba(var(--glow-rgb), 0.08); /* 面板的微妙發光色調 */
            --grid-color: rgba(var(--glow-rgb), 0.15); /* 網格線顏色基於發光色 */
            --text-color: #e6edf3; /* 淺灰白色文字 */
            --text-muted-color: #8b949e; /* 柔和灰色文字 */

            /* 新增: 背景徑向漸變顏色 (透過 JS 動態設置) */
            --bg-radial-start: rgba(var(--glow-rgb), 0.08); /* 中心微弱發光 */
            --bg-radial-end: rgba(1, 4, 9, 0.9); /* 融入深色背景 */
            --grad-pos-x: 20%; /* 透過 CSS 關鍵幀動畫 */
            --grad-pos-y: 20%; /* 透過 CSS 關鍵幀動畫 */
        }

        /* 日間模式特定覆蓋 (透過 JS 激活) */
        body.day-mode {
            --bg-color: #f0f8ff; /* 淺藍色作為較淺的基礎色 */
            --text-color: #333333; /* 較深的文字用於對比 */
            --text-muted-color: #666666; /* 日間模式的柔和灰色 */
            --surface-color: rgba(var(--glow-rgb), 0.15); /* 面板的較淺發光色調 */

            /* 日間模式徑向漸變調整 */
            --bg-radial-start: rgba(var(--glow-rgb), 0.15); /* 較強的發光起始 */
            --bg-radial-end: rgba(240, 248, 255, 0.9); /* 融入淺色背景 */
        }

        /* 基本樣式 */
        body {
            font-family: 'Noto Sans SC', sans-serif; /* 主要內容使用 Noto Sans SC 字體 */
            background-color: var(--bg-color); /* 基礎背景色 */
            color: var(--text-color);
            transition: background-color 0.5s ease, color 0.5s ease; /* 主題切換平滑過渡 */
            overflow-x: hidden; /* 防止水平滾動條 */
            overflow-y: auto; /* 允許內容垂直滾動 */
            opacity: 0;
            animation: fadeIn 1s ease 0.5s forwards;
            position: relative; /* 用於疊加層的 z-index 上下文 */
        }
        
        .font-pixel { font-family: 'Press Start 2P', cursive; } /* 僅對特定元素應用像素字體 */
        .glow-text { color: rgb(var(--glow-light-rgb)); text-shadow: 0 0 8px rgba(var(--glow-rgb), 0.8); }
        .glow-border { 
            border: 1px solid rgba(var(--glow-rgb), 0.4); 
            box-shadow: 0 0 12px rgba(var(--glow-rgb), 0.2), inset 0 0 8px rgba(var(--glow-rgb), 0.15); 
            transition: border-color 0.5s ease, box-shadow 0.5s ease; /* 平滑過渡 */
        }
        
        /* 動畫網格和徑向漸變背景 */
        #grid-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* 位於所有內容之下 */
            background-image:
                /* 徑向漸變用於光影效果 - 第一層 */
                radial-gradient(circle at var(--grad-pos-x) var(--grad-pos-y), 
                                var(--bg-radial-start) 0%, 
                                var(--bg-radial-end) 60%),
                /* 現有網格線 - 第二層 */
                linear-gradient(rgba(var(--glow-rgb), 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(var(--glow-rgb), 0.15) 1px, transparent 1px);
            background-size: cover, 50px 50px, 50px 50px; /* 徑向覆蓋，網格 50px */
            background-repeat: no-repeat, repeat, repeat; /* 徑向不重複，網格重複 */
            /* 徑向漸變移動路徑更新為更隨機和流暢 */
            animation: pan-grid 20s linear infinite, radial-move 60s cubic-bezier(0.4, 0, 0.2, 1) infinite alternate;
            transition: background-image 0.5s ease; /* 主題顏色切換的平滑過渡 */
        }

        /* 掃描線疊加 */
        #scanline-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100; /* 位於大多數內容之上，模態框之下 */
            pointer-events: none; /* 允許點擊穿透 */
            background: linear-gradient(to bottom, rgba(18, 18, 18, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(to bottom, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.08));
            background-size: 100% 4px, 100% 1px;
            animation: scanline-move 10s linear infinite;
        }

        /* 派克曼頭像容器 - 增強動態效果 */
        .pacman-container {
            position: relative;
            width: 160px; height: 160px;
            border-radius: 50%; 
            overflow: hidden; 
            transition: box-shadow 0.3s ease; /* 平滑發光過渡 */
        }
        .pacman-container .profile-image-wrapper {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden; 
            position: relative; 
            transition: clip-path 0.4s ease-in-out; /* 平滑嘴巴動畫 */
            /* 初始狀態: 完整圓形 */
            clip-path: circle(50% at 50% 50%);
        }

        .pacman-container:hover .profile-image-wrapper {
            /* 懸停時，創建派克曼嘴巴效果 */
            clip-path: polygon(0% 0%, 100% 0%, 100% 40%, 50% 50%, 100% 60%, 100% 100%, 0% 100%);
        }
        
        /* 懸停時添加動態發光效果 */
        .pacman-container:hover {
            box-shadow: 0 0 30px rgba(var(--glow-rgb), 0.9), inset 0 0 20px rgba(var(--glow-rgb), 0.6); /* 懸停時強烈發光 */
        }


        /* 主容器和 UI 元素 */
        .main-container {
            background-color: var(--surface-color); /* 現在使用動態表面色 */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            min-height: 80vh; 
            min-width: 320px; /* 確保小螢幕的最小寬度 */
            position: relative; /* 用於模塊的 z-index 上下文 */
            transition: background-color 0.5s ease; /* 主題切換平滑過渡 */
            border-radius: 1rem; /* 更圓潤的現代科技感 */
        }
        .ui-module { 
            transition: all 0.5s; 
            opacity: 0; 
            transform: translateY(20px); 
            animation: module-boot 0.5s ease forwards; 
            min-height: 150px; 
            background-color: rgba(var(--glow-rgb), 0.05); /* 基於主題的微妙模塊背景 */
            border-left: 3px solid rgba(var(--glow-rgb), 0.5); /* 左側邊框也基於主題 */
            transition: background-color 0.5s ease, border-left-color 0.5s ease; /* 平滑過渡 */
            border-radius: 0.75rem; /* 模塊一致的圓角 */
            box-shadow: 0 4px 15px rgba(var(--glow-rgb), 0.1); /* 更明顯的微妙陰影 */
        }
        .list-pellet li::before {
            content: '•';
            color: rgb(var(--glow-light-rgb));
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
            animation: pellet-glow 1.5s infinite alternate;
        }

        /* 模態框 */
        .modal-overlay { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; } /* 確保模態框位於頂部 */
        .modal-content-base {
            background-color: var(--surface-color); /* 模態框也使用動態表面色 */
            transition: background-color 0.5s ease; /* 平滑過渡 */
            border-radius: 1rem; /* 模態框一致的圓角 */
        }


        /* 動畫 */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pan-grid { from { background-position: 0 0; } to { background-position: -50px -50px; } }
        @keyframes scanline-move { from { background-position: 0 0; } to { background-position: 0 100%; } }
        @keyframes pellet-glow { from { text-shadow: 0 0 2px; } to { text-shadow: 0 0 10px rgba(var(--glow-light-rgb), 1); } }
        @keyframes module-boot { to { opacity: 1; transform: translateY(0); } }
        /* 新增: 徑向漸變移動動畫 - 更複雜的路徑以實現隨機性 */
        @keyframes radial-move {
            0% { --grad-pos-x: 10%; --grad-pos-y: 10%; }
            16% { --grad-pos-x: 90%; --grad-pos-y: 20%; }
            32% { --grad-pos-x: 30%; --grad-pos-y: 90%; }
            48% { --grad-pos-x: 70%; --grad-pos-y: 40%; }
            64% { --grad-pos-x: 20%; --grad-pos-y: 80%; }
            80% { --grad-pos-x: 50%; --grad-pos-y: 15%; }
            100% { --grad-pos-x: 10%; --grad-pos-y: 10%; }
        }

        /* 自定義滾動條 */
        .record-scrollbar::-webkit-scrollbar { width: 8px; }
        .record-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .record-scrollbar::-webkit-scrollbar-thumb { background: rgba(var(--glow-rgb), 0.5); border-radius: 4px; }
        .record-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(var(--glow-rgb), 0.8); }

        /* 兔子樣式 */
        #wandering-rabbit {
            position: fixed;
            width: 72px; 
            height: 72px; 
            z-index: 90; 
            pointer-events: none;
            fill: rgb(var(--glow-light-rgb)); 
            filter: drop-shadow(0 0 15px rgba(var(--glow-rgb), 0.8));
        }
        .rabbit-dropping {
            position: absolute;
            width: 6px; 
            height: 6px;
            background-color: #4a2c2a; 
            border-radius: 1px; 
            transform: scale(1);
            opacity: 1;
            transition: transform 2s ease-out, opacity 2s ease-out; 
            z-index: 89; 
            pointer-events: none; 
            box-shadow: 0 0 2px rgba(0,0,0,0.5); 
        }
        .rabbit-dropping.fade-out {
            transform: scale(0.2);
            opacity: 0;
        }

        /* 確保主容器居中並佔用適當寬度 */
        .flex.items-center.justify-center.min-h-screen.p-4 {
            align-items: flex-start; /* 頂部對齊以更好地利用垂直空間 */
            padding-top: 2rem; /* 添加一些頂部內邊距 */
            padding-bottom: 2rem; /* 添加一些底部內邊距 */
        }
        /* 主內容的 flex 擴展以填充可用空間 */
        .lg\\:col-span-1.p-6.flex.flex-col.space-y-8, .lg\\:col-span-2.p-6.space-y-6 {
            flex-grow: 1;
        }

        /* 更新日誌條目樣式 */
        .changelog-entry {
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            margin-bottom: 1rem; /* mb-4 */
            background-color: rgba(var(--glow-rgb), 0.1); /* bg-gray-800 等效，但動態 */
            border: 1px solid rgba(var(--glow-rgb), 0.4); /* border-gray-700 等效，但動態 */
            box-shadow: 0 2px 8px rgba(var(--glow-rgb), 0.1); /* 微妙陰影 */
            transition: all 0.3s ease; /* 主題切換平滑過渡 */
        }

        .changelog-entry ul {
            list-style: none; /* 移除預設項目符號 */
            padding-left: 1.5em; /* 為自定義項目符號縮進 */
        }

        .changelog-entry li::before {
            content: '★ '; /* 更新日誌的自定義星號項目符號 */
            color: rgb(var(--glow-light-rgb)); /* 使用發光色 */
            font-weight: bold;
            display: inline-block;
            width: 1.5em; /* 星號的空間 */
            margin-left: -1.5em;
        }
        /* 從全局更新日誌列表中移除彈丸樣式（如果已全局應用） */
        #changelog-list.list-pellet li::before {
            content: none; /* 覆蓋以在此處移除全局彈丸 */
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="grid-background"></div>
    <!-- 遊走兔角色 -->
    <div id="wandering-rabbit">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" fill="currentColor">
            <rect x="1" y="0" width="1" height="1"/><rect x="3" y="0" width="1" height="1"/>
            <rect x="0" y="1" width="1" height="1"/><rect x="4" y="1" width="1" height="1"/>
            <rect x="0" y="2" width="1" height="1"/><rect x="6" y="2" width="1" height="1"/>
            <rect x="0" y="3" width="1" height="1"/><rect x="6" y="3" width="1" height="1"/>
            <rect x="0" y="4" width="1" height="1"/><rect x="6" y="4" width="1" height="1"/>
            <rect x="2" y="2" width="1" height="1"/><rect x="3" y="2" width="1" height="1"/>
            <rect x="2" y="3" width="1" height="1"/><rect x="3" y="3" width="1" height="1"/>
            <rect x="1" y="5" width="1" height="1"/><rect x="2" y="5" width="1" height="1"/>
            <rect x="3" y="5" width="1" height="1"/><rect x="4" y="5" width="1" height="1"/><rect x="5" y="5" width="1" height="1"/>
        </svg>
    </div>
    <div id="scanline-overlay"></div>

    <!-- 主容器 -->
    <div class="main-container w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden transition-all duration-500 glow-border">
        <!-- 頁眉 -->
        <div class="px-4 py-2 flex items-center justify-between border-b" style="border-color: rgba(var(--glow-rgb), 0.3)">
            <!-- 更新標題文字以模仿終端提示符 -->
            <p class="font-pixel text-xs sm:text-sm tracking-widest glow-text">BCC_SYS_v8.0.2_TRON <span style="font-size: 0.75em;">CANGUROMIO_BCC@ARCHIVE:~$</span></p>
            <!-- 控制按鈕（現在使用 ID 和 programmatically 綁定事件） -->
            <div class="flex items-center space-x-3 text-gray-400">
                <button id="changelog-btn" title="更新日誌" class="transition-colors hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></button>
                <button id="theme-btn" title="色彩循環" class="transition-colors hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg></button>
                <button id="performance-btn" title="性能監控" class="transition-colors hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></button>
                <button id="fullscreen-btn" title="全螢幕" class="transition-colors hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" /></svg></button>
            </div>
        </div>

        <!-- 主內容網格 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
            <!-- 左側面板 -->
            <div class="lg:col-span-1 p-6 flex flex-col space-y-8 ui-module" style="animation-delay: 0.2s;">
                <div class="text-center">
                    <div class="pacman-container mx-auto glow-border">
                        <div class="profile-image-wrapper">
                            <img id="profile-pic" src="./dist/Bunny CC_Profile.JPG" 
                                 onerror="this.onerror=null; this.src='https://placehold.co/160x160/010409/22d3ee?text=Error';"
                                 class="w-full h-full object-cover">
                        </div>
                    </div>
                    <h1 class="font-pixel text-2xl font-bold mt-4 glow-text">BUNNY CC</h1>
                    <p class="text-sm font-pixel" style="color: var(--text-muted-color)">ID: B-20240312</p>
                </div>
                <div class="ui-module" style="animation-delay: 0.4s;">
                    <h2 class="font-pixel text-base pb-2 mb-4 glow-text" style="border-bottom: 1px solid rgba(var(--glow-rgb), 0.3)">里程碑</h2>
                    <div id="timing" class="space-y-2 text-sm whitespace-pre-line leading-relaxed list-pellet" style="color: var(--text-muted-color)"></div>
                </div>
            </div>

            <!-- 右側面板 -->
            <div class="lg:col-span-2 p-6 space-y-6">
                <div class="ui-module" style="animation-delay: 0.6s;">
                    <h2 class="font-pixel text-base pb-2 mb-4 glow-text" style="border-bottom: 1px solid rgba(var(--glow-rgb), 0.3)">體重軌跡</h2>
                    <div class="h-64"><canvas id="weightChart"></canvas></div>
                    <div id="weight-change-info" class="mt-4 text-center p-3 rounded-lg h-12 flex items-center justify-center text-sm" style="background-color: rgba(var(--glow-rgb), 0.05); border: 1px solid rgba(var(--glow-rgb), 0.2)"></div>
                </div>
                <div class="ui-module" style="animation-delay: 0.8s;">
                    <h2 class="font-pixel text-base pb-2 mb-4 glow-text" style="border-bottom: 1px solid rgba(var(--glow-rgb), 0.3)">數據流</h2>
                    <div id="all-records-container" class="record-scrollbar h-56 overflow-y-auto pr-2 space-y-3 text-sm"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 模態框 -->
    <div id="changelog-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center">
        <div class="main-container glow-border w-11/12 max-w-2xl modal-content-base" onclick="event.stopPropagation()">
            <h2 class="font-pixel text-lg p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb), 0.3)">更新日誌</h2>
            <div class="p-6 max-h-[70vh] overflow-y-auto record-scrollbar" id="changelog-list">
                <!-- 更新日誌內容將由 JavaScript 填充 -->
            </div>
            <!-- 模態框關閉按鈕 -->
            <button id="changelog-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>
    <div id="theme-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center">
        <div class="main-container glow-border w-11/12 max-w-md modal-content-base" onclick="event.stopPropagation()">
            <h2 class="font-pixel text-lg p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb), 0.3)">色彩循環</h2>
            <div id="theme-grid" class="p-6 grid grid-cols-3 sm:grid-cols-4 gap-4"></div>
            <div class="flex justify-between p-4 border-t" style="border-color:rgba(var(--glow-rgb), 0.3)">
                <button id="prev-theme-page-btn" class="px-4 py-2 rounded-md font-bold text-white transition-colors duration-200" style="background-color: rgb(var(--glow-rgb)); hover:background-color: rgba(var(--glow-rgb), 0.8);" disabled>上一頁</button>
                <button id="next-theme-page-btn" class="px-4 py-2 rounded-md font-bold text-white transition-colors duration-200" style="background-color: rgb(var(--glow-rgb)); hover:background-color: rgba(var(--glow-rgb), 0.8);">下一頁</button>
            </div>
            <!-- 模態框關閉按鈕 -->
            <button id="theme-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>
    <div id="performance-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center">
        <div class="main-container glow-border w-11/12 max-w-lg modal-content-base" onclick="event.stopPropagation()">
            <h2 class="font-pixel text-lg p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb), 0.3)">性能監控</h2>
            <div class="p-6 max-h-[70vh] overflow-y-auto record-scrollbar" id="performance-metrics">
                <p class="text-sm" style="color: var(--text-muted-color);">激活感應器陣列以獲取實時指標。</p>
                <!-- 按鈕現在使用 ID 並 programmatically 綁定事件 -->
                <button id="activate-sensor-btn" class="mt-4 px-4 py-2 rounded-md font-bold text-white transition-colors duration-200" style="background-color: rgb(var(--glow-rgb)); hover:background-color: rgba(var(--glow-rgb), 0.8);">激活感應器陣列</button>
                <div id="performance-data-output" class="mt-4 space-y-2 text-sm" style="color: var(--text-color);"></div>
                <p class="text-xs mt-4 text-red-400">注意: 由於安全協議，無法直接訪問 CPU/GPU 利用率和公共 IP。</p>
            </div>
            <!-- 模態框關閉按鈕 -->
            <button id="performance-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>

    <script>
        // content_fetcher 是全域可用的，不需要 import
        // import { content_fetcher } from 'content_fetcher'; // 移除此行

        // --- 配置 ---
        const CONFIG = {
            PROFILE_PIC_PATH: './dist/Bunny CC_Profile.JPG', // 用於 GitHub Pages 部署的相對路徑
            PET_RECORDS_FETCH_ID: 'uploaded:PetRecords.json', // 使用 content_fetcher 的 ID
            START_DATE: '2024/03/12 00:00:00', // 週年計時器起始日期
            // 擴展的 THEMES 陣列至 56 種獨特配色方案
            THEMES: [
                { name: '青色', rgb: '34, 211, 238', light_rgb: '103, 232, 249'},
                { name: '品紅', rgb: '244, 114, 182', light_rgb: '249, 168, 212'},
                { name: '檸檬綠', rgb: '132, 204, 22', light_rgb: '163, 230, 53'},
                { name: '橙色', rgb: '249, 115, 22', light_rgb: '251, 146, 60'},
                { name: '黃色', rgb: '251, 191, 36', light_rgb: '252, 211, 77'},
                { name: '紅色', rgb: '239, 68, 68', light_rgb: '248, 113, 113'},
                { name: '靛藍', rgb: '88, 86, 214', light_rgb: '129, 140, 248'},
                { name: '綠色', rgb: '34, 197, 94', light_rgb: '74, 222, 128'},
                { name: '白色', rgb: '229, 231, 235', light_rgb: '243, 244, 246'},
                { name: '紫色', rgb: '168, 85, 247', light_rgb: '192, 132, 252'},
                { name: '金色', rgb: '255, 215, 0', light_rgb: '255, 228, 77'},
                { name: '水鴨色', rgb: '0, 128, 128', light_rgb: '0, 168, 168'},
                { name: '珊瑚紅', rgb: '255, 127, 80', light_rgb: '255, 160, 122'},
                { name: '天藍色', rgb: '135, 206, 235', light_rgb: '173, 216, 230'},
                { name: '玫瑰色', rgb: '255, 0, 127', light_rgb: '255, 51, 153'},
                { name: '電光藍', rgb: '125, 249, 255', light_rgb: '173, 255, 255'},
                { name: '深粉紅', rgb: '255, 20, 147', light_rgb: '255, 105, 180'},
                { name: '春綠', rgb: '0, 255, 127', light_rgb: '127, 255, 212'},
                { name: '火橙色', rgb: '255, 87, 51', light_rgb: '255, 139, 90'},
                { name: '紫羅蘭', rgb: '238, 130, 238', light_rgb: '221, 160, 221'},
                { name: '森林綠', rgb: '34, 139, 34', light_rgb: '60, 179, 113'},
                { name: '寶藍色', rgb: '65, 105, 225', light_rgb: '100, 149, 237'},
                { name: '熱粉紅', rgb: '255, 105, 180', light_rgb: '255, 140, 200'},
                { name: '金黃色', rgb: '218, 165, 32', light_rgb: '255, 193, 7'},
                { name: '深蘭花紫', rgb: '153, 50, 204', light_rgb: '186, 85, 211'},
                { name: '薄荷綠', rgb: '152, 255, 152', light_rgb: '192, 255, 192'},
                { name: '石英粉', rgb: '232, 173, 192', light_rgb: '240, 200, 210'},
                { name: '午夜藍', rgb: '25, 25, 112', light_rgb: '65, 105, 225'},
                { name: '琥珀金', rgb: '255, 191, 0', light_rgb: '255, 215, 0'},
                { name: '湖藍色', rgb: '0, 139, 139', light_rgb: '0, 191, 191'},
                // 額外 26 種主題以達到 56 種
                { name: '蔚藍色', rgb: '42, 82, 190', light_rgb: '64, 130, 250'},
                { name: '深紅', rgb: '220, 20, 60', light_rgb: '255, 99, 71'},
                { name: '暗板岩灰', rgb: '47, 79, 79', light_rgb: '95, 158, 160'},
                { name: '深紫羅蘭', rgb: '148, 0, 211', light_rgb: '186, 85, 211'},
                { name: '道奇藍', rgb: '30, 144, 255', light_rgb: '65, 105, 225'},
                { name: '火磚紅', rgb: '178, 34, 34', light_rgb: '220, 20, 60'},
                { name: '紫紅色', rgb: '255, 0, 255', light_rgb: '255, 105, 180'},
                { name: '中春綠', rgb: '0, 250, 154', light_rgb: '127, 255, 212'},
                { name: '海軍藍', rgb: '0, 0, 128', light_rgb: '70, 130, 180'},
                { name: '橄欖褐', rgb: '107, 142, 35', light_rgb: '154, 205, 50'},
                { name: '橘紅色', rgb: '255, 69, 0', light_rgb: '255, 99, 71'},
                { name: '淡紫羅蘭紅', rgb: '219, 112, 147', light_rgb: '255, 182, 193'},
                { name: '秘魯色', rgb: '205, 133, 63', light_rgb: '244, 164, 96'},
                { name: '粉藍色', rgb: '176, 224, 230', light_rgb: '204, 235, 240'},
                { name: '海綠色', rgb: '46, 139, 87', light_rgb: '60, 179, 113'},
                { name: '石板藍', rgb: '106, 90, 205', light_rgb: '123, 104, 238'},
                { name: '番茄紅', rgb: '255, 99, 71', light_rgb: '255, 128, 96'},
                { name: '綠松石', rgb: '64, 224, 208', light_rgb: '128, 240, 220'},
                { name: '暗鮭魚色', rgb: '233, 150, 122', light_rgb: '255, 160, 122'},
                { name: '深天藍', rgb: '0, 191, 255', light_rgb: '135, 206, 250'},
                { name: '中海藍', rgb: '102, 205, 170', light_rgb: '127, 255, 212'},
                { name: '中海綠', rgb: '60, 179, 113', light_rgb: '84, 198, 140'},
                { name: '中石板藍', rgb: '123, 104, 238', light_rgb: '150, 135, 250'},
                { name: '鋼鐵藍', rgb: '70, 130, 180', light_rgb: '100, 149, 237'},
                { name: '暗金黃色', rgb: '184, 134, 11', light_rgb: '218, 165, 32'},
                { name: '軍藍色', rgb: '95, 158, 160', light_rgb: '120, 180, 180'}
            ],
            THEMES_PER_PAGE: 8 // 每頁顯示的主題數 (8*7 翻頁制, 但總數 56，每頁 8 個，共 7 頁)
        };

        // --- 全局狀態與 UI 元素 ---
        let weightChart = null; // Chart.js 實例
        let allRecordsData = []; // 儲存所有解析後的寵物記錄
        let weightChartData = []; // 儲存用於圖表的過濾體重記錄
        let currentThemePage = 0; // 當前主題頁面索引

        // 兔子動畫變量
        let wanderingRabbit; 
        const droppingsPool = [];
        const MAX_DROPPINGS = 70; 
        let currentDroppingIndex = 0;
        let lastDropTime = 0;
        let targetX, targetY, currentX, currentY; 
        let animationSpeedMultiplier = 1; // 動畫速度乘數，用於 Safari 優化
        let DROP_INTERVAL_MS = 150; // 掉落「巧克力豆」的時間間隔

        /**
         * 切換模態框元素的顯示狀態。
         * @param {string} modalId - 要切換的模態框元素的 ID。
         */
        function toggleModal(modalId) {
            console.log(`[DEBUG] 嘗試切換模態框: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (modal) {
                const isHidden = modal.classList.contains('hidden');
                modal.classList.toggle('hidden', !isHidden);
                modal.classList.toggle('flex', isHidden); // 顯示時添加 flex

                // 只有當性能模態框顯示時才顯示指標
                if (modalId === 'performance-modal' && isHidden) { 
                    displayPerformanceMetrics(); // 調用函數
                }
                // 當主題模態框顯示時，重新生成主題樣本以確保分頁正確
                if (modalId === 'theme-modal' && isHidden) {
                    currentThemePage = 0; // 重置到第一頁
                    generateThemeSwatches();
                }
            } else {
                console.error(`[ERROR] 執行 toggleModal 時未找到 ID 為 '${modalId}' 的模態框。`);
            }
        }

        /**
         * 切換文檔的全螢幕模式。
         */
        function toggleFullscreen() {
            console.log("[DEBUG] 嘗試切換全螢幕。");
            const docEl = document.documentElement;
            if (!document.fullscreenElement) {
                docEl.requestFullscreen().catch(err => console.error(`[ERROR] 進入全螢幕失敗: ${err.message}`));
            } else {
                document.exitFullscreen().catch(err => console.error(`[ERROR] 退出全螢幕失敗: ${err.message}`));
            }
        }

        /**
         * 在性能模態框中顯示瀏覽器性能指標。
         */
        function displayPerformanceMetrics() {
            console.log("[DEBUG] 顯示性能指標。");
            const performanceDataOutput = document.getElementById('performance-data-output');
            if (!performanceDataOutput) {
                console.error("[ERROR] 未找到性能數據輸出元素以進行顯示。");
                return;
            }

            let outputHtml = '<h3>當前性能數據:</h3>';

            // 記憶體使用情況 (非標準，主要用於 Chrome)
            if (window.performance && window.performance.memory) {
                const memory = window.performance.memory;
                outputHtml += `<p><strong>JS 堆使用量:</strong> ${(memory.usedJSHeapSize / (1024 * 1024)).toFixed(2)} MB</p>`;
                outputHtml += `<p><strong>總 JS 堆:</strong> ${(memory.totalJSHeapSize / (1024 * 1024)).toFixed(2)} MB</p>`;
                outputHtml += `<p><strong>JS 堆限制:</strong> ${(memory.jsHeapSizeLimit / (1024 * 1024)).toFixed(2)} MB</p>`;
            } else {
                outputHtml += `<p><em>Performance.memory API 不可用。</em></p>`;
            }

            // 導航計時 API
            if (window.performance && window.performance.getEntriesByType) {
                const navTiming = performance.getEntriesByType("navigation")[0];
                if (navTiming) {
                    outputHtml += `<h3>頁面加載時間:</h3>`;
                    outputHtml += `<p><strong>DOM 內容加載:</strong> ${(navTiming.domContentLoadedEventEnd - navTiming.domContentLoadedEventStart).toFixed(2)} ms</p>`;
                    outputHtml += `<p><strong>總加載時間:</strong> ${(navTiming.loadEventEnd - navTiming.startTime).toFixed(2)} ms</p>`;
                    outputHtml += `<p><strong>DNS 解析:</strong> ${(navTiming.domainLookupEnd - navTiming.domainLookupStart).toFixed(2)} ms</p>`;
                    outputHtml += `<p><strong>TCP 握手:</strong> ${(navTiming.connectEnd - navTiming.connectStart).toFixed(2)} ms</p>`;
                    outputHtml += `<p><strong>請求-響應延遲:</strong> ${(navTiming.responseEnd - navTiming.requestStart).toFixed(2)} ms</p>`;
                }
            } else {
                outputHtml += `<p><em>性能計時 API 不可用。</em></p>`;
            }

            // 網絡資訊 API (實驗性，並非所有瀏覽器都支持)
            if (navigator.connection) {
                const connection = navigator.connection;
                outputHtml += `<h3>網絡子系統資訊:</h3>`;
                outputHtml += `<p><strong>有效類型:</strong> ${connection.effectiveType || 'N/A'}</p>`;
                outputHtml += `<p><strong>往返時間 (RTT):</strong> ${connection.rtt || 'N/A'} ms</p>`;
                outputHtml += `<p><strong>下行帶寬:</strong> ${connection.downlink || 'N/A'} Mbps</p>`;
                outputHtml += `<p><strong>數據節省模式:</strong> ${connection.saveData ? '已啟用' : '已禁用'}</p>`;
            } else {
                outputHtml += `<p><em>網絡資訊 API 不可用。</em></p>`;
            }

            // 硬體並發 (CPU 核心數)
            if (navigator.hardwareConcurrency) {
                outputHtml += `<h3>硬體子系統資訊:</h3>`;
                outputHtml += `<p><strong>處理器核心數:</strong> ${navigator.hardwareConcurrency}</p>`;
            } else {
                outputHtml += `<p><em>處理器核心數無法檢測。</em></p>`;
            }

            // 設備記憶體 (實驗性)
            if (navigator.deviceMemory) {
                outputHtml += `<p><strong>系統記憶體 (約):</strong> ${navigator.deviceMemory} GB</p>`;
            } else {
                outputHtml += `<p><em>系統記憶體無法檢測。</em></p>`;
            }

            // 瀏覽器用戶代理和作業系統 (來自 navigator.userAgent)
            outputHtml += `<h3>瀏覽器與作業系統診斷:</h3>`;
            if (navigator && navigator.userAgent) {
                outputHtml += `<p><strong>用戶代理 (UA):</strong> ${navigator.userAgent}</p>`;
                let os = "未知";
                if (navigator.userAgent.includes("Win")) os = "Windows";
                else if (navigator.userAgent.includes("Mac")) os = "macOS";
                else if (navigator.userAgent.includes("Linux")) os = "Linux";
                else if (navigator.userAgent.includes("Android")) os = "Android";
                else if (navigator.userAgent.includes("iPad")) os = "iPadOS";
                else if (navigator.userAgent.includes("iPhone")) os = "iOS";
                outputHtml += `<p><strong>操作系統 (估計):</strong> ${os}</p>`;
            } else {
                outputHtml += `<p><em>用戶代理資訊無法訪問。</em></p>`;
            }
            
            performanceDataOutput.innerHTML = outputHtml;
        }


        /**
         * 根據 RGB 值改變應用程序的整體主題。
         * 此函數現在還會更新背景徑向漸變顏色。
         * @param {Object} theme - 包含主題 RGB 和 light_rgb 值的對象。
         */
        function changeTheme(theme) {
            console.log(`[DEBUG] 改變主題為: ${theme.name}`);
            const docEl = document.documentElement;
            docEl.style.setProperty('--glow-rgb', theme.rgb);
            docEl.style.setProperty('--glow-light-rgb', theme.light_rgb);

            // 動態設置背景徑向漸變顏色，基於主題和日間/夜間模式
            const isDayMode = document.body.classList.contains('day-mode');
            const currentBgColor = getComputedStyle(docEl).getPropertyValue('--bg-color');
            let baseBgColorRgb;
            // 嘗試解析基礎背景顏色
            const match = currentBgColor.match(/\d+/g);
            if (match && match.length >= 3) {
                baseBgColorRgb = [parseInt(match[0]), parseInt(match[1]), parseInt(match[2])];
            } else {
                // 如果解析失敗，回退到預設的深色/淺色
                baseBgColorRgb = isDayMode ? [240, 248, 255] : [1, 4, 9]; 
            }
            
            const radialStartAlpha = isDayMode ? 0.15 : 0.08;
            const radialEndAlpha = 0.9; 
            
            docEl.style.setProperty('--bg-radial-start', `rgba(${theme.rgb}, ${radialStartAlpha})`);
            docEl.style.setProperty('--bg-radial-end', `rgba(${baseBgColorRgb.join(', ')}, ${radialEndAlpha})`);

            // 也根據新主題的發光色更新面板和模態框的表面色
            const surfaceAlpha = isDayMode ? 0.15 : 0.08;
            docEl.style.setProperty('--surface-color', `rgba(${theme.rgb}, ${surfaceAlpha})`);


            // 如果圖表存在，重新渲染圖表以應用新顏色
            if (weightChart) {
                renderWeightChart(); 
            }
        }

        /**
         * 生成並將主題顏色樣本添加到主題模態框。
         */
        function generateThemeSwatches() {
            console.log("[DEBUG] 生成主題樣本。");
            const themeGrid = document.getElementById('theme-grid');
            const prevBtn = document.getElementById('prev-theme-page-btn');
            const nextBtn = document.getElementById('next-theme-page-btn');

            if (!themeGrid || !prevBtn || !nextBtn) {
                console.error("[ERROR] 未找到主題網格或分頁按鈕元素以生成樣本。");
                return;
            }

            themeGrid.innerHTML = ''; // 清除之前的樣本

            const startIndex = currentThemePage * CONFIG.THEMES_PER_PAGE;
            const endIndex = startIndex + CONFIG.THEMES_PER_PAGE;
            const themesToShow = CONFIG.THEMES.slice(startIndex, endIndex);

            themesToShow.forEach(theme => {
                const swatch = document.createElement('button');
                swatch.className = "h-12 w-full rounded-md transition-all duration-200 hover:scale-110 hover:shadow-lg focus:ring-2 ring-offset-2";
                swatch.style.backgroundColor = `rgb(${theme.rgb})`;
                swatch.style.boxShadow = `0 0 15px rgba(${theme.rgb}, 0.5)`;
                swatch.style.ringColor = `rgb(${theme.rgb})`;
                swatch.style.ringOffsetColor = `var(--bg-color)`;
                swatch.title = theme.name;
                swatch.addEventListener('click', () => changeTheme(theme));
                themeGrid.appendChild(swatch);
            });

            // 更新分頁按鈕狀態
            prevBtn.disabled = currentThemePage === 0;
            nextBtn.disabled = endIndex >= CONFIG.THEMES.length;

            console.log("[DEBUG] 主題樣本已生成。");
        }
        
        // --- 數據與計時邏輯 ---
        /**
         * 更新週年計時顯示。
         */
        function updateTiming() {
            const timingElement = document.getElementById('timing');
            if (!timingElement) {
                console.warn("[WARN] 未找到 UI 元素 'timing' 以進行 updateTiming。跳過。");
                return;
            }

            const start = new Date(CONFIG.START_DATE);
            const now = new Date();
            const elapsedMs = now.getTime() - start.getTime();

            const elapsedDays = (elapsedMs / (1000 * 60 * 60 * 24)).toFixed(3);
            const totalSeconds = Math.floor(elapsedMs / 1000);
            const elapsedHours = Math.floor(totalSeconds / 3600);
            const elapsedMinutes = Math.floor((totalSeconds % 3600) / 60);
            const elapsedSeconds = totalSeconds % 60;
            
            const formatDate = (d) => `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
            
            // 幫助函數：根據固定天數間隔獲取下一個週年日期
            const getNextAnniversary = (baseDate, days) => {
                let count = 0, nextDate;
                do { 
                    count++; 
                    nextDate = new Date(baseDate.getTime() + count * days * 24 * 60 * 60 * 1000); 
                } while (nextDate < now);
                return { date: nextDate, count };
            };
            
            // 幫助函數：獲取下一個年度週年日期
            const getNextYearly = (baseDate) => {
                let count = 0, nextDate;
                do { 
                    count++; 
                    nextDate = new Date(baseDate); 
                    nextDate.setFullYear(baseDate.getFullYear() + count); 
                } while (nextDate < now);
                return { date: nextDate, count };
            };
            
            const next100 = getNextAnniversary(new Date(CONFIG.START_DATE), 100);
            const next180 = getNextAnniversary(new Date(CONFIG.START_DATE), 180);
            const next300 = getNextAnniversary(new Date(CONFIG.START_DATE), 300);
            const nextYear = getNextYearly(new Date(CONFIG.START_DATE));
            
            timingElement.innerHTML = `<ul>
                <li>Bunny CC 已與吾等共度 ${elapsedDays} 太陽週期。</li>
                <li>下個百年標記: ${formatDate(next100.date)} (週期 ${next100.count})。</li>
                <li>下個 180 日標記: ${formatDate(next180.date)} (週期 ${next180.count})。</li>
                <li>下個 300 日標記: ${formatDate(next300.date)} (週期 ${next300.count})。</li>
                <li>下個星辰年標記: ${formatDate(nextYear.date)} (第 ${nextYear.count} 年)。</li>
                <li>逝去時光: ${elapsedHours}時 ${elapsedMinutes}分 ${elapsedSeconds}秒。</li>
            </ul>`;
        }
        
        /**
         * 從 JSON 文件加載寵物記錄並處理以用於顯示和圖表。
         * 現在使用 content_fetcher 來加載上傳的文件。
         */
        async function loadAndProcessData() {
            console.log("[DEBUG] 開始數據加載與處理。");
            const allRecordsContainer = document.getElementById('all-records-container');
            if (!allRecordsContainer) {
                console.error("[ERROR] 未找到所有記錄容器元素以進行數據加載。");
                return;
            }

            // 顯示加載訊息
            allRecordsContainer.innerHTML = `<p class="text-center text-xl" style="color: var(--text-muted-color);">啟動寵物檔案檢索中...請稍候。</p>`;

            try {
                // 使用 content_fetcher 來加載上傳的文件
                const recordsText = await content_fetcher.fetch({ // content_fetcher is now directly accessible
                    query: CONFIG.PET_RECORDS_FETCH_ID,
                    source_references: [{ id: CONFIG.PET_RECORDS_FETCH_ID, type: 'FILE' }]
                });
                const records = JSON.parse(recordsText);
                console.log('[DEBUG] 已加載並解析寵物記錄數據:', records);
                
                // 處理所有記錄: 轉換時間戳並添加 31 年偏移
                allRecordsData = records.map(r => {
                    // 確保 r.date 是數字並轉換為毫秒
                    const dateTimestamp = typeof r.date === 'number' ? Math.floor(r.date) : Date.parse(r.date) / 1000;
                    const d = new Date(dateTimestamp * 1000); 
                    d.setFullYear(d.getFullYear() + 31); // 添加 31 年偏移 (根據用戶之前的代碼)
                    return { ...r, processedDate: d };
                }).sort((a, b) => b.processedDate.getTime() - a.processedDate.getTime()); // 降序排序以供顯示

                // 過濾體重圖表數據 - 注意這裡的 '体重测量' (簡體中文)
                weightChartData = records
                    .filter(r => r.activity === '体重测量' && typeof r.weight === 'number' && r.weight > 0)
                    .map(r => {
                        const dateTimestamp = typeof r.date === 'number' ? Math.floor(r.date) : Date.parse(r.date) / 1000;
                        const d = new Date(dateTimestamp * 1000);
                        d.setFullYear(d.getFullYear() + 31);
                        return { date: d, weight: r.weight };
                    })
                    .sort((a, b) => a.date.getTime() - b.date.getTime()); // 升序排序以供圖表按時間順序顯示

                renderAllRecords();
                renderWeightChart();
                console.log("[DEBUG] 數據加載與處理完成。");

            } catch (error) {
                console.error("[ERROR] 數據加載錯誤:", error);
                allRecordsContainer.innerHTML = `<p class="text-red-400 text-center">錯誤: 檔案檢索失敗。請查閱日誌。</p>`;
            }
        }

        /**
         * 在列表容器中渲染所有寵物記錄。
         */
        function renderAllRecords() {
            console.log("[DEBUG] 渲染所有記錄。");
            const allRecordsContainer = document.getElementById('all-records-container');
            if (!allRecordsContainer) return;

            allRecordsContainer.innerHTML = allRecordsData.map(rec => {
                const dateStr = rec.processedDate.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
                return `<div class="p-3 rounded-md" style="background: rgba(var(--glow-rgb), 0.05); border-left: 3px solid rgba(var(--glow-rgb), 0.5)">
                            <div class="flex justify-between items-center">
                                <strong class="font-bold glow-text text-sm">活動: ${rec.activity}</strong>
                                <time class="text-xs" style="color:var(--text-muted-color)">時間標記: ${dateStr}</time>
                            </div>
                            <p class="mt-1" style="color: var(--text-color)">筆記: ${rec.notes || '無'}</p>
                        </div>`;
            }).join('');
            // 如果沒有記錄，顯示一條訊息
            if (allRecordsData.length === 0) {
                allRecordsContainer.innerHTML = `<p class="text-center text-xl text-gray-500 mt-8">在此檔案中未找到任何記錄。</p>`;
            }
            console.log("[DEBUG] 所有記錄已渲染。");
        }

        /**
         * 渲染體重變化圖表。
         */
        function renderWeightChart() {
            console.log("[DEBUG] 渲染體重圖表。");
            const weightChartCanvas = document.getElementById('weightChart');
            const weightChangeInfo = document.getElementById('weight-change-info');

            if (!weightChartCanvas) {
                console.error("[ERROR] 未找到體重圖表畫布元素以進行渲染。");
                return;
            }

            if (weightChart) {
                weightChart.destroy(); // 銷毀現有圖表實例
                console.log("[DEBUG] 現有圖表已銷毀。");
            }

            if (!weightChartData.length) {
                weightChartCanvas.style.display = 'none';
                if (weightChangeInfo) weightChangeInfo.innerHTML = `<p class="text-yellow-400">未檢測到質量數據。</p>`;
                console.log("[DEBUG] 沒有體重數據可渲染圖表。");
                return;
            } else {
                weightChartCanvas.style.display = 'block';
                if (weightChangeInfo) weightChangeInfo.innerHTML = `<p class="text-gray-400">點擊數據點以進行質量波動分析。</p>`;
            }
            
            const ctx = weightChartCanvas.getContext('2d');
            const style = getComputedStyle(document.documentElement);
            const primaryColor = `rgb(${style.getPropertyValue('--glow-rgb').trim()})`;
            const textColor = style.getPropertyValue('--text-muted-color').trim();
            const gridColor = `rgba(${style.getPropertyValue('--glow-rgb').trim()}, 0.1)`;

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    // 標籤是簡單的日期字符串，而不是 'time' 刻度的 Date 對象
                    labels: weightChartData.map(d => d.date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' })),
                    datasets: [{
                        label: '質量 (g)',
                        data: weightChartData.map(d => d.weight),
                        borderColor: primaryColor,
                        backgroundColor: `rgba(${style.getPropertyValue('--glow-rgb').trim()}, 0.2)`,
                        borderWidth: 2,
                        pointBackgroundColor: primaryColor,
                        pointBorderColor: 'var(--bg-color)',
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { // 自定義工具提示樣式
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + 'g';
                                        const currentIndex = context.dataIndex;
                                        // 計算與前一個點的差異
                                        if (currentIndex > 0) {
                                            const previousWeight = context.dataset.data[currentIndex - 1];
                                            const currentWeight = context.parsed.y;
                                            const difference = currentWeight - previousWeight;
                                            label += ` (增量: ${difference >= 0 ? '+' : ''}${difference.toFixed(1)}g)`;
                                        }
                                    }
                                    return label;
                                }
                            },
                            titleFont: { family: "'Noto Sans SC', sans-serif" }, // 工具提示使用 Noto Sans
                            bodyFont: { family: "'Noto Sans SC', sans-serif" },
                            padding: 10,
                            boxPadding: 5,
                            displayColors: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            borderColor: primaryColor,
                            borderWidth: 1,
                            cornerRadius: 5,
                        }
                    },
                    scales: {
                        y: { 
                            grid: { color: gridColor, drawBorder: false }, 
                            ticks: { color: textColor, font: { family: "'Noto Sans SC', sans-serif" }} 
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: textColor, font: { family: "'Noto Sans SC', sans-serif" }} 
                        }
                    }
                    ,
                    onClick: (event, elements) => {
                        if (elements.length > 0 && weightChangeInfo) { // 確保元素存在
                            const index = elements[0].index;
                            if (index > 0) {
                                const diff = weightChartData[index].weight - weightChartData[index - 1].weight;
                                const sign = diff >= 0 ? '+' : '';
                                const color = diff >= 0 ? 'text-lime-400' : 'text-red-400';
                                weightChangeInfo.innerHTML = `<p>增量: <span class="font-bold ${color}">${sign}${diff.toFixed(1)}g</span></p>`;
                            } else {
                                weightChangeInfo.innerHTML = `<p>初始質量掃描。</p>`;
                            }
                        }
                    }
                }
            });
            console.log("[DEBUG] 體重圖表已渲染。");
        }

        // --- 遊走兔動畫邏輯 ---
        function animateRabbit() {
            if (!wanderingRabbit) {
                console.warn("[WARN] 未找到遊走兔元素，停止動畫。");
                return;
            }

            const speed = 2.5 * animationSpeedMultiplier; 
            
            // 從 transform 獲取當前位置
            const style = window.getComputedStyle(wanderingRabbit);
            const transform = style.transform || style.webkitTransform || style.mozTransform;
            let currentRabbitX = 0, currentRabbitY = 0;

            if (transform && transform !== 'none') {
                const matrix = new DOMMatrix(transform);
                currentRabbitX = matrix.m41;
                currentRabbitY = matrix.m42;
            } else {
                // 對不支持 style.transform 的 DOMMatrix 或 transform 尚未設置的瀏覽器進行回退。
                // 這裡我們需要解析當前樣式而不是依賴於 prevX/prevY
                currentRabbitX = parseFloat(wanderingRabbit.style.transform.match(/translateX\(([^)]+)px\)/)?.[1] || '0');
                currentRabbitY = parseFloat(wanderingRabbit.style.transform.match(/translateY\(([^)]+)px\)/)?.[1] || '0');
            }


            // 如果目標未定義或兔子靠近目標，設置一個新的隨機目標
            if (targetX === undefined || targetY === undefined || 
                Math.sqrt(Math.pow(targetX - currentRabbitX, 2) + Math.pow(targetY - currentRabbitY, 2)) < speed) { 
                targetX = Math.random() * (window.innerWidth - wanderingRabbit.offsetWidth); 
                targetY = Math.random() * (window.innerHeight - wanderingRabbit.offsetHeight); 
            }
            
            const prevX = currentRabbitX; // 儲存兔子移動前的位置用於掉落物
            const prevY = currentRabbitY;

            const distanceX = targetX - currentRabbitX;
            const distanceY = targetY - currentRabbitY; // 修正：應使用 currentRabbitY
            const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);

            if (distance > 0) { // 只有當存在距離時才移動
                currentX = currentRabbitX + (distanceX / distance) * speed;
                currentY = currentRabbitY + (distanceY / distance) * speed;
            } else { // 如果已經到達目標，則停留或重新計算 (由上面的條件處理)
                currentX = targetX;
                currentY = targetY;
            }

            // 將位置限制在邊界內
            currentX = Math.max(0, Math.min(currentX, window.innerWidth - wanderingRabbit.offsetWidth)); 
            currentY = Math.max(0, Math.min(currentY, window.innerHeight - wanderingRabbit.offsetHeight)); 

            wanderingRabbit.style.transform = `translate(${currentX}px, ${currentY}px)`;

            if (performance.now() - lastDropTime > DROP_INTERVAL_MS) {
                const dropping = droppingsPool[currentDroppingIndex];
                if (dropping) { 
                    dropping.style.left = `${prevX + (wanderingRabbit.offsetWidth - 6) / 2}px`; 
                    dropping.style.top = `${prevY + (wanderingRabbit.offsetHeight - 6) / 2 + 10}px`;  
                    
                    dropping.classList.remove('fade-out');
                    void dropping.offsetWidth; // 觸發重排以重新開始動畫
                    dropping.classList.add('fade-out');

                    currentDroppingIndex = (currentDroppingIndex + 1) % MAX_DROPPINGS;
                    lastDropTime = performance.now();
                }
            }
            window.requestAnimationFrame(animateRabbit);
        }

        // --- 更新日誌填充 ---
        function populateChangelog() {
            console.log("[DEBUG] 填充更新日誌。");
            const changelogList = document.getElementById('changelog-list');
            if (!changelogList) {
                console.error("[ERROR] 未找到更新日誌列表元素以填充。");
                return;
            }
            const changelogContent = `
                <h4>✨ v8.0.2 - 🌟 Grand Revival Rabbit (王者歸來兔)</h4>
                <div class="changelog-entry">
                    <p><strong>Fixes (The Maladies Vanquished! 痼疾盡除！):</strong></p>
                    <ul>
                        <li><span style="color: red;"><strong>The Oracle's Tongue Now Loosened! (神諭之舌終復甦！):</strong></span> The vexing silence of the <code>content_fetcher</code>, which oft whispered of its undefined nature, hath been banished! By removing the shroud of 'module' from our chief script, this noble oracle now speaketh freely, and the data, which once lay hidden, doth now cascade forth in its full glory! Henceforth, no more blank pages shall greet thine eyes, for the archives are fully restored! (數據空白問題已徹底解決！🎉)</li>
                        <li>The Hare's Gambit, More Precise! (玉兔之行，更趨精準！): The labyrinthine path of the wandering rabbit's journey hath been fine-tuned. Its steps, once prone to a slight miscalculation, now tread with an unparalleled accuracy, ensuring its playful dance is flawless upon the digital stage! (兔子亂跑的 bug 已修復！🥳)</li>
                    </ul>
                </div>
                <h4>✨ v8.0.1 - 🐛 Bug Fix Rabbit (除蟲兔)</h4>
                <div class="changelog-entry">
                    <p><strong>Fixes (The Maladies Vanquished! 痼疾盡除！):</strong></p>
                    <ul>
                        <li><span style="color: red;"><strong>Edge Browser's Folly Cured! (Edge 瀏覽器之蠢病已癒！):</strong></span> The peculiar ailment in Edge, which caused our script to stumble with an 'Unexpected identifier 'addEventListener',' hath been utterly vanquished! We have, with cunning, removed all direct 'onclick' attributes from our HTML, and now, our buttons heed the whispers of JavaScript's 'addEventListener', thereby ensuring their proper conduct and the swift flow of interaction! (Edge 瀏覽器執行錯誤已修正！🎉)</li>
                        <li><span style="color: red;"><strong>Weight Chart's Data Unveiled! (體重圖表數據終現世！):</strong></span> The cryptic absence of data from our weight chart, which stemmed from a subtle discord in the naming of 'weight measurement' activities, hath been resolved! We now heed the simpler tongue of '体重测量' (simplified Chinese), and lo, the cherished records of mass are now laid bare for all to witness! (體重圖表數據載入已修正！📈)</li>
                        <li>The 'Content_Fetcher' No Longer a Mystery! (內容抓取者不再是謎！): The perplexing error of 'content_fetcher module import' hath been set right. This noble tool, being a gift of the very environment, now serves without need of explicit import, answering to our call as a trusted companion! (<code>content_fetcher</code> 模組引入錯誤已修正！🛠️)</li>
                        <li>The Wandering Hare's Path Refined! (遊走兔之徑路更精！): The whimsical trajectory of our wandering rabbit's animation hath been subtly adjusted, ensuring its movements are now as graceful as a zephyr's dance! (遊走兔動畫路徑邏輯已微調！🏃‍♀️)</li>
                    </ul>
                </div>
                <h4>✨ v8.0.0 - 🐇 Arcane Chronos Rabbit (奧秘時序兔)</h4>
                <div class="changelog-entry">
                    <p><strong>New Illuminations (A Light Newly Cast! 新光乍現！):</strong></p>
                    <ul>
                        <li>The Axis of Time, Flowing Anew! (時光之軸，流轉不息！): The sprite of the wandering rabbit doth now animate with renewed vigour, its steps as fluid as a river's course, a veritable cascade of frames, breathing boundless life into this archive! (兔子動畫回來啦！🐰)</li>
                        <li>The Spectrum's Grand Embrace! (虹彩之譜，廣納天地！): Our palette of thematic colours hath expanded to fifty-six distinct hues, each a radiant spark, waiting to adorn this archive in garments of unparalleled splendor! (主題顏色多達 56 種！🌈)</li>
                        <li>The Arcana of Measure, Unveiling Performance! (術數之奧，洞悉性能！): Our method of performance scrutiny hath been refined, now capable of revealing the browser's secret whispers, the depths of its memory, and the pulse of its network! Yet, the CPU's core, the GPU's might, and the IP's hidden trail, remain shrouded in mystery, beyond our common ken. (新增性能監控模塊！💻)</li>
                        <li>Ancient Texts Reborn, Scented with Ink! (古籍新生，筆墨留香！): This chronicle of updates hath been re-penned with the quill of Shakespeare, each word imbued with antique grace and profound depth, offering a feast of eloquence to the discerning reader! (更新日誌變成古風英語了！📜)</li>
                        <li>The Prologue's Mark, A Terminal's Soul! (始頁標記，終端之靈！): The inscription at the page's head, which once spoke of shared archives, hath transformed into the style of a terminal's command prompt, lending this archive a fresh, technological allure! (標題變成終端機風格！😎)</li>
                    </ul>
                    <p><strong>Refinements (An Ode to Refinement! 精進頌歌！):</strong></p>
                    <ul>
                        <li>Data's Flow, Unhindered! (數據流轉，無礙暢行！): The core mechanisms for data processing and element interplay have reverted to their former robust foundation, ensuring all logic proceeds as seamlessly as in days of yore, without a single hitch! (數據加載和頁面交互邏輯回歸穩定！👍)</li>
                    </ul>
                    <p><strong>Fixes (The Maladies Vanquished! 痼疾盡除！):</strong></p>
                    <ul>
                        <li>Woes of Yore, Now Dispelled! (往昔之困，盡皆消弭！): All manner of runtime afflictions, such as 'Unexpected identifier 'addEventListener'' and 'window.toggleModal is not a function', have been utterly uprooted in this iteration, rendering the archive stable and serene! (各種報錯都沒了！🥳)</li>
                    </ul>
                </div>
                <!-- Previous Changelog Entries (省略了，因為內容較長，但結構與上面相同) -->
            `;
            changelogList.innerHTML = changelogContent;
            console.log("[DEBUG] 更新日誌已填充。");
        }

        /**
         * 設置所有 UI 按鈕的事件監聽器。
         */
        function setupEventListeners() {
            console.log("[DEBUG] 設置事件監聽器。");
            document.getElementById('changelog-btn')?.addEventListener('click', () => toggleModal('changelog-modal'));
            document.getElementById('theme-btn')?.addEventListener('click', () => toggleModal('theme-modal'));
            document.getElementById('performance-btn')?.addEventListener('click', () => toggleModal('performance-modal'));
            document.getElementById('fullscreen-btn')?.addEventListener('click', toggleFullscreen);

            // 模態框關閉按鈕
            document.getElementById('changelog-close-btn')?.addEventListener('click', () => toggleModal('changelog-modal'));
            document.getElementById('theme-close-btn')?.addEventListener('click', () => toggleModal('theme-modal'));
            document.getElementById('performance-close-btn')?.addEventListener('click', () => toggleModal('performance-modal'));
            
            // 性能模態框中的激活感應器按鈕
            document.getElementById('activate-sensor-btn')?.addEventListener('click', displayPerformanceMetrics);

            // 主題分頁按鈕
            document.getElementById('prev-theme-page-btn')?.addEventListener('click', () => {
                if (currentThemePage > 0) {
                    currentThemePage--;
                    generateThemeSwatches();
                }
            });
            document.getElementById('next-theme-page-btn')?.addEventListener('click', () => {
                const totalPages = Math.ceil(CONFIG.THEMES.length / CONFIG.THEMES_PER_PAGE);
                if (currentThemePage < totalPages - 1) {
                    currentThemePage++;
                    generateThemeSwatches();
                }
            });

            // 模態框疊加層點擊關閉功能 (僅當點擊疊加層本身時)
            document.getElementById('changelog-modal')?.addEventListener('click', (event) => {
                if (event.target.id === 'changelog-modal') toggleModal('changelog-modal');
            });
            document.getElementById('theme-modal')?.addEventListener('click', (event) => {
                if (event.target.id === 'theme-modal') toggleModal('theme-modal');
            });
            document.getElementById('performance-modal')?.addEventListener('click', (event) => {
                if (event.target.id === 'performance-modal') toggleModal('performance-modal');
            });

            console.log("[DEBUG] 事件監聽器已設置。");
        }


        // --- 主 window.onload 監聽器 ---
        // 使用 window.onload 以確保所有 DOM 元素在嘗試獲取其引用或附加事件監聽器之前已完全加載並可訪問。
        window.onload = function() {
            console.log("[DEBUG] window.onload 事件觸發。開始初始化...");

            // 初始化兔子元素及其位置
            wanderingRabbit = document.getElementById('wandering-rabbit');
            if (wanderingRabbit) {
                // 將 currentX, currentY 初始化為隨機起始位置
                currentX = Math.random() * (window.innerWidth - wanderingRabbit.offsetWidth); 
                currentY = Math.random() * (window.innerHeight - wanderingRabbit.offsetHeight); 
                wanderingRabbit.style.transform = `translate(${currentX}px, ${currentY}px)`;
                
                // 初始化掉落物池
                for (let i = 0; i < MAX_DROPPINGS; i++) {
                    const dropping = document.createElement('div');
                    dropping.className = 'rabbit-dropping';
                    document.body.appendChild(dropping);
                    droppingsPool.push(dropping);
                }
                console.log("[DEBUG] 兔子掉落物池已初始化。");
                window.requestAnimationFrame(animateRabbit); // 開始動畫循環
                console.log("[DEBUG] 兔子動畫已啟動。");
            } else {
                console.warn("[WARN] 未找到遊走兔元素，動畫已禁用。");
            }

            // 檢測 Safari 並調整動畫幀率以獲得感知的流暢度
            const isSafari = navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome');
            if (isSafari) {
                animationSpeedMultiplier = 1.2; 
                DROP_INTERVAL_MS = 100; 
                console.log("[DEBUG] 檢測到 Safari 瀏覽器，動畫速度已優化。");
            }

            // 設置頭像圖片源
            const profilePic = document.getElementById('profile-pic');
            if (profilePic) {
                profilePic.src = CONFIG.PROFILE_PIC_PATH;
            } else {
                console.error("[ERROR] 初始化時未找到頭像圖片元素。");
            }

            // 設置事件監聽器
            setupEventListeners();
            
            // 開始計時器更新
            setInterval(updateTiming, 100);
            console.log("[DEBUG] 計時器更新已啟動。");

            // 加載並處理數據
            loadAndProcessData();

            // 生成主題樣本 (初始會顯示第一頁)
            generateThemeSwatches();

            // 添加調整大小監聽器以調整兔子動畫邊界
            window.addEventListener('resize', () => {
                if (!wanderingRabbit) return; 
                const style = window.getComputedStyle(wanderingRabbit);
                const transform = style.transform || style.webkitTransform || style.mozTransform;
                let currentRabbitX = 0, currentRabbitY = 0;

                if (transform && transform !== 'none') {
                    const matrix = new DOMMatrix(transform);
                    currentRabbitX = matrix.m41;
                    currentRabbitY = matrix.m42;
                } else {
                    currentRabbitX = parseFloat(wanderingRabbit.style.transform.match(/translateX\(([^)]+)px\)/)?.[1] || '0');
                    currentRabbitY = parseFloat(wanderingRabbit.style.transform.match(/translateY\(([^)]+)px\)/)?.[1] || '0');
                }

                currentX = Math.min(Math.max(0, currentRabbitX), window.innerWidth - wanderingRabbit.offsetWidth); 
                currentY = Math.min(Math.max(0, currentRabbitY), window.innerHeight - wanderingRabbit.offsetHeight); 
                wanderingRabbit.style.transform = `translate(${currentX}px, ${currentY}px)`;

                targetX = Math.random() * (window.innerWidth - wanderingRabbit.offsetWidth); 
                targetY = Math.random() * (window.innerHeight - wanderingRabbit.offsetHeight); 
                console.log("[DEBUG] 窗口已調整大小，兔子位置和目標已更新。");
            });

            // 填充更新日誌內容
            populateChangelog();
            
            // 設置初始隨機主題
            const initialTheme = CONFIG.THEMES[Math.floor(Math.random() * CONFIG.THEMES.length)];
            changeTheme(initialTheme);
            console.log("[DEBUG] 初始主題已設置。");
            console.log("[DEBUG] 初始化完成。");
        };
    </script>
</body>
</html>
