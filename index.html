<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>檔案：Bunny CC vX [METROPOLIS_ZENITH_FINAL_v0.9.1_FIXED]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-rgb: 236,72,153; --accent-rgb: 251,191,36; --bg-color: #0c0a1d;
            --text-color: #e6edf3; --text-color-rgb: 230,237,243; --text-muted-color: #8b949e;
            --mouse-x: 50%; --mouse-y: 50%;
            --color-red: 239,68,68; --color-green: 34,197,94; --color-yellow: 251,191,36; --color-blue:59,130,246;
        }
        body { font-family:'Noto Sans SC',sans-serif;font-size:14px;background-color:var(--bg-color);color:var(--text-color);overflow:hidden;opacity:0;animation:fadeIn 1s ease forwards;cursor:none;position:relative;z-index:0; }
        body.font-pixel { font-family:'Press Start 2P','Noto Sans SC',sans-serif;font-size:12px; }
        body.font-pixel .lcars-button,body.font-pixel .accent-text,body.font-pixel .glow-text,body.font-pixel h1,body.font-pixel h2,body.font-pixel #theme-page-title,body.font-pixel .modal-container h2,body.font-pixel .sim-button{letter-spacing:1px;}

        #singularity-background { position:fixed;inset:0;z-index:-5;background:#0c0a1d; }
        #circuitry-background { position:fixed;inset:0;z-index:-4;background-image:linear-gradient(rgba(var(--glow-rgb),.03) 1px,transparent 1px),linear-gradient(90deg,rgba(var(--glow-rgb),.03) 1px,transparent 1px);background-size:25px 25px;animation:hue-cycle 30s linear infinite; }
        @keyframes hue-cycle { from{filter:hue-rotate(0deg);} to{filter:hue-rotate(360deg);} }
        body::before { content:'';position:fixed;inset:0;z-index:-3;background-image:linear-gradient(rgba(var(--glow-rgb),.08) 1px,transparent 1px),linear-gradient(to right,rgba(var(--glow-rgb),.08) 1px,transparent 1px);background-size:75px 75px;animation:grid-scroll 15s linear infinite;opacity:.7; }
        @keyframes grid-scroll { from{background-position:0 0;} to{background-position:75px 150px;} }
        body::after { content:'';position:fixed;inset:0;z-index:-2;background:radial-gradient(800px at var(--mouse-x) var(--mouse-y),rgba(var(--glow-rgb),.18),transparent 80%);pointer-events:none; }
        
        .effect-canvas { position:fixed;inset:0;pointer-events:none; } #vfx-canvas { z-index:11; } #bunny-trail-canvas { z-index:9998; }
        .pixel-entity { position:fixed;width:32px;height:32px;background-size:contain;pointer-events:none;transform:translate(-50%,-50%);transition:filter .5s,opacity .5s;will-change:transform,left,top; }
        #mouse-bunny { z-index:9999;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3 4h1v1h1v1h4v-1h1v-1h1v3h1v1h-1v1h-1v1h-1v1h-2v-1h-1v-1h-1v-1h-1v-1h-1v-2z' fill='rgb(var(--glow-rgb))'/%3E%3Cpath d='M7 6h1v1h-1z' fill='%23000'/%3E%3Cpath d='M4 4h1v1h-1zM10 4h1v1h-1zM5 6h1v1h-1z' fill='rgb(var(--accent-rgb))'/%3E%3C/svg%3E");filter:drop-shadow(0 0 8px rgba(var(--glow-rgb),.8)); }
        
        .lcars-container { display:flex;height:100vh;padding:1rem;gap:1rem;position:relative;z-index:10; }
        .lcars-sidebar { width:150px;display:flex;flex-direction:column;gap:1rem;flex-shrink:0; }
        .lcars-main { flex-grow:1;display:flex;flex-direction:column;gap:1rem;min-width:0; }
        .lcars-element { background:rgb(var(--glow-rgb));transition:all .3s ease; }
        .lcars-elbow { width:100%;height:60px;background:rgb(var(--glow-rgb));border-top-left-radius:30px;border-bottom-left-radius:30px; }
        .lcars-content-panel { flex-grow:1;background:rgba(8,8,8,.8);backdrop-filter:blur(2px);border:2px solid rgb(var(--glow-rgb));padding:1.5rem;display:flex;flex-direction:column;gap:1.5rem;overflow-y:auto;min-height:0;animation:border-glow-in 2s ease-out forwards; }
        .lcars-button { background:#080808;border:2px solid rgb(var(--accent-rgb));color:rgb(var(--accent-rgb));text-shadow:0 0 8px rgba(var(--accent-rgb),.8);transition:all .2s ease;display:flex;align-items:center;justify-content:center;gap:.5rem; }
        .lcars-button:hover, .sim-button:hover:not(:disabled) { background:rgb(var(--accent-rgb));color:#000;box-shadow:0 0 15px rgba(var(--accent-rgb),.7); }
        .sim-button:disabled { filter:grayscale(80%);cursor:not-allowed;opacity:.5; }

        .modal-overlay { display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);transition:opacity .3s ease; }
        .modal-container { background:#080808;border:2px solid rgb(var(--glow-rgb));box-shadow:0 0 30px rgba(var(--glow-rgb),.5);transition:transform .3s ease; }
        .modal-overlay.hidden { pointer-events:none; } .modal-overlay.hidden .modal-container { transform:scale(.95); }
        
        #city-management-modal .status-bar-container { background:#222;border-radius:.25rem;overflow:hidden;border:1px solid #333;height:.7rem; }
        #city-management-modal .status-bar-fill { height:.7rem;border-radius:.25rem;transition:width .5s ease;text-align:center;font-size:.55rem;color:black;font-weight:bold;line-height:.7rem; }
        #city-main-screen { min-height:70px;background-color:#111;border:1px solid rgba(var(--glow-rgb),.2);border-radius:.5rem;padding:.5rem;display:flex;flex-direction:column;justify-content:center;text-align:left;white-space:pre-wrap;transition:all .3s;font-size:.7rem; }
        .sim-button { flex-grow:1;margin:.2rem;padding:.35rem .15rem;border-radius:.25rem;background:#222;border:1px solid rgb(var(--accent-rgb));color:rgb(var(--accent-rgb));transition:all .2s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.55rem;line-height:1;text-align:center; }
        .sim-button svg { width:.9rem;height:.9rem;margin-bottom:.1rem; }
        .sim-panel-content { max-height:40vh;overflow-y:auto;padding:.5rem;border-top:1px solid rgba(var(--glow-rgb),.2);display:none; }
        .resource-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(75px,1fr));gap:.25rem;font-size:.6rem; }
        .resource-item span:first-child {color:var(--text-muted-color);} .resource-item span:last-child {color:rgb(var(--accent-rgb));font-weight:bold;}
        .detail-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.2rem;font-size:.6rem;margin-top:.25rem; }
        .detail-item { padding:.1rem .15rem;background-color:rgba(var(--text-color-rgb),.03);border-radius:.2rem; }
        .tooltip { position:relative;display:inline-block; } .tooltip .tooltiptext { visibility:hidden;min-width:100px;background-color:#333;color:#fff;text-align:center;border-radius:4px;padding:3px 5px;position:absolute;z-index:100;bottom:115%;left:50%;margin-left:-50px;opacity:0;transition:opacity .2s;font-size:.6rem;box-shadow:0 2px 5px rgba(0,0,0,.5); } .tooltip:hover .tooltiptext { visibility:visible;opacity:1; }
        .list-item { padding:.3rem;border:1px solid rgba(var(--glow-rgb),.1);border-radius:.3rem;margin-bottom:.3rem; }
        .list-item:hover { background-color:rgba(var(--accent-rgb),.1); }
        .god-mode-input { background:rgba(var(--text-color-rgb),.1);border:1px solid rgba(var(--accent-rgb),.5);color:var(--text-color);padding:.2rem .4rem;border-radius:.2rem;width:100px;text-align:right;font-size:.7rem; }
        #god-mode-calculator-modal .modal-container {max-width:450px;padding:1.5rem;text-align:left;font-size:0.75rem;}
        #god-mode-calculator-modal p {margin-bottom:0.4rem;} #god-mode-calculator-modal strong {color:rgb(var(--accent-rgb));}
        #god-mode-calculator-modal .code-block {background:rgba(0,0,0,0.2);padding:0.5rem;border-radius:0.25rem;font-family:monospace;word-break:break-all;}

        .ui-module { opacity:0;transform:translateY(20px) scale(.98);animation:module-boot .6s ease-out forwards; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} } @keyframes module-boot { to{opacity:1;transform:translateY(0) scale(1);} }
        @keyframes border-glow-in { from{box-shadow:0 0 0px rgba(var(--glow-rgb),0);} to{box-shadow:0 0 20px rgba(var(--glow-rgb),.3);} }
        #avatar-container { position:relative;cursor:pointer; } #profile-pic { transition:opacity .5s ease;will-change:opacity; }
        .record-scrollbar::-webkit-scrollbar { width:6px; } .record-scrollbar::-webkit-scrollbar-track { background:transparent; } .record-scrollbar::-webkit-scrollbar-thumb { background:rgba(var(--glow-rgb),.4);border-radius:3px; }
    </style>
</head>
<body>
    <div id="singularity-background"></div> <div id="circuitry-background"></div>
    <canvas id="vfx-canvas" class="effect-canvas"></canvas> <canvas id="bunny-trail-canvas" class="effect-canvas"></canvas>
    <div id="mouse-bunny" class="pixel-entity"></div>
    
    <div class="lcars-container">
        <div class="lcars-sidebar">
            <div class="lcars-elbow"></div>
            <div class="flex-grow flex flex-col justify-end gap-4">
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('changelog-modal')">LOGS</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('theme-modal')">THEME</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleFullscreen()">FSCRN</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('performance-modal')">PERF</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('city-management-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /><path d="M16 4.586V17a1 1 0 01-1 1h-1.5a1 1 0 01-1-1v-2.268a2 2 0 00-2-2h-1.06a2 2 0 00-2 2V17a1 1 0 01-1 1H6a1 1 0 01-1-1V4.586l7-7 4 4zM9 13.732V17h2v-3.268a4.002 4.002 0 00-2-.001z" fill-rule="evenodd" clip-rule="evenodd"/> </svg>
                    <span>CITY OS</span>
                </button>
            </div>
        </div>
        <div class="lcars-main">
            <div id="main-title-area" class="h-16 flex justify-between items-center flex-shrink-0 cursor-pointer" title="多次点击此处有惊喜...">
                <div class="flex items-center">
                    <div class="lcars-element w-24 h-16 rounded-l-full"></div>
                    <div class="ml-4"><p class="text-xl sm:text-2xl font-bold tracking-wider glow-text">SIM-BCC</p><p class="accent-text text-sm">METROPOLIS_ZENITH_FINAL_v0.9</p></div>
                </div>
                <div id="god-mode-indicator" class="text-xs text-red-500 font-bold hidden mr-4">GOD MODE ACTIVE</div>
            </div>
            <div class="lcars-content-panel record-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 flex flex-col space-y-6">
                        <div class="ui-module text-center">
                            <div id="avatar-container" class="w-40 h-40 mx-auto"> <img id="profile-pic" class="w-full h-full rounded-full object-cover p-1 border-2" style="border-color:rgb(var(--glow-rgb));"> </div>
                            <h1 class="text-2xl font-bold mt-4 glow-text">MAYOR BUNNY (兔可可)</h1>
                        </div>
                        <div class="ui-module"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">MILESTONES</h2><div id="timing" class="space-y-3" style="color:var(--text-muted-color)"></div></div>
                    </div>
                    <div class="md:col-span-2 flex flex-col space-y-6">
                        <div class="ui-module"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">DATA VISUALIZATION</h2>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div><h3 class="text-sm accent-text mb-1">POPULATION_TREND (City Sim)</h3><div class="h-56 chart-container"><canvas id="populationChart"></canvas></div><div id="population-change-info" class="mt-2 text-center p-2 rounded-lg h-10 flex items-center justify-center text-xs" style="background-color:rgba(var(--glow-rgb),.05);border:1px solid rgba(var(--glow-rgb),.2);"></div></div>
                                <div id="pet-weight-module" style="display:none;"><h3 class="text-sm accent-text mb-1">PET_WEIGHT_ARCHIVE (Legacy)</h3><div class="h-56 chart-container"><canvas id="weightChart"></canvas></div><div id="weight-change-info" class="mt-2 text-center p-2 rounded-lg h-10 flex items-center justify-center text-xs" style="background-color:rgba(var(--glow-rgb),.05);border:1px solid rgba(var(--glow-rgb),.2);"></div></div>
                            </div>
                        </div>
                        <div class="ui-module flex-grow flex flex-col"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">EVENT_STREAM</h2>
                            <div class="flex text-xs mb-2"><button id="log-toggle-city" class="px-2 py-1 border border-transparent border-b-2 font-bold accent-text" style="border-bottom-color:rgb(var(--accent-rgb))">City Log</button><button id="log-toggle-pet" class="px-2 py-1 opacity-60 hover:opacity-100">Pet Archive</button></div>
                            <div id="city-events-container" class="record-scrollbar flex-grow pr-2 space-y-3"></div>
                            <div id="all-records-container" class="record-scrollbar flex-grow pr-2 space-y-3" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="changelog-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('changelog-modal')"><div class="modal-container w-11/12 max-w-4xl max-h-[80vh] flex flex-col" onclick="event.stopPropagation()"><h2 class="text-xl p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb),.3)">CHANGELOG</h2><div id="changelog-content" class="p-6 overflow-y-auto record-scrollbar"></div></div></div>
    <div id="theme-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('theme-modal')"><div class="modal-container w-11/12 max-w-md" onclick="event.stopPropagation()"><div class="p-4 flex justify-between items-center border-b" style="border-color:rgba(var(--glow-rgb),.3)"><button id="prev-theme-page" class="text-2xl glow-text"><</button><h2 id="theme-page-title" class="text-xl glow-text">COLOR_CYCLE</h2><button id="next-theme-page" class="text-2xl glow-text">></button></div><div id="theme-grid" class="p-6 grid grid-cols-5 gap-4"></div><div class="p-4 border-t flex items-center gap-4" style="border-color:rgba(var(--glow-rgb),.3)"><input id="custom-color-input" type="text" placeholder="色码 或 最终激活码..." class="flex-grow bg-transparent border text-center p-2 rounded-md" style="border-color:rgba(var(--accent-rgb),.5)"><button id="font-toggle-button" class="lcars-button rounded-md px-4 py-2 text-xs">PIXEL FONT</button></div></div></div>
    <div id="performance-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('performance-modal')"><div class="modal-container w-11/12 max-w-lg p-6 flex flex-col" onclick="event.stopPropagation()"><h2 class="text-xl pb-4 mb-4 glow-text border-b flex-shrink-0" style="border-color:rgba(var(--glow-rgb),.3)">OBSERVER_PRIME</h2><div id="perf-modal-content" class="text-xs space-y-1 overflow-y-auto record-scrollbar max-h-[70vh]" style="font-family:'Press Start 2P',sans-serif;"></div></div></div>
    
    <div id="city-management-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('city-management-modal')">
        <div class="modal-container w-11/12 max-w-3xl flex flex-col" style="max-height:95vh;" onclick="event.stopPropagation()">
            <h2 class="text-xl p-2 glow-text border-b flex-shrink-0 text-center" style="border-color:rgba(var(--glow-rgb),.3)">BCC 文字大都会控制中心 <span id="god-mode-modal-indicator" class="text-xs text-red-400 hidden">(上帝模式)</span></h2>
            <div class="p-2 space-y-1 flex-shrink-0 border-b" style="border-color:rgba(var(--glow-rgb),.1);">
                <div class="resource-grid mb-1">
                    <div class="resource-item tooltip">💰<span class="tooltiptext">资金</span>:<span id="sim-funds">0</span></div> 
                    <div class="resource-item tooltip">🧑‍🤝‍🧑<span class="tooltiptext">人口/最大容量</span>:<span id="sim-population">0</span></div>
                    <div class="resource-item tooltip">⚡<span class="tooltiptext">电力需求/产能</span>:<span id="sim-power">0/0</span></div> 
                    <div class="resource-item tooltip">💧<span class="tooltiptext">水源需求/产能</span>:<span id="sim-water">0/0</span></div>
                    <div class="resource-item tooltip">🏭<span class="tooltiptext">工业品产出</span>:<span id="sim-goods-produced">0</span></div>
                    <div class="resource-item tooltip">🛍️<span class="tooltiptext">商品需求</span>:<span id="sim-goods-demand">0</span></div>
                    <div class="resource-item">🗓️<span class="tooltiptext">日期</span>:<span id="sim-date">Y1D1</span></div> 
                    <div class="resource-item tooltip">🔬<span class="tooltiptext">科研点</span>:<span id="sim-research">0</span></div>
                    <div class="resource-item tooltip">🛠️<span class="tooltiptext">劳动力/岗位(失业)</span>:<span id="sim-workforce">0/0(0)</span></div>
                    <div class="resource-item tooltip">💡<span class="tooltiptext">顾问状态</span>:<span id="sim-bunny-status">良好</span></div>
                    <div class="resource-item tooltip">🏆<span class="tooltiptext">城市等级(经验)</span>:<span id="sim-city-level">1(0/100)</span></div>
                    <div class="resource-item tooltip">🪨<span class="tooltiptext">原材料储备(多种)</span>:<span id="sim-raw-materials">0</span></div>
                </div>
                <div class="detail-grid">
                    <div class="detail-item tooltip">😊<span class="tooltiptext">平均满意度</span>:<span id="sim-satisfaction-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-satisfaction-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#10b981,#34d399);"></div></div></div>
                    <div class="detail-item tooltip">🌳<span class="tooltiptext">环境质量</span>:<span id="sim-environment-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-environment-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#22c55e,#4ade80);"></div></div></div>
                    <div class="detail-item tooltip">🚗<span class="tooltiptext">交通压力</span>:<span id="sim-traffic-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-traffic-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#f59e0b,#fbbf24);"></div></div></div>
                    <div class="detail-item tooltip">🗑️<span class="tooltiptext">垃圾处理压力</span>:<span id="sim-garbage-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-garbage-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#a16207,#ca8a04);"></div></div></div>
                </div>
            </div>
            <div id="city-main-screen" class="flex-grow m-2 text-sm record-scrollbar pr-1">市长，请下达指示...</div>
            <div id="city-action-tabs" class="p-1 border-t border-b flex-shrink-0 flex flex-wrap justify-around text-xs" style="border-color:rgba(var(--glow-rgb),.2);">
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button active" onclick="showCityPanel('city-main-screen')">概览</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('construction-panel')">建设</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('budget-panel')">预算</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('policy-panel')">政策</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('tech-tree-panel')">科技</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('district-panel')">区域</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('mayor-actions-panel')">市长行动</button>
                <button id="god-mode-tab-button" class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button hidden" onclick="showCityPanel('god-mode-panel')">GM</button>
            </div>
            <div id="construction-panel" class="sim-panel-content record-scrollbar"></div> <div id="budget-panel" class="sim-panel-content record-scrollbar"></div> 
            <div id="policy-panel" class="sim-panel-content record-scrollbar"></div> <div id="tech-tree-panel" class="sim-panel-content record-scrollbar"></div>
            <div id="district-panel" class="sim-panel-content record-scrollbar"></div><div id="mayor-actions-panel" class="sim-panel-content record-scrollbar"></div>
            <div id="god-mode-panel" class="sim-panel-content record-scrollbar p-2 space-y-2"></div>
            <div class="p-1 border-t flex-shrink-0 flex justify-around" style="border-color:rgba(var(--glow-rgb),.3)">
                <button id="sim-next-day-button" class="sim-button" title="结束本日"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/></svg>结束本日</button>
                <button id="sim-save-button" class="sim-button" title="保存进度到浏览器"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v1H5V4zM5 7h10v9a2 2 0 01-2 2H7a2 2 0 01-2-2V7z"/></svg>保存</button>
                 <button id="sim-load-button" class="sim-button" title="从浏览器读取进度"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>读取</button>
            </div>
        </div>
    </div>
    <div id="god-mode-calculator-modal" class="modal-overlay fixed inset-0 z-[210] hidden items-center justify-center opacity-0" onclick="toggleCalculatorModal(false)">
        <div class="modal-container" onclick="event.stopPropagation()">
            <h2 class="text-lg p-3 glow-text border-b" style="border-color:rgba(var(--glow-rgb),.3)">上帝模式 - 激活码计算器</h2>
            <div id="calculator-info" class="p-4 space-y-2"></div>
            <div class="p-3 border-t text-center" style="border-color:rgba(var(--glow-rgb),.3)">
                <button class="lcars-button px-4 py-2 text-sm rounded" onclick="toggleCalculatorModal(false)">明白</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIG, GLOBAL STATE, DEFINITIONS... ---
        const CONFIG={PROFILE_PIC_PATH:'./dist/Bunny CC_Profile.JPG',PET_RECORDS_PATH:'./dist/bunnycc/PetRecords.json',CITY_SAVE_KEY:'bunny_cc_sim_save_v0.9',START_DATE:'2024/03/12 00:00:00',MOUSE_SNAKE_LENGTH:20,COSMIC_DUST_COUNT:250,AVATAR_EFFECT_PRESETS:2,MAX_LOCALSTORAGE_SAVE_BYTES:4.5*1024*1024,GOD_MODE_TITLE_CLICKS:10,GOD_MODE_CALC_SALT_S1:12345,GOD_MODE_JS_ADDON:5678,THEMES:`pink/236,72,153 gold/251,191,36 cyan/34,211,238 magenta/244,114,182 lime/132,204,22 red/239,68,68 indigo/88,86,214 green/34,197,94 white/229,231,235 purple/168,85,247 sky/56,189,248 rose/251,113,133 emerald/16,185,129 amber/245,158,11 violet/139,92,246 fuchsia/217,70,239 teal/20,184,166 blue/59,130,246 lightblue/14,165,233 forest/22,163,74 crimson/220,38,38 silver/156,163,175 bronze/205,133,63 steel/113,128,150 mint/10,200,150 lavender/216,180,254 salmon/250,128,114 turquoise/64,224,208 olive/128,128,0 maroon/128,0,0 navy/0,0,128 coral/255,127,80 orchid/218,112,214 plum/221,160,221 khaki/240,230,140 slateblue/106,90,205 sienna/160,82,45 hotpink/255,105,180 deepskyblue/0,191,255 lawngreen/124,252,0 mediumvioletred/199,21,133 darkorange/255,140,0 dodgerblue/30,144,255 tomato/255,99,71 springgreen/0,255,127 aqua/0,255,255 chartreuse/127,255,0 darkviolet/148,0,211 electric/213,252,9 cosmic/45,15,128 nebula/188,45,225 solar/255,180,0 galactic/75,0,130 cyber/0,255,198 quantum/255,30,90 void/10,10,25 supernova/255,80,0 starlight/230,230,250`.split(' ').map(s=>({n:s.split('/')[0],r:s.split('/')[1]}))};
        const docEl=document.documentElement,bodyEl=document.body;
        const avatarContainer=document.getElementById('avatar-container');const mouseBunnyEl=document.getElementById('mouse-bunny');
        const vfxCanvas=document.getElementById('vfx-canvas'),vfxCtx=vfxCanvas.getContext('2d');
        const mouseTrailCanvas=document.getElementById('bunny-trail-canvas'),mouseTrailCtx=mouseTrailCanvas.getContext('2d');
        const cityManagementModal=document.getElementById('city-management-modal');const cityMainScreen=document.getElementById('city-main-screen');
        const mainTitleArea=document.getElementById('main-title-area');
        const godModeCalculatorModal=document.getElementById('god-mode-calculator-modal');
        const calculatorInfoEl=document.getElementById('calculator-info');
        const simEls={f:document.getElementById('sim-funds'),p:document.getElementById('sim-population'),w:document.getElementById('sim-water'),e:document.getElementById('sim-power'),gP:document.getElementById('sim-goods-produced'),gD:document.getElementById('sim-goods-demand'),d:document.getElementById('sim-date'),r:document.getElementById('sim-research'),wf:document.getElementById('sim-workforce'),bs:document.getElementById('sim-bunny-status'),cl:document.getElementById('sim-city-level'),rm:document.getElementById('sim-raw-materials'),sBar:document.getElementById('sim-satisfaction-bar'),eBar:document.getElementById('sim-environment-bar'),tBar:document.getElementById('sim-traffic-bar'),gbBar:document.getElementById('sim-garbage-bar'),sP:document.getElementById('sim-satisfaction-perc'),eP:document.getElementById('sim-environment-perc'),tP:document.getElementById('sim-traffic-perc'),gbP:document.getElementById('sim-garbage-perc')};
        const simPanels={con:document.getElementById('construction-panel'),bud:document.getElementById('budget-panel'),pol:document.getElementById('policy-panel'),tec:document.getElementById('tech-tree-panel'),dis:document.getElementById('district-panel'),may:document.getElementById('mayor-actions-panel'),god:document.getElementById('god-mode-panel')};
        const cityEventsContainer=document.getElementById('city-events-container'),allRecordsContainer=document.getElementById('all-records-container');
        const populationChartEl=document.getElementById('populationChart'),weightChartEl=document.getElementById('weightChart');
        const petWeightModule=document.getElementById('pet-weight-module');
        let mouse={x:window.innerWidth/2,y:window.innerHeight/2,dx:0,lastX:0},mouseSnake=[];
        let city={},advisorBunny={happiness:75,energy:80,lastFed:-1,lastInteract:-1};
        let weightChartJS,populationChartJS,allPetRecords=[],weightRecords=[];
        let lastPerfUpdateTime=0,frameCount=0,lastFrameTime=0,cosmicDust=[],clickRipples=[],forceParticles=[],celestialParticles=[];
        let currentThemePage=0,audioCtx,avatarState='normal',currentCityPanel='city-main-screen',currentLogView='city';
        let currentAvatarEffect=0,godModeActive=false,titleClickCount=0,lastTitleClickTime=0;
        const CITIZEN_TYPES={LOW_INC:{needs:{housing_density:['LOW'],goods_basic:1,jobs_low_skill:1},tax_contrib:0.8,edu_max:0.3,name:"低收入"},MED_INC:{needs:{housing_density:['LOW','MED'],goods_varied:1,jobs_med_skill:1,recreation_basic:0.5},tax_contrib:1,edu_max:0.6,name:"中等收入"},HIGH_INC:{needs:{housing_density:['MED','HIGH'],goods_luxury:1,jobs_high_skill:1,recreation_advanced:0.5,education_good:0.5},tax_contrib:1.5,edu_max:1,name:"高收入"}};
        const ZONE_DENSITY={LOW:{mod:1,name:"低"},MED:{mod:1.8,name:"中",reqTech:['ZONING_MED_DENSITY']},HIGH:{mod:3,name:"高",reqTech:['ZONING_HIGH_DENSITY']}};
        const RAW_MATERIALS_TYPES={STONE:{n:"石材",baseVal:5,color:"128,128,128"},WOOD:{n:"木材",baseVal:4,color:"139,69,19"},OIL:{n:"石油",baseVal:10,pol:2,color:"50,50,50"},ORE:{n:"矿石",baseVal:8,pol:1,color:"112,128,144"},FARM:{n:"农产品",baseVal:3,color:"154,205,50"},COAL:{n:"煤炭",baseVal:6,color:"70,70,70"}};
        const BUILDING_CATEGORIES={residential:"住宅",commercial:"商业",industrial:"工业",office:"办公",utility:"公共设施",service:"服务",special:"特殊",extractor:"开采",processor:"加工",transport:"交通",road:"道路"};
        const GOODS_TYPES={goods_basic:"基础商品",goods_varied:"多样商品",goods_luxury:"奢侈品",CONSTRUCTION_MATERIALS:"建筑材料",MACHINERY:"机械设备",ELECTRONICS:"电子产品",PROCESSED_FOOD:"加工食品"};
        const BUILDINGS={RZONE_LD_L1:{n:"棚户区",c:150,t:'zone',cat:'residential',density:'LOW',lvl:1,cap:10,pU:-1,wU:-0.5,pol:0.2,m:2,ui:{ic:'🛖'},popTypeReq:['LOW_INC']},RZONE_LD_L2:{n:"平房",c:0,t:'zone',cat:'residential',density:'LOW',lvl:2,cap:25,pU:-2,wU:-1,pol:0.5,m:5,ui:{ic:'🏠'},upgFrom:'RZONE_LD_L1',upgCost:200,upgReq:{landValue:30,serviceCov:.2},popTypeReq:['LOW_INC','MED_INC']},RZONE_MD_L1:{n:"公寓楼",c:800,t:'zone',cat:'residential',density:'MED',lvl:1,cap:70,pU:-6,wU:-3,pol:1,m:15,ui:{ic:'🏡'},popTypeReq:['MED_INC'],reqTech:['ZONING_MED_DENSITY']},RZONE_HD_L1:{n:"高层公寓",c:2000,t:'zone',cat:'residential',density:'HIGH',lvl:1,cap:200,pU:-15,wU:-8,pol:2,m:40,ui:{ic:'🏢'},popTypeReq:['MED_INC','HIGH_INC'],reqTech:['ZONING_HIGH_DENSITY']},CZONE_LD_L1:{n:"小商店",c:200,t:'zone',cat:'commercial',density:'LOW',lvl:1,jS_types:{jobs_low_skill:3,jobs_med_skill:2},pU:-2,wU:-1,pol:0.5,m:5,gI_types:{goods_basic:2},taxMod:0.05,ui:{ic:'🏪'}},CZONE_MD_L1:{n:"购物街",c:1000,t:'zone',cat:'commercial',density:'MED',lvl:1,jS_types:{jobs_low_skill:10,jobs_med_skill:15,jobs_high_skill:5},pU:-12,wU:-5,pol:2.5,m:25,gI_types:{goods_basic:8,goods_varied:7},taxMod:0.1,ui:{ic:'🏬'},reqTech:['ZONING_MED_DENSITY']},IZONE_LD_L1:{n:"轻工厂",c:250,t:'zone',cat:'industrial',density:'LOW',lvl:1,jS_types:{jobs_low_skill:6,jobs_med_skill:2},gO_types:{goods_basic:10},pU:-5,wU:-2,pol:3,m:8,rmIn_types:{WOOD:1,STONE:1},ui:{ic:'🛠️'}},OFFICE_LD_L1:{n:"小型办公室",c:600,t:'zone',cat:'office',density:'LOW',lvl:1,jS_types:{jobs_med_skill:10,jobs_high_skill:5},pU:-5,wU:-1,pol:0.2,m:20,ui:{ic:'🏢'}},QUARRY_STONE:{n:"采石场",c:1500,t:'extractor',cat:'industrial',rmType:'STONE',outBase:10,pU:-20,m:80,pol:8,ui:{ic:'⛏️'}},COAL_MINE:{n:"煤矿",c:1800,t:'extractor',cat:'industrial',rmType:'COAL',outBase:12,pU:-22,m:90,pol:10,ui:{ic:'⚒️'}},LUMBER_MILL:{n:"伐木场",c:1200,t:'extractor',cat:'industrial',rmType:'WOOD',outBase:15,pU:-15,m:60,pol:4,ui:{ic:'🌲🪚'}},OIL_WELL:{n:"油井",c:2500,t:'extractor',cat:'industrial',rmType:'OIL',outBase:5,pU:-25,m:120,pol:12,ui:{ic:'🛢️'}},FARM_SMALL:{n:"小型农场",c:1000,t:'extractor',cat:'agricultural',rmType:'FARM',outBase:20,pU:-5,wU:-5,m:40,pol:1,ui:{ic:'🌾'}},CONCRETE_PLANT:{n:"混凝土厂",c:2000,t:'processor',cat:'industrial',inputs:{STONE:2},gO_types:{CONSTRUCTION_MATERIALS:15},pU:-30,m:100,pol:10,jS_types:{jobs_low_skill:15,jobs_med_skill:5},ui:{ic:'🧱🏭'}},FURNITURE_FACTORY:{n:"家具厂",c:1800,t:'processor',cat:'industrial',inputs:{WOOD:2},gO_types:{goods_varied:12},pU:-25,m:90,pol:8,jS_types:{jobs_low_skill:12,jobs_med_skill:6},ui:{ic:'🛋️🏭'}},PWR_COAL:{n:"燃煤电厂",c:3000,t:'utility',cat:'power',out:100,pol:20,m:100,fuelIn:{COAL:2},ui:{ic:'💨'}},WAT_TOWER:{n:"水塔",c:1500,t:'utility',cat:'water',out:50,pU:-5,m:50,ui:{ic:'💧'}},SCHOOL_E:{n:"小学",c:2500,t:'service',cat:'education',sC:200,pU:-10,m:150,s_b:1,eduBoost:.05,sR:5,ui:{ic:'🏫'}},CLINIC_S:{n:"诊所",c:2000,t:'service',cat:'health',sC:150,pU:-8,m:120,s_b:1,healthBoost:.1,sR:4,ui:{ic:'🏥'}},FIRE_S:{n:"消防站",c:1800,t:'service',cat:'safety',sC:1,pU:-5,m:100,fireRiskRed:.1,sR:4,ui:{ic:'🚒'}},POLICE_S:{n:"警局",c:1800,t:'service',cat:'safety',sC:1,pU:-5,m:100,crimeRed:.1,sR:4,ui:{ic:'🚓'}},LANDFILL:{n:"垃圾填埋场",c:3000,t:'utility',cat:'garbage',sC:5000,pU:-10,m:150,pol:15,rR:3,ui:{ic:'🗑️'}},BUS_DEPOT:{n:"公交总站",c:4000,t:'service',cat:'transport',sC:.2,pU:-15,m:200,trafficRed:.1,s_b:1,sR:6,reqTech:['PUBLIC_TRANSIT'],ui:{ic:'🚌'}},PARK_S:{n:"小型公园",c:300,t:'service',cat:'recreation',s_b:2,e_b:1,sR:3,m:5,ui:{ic:'🌳'}},MAYOR_STATUE:{n:"市长雕像",c:5000,t:'special',cat:'landmark',s_b:5,sR:5,m:10,unique:true,ui:{ic:'🗿'}},BANK:{n:"银行",c:8000,t:'service',cat:'finance',jS_types:{jobs_high_skill:20},pU:-15,m:250,s_b:1,eff:{loanInterestRateMod:-0.005,comRevenueModNearby:0.05},sR:6,reqTech:['BANKING'],ui:{ic:'🏦'}}};
        const TECHS={ZONING_MED_DENSITY:{n:"中密度规划",c:100,t:8,pre:[],eff:{unlockZoneDensity:['MED'],unlock:['RZONE_MD_L1','CZONE_MD_L1']}},ZONING_HIGH_DENSITY:{n:"高密度规划",c:250,t:15,pre:['ZONING_MED_DENSITY','URBAN_PLANNING'],eff:{unlockZoneDensity:['HIGH'],unlock:['RZONE_HD_L1','CZONE_HD_L1']}},ADV_EDUCATION:{n:"高等教育",c:150,t:10,pre:['URBAN_PLANNING'],eff:{unlock:['HIGH_SCHOOL','UNIVERSITY'],global:{workerQualityBonus:0.05}}},MEDICAL_RESEARCH:{n:"医疗研究",c:180,t:12,pre:['ADV_EDUCATION'],eff:{unlock:['HOSPITAL'],global:{healthBonus:5}}},PUBLIC_TRANSIT:{n:"公共交通",c:200,t:12,pre:['URBAN_PLANNING'],eff:{unlock:['BUS_DEPOT','METRO_STATION'],global:{trafficIndexMod:-0.05}}},WASTE_MANAGEMENT:{n:"废物管理",c:80,t:6,pre:[],eff:{unlock:['RECYCLING_CENTER'],modify:{type:'building',target:'LANDFILL',prop:'pol',val:0.8,mode:'mul'}}},BANKING:{n:"银行业",c:300,t:15,pre:['COMMERCE_BASICS'],eff:{unlock:['BANK'],global:{loanInterestRateMod:-0.01}}},ADV_INDUSTRIAL_TECH:{n:"先进工业技术",c:220,t:14,pre:['INDUSTRIAL_PROCESSES'],eff:{global:{industrialOutputMod:0.1,industrialPollutionMod:-0.05}}},CONSTRUCTION_BASICS:{n:"基础建筑学",c:50,t:5,pre:[],eff:{global:{buildCostModRes:-0.05}}},COMMERCE_BASICS:{n:"基础商业学",c:60,t:6,pre:[],eff:{global:{taxModCom:0.01}}},INDUSTRIAL_PROCESSES:{n:"工业流程优化",c:70,t:7,pre:[],eff:{global:{goodsOutputModInd:0.05}}},URBAN_PLANNING:{n:"城市规划",c:120,t:12,pre:['CONSTRUCTION_BASICS','COMMERCE_BASICS'],eff:{global:{taxBonus:0.02,landValueBoost:0.05}}}};
        const POLICIES={TAX_HIKE_RES:{n:"提高住宅税",desc:"住宅税率+2%",eff:{type:'tax_change',target:'res',val:2,mode:'add'},satisImpact:-3,active:false},FREE_PUBLIC_TRANSPORT:{n:"免费公交",desc:"交通压力-15%,满意度+5,每日高额成本",eff:{global:{trafficIndexMod:-0.15,satisfactionMod:5}},costPerDay:500,active:false,reqTech:['PUBLIC_TRANSIT']},POWER_SAVING:{n:"节能倡议",desc:"电力消耗-10%,工业产出略降",eff:{global:{powerDemandMod:-0.1,industrialOutputMod:-0.02}},costPerDay:20,active:false},EDUCATION_GRANTS:{n:"教育补贴",desc:"教育水平提升加速,教育建筑成本增加",eff:{global:{educationProgressSpeed:1.2,educationBuildingCostMod:0.1}},costPerDay:100,active:false,reqTech:['ADV_EDUCATION']}};
        const DISTRICT_SPECIALIZATIONS={GENERIC:{n:"通用区",desc:"无特定加成。",effects:{}},FINANCIAL:{n:"金融区",desc:"+20%办公税,办公楼运营成本-10%",effects:{taxModOffice:0.2,officeCostMod:-0.1},reqTech:['BANKING']},TOURISM:{n:"旅游区",desc:"+15%商业收入,吸引游客",effects:{comRevenueMod:0.15,tourismAttraction:10},reqTech:['HOSPITALITY']}};
        const MAYOR_ACTIONS={SPEECH_INSPIRING:{n:"鼓舞演讲",desc:"全市满意度+5%(3天)",c:1000,eff:{type:'timed_boost',target:'avgSatisfaction',val:5,dur:3,advisorEnergyCost:10}},EMERGENCY_LOAN_SMALL:{n:"小型紧急贷款",desc:"获得5000资金,利率5%,10天后还本付息",c:0,loanAmount:5000,interestRate:0.05,termDays:10,eff:{type:'loan'},advisorEnergyCost:0},FEED_ADVISOR:{n:"喂食顾问",desc:"顾问精力+50,快乐+20(需1零食)",c:0,eff:{type:'advisor_feed'},unlockReq:{item:'SPECIAL_SNACKS',qty:1},advisorEnergyCost:0}};

        // --- Initialize & Event Listeners ---
        document.addEventListener('DOMContentLoaded',()=>{document.getElementById('profile-pic').src=CONFIG.PROFILE_PIC_PATH;Chart.defaults.font.family="'Noto Sans SC',sans-serif";Chart.defaults.font.size=12;setupEventListeners();initVFX();loadAndProcessPetData();setupThemeEngine();initMouseBunny();initCitySim();lastFrameTime=performance.now();requestAnimationFrame(animationLoop);setInterval(updateAdvisorBunny,5000);});
        function setupEventListeners(){window.addEventListener('pointermove',e=>{mouse.lastX=mouse.x;mouse.x=e.clientX;mouse.y=e.clientY;mouse.dx=mouse.x-mouse.lastX;docEl.style.setProperty('--mouse-x',`${e.clientX}px`);docEl.style.setProperty('--mouse-y',`${e.clientY}px`);});window.addEventListener('resize',()=>{[mouseTrailCanvas,vfxCanvas].forEach(c=>{c.width=window.innerWidth;c.height=window.innerHeight;});renderPopulationChart();if(weightRecords.length>0)renderWeightChart();});window.addEventListener('pointerdown',e=>{createClickRipple(e.clientX,e.clientY);initAudio();});avatarContainer.addEventListener('pointerdown',handleAvatarClick);mainTitleArea.addEventListener('click',handleTitleClickForGodMode);document.getElementById('font-toggle-button').addEventListener('click',toggleFont);document.getElementById('prev-theme-page').addEventListener('click',()=>changeThemePage(-1));document.getElementById('next-theme-page').addEventListener('click',()=>changeThemePage(1));document.getElementById('custom-color-input').addEventListener('change',applyCustomColorOrGodModeKey);document.getElementById('sim-next-day-button').addEventListener('click',advanceDay);document.getElementById('sim-save-button').addEventListener('click',saveCity);document.getElementById('sim-load-button').addEventListener('click',loadCity);document.getElementById('log-toggle-city').addEventListener('click',()=>toggleLogView('city'));document.getElementById('log-toggle-pet').addEventListener('click',()=>toggleLogView('pet'));}
        
        // --- Core Animation Loop & Basic VFX ---
        function animationLoop(cT){const dT=cT-lastFrameTime;lastFrameTime=cT;vfxCtx.clearRect(0,0,vfxCanvas.width,vfxCanvas.height);updateAndDrawCosmicDust();updateAndDrawClickRipples();updateAndDrawForceParticles();updateAndDrawMouseBunny();updateAndDrawCelestialParticles(vfxCtx);frameCount++;if(cT-lastPerfUpdateTime>500){updatePerfPanel(cT);}requestAnimationFrame(animationLoop);}
        function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
        function playSound(type,opts={}){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);let d=1;o.type=opts.w||'sine';g.gain.setValueAtTime(opts.v||.1,audioCtx.currentTime);o.frequency.setValueAtTime(opts.fS||440,audioCtx.currentTime);if(type==='dissolve'){o.type='sawtooth';o.frequency.setValueAtTime(1500,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(50,audioCtx.currentTime+3);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+3);d=3;}else if(type==='rebuild'){o.type='sine';o.frequency.setValueAtTime(80,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(2500,audioCtx.currentTime+4);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+4.2);d=4.2;}else if(type==='confirm'){o.frequency.setValueAtTime(600,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.1);d=.1;}else if(type==='build'){o.type='square';o.frequency.setValueAtTime(200,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(300,audioCtx.currentTime+.1);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.2);d=.2;}else if(type==='error'){o.type='sawtooth';o.frequency.setValueAtTime(400,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(100,audioCtx.currentTime+.3);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.3);d=.3;}else if(type==='special'){o.type='triangle';o.frequency.setValueAtTime(800,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(1600,audioCtx.currentTime+.15);o.frequency.linearRampToValueAtTime(400,audioCtx.currentTime+.3);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.4);d=.4;}else if(type==='milestone'){o.type='sine';o.frequency.setValueAtTime(523.25,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(1046.5,audioCtx.currentTime+.3);g.gain.setValueAtTime(.15,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.5);d=.5;}else if(type==='godmode'){o.type='sawtooth';o.frequency.setValueAtTime(130.81,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(261.63,audioCtx.currentTime+.1);g.gain.setValueAtTime(.2,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.2);d=.2;}o.start();o.stop(audioCtx.currentTime+d);}
        function initVFX(){[vfxCanvas,mouseTrailCanvas].forEach(c=>{c.width=window.innerWidth;c.height=window.innerHeight;});for(let i=0;i<CONFIG.COSMIC_DUST_COUNT;i++){cosmicDust.push({x:Math.random()*vfxCanvas.width,y:Math.random()*vfxCanvas.height,z:Math.random()*1e3,vx:(Math.random()-.5)*.1,vy:(Math.random()-.5)*.1,s:Math.random()*1.5+.5});}}
        function updateAndDrawCosmicDust(){vfxCtx.fillStyle=`rgba(var(--text-color-rgb),.5)`;cosmicDust.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=vfxCanvas.width;if(p.x>vfxCanvas.width)p.x=0;if(p.y<0)p.y=vfxCanvas.height;if(p.y>vfxCanvas.height)p.y=0;vfxCtx.beginPath();vfxCtx.arc(p.x,p.y,p.s,0,Math.PI*2);vfxCtx.fill();});}
        function createClickRipple(x,y){clickRipples.push({x,y,r:0,mR:60,l:1});}
        function updateAndDrawClickRipples(){clickRipples=clickRipples.filter(r=>r.l>0);clickRipples.forEach(r=>{r.r=(1-r.l)*r.mR;r.l-=.04;vfxCtx.strokeStyle=`rgba(var(--accent-rgb),${r.l})`;vfxCtx.lineWidth=2;vfxCtx.beginPath();vfxCtx.arc(r.x,r.y,r.r,0,Math.PI*2);vfxCtx.stroke();});}
        function createForceBurst(count,x,y,colorOverride=null,speedMod=1,sizeMod=1){const rect=avatarContainer.getBoundingClientRect();x=x||rect.left+rect.width/2;y=y||rect.top+rect.height/2;for(let i=0;i<count;i++){const a=Math.random()*Math.PI*2,s=(Math.random()*8+4)*speedMod;forceParticles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,l:1,sz:(Math.random()*4+2)*sizeMod,c:colorOverride||(Math.random()>.3?`var(--glow-rgb)`:Math.random()>.5?`var(--accent-rgb)`:`255,255,255`)});}}
        function updateAndDrawForceParticles(){forceParticles=forceParticles.filter(p=>p.l>0);forceParticles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=.97;p.vy*=.97;p.vy+=.05;p.l-=.015;const clr=p.c.startsWith('var')?getComputedStyle(docEl).getPropertyValue(p.c.slice(4,-1)).trim():p.c;vfxCtx.fillStyle=`rgba(${clr},${p.l*p.l})`;vfxCtx.beginPath();vfxCtx.arc(p.x,p.y,Math.max(0,p.sz*p.l),0,Math.PI*2);vfxCtx.fill();});}
        function initMouseBunny(){for(let i=0;i<CONFIG.MOUSE_SNAKE_LENGTH;i++){mouseSnake.push({x:mouse.x,y:mouse.y});}}
        function updateAndDrawMouseBunny(){mouseTrailCtx.clearRect(0,0,mouseTrailCanvas.width,mouseTrailCanvas.height);let h={...mouseSnake[0]};h.x+=(mouse.x-h.x)*.25;h.y+=(mouse.y-h.y)*.25;mouseSnake.unshift(h);if(mouseSnake.length>CONFIG.MOUSE_SNAKE_LENGTH)mouseSnake.pop();const gR=getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim(),aR=getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim();for(let i=1;i<mouseSnake.length;i++){const gr=mouseTrailCtx.createLinearGradient(mouseSnake[i-1].x,mouseSnake[i-1].y,mouseSnake[i].x,mouseSnake[i].y);const op=1-(i/mouseSnake.length);gr.addColorStop(0,`rgba(${gR},${op*.8})`);gr.addColorStop(1,`rgba(${aR},${op*.8})`);mouseTrailCtx.strokeStyle=gr;mouseTrailCtx.lineWidth=1+(mouseSnake.length-i)*.15;mouseTrailCtx.beginPath();mouseTrailCtx.moveTo(mouseSnake[i-1].x,mouseSnake[i-1].y);mouseTrailCtx.lineTo(mouseSnake[i].x,mouseSnake[i].y);mouseTrailCtx.stroke();}mouseBunnyEl.style.left=`${h.x}px`;mouseBunnyEl.style.top=`${h.y}px`;if(mouse.dx!==0)mouseBunnyEl.style.transform=`translate(-50%,-50%) scaleX(${mouse.dx>0?1:-1})`;}
        
        // --- AVATAR EFFECT (Taijitu & Granzort) ---
        function handleAvatarClick(){if(avatarState==='normal'){dissolveAvatar();}}
        function dissolveAvatar() { if(avatarState!=='normal')return;avatarState='animating';currentAvatarEffect=(currentAvatarEffect+1)%CONFIG.AVATAR_EFFECT_PRESETS; const pic=document.getElementById('profile-pic');pic.style.opacity='0'; const rect=avatarContainer.getBoundingClientRect(),cX=rect.left+rect.width/2,cY=rect.top+rect.height/2; celestialParticles=[]; let dur1=1500,dur2=8000,dur3=3000,endTime=dur1+dur2+dur3+500; playSound('dissolve',{v:.2,fS:1800,fE:100,d:(dur1+dur2)/1000}); const taijiColors=[`rgb(var(--text-color-rgb))`,`rgb(var(--bg-color))`],carrotOrange='255,140,0',bunnyPink='255,182,193'; for(let i=0;i<2;i++){for(let j=0;j<80;j++){const ang=Math.PI*i+j/80*Math.PI;const r=20+j*0.7;celestialParticles.push({x:cX,y:cY,r,a:ang,s:2,c:taijiColors[i],st:'taiji_form',l:1,sp:(Math.random()-.5)*.005,tEnd:dur1,startTime:performance.now()});}} for(let i=0;i<2;i++){celestialParticles.push({x:cX+(i===0?1:-1)*35,y:cY,s:25,txt:(i===0?'🐰':'🥕'),c:(i===0?bunnyPink:carrotOrange),st:'taiji_eye',l:1,tEnd:dur1+dur2,rot:0,rotSpd:(i===0?0.02:-0.02),startTime:performance.now()});} const baGuaSymbols=['☰','☱','☲','☳','☴','☵','☶','☷'];for(let i=0;i<8;i++){const ang=i/8*Math.PI*2-Math.PI/8;celestialParticles.push({x:cX+Math.cos(ang)*80,y:cY+Math.sin(ang)*80,s:18,txt:baGuaSymbols[i],c:'gold',st:'taiji_bagua',l:0,fadeInEnd:dur1/2,holdEnd:dur1,tEnd:dur1+dur2/2,startTime:performance.now(),lastUpdateTime:performance.now()});} setTimeout(()=>{ playSound('special',{v:.3,fS:200,fE:1200,d:dur2/1000}); celestialParticles.filter(p=>p.st==='taiji_form'||p.st==='taiji_swirl'||p.st==='taiji_bagua').forEach(p=>p.st='granzort_expand'); const G_SYMBOLS=['輝','力','速','α','β','γ','δ','Ω']; let g_rad=90; for(let i=0;i<5;i++){for(let j=0;j<24+i*8;j++){ const ang=j/(24+i*8)*Math.PI*2; celestialParticles.push({x:cX,y:cY,r:g_rad+i*20,a:ang,s:1.2+i*0.15,c:`hsla(${160+i*25+Math.random()*20},90%,75%,.6)`,st:'granzort_form',l:1,sp:(.0015+.0008*i)*(i%2===0?1:-1),tEnd:dur2,maxR:g_rad+(4*20)+30,startTime:performance.now()});}} for(let i=0;i<8;i++){ const ang=i/8*Math.PI*2+Math.PI/16; celestialParticles.push({x:cX+Math.cos(ang)*160,y:cY+Math.sin(ang)*160,s:18,txt:G_SYMBOLS[i],c:'cyan',st:'granzort_rune',l:1,tEnd:dur2,origR:160,origA:ang,startTime:performance.now()});} celestialParticles.filter(p=>p.st==='taiji_eye').forEach(p=>{p.st='granzort_center_swirl';p.tEnd=dur2;p.targetR=p.txt==='🐰'?15:45;p.swirlSpd=p.txt==='🐰'?0.05:-0.03;}); },dur1); setTimeout(()=>{ playSound('rebuild',{v:.25,fS:100,fE:2000,d:dur3/1000}); celestialParticles.forEach(p=>p.st='converging'); },dur1+dur2); setTimeout(()=>{celestialParticles=[];pic.style.opacity='1';avatarState='normal';createForceBurst(120,cX,cY,null,1.8,1.8);},endTime); }
        function updateAndDrawCelestialParticles(ctx){if(celestialParticles.length===0)return;const rect=avatarContainer.getBoundingClientRect(),cX=rect.left+rect.width/2,cY=rect.top+rect.height/2;let now=performance.now();celestialParticles=celestialParticles.filter(p=>p.l>0);celestialParticles.forEach(p=>{p.l-=.0004;p.a+=(p.sp||0);p.rot+=(p.rotSpd||0); switch(p.st){case 'taiji_form':p.r*=.985;p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='taiji_swirl';break;case 'taiji_swirl':p.r=Math.max(2,p.r*.97);p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;break;case 'taiji_eye':p.r=35;p.x=cX+Math.cos(p.a+(p.txt==='🐰'?0:Math.PI))*p.r;p.y=cY+Math.sin(p.a+(p.txt==='🐰'?0:Math.PI))*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='fade_out';break;case 'taiji_bagua':if(p.l<1&&now<(p.startTime+(p.fadeInEnd||0))){p.l=Math.min(1,(now-(p.startTime||0))/(p.fadeInEnd||1));}else if(now>(p.startTime+(p.holdEnd||0))){p.l=Math.max(0,1-(now-(p.startTime+(p.holdEnd||0)))/((p.tEnd||0)-(p.holdEnd||0)));}p.s=18*p.l;break;case 'granzort_expand':p.r*=1.03;p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;p.l*=.985;if(p.r>(p.maxR||350))p.l=0;break;case 'granzort_form':p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='fade_out';break;case 'granzort_rune':p.r=p.origR*(1-Math.sin(Math.PI*(1-p.l/1)));p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='fade_out';p.s=18*p.l;break;case 'granzort_center_swirl':p.r+=(p.targetR-p.r)*.05;p.a+=p.swirlSpd;p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='fade_out';p.s=Math.max(10,p.s*.99);break;case 'converging':p.x+=(cX-p.x)*.1;p.y+=(cY-p.y)*.1;p.s*=.92;p.l*=.97;break;case 'fade_out':p.l*=.85;break;} p.lastUpdateTime=now; ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.globalAlpha=Math.max(0,Math.min(1,p.l*p.l));if(p.txt){ctx.font=`${Math.max(1,p.s)}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle=p.c||`rgb(var(--text-color-rgb))`;ctx.fillText(p.txt,0,0);}else{ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,Math.max(.5,p.s),0,Math.PI*2);ctx.fill();}ctx.restore();});ctx.globalAlpha=1;}
        
        // --- Advisor Bunny (Integrated into City Sim) & City Sim Core ---
        function updateAdvisorBunny(){advisorBunny.energy=Math.max(0,advisorBunny.energy-.5*(city.population/10000+1||1));advisorBunny.happiness=Math.max(20,advisorBunny.happiness-.2*(1+(50-(city.avgSatisfaction||50))/100));if(simEls.bs)simEls.bs.textContent=advisorBunny.energy<30?'疲惫':(advisorBunny.happiness<40?'不悦':'良好');if(advisorBunny.energy<20&&city.day-(advisorBunny.lastFed||-10)>5){logCityEvent("提示: 城市顾问Bunny看起来精疲力尽，考虑在'市长行动'中喂食它。","system");advisorBunny.lastFed=city.day;}if(city.timedBoosts&&city.timedBoosts.some(b=>b.source==='advisor_speech'&&b.remainingDays>0))advisorBunny.happiness=Math.min(100,advisorBunny.happiness+.5);}
        function handleMayorAction_FeedAdvisor(){if(city.inventory.SPECIAL_SNACKS>0&&advisorBunny.energy<100){city.inventory.SPECIAL_SNACKS--;advisorBunny.energy=Math.min(100,advisorBunny.energy+50);advisorBunny.happiness=Math.min(100,advisorBunny.happiness+20);advisorBunny.lastFed=city.day;logCityEvent("顾问Bunny享用了特殊零食，精力充沛！","action");playSound('special');}else if(city.inventory.SPECIAL_SNACKS<=0){logCityEvent("没有特殊零食来喂顾问Bunny。","error");}else{logCityEvent("顾问Bunny精力充沛，现在不想吃。","info");}updateAdvisorBunny();renderMayorActionsPanel();}
        function initCitySim(){const sS=localStorage.getItem(CONFIG.CITY_SAVE_KEY);if(sS&&!godModeActive){try{const lc=JSON.parse(sS);city=validateLoadedCity(lc);logCityEvent("从浏览器加载存档成功！","system");}catch(e){console.error("加载城市存档失败:",e);generateNewCityState();logCityEvent("存档损坏，已重置为新城市。","error");}}else{generateNewCityState();if(!godModeActive) logCityEvent(`欢迎来到 ${city.name}，市长！新的城市等待您的规划。`,'system'); else logCityEvent("上帝模式已激活，开始新游戏。","godmode");}initCitySimAfterLoad();}
        function generateNewCityState(){const nameSuffix=Math.floor(Math.random()*900)+100; city={id:`city_${Date.now()}_${nameSuffix}`,name:"兔克市"+nameSuffix,day:1,year:1,funds:20000+Math.floor(Math.random()*15000),population:0,maxPopulation:0,avgSatisfaction:60+Math.floor(Math.random()*15),environmentQuality:70+Math.floor(Math.random()*15),researchPoints:20+Math.floor(Math.random()*30),powerCapacity:0,powerDemand:0,waterCapacity:0,waterDemand:0,goodsProducedByType:{},goodsDemandByType:{},rawMaterialsStock:{STONE:50,WOOD:50,OIL:20,ORE:30,FARM:60,COAL:40},jobsAvailableBySkill:{jobs_low_skill:0,jobs_med_skill:0,jobs_high_skill:0},workforceBySkill:{jobs_low_skill:0,jobs_med_skill:0,jobs_high_skill:0},unemployed:0,taxRate:{res:9,com:10,ind:8,office:11},budget:{services:100,education:100,health:100,safety:100,transport:100,garbage:100,maintenance:100},zones:[],buildings:[],activePolicies:{},unlockedTech:[],unlockedZoneDensities:['LOW'],eventLog:[],populationHistory:[{d:0,p:0}],landValueGrid:createGrid(10,50),trafficIndex:10,crimeRate:5,fireRisk:5,healthIndex:70,educationIndex:0.1,pollutionGrid:createGrid(10,0),garbageAccumulated:0,garbageCapacity:0,timedBoosts:[],inventory:{SPECIAL_SNACKS:3},cityLevel:1,cityXP:0,cityXPNext:100,districts:[],mapSeed:Math.random(),trade:{exportVal:0,importVal:0,routes:[]},loans:[]};Object.values(GOODS_TYPES).forEach(gtn => { city.goodsProducedByType[gtn] = 0; city.goodsDemandByType[gtn] = 0; }); }
        function createGrid(size,val){return Array(size).fill(null).map(()=>Array(size).fill(val));}
        function validateLoadedCity(lc){const dc=generateNewCityState();for(const k in dc){if(lc[k]===undefined||(typeof lc[k]==='object'&&lc[k]===null&&typeof dc[k]==='object'&&dc[k]!==null)){lc[k]=JSON.parse(JSON.stringify(dc[k]));}else if(typeof dc[k]==='object'&&dc[k]!==null&&!Array.isArray(dc[k])){if(typeof lc[k]!=='object'||lc[k]===null)lc[k]=JSON.parse(JSON.stringify(dc[k]));else for(const sk in dc[k]){if(lc[k][sk]===undefined)lc[k][sk]=dc[k][sk];}}}return lc;}
        function advanceDay(){ city.day++;let milestoneReached=false;if(city.day>30){city.day=1;city.year++;if(city.year%2===0&&city.inventory.SPECIAL_SNACKS<5){city.inventory.SPECIAL_SNACKS++;logCityEvent("年度预算包含顾问兔零食!","system");}Object.values(RAW_MATERIALS_TYPES).forEach(rt=>city.rawMaterialsStock[rt.n]=(city.rawMaterialsStock[rt.n]||0)+Math.floor(Math.random()*5));city.loans.forEach(l=>{if(l.remainingTerm>0){l.remainingTerm--;city.funds-=l.paymentPerDay;if(l.remainingTerm===0)logCityEvent(`贷款 ${l.id.substring(0,5)} 已还清！`,'finance');}});city.loans=city.loans.filter(l=>l.remainingTerm>0);}city.timedBoosts=city.timedBoosts.filter(b=>{b.remainingDays--;if(b.remainingDays<=0)logCityEvent(`${b.target}效果结束。`,'info');return b.remainingDays>0;});let dInc=0,dExp=0,pollutionToday=0,eduCap=0,healthCap=0,fireStations=0,policeStations=0,garbageCapacityToday=0,rawMatProdToday={},rawMatConsToday={},jobDemandBySkill={low:0,med:0,high:0};Object.keys(RAW_MATERIALS_TYPES).forEach(k=>{rawMatProdToday[k]=0;rawMatConsToday[k]=0;});Object.values(GOODS_TYPES).forEach(gtn=>{city.goodsProducedByType[gtn]=0;city.goodsDemandByType[gtn]=0;});
            city.powerDemand=0;city.powerCapacity=0;city.waterDemand=0;city.waterCapacity=0;city.maxPopulation=0;city.jobsAvailableBySkill={jobs_low_skill:0,jobs_med_skill:0,jobs_high_skill:0};
            let totalMaintenanceModifier=(city.budget.maintenance||100)/100;
            city.buildings.forEach(b=>{const bd=BUILDINGS[b.id];if(!bd) return; const densityMod=bd.density?ZONE_DENSITY[bd.density].mod:1;let serviceBudgetMod=(bd.cat&&city.budget[BUILDING_CATEGORIES[bd.cat]?.toLowerCase()]||100)/100;if(bd.m)dExp+=bd.m*densityMod*serviceBudgetMod*totalMaintenanceModifier;city.powerDemand+=(bd.pU||0)*densityMod;if(bd.out&&bd.cat==='power')city.powerCapacity+=bd.out*serviceBudgetMod;city.waterDemand+=(bd.wU||0)*densityMod;if(bd.out&&bd.cat==='water')city.waterCapacity+=bd.out*serviceBudgetMod;if(bd.cap)city.maxPopulation+=bd.cap*densityMod;if(bd.gO_types){Object.entries(bd.gO_types).forEach(([type,amt])=>city.goodsProducedByType[type]=(city.goodsProducedByType[type]||0)+amt*densityMod*serviceBudgetMod*(1+city.educationIndex*.2));}if(bd.gI_types){Object.entries(bd.gI_types).forEach(([type,amt])=>city.goodsDemandByType[type]=(city.goodsDemandByType[type]||0)+amt*densityMod);}if(bd.rmIn_types){Object.entries(bd.rmIn_types).forEach(([mat,qty])=>rawMatConsToday[mat]=(rawMatConsToday[mat]||0)+qty*densityMod);}if(bd.rmType&&bd.outBase)rawMatProdToday[bd.rmType]=(rawMatProdToday[bd.rmType]||0)+bd.outBase*densityMod*serviceBudgetMod;if(bd.jS_types){Object.entries(bd.jS_types).forEach(([skill,num])=>city.jobsAvailableBySkill[skill]=(city.jobsAvailableBySkill[skill]||0)+num*densityMod);}if(bd.pol)pollutionToday+=bd.pol*densityMod;if(bd.cat==='education'&&bd.sC)eduCap+=bd.sC*serviceBudgetMod;if(bd.cat==='health'&&bd.sC)healthCap+=bd.sC*serviceBudgetMod;if(bd.cat==='safety'&&(bd.id.includes('FIRE')))fireStations+=bd.sC*serviceBudgetMod;if(bd.cat==='safety'&&(bd.id.includes('POLICE')))policeStations+=bd.sC*serviceBudgetMod;if(bd.cat==='garbage'&&bd.sC)garbageCapacityToday+=bd.sC*serviceBudgetMod;});
            Object.keys(rawMatConsToday).forEach(mat=>{if(rawMatConsToday[mat]>0){const needed=rawMatConsToday[mat];const available=city.rawMaterialsStock[mat]||0;const consumed=Math.min(needed,available);city.rawMaterialsStock[mat]-=consumed;if(consumed<needed)Object.keys(city.goodsProducedByType).forEach(gk=>city.goodsProducedByType[gk]*=0.7);}});Object.keys(rawMatProdToday).forEach(mat=>city.rawMaterialsStock[mat]=(city.rawMaterialsStock[mat]||0)+rawMatProdToday[mat]);
            city.garbageAccumulated+=Math.floor(city.population*.15+city.buildings.filter(b=>BUILDINGS[b.id]?.cat==='industrial').length*8);let garbageProcessed=Math.min(city.garbageAccumulated,garbageCapacityToday);city.garbageAccumulated-=garbageProcessed;
            let landValueScore=50+city.buildings.reduce((acc,b)=>(acc+(BUILDINGS[b.id]?.lVMod||0)*200),0)/Math.max(1,city.buildings.length);landValueScore*=(1+(advisorBunny.happiness-50)/150-(city.garbageAccumulated/Math.max(100,city.population*2))*50);landValueScore=Math.max(5,Math.min(250,landValueScore));
            city.educationIndex=Math.min(1,eduCap/Math.max(1,city.population*.5));city.healthIndex=Math.min(100,50+(healthCap/Math.max(1,city.population*.6))*50);city.fireRisk=Math.max(0.5,10-fireStations*0.1-(city.unlockedTech.includes('FIRE_PREVENTION_PLANNING')?3:0));city.crimeRate=Math.max(0.5,10-policeStations*0.1-(city.unlockedTech.includes('NEIGHBORHOOD_WATCH')?3:0));
            city.workforceBySkill.jobs_low_skill=Math.floor(city.population*0.6*(1-city.educationIndex)*0.8);city.workforceBySkill.jobs_med_skill=Math.floor(city.population*0.6*city.educationIndex*0.6);city.workforceBySkill.jobs_high_skill=Math.floor(city.population*0.6*city.educationIndex*0.4);city.workforce=Object.values(city.workforceBySkill).reduce((s,v)=>s+v,0);let totalJobs=Object.values(city.jobsAvailableBySkill).reduce((s,v)=>s+v,0);city.unemployed=Math.max(0,city.workforce-totalJobs);
            let resTax=0,comTax=0,indTax=0,offTax=0;city.buildings.filter(b=>BUILDINGS[b.id]?.t==='zone').forEach(z=>{const zd=BUILDINGS[z.id];const densMod=ZONE_DENSITY[zd.density].mod;const popInZone=Math.min(zd.cap*densMod,city.population*0.25/(city.buildings.filter(x=>BUILDINGS[x.id]?.cat==='residential').length||1));const zoneLV=landValueScore*(1+(zd.lVMod||0));if(zd.cat==='residential')resTax+=popInZone*(city.taxRate.res/100)*.7*(zoneLV/100);else if(zd.cat==='commercial')comTax+=(zd.jS_types?Object.values(zd.jS_types).reduce((s,v)=>s+v,0):zd.jS)*densMod*(city.taxRate.com/100)*1.0*(zoneLV/100)*(Math.min(1,city.goodsProducedByType.goods_basic/(city.goodsDemandByType.goods_basic||1)));else if(zd.cat==='industrial')indTax+=(zd.jS_types?Object.values(zd.jS_types).reduce((s,v)=>s+v,0):zd.jS)*densMod*(city.taxRate.ind/100)*.8*((Object.values(city.rawMaterialsStock).reduce((s,v)=>s+v,0))>0?1:0.4);else if(zd.cat==='office')offTax+=(zd.jS_types?Object.values(zd.jS_types).reduce((s,v)=>s+v,0):zd.jS)*densMod*(city.taxRate.office/100)*1.1*(1+city.educationIndex*.5);});dInc=Math.floor(resTax+comTax+indTax+offTax);Object.keys(city.activePolicies).forEach(polKey=>{const p=POLICIES[polKey];if(p&&p.eff.global&&p.eff.global.taxBonusTotal)dInc*=(1+p.eff.global.taxBonusTotal);if(p&&p.costPerDay)dExp+=p.costPerDay;});city.funds+=dInc-dExp;city.cityXP+=Math.floor(dInc/150+city.population/80+Object.keys(city.unlockedTech).length*2);
            if(dInc>0)logCityEvent(`税收:+${dInc}💰`,'finance');if(dExp>0)logCityEvent(`维护费:-${dExp}💰`,'finance');
            if(city.cityXP>=city.cityXPNext){city.cityLevel++;city.cityXP-=city.cityXPNext;city.cityXPNext=Math.floor(city.cityXPNext*(1.4+city.cityLevel*0.05));logCityEvent(`城市已升级至 ${city.cityLevel} 级! 解锁新内容！`,'milestone');playSound('milestone');milestoneReached=true;Object.entries(BUILDINGS).forEach(([k,b])=>{if(b.reqLevel===city.cityLevel)logCityEvent(`新建筑已解锁: ${b.n}`,'unlock');});Object.entries(TECHS).forEach(([k,t])=>{if(t.reqLevel===city.cityLevel)logCityEvent(`新科技可研发: ${t.n}`,'unlock');});}
            let researchBoost=1+(city.activePolicies.ENCOURAGE_RD?0.25:0)+(city.educationIndex*0.2);researchBoost*=(advisorBunny.energy/100)*0.5+0.5; city.researchPoints+=city.buildings.reduce((acc,b)=>acc+(BUILDINGS[b.id]?.r_o||0),0)*researchBoost;if(city.currentResearch){city.currentResearch.daysLeft--;if(city.currentResearch.daysLeft<=0){const techKey=city.currentResearch.key;city.unlockedTech.push(techKey);logCityEvent(`科技 ${TECHS[techKey].n} 研发完成!`,'tech');delete city.currentResearch;renderTechTreePanel();milestoneReached=true;applyTechEffect(techKey);}}
            let pSufficient=city.powerCapacity>=city.powerDemand,wSufficient=city.waterCapacity>=city.waterDemand,jSufficient=city.unemployed<city.workforce*0.1,gbSufficient=garbageCapacityToday>=city.garbageAccumulated;let gSufficientTotal=true;Object.keys(city.goodsDemandByType).forEach(gk=>{if(city.goodsDemandByType[gk]>0 && city.goodsProducedByType[gk]<city.goodsDemandByType[gk]*0.8)gSufficientTotal=false;});
            let satisfChange=0;satisfChange+=(pSufficient?1.5:-4);satisfChange+=(wSufficient?1.5:-4);satisfChange+=(jSufficient?2.5:-5);satisfChange+=(gSufficientTotal?1.5:-2.5);satisfChange+=(gbSufficient?1:-3);satisfChange-=city.crimeRate/2.5;satisfChange-=city.fireRisk/2.5;satisfChange+=(city.healthIndex-60)/6;satisfChange+=(city.educationIndex-.08)*40;satisfChange-=city.trafficIndex/15;city.timedBoosts.forEach(b=>{if(b.target==='avgSatisfaction')satisfChange+=b.val;});satisfChange+=(advisorBunny.happiness-60)/8;Object.keys(city.activePolicies).forEach(polKey=>{const p=POLICIES[polKey];if(p){if(p.satisImpact)satisfChange+=p.satisImpact;if(p.satisImpactCom&&city.buildings.some(b=>BUILDINGS[b.id]?.cat==='commercial'))satisfChange+=p.satisImpactCom;}});
            city.avgSatisfaction=Math.max(0,Math.min(100,city.avgSatisfaction+satisfChange*.1-Math.random()*.8));
            let popGr=0;const immigrationFactor=Math.max(0,(city.avgSatisfaction-45)/20+(jSufficient?0.5:0)+(landValueScore-40)/80-(city.trafficIndex/50));const emigrationFactor=Math.max(0,(45-city.avgSatisfaction)/10+(!jSufficient?0.8:0)+(city.crimeRate/10));if(immigrationFactor>emigrationFactor&&city.population<city.maxPopulation){popGr=Math.floor(Math.max(1,city.population*.005*immigrationFactor)+(city.maxPopulation-city.population)*.01);}else if(city.population>0){popGr=-Math.floor(city.population*.008*emigrationFactor);}
            city.population=Math.max(0,Math.floor(city.population+popGr));
            if(popGr>0)logCityEvent(`人口增加:+${popGr}🧑‍🤝‍🧑`,'info');else if(popGr<0)logCityEvent(`人口减少:${popGr}🧑‍🤝‍🧑`,'warning');
            city.populationHistory.push({d:city.year*30+city.day,p:city.population});if(city.populationHistory.length>250)city.populationHistory.shift();
            city.environmentQuality=Math.max(0,Math.min(100,city.environmentQuality-(pollutionToday*.12)+(gbSufficient?0.6:-0.8)+.15+(advisorBunny.energy-30)/100 - (city.activePolicies.INDUSTRIAL_SUBSIDIES?2:0) + (city.activePolicies.GREEN_INITIATIVES?3:0) ));
            city.trafficIndex=Math.min(100,Math.max(0,(city.population/(Math.max(1,city.buildings.filter(b=>BUILDINGS[b.id]?.cat==='road'||BUILDINGS[b.id]?.t==='zone').length*350 + city.buildings.filter(b=>b.id==='BUS_DEPOT').length*1000)))*100-(city.unlockedTech.includes('TRAFFIC_AI_OPTIMIZATION')?25:0)-(city.activePolicies.FREE_PUBLIC_TRANSPORT&&POLICIES.FREE_PUBLIC_TRANSPORT.eff.global?POLICIES.FREE_PUBLIC_TRANSPORT.eff.global.trafficIndexMod*100:0) ));
            if(Math.random()<.1&&!milestoneReached){const dT=['FACTORY_FIRE','HEAT_WAVE','MAJOR_TRAFFIC_JAM','DISEASE_OUTBREAK_S','STOCK_MARKET_FLUCTUATION','METEORITE_SCARE','SINKHOLE_REPORTS'];const d=dT[Math.floor(Math.random()*dT.length)];handleDisaster(d);}
            updateCityUI();renderPopulationChart();playSound('confirm',{fS:300,fE:200,d:.1,v:.05});
        }
        function applyTechEffect(techKey){const tech=TECHS[techKey];if(!tech||!tech.eff)return;if(tech.eff.unlockZoneDensity)city.unlockedZoneDensities.push(...tech.eff.unlockZoneDensity);if(tech.eff.modify){if(tech.eff.modify.type==='building'){city.buildings.filter(b=>BUILDINGS[b.id]?.id===tech.eff.modify.target||BUILDINGS[b.id]?.cat===tech.eff.modify.target_cat).forEach(bInst=>{BUILDINGS[bInst.id][tech.eff.modify.prop]*=(tech.eff.modify.mode==='mul'?tech.eff.modify.val:1);BUILDINGS[bInst.id][tech.eff.modify.prop]+=(tech.eff.modify.mode==='add'?tech.eff.modify.val:0);});}logCityEvent(`${tech.n}效果已应用。`,'info');}if(tech.eff.global){logCityEvent(`${tech.n}全局效果已应用。`,'info');}}
        function handleDisaster(type){let msg='';let cost=0;switch(type){case 'FACTORY_FIRE':const indZones=city.buildings.filter(b=>BUILDINGS[b.id]?.cat==='industrial');if(indZones.length>0){const target=indZones[Math.floor(Math.random()*indZones.length)];if(target)target.condition=0.3;msg=`${BUILDINGS[target.id]?.n||'一家工厂'}发生火灾！`;city.fireRisk+=5;}else{msg="火灾警报，但无工业区受影响。";}break;case 'HEAT_WAVE':city.powerDemand*=1.3;city.waterDemand*=1.2;city.avgSatisfaction-=3;msg="热浪来袭，水电需求激增！";setTimeout(()=>{city.powerDemand/=1.3;city.waterDemand/=1.2;},3*24*60*60*1000);break;case 'MAJOR_TRAFFIC_JAM':city.trafficIndex=Math.min(100,city.trafficIndex+30);Object.keys(city.goodsProducedByType).forEach(k=>city.goodsProducedByType[k]*=0.8);msg="严重交通堵塞，影响全城！";break;case 'DISEASE_OUTBREAK_S':city.healthIndex-=15;city.workforce*=0.9;msg="小型疾病爆发，市民健康受影响！";break;case 'STOCK_MARKET_FLUCTUATION':if(Math.random()>.5){cost=Math.floor(city.funds*0.1);city.funds-=cost;msg=`股市动荡，资金损失 ${cost}！`;}else{const gain=Math.floor(city.funds*0.05);city.funds+=gain;msg=`股市利好，资金增加 ${gain}！`;}break;case 'METEORITE_SCARE':city.avgSatisfaction-=10;msg="陨石坠落恐慌！但未击中城市。";break;case 'SINKHOLE_REPORTS':const betroffen=city.buildings.filter(b=>Math.random()<.03);betroffen.forEach(b=>{city.buildings.splice(city.buildings.indexOf(b),1);logCityEvent(`${BUILDINGS[b.id]?.n} 被天坑吞噬！`,'disaster');});msg=`地面塌陷报告，${betroffen.length}栋建筑受损或被毁！`;break;}logCityEvent(`灾难: ${msg}`,'disaster');playSound('error',{v:.3,fS:600,fE:50});updateCityUI();}
        function updateCityUI(){simEls.f.textContent=city.funds.toFixed(0);simEls.p.textContent=`${city.population}/${city.maxPopulation}`;simEls.e.textContent=`${city.powerDemand.toFixed(0)}/${city.powerCapacity.toFixed(0)}`;simEls.w.textContent=`${city.waterDemand.toFixed(0)}/${city.waterCapacity.toFixed(0)}`;simEls.gP.textContent=Object.values(city.goodsProducedByType).reduce((s,v)=>s+v,0).toFixed(0);simEls.gD.textContent=Object.values(city.goodsDemandByType).reduce((s,v)=>s+v,0).toFixed(0);simEls.d.textContent=`Y${city.year}D${city.day}`;simEls.r.textContent=city.researchPoints.toFixed(0);simEls.wf.textContent=`${city.workforce.toFixed(0)}/${Math.floor(Object.values(city.jobsAvailableBySkill).reduce((s,v)=>s+v,0))}(${city.unemployed.toFixed(0)}失业)`;simEls.cl.textContent=`${city.cityLevel} (${city.cityXP}/${city.cityXPNext})`;simEls.rm.textContent=Object.entries(city.rawMaterialsStock).map(([k,v])=>`${RAW_MATERIALS_TYPES[k]?RAW_MATERIALS_TYPES[k].n.substring(0,1):'X'}:${v.toFixed(0)}`).join(' ');simEls.sBar.style.width=`${city.avgSatisfaction}%`;simEls.eBar.style.width=`${city.environmentQuality}%`;simEls.tBar.style.width=`${city.trafficIndex}%`;simEls.gbBar.style.width=`${Math.min(100,(city.garbageCapacity||0)/(Math.max(1,city.garbageAccumulated)))*100}%`;simEls.sP.textContent=city.avgSatisfaction.toFixed(0);simEls.eP.textContent=city.environmentQuality.toFixed(0);simEls.tP.textContent=city.trafficIndex.toFixed(0);simEls.gbP.textContent=simEls.gbBar.style.width.slice(0,-1);simEls.e.closest('.resource-item').style.color=city.powerCapacity<city.powerDemand?'rgb(var(--color-red))':'inherit';simEls.w.closest('.resource-item').style.color=city.waterCapacity<city.waterDemand?'rgb(var(--color-red))':'inherit';simEls.wf.closest('.resource-item').style.color=city.unemployed>city.workforce*0.15?'rgb(var(--color-yellow))':'inherit';simEls.rm.closest('.resource-item').style.color=Object.values(city.rawMaterialsStock).reduce((s,v)=>s+v,0)<Object.values(city.goodsDemandByType).reduce((s,v)=>s+v,0)*0.1?'rgb(var(--color-yellow))':'inherit';updateAdvisorBunny();Object.values(simPanels).forEach(p=>{if(p&&p.style.display!=='none'&&p.id!=='god-mode-panel'&&p.id!=='city-main-screen'){const rFKey=p.id.replace(/-panel$/,'');const rF=window[`render${rFKey.charAt(0).toUpperCase()+rFKey.slice(1)}Panel`];if(typeof rF==='function')rF();}});}
        function renderConstructionPanel(){let h='<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-1 p-1">';Object.entries(BUILDINGS).forEach(([k,b])=>{let rd=''; const ul=!b.reqTech||b.reqTech.every(t=>city.unlockedTech.includes(t)); if(!ul)rd+='(科技不足)';const ub=(b.unique&&city.buildings.some(bi=>bi.id===k));if(ub)rd+='(已建唯一)';const du=!b.density||city.unlockedZoneDensities.includes(b.density);if(!du)rd+='(密度未解锁)';const rl=!b.reqLevel||city.cityLevel>=b.reqLevel;if(!rl)rd+=`(需Lv${b.reqLevel})`;h+=`<button class="sim-button list-item aspect-[4/5] text-xs p-1 ${!ul||ub||!du||!rl?'opacity-50 cursor-not-allowed':''}" onclick="${ul&&!ub&&du&&rl?`tryBuild('${k}')`:''}" title="${b.n} | ${b.c}💰${b.m?'(维护:'+b.m+')':''}\n${b.cap?'容量:'+(b.cap*(b.density?ZONE_DENSITY[b.density].mod:1)):''}${b.out&&b.cat=='power'?'⚡:'+b.out:''}${b.pol?'污染:'+b.pol:''} ${rd}"><span class="text-xl">${b.ui.ic}</span><span>${b.n.substring(0,7)}</span><span class="text-yellow-400">${b.c}💰</span></button>`;});simPanels.con.innerHTML=h+'</div>';}
        function renderBudgetPanel(){let h='<div class="p-2 space-y-3 text-xs">';h+='<div class="grid grid-cols-2 gap-2"><strong>税率调整:</strong><div></div>';Object.keys(city.taxRate).forEach(type=>{const catName=BUILDING_CATEGORIES[type]||type.charAt(0).toUpperCase()+type.slice(1);h+=`<div><label class="text-sm accent-text">${catName} 税: ${city.taxRate[type]}%</label><input type="range" min="0" max="25" step="1" value="${city.taxRate[type]}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="this.previousElementSibling.textContent='${catName} 税: '+this.value+'%';" onchange="setTaxRate('${type}',this.value)"></div>`;});h+='</div><hr class="border-gray-700 my-2"><div class="grid grid-cols-2 gap-2"><strong>部门预算:</strong><div></div>';Object.keys(city.budget).forEach(cat=>{const catName=(BUILDING_CATEGORIES[cat]||cat.charAt(0).toUpperCase()+cat.slice(1));h+=`<div><label class="text-sm text-gray-400">${catName} 预算: ${city.budget[cat]}%</label><input type="range" min="50" max="150" step="10" value="${city.budget[cat]}" class="w-full h-2 bg-gray-700 rounded-lg" oninput="this.previousElementSibling.textContent='${catName} 预算: '+this.value+'%';" onchange="setBudget('${cat}',this.value)"></div>`;});h+='</div><hr class="border-gray-700 my-2"><div><strong>银行贷款:</strong><button class="sim-button text-xs px-2 py-1 ml-2" onclick="takeLoanPrompt()">申请贷款</button><div id="loans-list" class="mt-1 space-y-1">';city.loans.forEach(l=>{h+=`<div class="list-item text-xs">贷款 ${l.id.substring(0,4)}: ${l.amount}💰, 利率${(l.interestRate*100).toFixed(1)}%, 剩余 ${l.remainingTerm}天, 日还 ${l.paymentPerDay.toFixed(0)}💰</div>`;});h+='</div></div>';simPanels.bud.innerHTML=h+'</div>';}
        function setTaxRate(type,rate){city.taxRate[type]=parseInt(rate);logCityEvent(`${BUILDING_CATEGORIES[type]||type.charAt(0).toUpperCase()+type.slice(1)} 税率调整为 ${rate}%`,'action');updateCityUI();}
        function setBudget(cat,rate){city.budget[cat]=parseInt(rate);logCityEvent(`${BUILDING_CATEGORIES[cat]||cat.charAt(0).toUpperCase()+cat.slice(1)} 部门预算调整为 ${rate}%`,'action');updateCityUI();}
        function takeLoanPrompt(){const amount=parseInt(prompt("输入贷款金额 (例如: 10000):", "10000"));const term=parseInt(prompt("输入贷款期限(天) (例如: 20):", "20"));if(isNaN(amount)||amount<=0||isNaN(term)||term<=5){logCityEvent("无效的贷款参数。","error");return;}const interestRate=Math.max(0.01,0.03 + city.cityLevel*0.001 - (city.unlockedTech.includes('BANKING')?0.01:0) + Math.max(0,(50-city.avgSatisfaction)/500) - (city.buildings.filter(b=>b.id==='BANK').length*0.002));const totalRepayment=amount*(1+interestRate);const dailyPayment=totalRepayment/term;city.loans.push({id:`L${Date.now().toString().slice(-4)}`,amount,interestRate,termDays:term,remainingTerm:term,paymentPerDay:dailyPayment});city.funds+=amount;logCityEvent(`成功申请贷款 ${amount}💰, 利率 ${(interestRate*100).toFixed(1)}%, 为期 ${term}天。`,'finance');playSound('confirm');updateCityUI();renderBudgetPanel();}
        function renderPolicyPanel(){let h='<div class="p-2 space-y-2">';Object.entries(POLICIES).forEach(([k,p])=>{const active=city.activePolicies[k];const unlocked=(!p.reqTech||p.reqTech.every(t=>city.unlockedTech.includes(t)));h+=`<div class="list-item ${!unlocked?'opacity-60':''}"><div class="flex justify-between items-center"><span class="font-bold ${!unlocked?'text-gray-500':''}">${p.n} ${active?'(生效中)':''}</span>${unlocked?`<button class="sim-button text-xs px-2 py-1" onclick="togglePolicy('${k}')">${active?'停用':'激活'}</button>`:'<span class="text-xs text-red-500">需科技</span>'}</div><p class="text-xs text-gray-400 mt-1">${p.desc} ${p.costPerDay?`(每日成本:${p.costPerDay}💰)`:''} ${p.satisImpact?`(满意度影响:${p.satisImpact})`:''}</p></div>`;});simPanels.pol.innerHTML=h+'</div>';}
        function togglePolicy(key){const policy=POLICIES[key];if(!policy.reqTech||policy.reqTech.every(t=>city.unlockedTech.includes(t))){if(city.activePolicies[key]){delete city.activePolicies[key];logCityEvent(`政策 ${policy.n} 已停用。`,'policy_deact');}else{if(city.funds<(policy.costPerDay||0)*5 && policy.costPerDay > 0){logCityEvent(`资金不足以支持政策 ${policy.n}。`,'error');return;}city.activePolicies[key]=true;logCityEvent(`政策 ${policy.n} 已激活。`,'policy_act');}}else{logCityEvent(`科技不足以激活政策 ${policy.n}。`,'error');}playSound('confirm');advanceDay();}
        function renderTechTreePanel(){let h='<div class="p-2 space-y-2">';Object.entries(TECHS).forEach(([k,t])=>{const researched=city.unlockedTech.includes(k);const canResearch=(!researched&&city.researchPoints>=t.c&&(t.pre.length===0||t.pre.every(p=>city.unlockedTech.includes(p))));h+=`<div class="list-item ${researched?'border-green-500':(canResearch?'border-yellow-500':'border-gray-700')}"><div class="flex justify-between items-center"><span class="font-bold">${t.n} ${researched?'(已研发)':''}</span>${!researched?`<button class="sim-button text-xs px-2 py-1 ${!canResearch?'opacity-50 cursor-not-allowed':''}" onclick="${canResearch?`researchTech('${k}')`:''}">研发(${t.c}🔬, ${t.t}天)</button>`:''}</div><p class="text-xs text-gray-400 mt-1">${t.pre.length>0?'前置: '+t.pre.map(pk=>TECHS[pk]?.n||pk).join(', '):''} | 效果: ${getTechEffectDesc(t.eff)}</p></div>`;});simPanels.tec.innerHTML=h+'</div>';}
        function researchTech(key){const tech=TECHS[key];if(city.currentResearch){logCityEvent(`已在研发 ${TECHS[city.currentResearch.key].n}。`,'info');return;}if(city.researchPoints>=tech.c&&(tech.pre.length===0||tech.pre.every(p=>city.unlockedTech.includes(p)))){city.researchPoints-=tech.c;logCityEvent(`开始研发 ${tech.n}... 预计 ${tech.t} 天。`,'tech');city.currentResearch={key,daysLeft:tech.t};playSound('confirm');}else{logCityEvent(`无法研发 ${tech.n} (条件或点数不足)。`,'error');}renderTechTreePanel();}
        function renderDistrictPanel(){let h='<div class="p-2 space-y-2"><p class="text-sm text-gray-400">区域规划与专业化 (功能开发中)</p>';(city.districts||[]).forEach((d,idx)=>{h+=`<div class="list-item">区域 ${idx+1}: ${DISTRICT_SPECIALIZATIONS[d.type]?.n||'未知'}</div>`;});h+='</div>';simPanels.dis.innerHTML=h;}
        function renderMayorActionsPanel(){let h='<div class="p-2 space-y-2">';Object.entries(MAYOR_ACTIONS).forEach(([k,a])=>{const canAfford=(city.funds>=a.c&&advisorBunny.energy>=(a.advisorEnergyCost||0));const meetsReq=!a.unlockReq||(city.inventory[a.unlockReq.item]&&city.inventory[a.unlockReq.item]>=a.unlockReq.qty);const techOk=!a.reqTech||a.reqTech.every(t=>city.unlockedTech.includes(t));h+=`<div class="list-item ${canAfford&&meetsReq&&techOk?'':'opacity-60'}"><div class="flex justify-between items-center"><span class="font-bold">${a.n}</span><button class="sim-button text-xs px-2 py-1 ${!(canAfford&&meetsReq&&techOk)?'opacity-50 cursor-not-allowed':''}" onclick="${canAfford&&meetsReq&&techOk?`executeMayorAction('${k}')`:''}">执行 (${a.c}💰${a.advisorEnergyCost?', '+a.advisorEnergyCost+'活力':''})</button></div><p class="text-xs text-gray-400 mt-1">${a.desc}</p></div>`;});simPanels.may.innerHTML=h+'</div>';}
        function getTechEffectDesc(eff){if(eff.unlockZoneDensity)return`解锁${eff.unlockZoneDensity.map(d=>ZONE_DENSITY[d]?.name).join('/')}规划`;if(eff.unlock)return`解锁 ${eff.unlock.map(uk=>BUILDINGS[uk]?.n||TECHS[uk]?.n||uk).join(', ')}`;if(eff.modify)return`${BUILDINGS[eff.modify.target]?.n||eff.modify.target_cat} ${eff.modify.prop} ${eff.modify.mode==='mul'?'x':(eff.modify.mode==='add'?'+':'')} ${eff.modify.val}`;if(eff.global)return Object.entries(eff.global).map(([k,v])=>`${k}:${v}`).join(', ');return JSON.stringify(eff).substring(0,40)+'...';}
        function tryBuild(bKey){const b=BUILDINGS[bKey];let rd='';const ul=!b.reqTech||b.reqTech.every(t=>city.unlockedTech.includes(t));if(!ul)rd+='科技不足;';const ub=(b.unique&&city.buildings.some(bi=>bi.id===bKey));if(ub)rd+='已建唯一;';const du=!b.density||city.unlockedZoneDensities.includes(b.density);if(!du)rd+='密度未解锁;';const rl=!b.reqLevel||city.cityLevel>=b.reqLevel;if(!rl)rd+=`需Lv${b.reqLevel};`;if(rd){logCityEvent(`无法建造 ${b.n} (${rd.slice(0,-1)})。`,'error');playSound('error');return;}if(city.funds<b.c){logCityEvent(`资金不足建 ${b.n}！`,'error');playSound('error');return;}city.funds-=b.c;city.buildings.push({id:bKey,x:0,y:0,lvl:b.lvl||1,eff:1,density:b.density||null,condition:1,district:null});logCityEvent(`已建 ${b.n}。`,'build');playSound('build');advanceDay();}
        function executeMayorAction(key){const action=MAYOR_ACTIONS[key];if(city.funds<action.c||advisorBunny.energy<(action.advisorEnergyCost||0)){logCityEvent(`无法执行 ${action.n}:资源或活力不足。`,'error');return;}if(action.unlockReq&&(!city.inventory[action.unlockReq.item]||city.inventory[action.unlockReq.item]<action.unlockReq.qty)){logCityEvent(`无法执行 ${action.n}:缺少物品。`,'error');return;}if(action.reqTech&&!action.reqTech.every(t=>city.unlockedTech.includes(t))){logCityEvent(`无法执行 ${action.n}:缺少科技。`,'error');return;}if(action.eff.type==='loan'){if(city.loans.length>=3){logCityEvent("贷款已达上限(3笔)。","error");return;}city.funds+=action.loanAmount;const loanId=`L${Date.now().toString().slice(-4)}`;const payment=(action.loanAmount*(1+action.interestRate))/action.termDays;city.loans.push({id:loanId,amount:action.loanAmount,interestRate:action.interestRate,termDays:action.termDays,remainingTerm:action.termDays,paymentPerDay:payment});logCityEvent(`成功获得贷款 ${action.loanAmount}💰 (ID:${loanId})。`,'finance');}else{city.funds-=action.c;}advisorBunny.energy-=(action.advisorEnergyCost||0);if(action.eff.type==='timed_boost'){city.timedBoosts.push({target:action.eff.target,val:action.eff.val,remainingDays:action.eff.duration,source:`mayor_${key}`});}else if(action.eff.type==='boost'){city[action.eff.target]=Math.min(100,(city[action.eff.target]||0)+action.eff.val);}else if(action.eff.type==='advisor_feed'){handleMayorAction_FeedAdvisor();}else if(action.eff.type==='random_utility_upgrade'){const utils=city.buildings.filter(b=>BUILDINGS[b.id].t==='utility'&&BUILDINGS[b.id].out);if(utils.length>0){const target=utils[Math.floor(Math.random()*utils.length)];BUILDINGS[target.id].out=parseFloat((BUILDINGS[target.id].out*1.1).toFixed(1));logCityEvent(`${BUILDINGS[target.id].n} 效率提升10%！`,'action');}else{logCityEvent("没有公共设施可升级。","info");}}else if(action.eff.type==='random_trade_benefit'){if(Math.random()>.5){const amt=Math.floor(Math.random()*200+50);const mat=Object.keys(RAW_MATERIALS_TYPES)[Math.floor(Math.random()*Object.keys(RAW_MATERIALS_TYPES).length)];city.rawMaterialsStock[mat]=(city.rawMaterialsStock[mat]||0)+amt;logCityEvent(`贸易协定带来 ${amt} 单位${RAW_MATERIALS_TYPES[mat].n}!`,'action');}else{const amt=Math.floor(Math.random()*2000+1000);city.funds+=amt;logCityEvent(`贸易协定带来 ${amt} 资金!`,'action');}}logCityEvent(`执行市长行动: ${action.n}`,'action');playSound('special');advanceDay();renderMayorActionsPanel();updateCityUI();}
        function showCityPanel(pId){Object.values(simPanels).forEach(p=>{if(p)p.style.display='none';});cityMainScreen.style.display='none';const targetPanel=document.getElementById(pId);if(targetPanel)targetPanel.style.display=pId==='city-main-screen'?'flex':'block';else cityMainScreen.style.display='flex';document.querySelectorAll('#city-action-tabs .sim-tab-button').forEach(b=>{b.classList.remove('active','border-b-2');b.style.borderBottomColor='transparent';});const actBtn=document.querySelector(`#city-action-tabs .sim-tab-button[onclick*="'${pId}'"]`);if(actBtn){actBtn.classList.add('active','border-b-2');actBtn.style.borderBottomColor='rgb(var(--accent-rgb))';}currentCityPanel=pId;const renderFunc=window[`render${pId.charAt(0).toUpperCase()+pId.slice(1).replace('-panel','Panel')}`];if(typeof renderFunc==='function')renderFunc();}
        function saveCity(){const cityStr=JSON.stringify(city);const approxBytes=new TextEncoder().encode(cityStr).length;if(approxBytes>CONFIG.MAX_LOCALSTORAGE_SAVE_BYTES){logCityEvent(`存档过大(${(approxBytes/1024/1024).toFixed(2)}MB)，可能无法保存。`,'error');playSound('error');return;}try{localStorage.setItem(CONFIG.CITY_SAVE_KEY,cityStr);logCityEvent("城市进度已手动保存至浏览器！","system");playSound('confirm');}catch(e){logCityEvent("保存失败！浏览器存储空间可能已满或权限不足。","error");playSound('error');console.error("Save city failed:",e);}}
        function loadCity(){const sS=localStorage.getItem(CONFIG.CITY_SAVE_KEY);if(sS){try{const lc=JSON.parse(sS);city=validateLoadedCity(lc);logCityEvent("从浏览器手动加载存档成功！","system");playSound('confirm');}catch(e){console.error("Load city failed:",e);generateNewCityState();logCityEvent("手动加载存档损坏，已重置为新城市。","error");playSound('error');}}else{logCityEvent("未找到手动存档。可开始新游戏或继续当前。","system");playSound('error');}initCitySimAfterLoad();}
        function initCitySimAfterLoad(){updateCityUI();Object.values(simPanels).forEach(p=>{if(p&&typeof p.id==='string'&&p.id.endsWith('-panel'))p.innerHTML='';}); renderConstructionPanel();renderBudgetPanel();renderPolicyPanel();renderTechTreePanel();renderDistrictPanel();renderMayorActionsPanel();if(godModeActive)renderGodModePanel();renderPopulationChart();updateAdvisorBunny();renderCityLog();}
        function handleTitleClickForGodMode(event){if(godModeActive||event.target.closest('.lcars-element'))return;const now=Date.now();if(now-lastTitleClickTime<2000){titleClickCount++;}else{titleClickCount=1;}lastTitleClickTime=now;if(titleClickCount>=CONFIG.GOD_MODE_TITLE_CLICKS){showCalculatorModal();titleClickCount=0;}}
        function showCalculatorModal(){const y=city.year,p=city.population%1000,l=city.cityLevel,f=Math.floor(city.funds/1000),r=city.researchPoints%100;const stage1Key=calculateGodModeKey_Stage1(y,p,l,f,r);calculatorInfoEl.innerHTML=`<p>上帝模式激活序列...</p><p>- 年份 (Y): <strong>${y}</strong> | 人口后三位 (P): <strong>${p}</strong></p><p>- 等级 (L): <strong>${l}</strong> | 资金千位 (F): <strong>${f}</strong></p><p>- 科研点后两位 (R): <strong>${r}</strong></p><hr class="my-2 border-gray-700"><p>游戏内生成的第一阶段激活码 (S1 Key):</p><p class="code-block">${stage1Key}</p><p class="text-xs text-gray-500 mt-2">请将以上所有数值 (Y,P,L,F,R) 及 S1 Key 输入到您的Python验证器中以获取最终激活码。然后在主题面板输入最终激活码。</p><p class="text-xs text-red-400">Python验证逻辑提示: <span class="font-mono">FinalKey = "BCC-GOD-" + HMAC_SHA256( (Y+P+L+F+R) + S1_Key, YOUR_PYTHON_SECRET_SALT_S2 ).hex()[:4].upper()</span></p>`;toggleCalculatorModal(true);}
        function toggleCalculatorModal(show){godModeCalculatorModal.classList.toggle('hidden',!show);godModeCalculatorModal.classList.toggle('opacity-0',!show);}
        function calculateGodModeKey_Stage1(y,p,l,f,r){let key=(y*17+p*3+l*29)^(f*11-r*7+CONFIG.GOD_MODE_CALC_SALT_S1);return Math.abs(key%899999)+100000;}
        function applyCustomColorOrGodModeKey(event){let val=event.target.value.trim().toUpperCase();let rgb;const hexMatch=val.match(/^#?([A-F\d]{2})([A-F\d]{2})([A-F\d]{2})$/i);const shortHexMatch=val.match(/^#?([A-F\d])([A-F\d])([A-F\d])$/i);const rgbMatch=val.match(/^RGB\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/i);if(hexMatch){rgb=`${parseInt(hexMatch[1],16)},${parseInt(hexMatch[2],16)},${parseInt(hexMatch[3],16)}`;}else if(shortHexMatch){rgb=`${parseInt(shortHexMatch[1]+shortHexMatch[1],16)},${parseInt(shortHexMatch[2]+shortHexMatch[2],16)},${parseInt(shortHexMatch[3]+shortHexMatch[3],16)}`;}else if(rgbMatch){rgb=`${rgbMatch[1]},${rgbMatch[2]},${rgbMatch[3]}`;}if(rgb){changeTheme({r:rgb});event.target.value='';}else{const y=city.year,p=city.population%1000,l=city.cityLevel,f=Math.floor(city.funds/1000),r=city.researchPoints%100;const s1Key=calculateGodModeKey_Stage1(y,p,l,f,r);const expectedFinalNumericPart=(s1Key+CONFIG.GOD_MODE_JS_ADDON)%10000;const expectedFinalKey=`BCC-GOD-${expectedFinalNumericPart.toString().padStart(4,'0')}`;if(val===expectedFinalKey){godModeActive=true;document.getElementById('god-mode-indicator').classList.remove('hidden');document.getElementById('god-mode-modal-indicator').classList.remove('hidden');document.getElementById('god-mode-tab-button').classList.remove('hidden');logCityEvent("上帝模式已通过激活码激活！",'godmode');playSound('godmode');showCityPanel('god-mode-panel');renderGodModePanel();toggleModal('theme-modal',false);event.target.value='';}else{logCityEvent("无效的颜色代码或最终激活码。",'error');playSound('error');}}}
        function renderGodModePanel(){if(!godModeActive){simPanels.god.innerHTML='';return;}let h=`<div class="p-2 space-y-3 text-xs"><h3 class="text-lg accent-text font-bold">上帝模式控制台</h3>`;h+=`<div class="grid grid-cols-2 gap-2"><div><label>资金:</label><input id="gm-funds" type="number" class="god-mode-input" value="${city.funds}"></div><div><label>科研点:</label><input id="gm-research" type="number" class="god-mode-input" value="${city.researchPoints}"></div></div>`;Object.keys(city.rawMaterialsStock).forEach(k=>{h+=`<div><label>${RAW_MATERIALS_TYPES[k]?.n||k}:</label><input id="gm-rm-${k}" type="number" class="god-mode-input" value="${city.rawMaterialsStock[k]}"></div>`;});h+=`<div><label>顾问精力:</label><input id="gm-adv-energy" type="number" class="god-mode-input" value="${advisorBunny.energy}"></div><div><label>顾问快乐:</label><input id="gm-adv-happy" type="number" class="god-mode-input" value="${advisorBunny.happiness}"></div>`;h+=`<button class="sim-button bg-green-600 hover:bg-green-500" onclick="applyGodModeChanges()">应用更改</button><hr class="my-2 border-gray-700">`;h+=`<button class="sim-button" onclick="godModeUnlockAllTech()">解锁所有科技</button>`;h+=`<button class="sim-button" onclick="godModeMaxSatisfaction()">最大化满意度/环境</button>`;h+=`<select id="gm-disaster-select" class="god-mode-input w-full my-1 bg-gray-800 text-white"><option value="">选择灾难触发...</option>${['FACTORY_FIRE','HEAT_WAVE','MAJOR_TRAFFIC_JAM','DISEASE_OUTBREAK_S','STOCK_MARKET_FLUCTUATION','METEORITE_SCARE','SINKHOLE_REPORTS'].map(d=>`<option value="${d}">${d}</option>`).join('')}</select><button class="sim-button" onclick="godModeTriggerDisaster()">触发灾难</button>`;h+='</div>';simPanels.god.innerHTML=h;}
        function applyGodModeChanges(){if(!godModeActive)return;city.funds=parseInt(document.getElementById('gm-funds').value)||city.funds;city.researchPoints=parseInt(document.getElementById('gm-research').value)||city.researchPoints;Object.keys(city.rawMaterialsStock).forEach(k=>{if(document.getElementById(`gm-rm-${k}`))city.rawMaterialsStock[k]=parseInt(document.getElementById(`gm-rm-${k}`).value)||city.rawMaterialsStock[k];});advisorBunny.energy=parseInt(document.getElementById('gm-adv-energy').value)||advisorBunny.energy;advisorBunny.happiness=parseInt(document.getElementById('gm-adv-happy').value)||advisorBunny.happiness;logCityEvent("上帝模式更改已应用。",'godmode');updateCityUI();}
        function godModeUnlockAllTech(){if(!godModeActive)return;Object.keys(TECHS).forEach(k=>{if(!city.unlockedTech.includes(k))city.unlockedTech.push(k);});city.unlockedZoneDensities=['LOW','MED','HIGH'];logCityEvent("所有科技和密度已解锁。",'godmode');renderTechTreePanel();renderConstructionPanel();updateCityUI();}
        function godModeMaxSatisfaction(){if(!godModeActive)return;city.avgSatisfaction=100;city.environmentQuality=100;city.healthIndex=100;city.crimeRate=0;city.fireRisk=0;city.trafficIndex=0;city.garbageAccumulated=0;logCityEvent("满意度和城市指标已最大化。",'godmode');updateCityUI();}
        function godModeTriggerDisaster(){if(!godModeActive)return;const sel=document.getElementById('gm-disaster-select');if(sel.value)handleDisaster(sel.value);}
        
        async function loadAndProcessPetData(){try{const r=await fetch(CONFIG.PET_RECORDS_PATH);if(!r.ok)throw new Error('Pet records not found.');const raw=await r.json();const proc=raw.map(rec=>{const d=new Date(Math.floor(rec.date)*1e3);d.setFullYear(d.getFullYear()+31);return{...rec,pD:d};});allPetRecords=[...proc].sort((a,b)=>b.pD-a.pD);weightRecords=proc.filter(rec=>rec.activity==='体重测量'&&rec.weight>0).sort((a,b)=>a.pD-b.pD);if(weightRecords.length>0){petWeightModule.style.display='block';renderWeightChart();}else{petWeightModule.style.display='none';}renderAllPetRecords();}catch(e){console.warn("PetRecords.json 加载失败:",e.message);petWeightModule.style.display='none';allRecordsContainer.innerHTML='<p class="text-xs text-gray-500 p-2">宠物档案数据 (PetRecords.json) 加载失败或不存在。</p>';}}
        function renderAllPetRecords(){if(!allPetRecords||allPetRecords.length===0){if(allRecordsContainer.innerHTML.includes('失败'))return;allRecordsContainer.innerHTML='<p class="text-xs text-gray-500 p-2">无宠物档案记录。</p>';return;}allRecordsContainer.innerHTML=allPetRecords.map(rec=>{const dS=rec.pD.toLocaleDateString('sv-SE');const wI=rec.weight>0?` - 重量: <strong class="glow-text">${rec.weight}g</strong>`:'';return`<div class="list-item"><div class="flex justify-between items-center"><p class="font-bold"><span class="accent-text">${rec.activity}</span>${wI}</p><time class="text-xs flex-shrink-0 ml-2" style="color:var(--text-muted-color)">${dS}</time></div><p class="text-sm mt-1" style="color:var(--text-muted-color)">笔记: ${rec.notes||'N/A'}</p></div>`;}).join('');}
        function renderWeightChart(){if(weightChartJS)weightChartJS.destroy();if(!weightChartEl||weightRecords.length===0){petWeightModule.style.display='none'; return;} else {petWeightModule.style.display='block';} const gC=`rgb(${getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim()})`,aC=`rgb(${getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim()})`,mC=getComputedStyle(docEl).getPropertyValue('--text-muted-color').trim();const lbls=weightRecords.map(r=>r.pD.toLocaleDateString('zh-CN',{month:'2-digit',day:'2-digit'}));const data=weightRecords.map(r=>r.weight);const ctx=weightChartEl.getContext('2d');weightChartJS=new Chart(ctx,{type:'line',data:{labels:lbls,datasets:[{label:'重量(g)',data:data,borderColor:gC,backgroundColor:gC.replace(')',',.2)').replace('rgb','rgba'),pointBackgroundColor:aC,pointBorderColor:'#fff',tension:.3,fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true}},scales:{x:{ticks:{color:mC},grid:{color:'rgba(var(--glow-rgb),.1)'}},y:{ticks:{color:mC,callback:(v)=>`${v}g`},grid:{color:'rgba(var(--glow-rgb),.1)'},beginAtZero:false}}}});const wIE=document.getElementById('weight-change-info');if(weightRecords.length>=2){const l=weightRecords[weightRecords.length-1].weight,p=weightRecords[weightRecords.length-2].weight;const ch=l-p;const cT=ch>0?`▲ ${ch.toFixed(0)}g`:(ch<0?`▼ ${Math.abs(ch.toFixed(0))}g`:'持平');const cCC=ch>0?'accent-text':(ch<0?'text-red-400':'text-gray-400');wIE.innerHTML=`最新:<strong class="glow-text">${l}g</strong>. 对比上次:<strong class="${cCC}">${cT}</strong>.`}else if(weightRecords.length===1){wIE.innerHTML=`初始记录:<strong class="glow-text">${weightRecords[0].weight}g</strong>.`}else{wIE.innerHTML=`等待体重数据...`}}
        function renderPopulationChart(){if(populationChartJS)populationChartJS.destroy();if(!populationChartEl||!city.populationHistory)return;const gC=`rgb(${getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim()})`,aC=`rgb(${getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim()})`,mC=getComputedStyle(docEl).getPropertyValue('--text-muted-color').trim();const lbls=city.populationHistory.map(h=>`Y${Math.floor(h.d/30)}D${h.d%30||30}`);const data=city.populationHistory.map(h=>h.p);const ctx=populationChartEl.getContext('2d');populationChartJS=new Chart(ctx,{type:'line',data:{labels:lbls,datasets:[{label:'人口',data:data,borderColor:gC,backgroundColor:gC.replace(')',',.2)').replace('rgb','rgba'),pointBackgroundColor:aC,pointBorderColor:'#fff',tension:.1,fill:true,pointRadius:data.length<30?3:0,pointHoverRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true}},scales:{x:{ticks:{color:mC,maxRotation:0,minRotation:0,autoSkipPadding:10},grid:{color:'rgba(var(--glow-rgb),.1)'}},y:{ticks:{color:mC},grid:{color:'rgba(var(--glow-rgb),.1)'},beginAtZero:true}}}});const pIE=document.getElementById('population-change-info');if(city.populationHistory.length>=2){const l=city.populationHistory[city.populationHistory.length-1].p,p=city.populationHistory[city.populationHistory.length-2].p;const ch=l-p;const cT=ch>0?`▲ ${ch}`:(ch<0?`▼ ${Math.abs(ch)}`:'持平');pIE.innerHTML=`当前人口:<strong class="glow-text">${l}</strong>.较昨日:<strong class="${ch>0?'accent-text':(ch<0?'text-red-400':'text-gray-400')}">${cT}</strong>.`}else if(city.populationHistory.length===1){pIE.innerHTML=`初始人口:<strong class="glow-text">${city.populationHistory[0].p}</strong>.`}else{pIE.innerHTML=`等待人口数据...`}}
        function toggleFont(){bodyEl.classList.toggle('font-pixel');const btn=document.getElementById('font-toggle-button');if(bodyEl.classList.contains('font-pixel')){Chart.defaults.font.family="'Press Start 2P','Noto Sans SC',sans-serif";Chart.defaults.font.size=10;btn.textContent="SYSTEM FONT";}else{Chart.defaults.font.family="'Noto Sans SC',sans-serif";Chart.defaults.font.size=12;btn.textContent="PIXEL FONT";}renderPopulationChart();if(weightRecords.length>0)renderWeightChart();}
        function setupThemeEngine(){const rT=CONFIG.THEMES[Math.floor(Math.random()*CONFIG.THEMES.length)];changeTheme(rT);renderThemePage();}
        function changeThemePage(dir){const tP=Math.ceil(CONFIG.THEMES.length/10);currentThemePage=(currentThemePage+dir+tP)%tP;renderThemePage();}
        function renderThemePage(){const tG=document.getElementById('theme-grid');tG.innerHTML='';const numT=CONFIG.THEMES.length,tPpS=10,tP=Math.ceil(numT/tPpS);currentThemePage=(currentThemePage+tP)%tP;const sI=currentThemePage*tPpS,eI=sI+tPpS;CONFIG.THEMES.slice(sI,eI).forEach(th=>{const s=document.createElement('button');s.className="h-12 w-full rounded-md tr-all dur-200 hov:scale-110 hov:shadow-lg focus:ring-2 ring-offset-2";s.style.backgroundColor=`rgb(${th.r})`;s.style.boxShadow=`0 0 15px rgba(${th.r},.5)`;s.title=th.n;s.onclick=()=>changeTheme(th);tG.appendChild(s);});document.getElementById('theme-page-title').innerText=`COLORS [${currentThemePage+1}/${tP}]`;}
        function changeTheme(theme){docEl.style.setProperty('--glow-rgb',theme.r);const yT=CONFIG.THEMES.find(t=>t.n==='gold');if(yT)docEl.style.setProperty('--accent-rgb',yT.r);renderPopulationChart();if(weightRecords.length>0)renderWeightChart();}
        function updateTiming(){const tE=document.getElementById('timing');const sD=new Date(CONFIG.START_DATE),cD=new Date();const eMs=cD.getTime()-sD.getTime();const eD=(eMs/864e5).toFixed(3);const tS=Math.floor(eMs/1e3),eH=Math.floor(tS/3600),eM=Math.floor((tS%3600)/60),eS=tS%60;const fD=(d)=>`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;const gNA=(b,dys)=>{let c=0,nD;do{c++;nD=new Date(b.getTime()+c*dys*864e5);}while(nD<cD);return{d:nD,c};};const gNY=(b)=>{let c=0,nD;do{c++;nD=new Date(b);nD.setFullYear(b.getFullYear()+c);}while(nD<cD);return{d:nD,c};};const n100=gNA(sD,100),n180=gNA(sD,180),n300=gNA(sD,300),nY=gNY(sD);tE.innerHTML=`<p>🐰 兔可可已經到來 <strong class="accent-text">${eD}</strong> 天啦</p><p>🎂 目前已經到來 <strong class="accent-text">${eH}</strong>小時 <strong class="accent-text">${eM}</strong>分鐘 <strong class="accent-text">${eS}</strong>秒</p><div class="pt-2 mt-2 border-t border-dashed" style="border-color:rgba(var(--glow-rgb),.2)"></div><p>🌱 下一個100天紀念日是 <strong class="accent-text">${fD(n100.d)}</strong>（第${n100.c}個100天）</p><p>🌿 下一個180天紀念日是 <strong class="accent-text">${fD(n180.d)}</strong>（第${n180.c}個180天）</p><p>🍀 下一個300天紀念日是 <strong class="accent-text">${fD(n300.d)}</strong>（第${n300.c}个300天）</p><p>🎉 下一个一周年纪念日是 <strong class="accent-text">${fD(nY.d)}</strong>（第${nY.c}周年）</p>${city&&city.year?`<p class="mt-1 pt-1 border-t border-dotted border-gray-700">🏙️ 游戏内日期: <strong class="accent-text">Y${city.year} D${city.day}</strong></p>`:''}`;}
        function toggleModal(mId,forceState=null){const mdl=document.getElementById(mId);const S=forceState===null?mdl.classList.contains('hidden'):!forceState;if(S){mdl.classList.remove('hidden');requestAnimationFrame(()=>mdl.classList.remove('opacity-0'));if(mId==='changelog-modal'&&!document.getElementById('changelog-content').innerHTML)renderChangelog();if(mId==='performance-modal')getStaticPerfData();if(mId==='city-management-modal'&&city&&Object.keys(city).length>0)showCityPanel(currentCityPanel);else if(mId==='city-management-modal'&&(!city||Object.keys(city).length===0))initCitySim();}else{mdl.classList.add('opacity-0');setTimeout(()=>mdl.classList.add('hidden'),300);}}
        function toggleFullscreen(){if(!document.fullscreenElement)docEl.requestFullscreen().catch(err=>alert(`全屏失败: ${err.message}`));else document.exitFullscreen();}
        function renderChangelog() { // #CLOG_FULL_HISTORY_FINAL
            const changelogData = [
                {v:"v0.9",dt:"METROPOLIS_ZENITH_FINAL",it:[{t:"🚨 修復",zh:"彻底修复了getStaticPerfData函数中因错误压缩HTML类名导致的模板字符串语法错误，解决了页面无法加载的问题。",en:"Critically fixed template string syntax error in getStaticPerfData due to flawed HTML class compression, resolving blank page issue."},{t:"✨ 優化",zh:"完整恢复了旧版本(vX及更早)的宠物体重图表功能，并与城市模拟图表并存。",en:"Fully restored legacy pet weight chart functionality (vX and earlier), coexisting with city simulation chart."},{t:"🗑️ 移除",zh:"彻底移除了独立的宠物AI（拓麻歌子风格）模态框及其相关JS逻辑，将宠物概念统一为城市模拟中的'顾问Bunny'系统。",en:"Completely removed standalone Pet AI (Tamagotchi-style) modal and its JS logic; pet concept unified as 'Advisor Bunny' in city sim."},{t:"✨ 優化",zh:"确保城市模拟具备v0.8版本的所有深度玩法（经济、服务、科技、政策、灾难、贷款等）。",en:"Ensured city simulation retains all v0.8 deep gameplay features (economy, services, tech, policies, disasters, loans, etc.)."},{t:"✨ 優化",zh:"上帝模式激活方式固化为'点击标题->算号器->外部验证->输入最终码'。",en:"God Mode activation solidified to 'click title -> calculator -> external validator -> final key'."},{t:"✨ 優化",zh:"补全并整合了自v1.0以来的所有版本更新日志。",en:"Completed and consolidated all changelog entries since v1.0."}]},
                // ... (All historical changelog entries from v0.8.2 down to v1.0 are inserted here)
                {v:"v0.8.2",dt:"METROPOLIS_ZENITH_PRO",it:[{t:"✨ 優化",zh:"上帝模式激活方式更改为算号器流程。",en:"God Mode activation changed to calculator flow."}]},
                {v:"v0.8",dt:"METROPOLIS_ZENITH",it:[{t:"🚀 新增",zh:"城市模拟极大丰富。",en:"City sim vastly enriched."},{t:"✨ 優化",zh:"头像特效融合🐰🥕。",en:"Avatar VFX merges 🐰🥕."}]},
                { version: "vX", date: "GENESIS_OMEGA", items: [ { type: "🚀 新功能 (New)", en: "Introduced a deep simulation-management game layer with coins, tech points, and a permanent upgrade system.", zh: "引入了具有金币、科研点数和永久升级系统的深度模拟经营游戏层。" }, { type: "✨ 優化 (Improved)", en: "The avatar transformation has been extended to 35 seconds, with a new 'Genesis' phase featuring giant emoji constellations.", zh: "头像变身特效延长至35秒，并加入了以巨大Emoji星座为特色的全新“创生”阶段。" }, { type: "🐛 修復 (Fix)", en: "Fixed a critical bug where the mouse trail would disappear during avatar effects.", zh: "修复了在头像特效期间鼠标光轨会消失的关键错误。" }, { type: "🐛 修復 (Fix)", en: "Patched mobile browser compatibility issues and ensured all themes are correctly paginated.", zh: "修复了移动端浏览器的兼容性问题，并确保所有主题都能正确分页显示。" } ]},
                { version: "v12.0", date: "CELESTIAL_FINALE", items: [ { type: "🚀 新功能 (New)", en: "Replaced the avatar transformation with a 25-second 'Celestial Finale' particle dissolution and reconstitution effect.", zh: "将整个头像变身动画替换为一个长达25秒的“天穹终章”粒子分解与重组特效。" }, { type: "✨ 優化 (Improved)", en: "The new effect resolves all previous rendering artifacts by using a pure canvas-based particle system, incorporating emojis.", zh: "新的特效通过使用纯粹基于Canvas的粒子系统（并融合了Emoji），解决了所有之前的渲染瑕疵。" } ]},
                { version: "v11.3", date: "ETERNITY_DRIVE_FINAL", items: [ { type: "🐛 修復 (Fix)", en: "Fixed a critical execution-halting error in the mouse trail renderer and avatar animation stalls.", zh: "修复了鼠标光轨渲染器和头像动画卡顿的致命错误。" } ]},
                { version: "v11.0", date: "CRYSTAL_HEART", items: [ { type: "🚀 新功能 (New)", en: "Implemented a multi-stage 'Sailor Moon' transformation sequence for the avatar.", zh: "为头像实现了多阶段的“美少女战士”变身序列。" } ]},
                { version: "v10.1", date: "OBSERVER_PRIME", items: [ { type: "✨ 優化 (Improved)", en: "Upgraded the Performance Monitor to a professional-grade 'Observer Core'.", zh: "将性能监视器升级为专业级“观察者核心”。" } ]},
                { version: "v10.0", date: "AEGIS_PRIME", items: [ { type: "🐛 修復 (Fix)", en: "Fixed a critical regression bug with JSON date parsing.", zh: "修复了JSON日期解析的关键回归性Bug。" } ]},
                { version: "v9.4.1", date: "GRANZORT_DRIVE", items: [ { type: "🐛 修復 (Fix)", en: "Fixed a regression bug where date difference calculations failed.", zh: "修复了日期差异计算失败的回归性Bug。" } ]},
                { version: "v9.4", date: "GRANZORT_DRIVE", items: [ { type: "🚀 新功能 (New)", en: "Rebuilt the Pet AI modal into a 'Tamagotchi-style' 3-button interface.", zh: "将宠物AI窗口重构为“拓麻歌子”风格的三按键界面。" }, { type: "✨ 優化 (Improved)", en: "Enhanced the avatar rebuild effect with a 'Granzort-style' spiraling particle animation.", zh: "使用“魔动王”风格的螺旋粒子动画增强了头像重组特效。" } ]},
                { version: "v9.3.1", date: "TAMAGOTCHI_CORE", items: [ { type: "🐛 修復 (Fix)", en: "Fixed an issue where chart click events were not being registered.", zh: "修复了图表点击事件无法被注册的问题。" } ]},
                { version: "v9.3", date: "TAMAGOTCHI_CORE", items: [ { type: "🚀 新功能 (New)", en: "Overhauled the pet system into a 'Tamagotchi' mini-game.", zh: "将宠物系统重构为具有饥饿度和幸福度状态的“拓麻歌子”迷你游戏。" }, { type: "🚀 新功能 (New)", en: "AI responses are now based on real-time pet stats and JSON data.", zh: "AI的回复现在基于实时的宠物状态和已加载的JSON数据。" } ]},
                { version: "v9.2", date: "SYNAPSE", items: [ { type: "🚀 新功能 (New)", en: "Introduced a mock-AI chat modal.", zh: "引入了模拟AI聊天窗口。" }, { type: "✨ 優化 (Improved)", en: "Reworked the performance monitor into a modal window.", zh: "将性能监视器重构为弹出窗口。" }, { type: "🐛 修復 (Fix)", en: "Completely fixed the avatar slash/rebuild effect.", zh: "彻底修复了头像挥砍/重组特效。" } ]},
                { version: "v9.1.1", date: "AEGIS-CORE", items: [ { type: "🐛 修復 (Fix)", en: "Fixed a critical bug where the Performance Monitor was permanently hidden.", zh: "修复了导致性能监视器被永久隐藏的关键错误。" } ]},
                { version: "v9.1", date: "AEGIS-CORE", items: [ { type: "🚀 新功能 (New)", en: "Restored the fully interactive Pet Bunny module.", zh: "恢复了完全互动的宠物兔子模组。" }, { type: "✨ 優化 (Improved)", en: "Replaced the 'Genesis' avatar effect with the 'Lightsaber Slash' variant.", zh: "将「创世纪」头像特效替换为「光剑挥砍」版本。" } ]},
                { version: "v9.0", date: "GENESIS-PRIME", items: [ { type: "🚀 新功能 (New)", en: "Added 'Genesis' avatar effect.", zh: "新增「创世纪」头像特效。" }, { type: "✨ 優化 (Improved)", en: "The Performance Monitor is now a toggleable module.", zh: "性能监视器现已成为可切换模块。" } ]},
                { version: "v8.1", date: "ETERNITY", items: [ { type: "✨ 優化 (Improved)", en: "Conducted a full stability audit.", zh: "进行了全面稳定性审计。" } ]},
                { version: "v8.0", date: "SINGULARITY", items: [ { type: "🚀 新功能 (New)", en: "Added 'Lightsaber Duel' effect and black hole lensing VFX.", zh: "加入了「光剑对决」特效和黑洞引力透镜VFX。" } ]},
                { version: "v7.7", date: "RECALIBRATED", items: [ { type: "🐛 修復 (Fix)", en: "Recalibrated chart click events and restored pet bunny visibility.", zh: "重新校准了图表点击事件并恢复了宠物兔的可见性。" } ]},
                { version: "v7.6", date: "SOLID-STATE", items: [ { type: "🐛 修復 (Fix)", en: "Fixed critical bugs affecting Milestones, Theme Palette, and Chart Interactions.", zh: "修复了影响里程碑、主题面板和图表互动的关键错误。" } ]},
                { version: "v7.5.1", date: "QUANTUM-LEAP", items: [ { type: "✨ 優化 (Improved)", en: "Upgraded mouse trail to a 'Quantum Trail' and added a 'Data Storm' scanline.", zh: "将滑鼠轨迹升级为多彩的「量子光轨」，并新增了「数据风暴」扫描线。" } ]},
                { version: "v7.5", date: "STABILIZED-CORE", items: [ { type: "✨ 優化 (Improved)", en: "Enhanced the cosmic dust VFX to be interactive.", zh: "增強了宇宙尘埃特效使其可互动。" } ]},
                { version: "v7.4", date: "NEXUS-CORE", items: [ { type: "🚀 新功能 (New)", en: "Pet interaction now triggers a burst of heart particles.", zh: "宠物互动现在会触发爱心粒子爆发。" } ]},
                { version: "v7.3", date: "HYPERSPACE", items: [ { type: "🚀 新功能 (New)", en: "Added a 'Hyperspace' jump animation on page load.", zh: "加入了「超空间跳跃」加载动画。" } ]},
                { version: "v7.2.1", date: "FONT-MATRIX", items: [ { type: "🚀 新功能 (New)", en: "Added a font toggle.", zh: "增加了字体切换器。" } ]},
                { version: "v7.2", date: "LEGACY-ARCHIVE", items: [ { type: "✨ 優化 (Improved)", en: "Restored complete changelog history.", zh: "恢复了完整的更新日志。" } ]},
                { version: "v7.1", date: "AETHER-PAINTER", items: [ { type: "🚀 新功能 (New)", en: "Introduced the 'Aether Painter' autonomous bunny.", zh: "引入了「以太画家」自主兔子。" } ]},
                { version: "v7.0", date: "PHOTON-CORE", items: [ { type: "🚀 新功能 (New)", en: "Introduced the 'Photon Pixel Bunny' cursor.", zh: "引入了「光子像素兔」游標。" } ]},
                { version: "v6.4", date: "INTERACTIVE-GRID", items: [ { type: "🚀 新功能 (New)", en: "Added interactive chart data points.", zh: "为图表增加了互动数据点。" } ]},
                { version: "v6.3", date: "PIXEL-CORE", items: [ { type: "🚀 新功能 (New)", en: "Applied a global pixel font.", zh: "应用了全局像素字体。" } ]},
                { version: "v6.2", date: "LOGIC-REFINED", items: [ { type: "♻️ 重構 (Refactor)", en: "Refactored data loading logic.", zh: "重构了数据加载逻辑。" } ]},
                { version: "v6.1", date: "STABLE", items: [ { type: "🐛 修復 (Fix)", en: "Patched a theme engine issue.", zh: "修复了主题引擎问题。" } ]},
                { version: "v6.0", date: "STARFLEET-COMMAND", items: [ { type: "🚀 新功能 (New)", en: "Migrated UI to LCARS standard.", zh: "将UI迁移至LCARS标准。" } ]},
                { version: "v5.0", date: "NEBULA-GRID", items: [ { type: "🚀 新功能 (New)", en: "Added performance panel and roaming mascot.", zh: "新增了性能面板和漫游宠物。" } ]},
                { version: "v4.0", date: "TRON Grid", items: [ { type: "🚀 新功能 (New)", en: "Re-engineered UI with TRON aesthetic.", zh: "以TRON美学重构UI。" } ]},
                { version: "v3.0", date: "Modern Fusion", items: [ { type: "🚀 新功能 (New)", en: "Introduced theme engine and changelog.", zh: "引入主题引擎和更新日志。" } ]},
                { version: "v2.0", date: "Pixel Upgrade", items: [ { type: "✨ 優化 (Improved)", en: "Switched to pixel font and added record archive.", zh: "更换为像素字体并添加档案记录。" } ]},
                { version: "v1.0", date: "Initial Commit", items: [ { type: "🚀 新功能 (New)", en: "Project initialized with timers and chart.", zh: "项目初始化，实现计时器和图表。" }]}
            ];
            const cE=document.getElementById('changelog-content');cE.innerHTML=cD.map(l=>`<div class="mb-6"><p class="text-xl font-bold accent-text">${l.v} <span class="text-sm font-normal text-gray-400">- ${l.dt}</span></p><ul class="mt-3 space-y-2 list-disc list-inside">${l.it.map(i=>`<li><p class="inline font-bold">${i.t}</p><p class="text-gray-300 mt-1">${i.zh}</p><p class="text-xs text-gray-500">${i.en}</p></li>`).join('')}</ul></div>`).join('');
        }
        async function getStaticPerfData() { // #PERF_LS_SIZE_FIXED
            const perfContent = document.getElementById('perf-modal-content');
            if (!perfContent) return;
            perfContent.innerHTML = `<div id="realtime-metrics-container"></div>`; // Real-time gets populated by updatePerfPanel
            let staticHtml = '';

            // Memory Subsystem
            staticHtml += `<div class="col-span-2 text-lg glow-text mt-4 mb-2">Memory Subsystem</div>`;
            staticHtml += `<div class="col-span-2 border-b border-gray-700 mb-2"></div>`;
            staticHtml += `<div class="col-span-2 grid grid-cols-2 gap-x-4">`;
            if (performance.memory) {
                staticHtml += `<span>JS HEAP USED:</span><span class="text-white text-right">${(performance.memory.usedJSHeapSize / 1048576).toFixed(1)}MB</span>`;
                staticHtml += `<span>JS HEAP TOTAL:</span><span class="text-white text-right">${(performance.memory.totalJSHeapSize / 1048576).toFixed(1)}MB</span>`;
                staticHtml += `<span>JS HEAP LIMIT:</span><span class="text-white text-right">${(performance.memory.jsHeapSizeLimit / 1048576).toFixed(1)}MB</span>`;
            } else {
                staticHtml += '<span class="col-span-2">Memory API N/A</span>';
            }
            try {
                const lsSize = new TextEncoder().encode(JSON.stringify(localStorage)).length;
                staticHtml += `<span>LS USED (EST):</span><span class="text-white text-right">${(lsSize / 1024).toFixed(2)}KB / ~${(CONFIG.MAX_LOCALSTORAGE_SAVE_BYTES / 1024 / 1024).toFixed(0)}MB</span>`;
            } catch (e) {
                staticHtml += `<span>LS EST:</span><span class="text-white text-right">Error</span>`;
            }
            staticHtml += `</div>`;

            // Page Vitals & Load
            const navTiming = performance.getEntriesByType("navigation")[0];
            const paintTimings = performance.getEntriesByType("paint");
            if (navTiming || paintTimings.length > 0) {
                staticHtml += `<div class="col-span-2 text-lg glow-text mt-4 mb-2">Page Vitals & Load</div>`;
                staticHtml += `<div class="col-span-2 border-b border-gray-700 mb-2"></div>`;
                staticHtml += `<div class="col-span-2 grid grid-cols-2 gap-x-4">`;
                const fcp = paintTimings.find(p => p.name === 'first-contentful-paint');
                if (fcp) staticHtml += `<span>FIRST PAINT:</span><span class="text-white text-right">${fcp.startTime.toFixed(0)}ms</span>`;
                if (navTiming) staticHtml += `<span>TOTAL LOAD:</span><span class="text-white text-right">${navTiming.duration.toFixed(0)}ms</span>`;
                staticHtml += `</div>`;
            }

            // Resource Analysis
            const resources = performance.getEntriesByType("resource");
            if (resources.length > 0) {
                staticHtml += `<div class="col-span-2 text-lg glow-text mt-4 mb-2">Resource Analysis</div>`;
                staticHtml += `<div class="col-span-2 border-b border-gray-700 mb-2"></div>`;
                staticHtml += `<div class="col-span-2 grid grid-cols-2 gap-x-4">`;
                const totalSize = resources.reduce((acc, r) => acc + (r.transferSize || 0), 0);
                staticHtml += `<span>TOTAL ASSETS:</span><span class="text-white text-right">${resources.length}</span>`;
                staticHtml += `<span>PAGE WEIGHT:</span><span class="text-white text-right">${(totalSize / 1024).toFixed(1)}KB</span>`;
                const slowest = [...resources].sort((a, b) => b.duration - a.duration)[0];
                if (slowest) staticHtml += `<span class="col-span-2">SLOWEST:</span><span class="text-white col-span-2 break-all text-right">${slowest.name.split('/').pop()}(${slowest.duration.toFixed(0)}ms)</span>`;
                staticHtml += `</div>`;
            }

            // Hardware & System
            staticHtml += `<div class="col-span-2 text-lg glow-text mt-4 mb-2">Hardware & System</div>`;
            staticHtml += `<div class="col-span-2 border-b border-gray-700 mb-2"></div>`;
            staticHtml += `<div class="col-span-2 grid grid-cols-2 gap-x-4">`;
            if(navigator.hardwareConcurrency) staticHtml += `<span>CPU CORES:</span><span class="text-white text-right">${navigator.hardwareConcurrency}</span>`;
            if(navigator.deviceMemory) staticHtml += `<span>SYS MEMORY:</span><span class="text-white text-right">~${navigator.deviceMemory}GB</span>`;
            if(navigator.getBattery){ try{ const b = await navigator.getBattery(); staticHtml += `<span>BATTERY:</span><span class="text-white text-right">${(b.level*100).toFixed(0)}% ${b.charging?'(Chg)':'')</span>`; }catch(e){} }
            if(navigator.userAgent){ let os="Unk"; if(navigator.userAgent.includes("Win"))os="Win"; else if(navigator.userAgent.includes("Mac"))os="macOS"; else if(navigator.userAgent.includes("Linux"))os="Linux"; else if(navigator.userAgent.includes("Android"))os="Android"; else if(navigator.userAgent.includes("iPad"))os="iPadOS"; else if(navigator.userAgent.includes("iPhone"))os="iOS"; staticHtml += `<span>OS:</span><span class="text-white text-right">${os}</span>`; }
            staticHtml += `</div>`;
            
            perfContent.innerHTML += staticHtml; // Append all static HTML at once
        }
        function updatePerfPanel(cT){const pC=document.getElementById('perf-modal-content');if(!pC||document.getElementById('performance-modal').classList.contains('hidden'))return;const iV=cT-lastPerfUpdateTime;const fps=Math.round((frameCount/iV)*1e3);const rTC=pC.querySelector('#realtime-metrics-container');if(rTC){rTC.innerHTML=`<div class="col-span-2 text-lg glow-text mb-2">Real-time</div><div class="col-span-2 border-b border-gray-700 mb-2"></div><div class="col-span-2 grid grid-cols-2 gap-x-4"><span class="text-gray-400">FPS:</span><span class="text-white text-right">${fps}</span><span class="text-gray-400">FRAME TIME:</span><span class="text-white text-right">${(1e3/fps||0).toFixed(2)}ms</span><span class="text-gray-400">PARTICLES:</span><span class="text-white text-right">${cosmicDust.length+clickRipples.length+forceParticles.length+mouseSnake.length+celestialParticles.length}</span><span class="text-gray-400">DOM NODES:</span><span class="text-white text-right">${document.getElementsByTagName('*').length}</span></div>`;}lastPerfUpdateTime=cT;frameCount=0;}
    </script>
</body>
</html>
