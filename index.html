<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æª”æ¡ˆï¼šBunny CC vX [METROPOLIS_ZENITH_FINAL_v0.9.1_FIXED]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-rgb: 236,72,153; --accent-rgb: 251,191,36; --bg-color: #0c0a1d;
            --text-color: #e6edf3; --text-color-rgb: 230,237,243; --text-muted-color: #8b949e;
            --mouse-x: 50%; --mouse-y: 50%;
            --color-red: 239,68,68; --color-green: 34,197,94; --color-yellow: 251,191,36; --color-blue:59,130,246;
        }
        body { font-family:'Noto Sans SC',sans-serif;font-size:14px;background-color:var(--bg-color);color:var(--text-color);overflow:hidden;opacity:0;animation:fadeIn 1s ease forwards;cursor:none;position:relative;z-index:0; }
        body.font-pixel { font-family:'Press Start 2P','Noto Sans SC',sans-serif;font-size:12px; }
        body.font-pixel .lcars-button,body.font-pixel .accent-text,body.font-pixel .glow-text,body.font-pixel h1,body.font-pixel h2,body.font-pixel #theme-page-title,body.font-pixel .modal-container h2,body.font-pixel .sim-button{letter-spacing:1px;}

        #singularity-background { position:fixed;inset:0;z-index:-5;background:#0c0a1d; }
        #circuitry-background { position:fixed;inset:0;z-index:-4;background-image:linear-gradient(rgba(var(--glow-rgb),.03) 1px,transparent 1px),linear-gradient(90deg,rgba(var(--glow-rgb),.03) 1px,transparent 1px);background-size:25px 25px;animation:hue-cycle 30s linear infinite; }
        @keyframes hue-cycle { from{filter:hue-rotate(0deg);} to{filter:hue-rotate(360deg);} }
        body::before { content:'';position:fixed;inset:0;z-index:-3;background-image:linear-gradient(rgba(var(--glow-rgb),.08) 1px,transparent 1px),linear-gradient(to right,rgba(var(--glow-rgb),.08) 1px,transparent 1px);background-size:75px 75px;animation:grid-scroll 15s linear infinite;opacity:.7; }
        @keyframes grid-scroll { from{background-position:0 0;} to{background-position:75px 150px;} }
        body::after { content:'';position:fixed;inset:0;z-index:-2;background:radial-gradient(800px at var(--mouse-x) var(--mouse-y),rgba(var(--glow-rgb),.18),transparent 80%);pointer-events:none; }
        
        .effect-canvas { position:fixed;inset:0;pointer-events:none; } #vfx-canvas { z-index:11; } #bunny-trail-canvas { z-index:9998; }
        .pixel-entity { position:fixed;width:32px;height:32px;background-size:contain;pointer-events:none;transform:translate(-50%,-50%);transition:filter .5s,opacity .5s;will-change:transform,left,top; }
        #mouse-bunny { z-index:9999;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3 4h1v1h1v1h4v-1h1v-1h1v3h1v1h-1v1h-1v1h-1v1h-2v-1h-1v-1h-1v-1h-1v-1h-1v-2z' fill='rgb(var(--glow-rgb))'/%3E%3Cpath d='M7 6h1v1h-1z' fill='%23000'/%3E%3Cpath d='M4 4h1v1h-1zM10 4h1v1h-1zM5 6h1v1h-1z' fill='rgb(var(--accent-rgb))'/%3E%3C/svg%3E");filter:drop-shadow(0 0 8px rgba(var(--glow-rgb),.8)); }
        
        .lcars-container { display:flex;height:100vh;padding:1rem;gap:1rem;position:relative;z-index:10; }
        .lcars-sidebar { width:150px;display:flex;flex-direction:column;gap:1rem;flex-shrink:0; }
        .lcars-main { flex-grow:1;display:flex;flex-direction:column;gap:1rem;min-width:0; }
        .lcars-element { background:rgb(var(--glow-rgb));transition:all .3s ease; }
        .lcars-elbow { width:100%;height:60px;background:rgb(var(--glow-rgb));border-top-left-radius:30px;border-bottom-left-radius:30px; }
        .lcars-content-panel { flex-grow:1;background:rgba(8,8,8,.8);backdrop-filter:blur(2px);border:2px solid rgb(var(--glow-rgb));padding:1.5rem;display:flex;flex-direction:column;gap:1.5rem;overflow-y:auto;min-height:0;animation:border-glow-in 2s ease-out forwards; }
        .lcars-button { background:#080808;border:2px solid rgb(var(--accent-rgb));color:rgb(var(--accent-rgb));text-shadow:0 0 8px rgba(var(--accent-rgb),.8);transition:all .2s ease;display:flex;align-items:center;justify-content:center;gap:.5rem; }
        .lcars-button:hover, .sim-button:hover:not(:disabled) { background:rgb(var(--accent-rgb));color:#000;box-shadow:0 0 15px rgba(var(--accent-rgb),.7); }
        .sim-button:disabled { filter:grayscale(80%);cursor:not-allowed;opacity:.5; }

        .modal-overlay { display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);transition:opacity .3s ease; }
        .modal-container { background:#080808;border:2px solid rgb(var(--glow-rgb));box-shadow:0 0 30px rgba(var(--glow-rgb),.5);transition:transform .3s ease; }
        .modal-overlay.hidden { pointer-events:none; } .modal-overlay.hidden .modal-container { transform:scale(.95); }
        
        #city-management-modal .status-bar-container { background:#222;border-radius:.25rem;overflow:hidden;border:1px solid #333;height:.7rem; }
        #city-management-modal .status-bar-fill { height:.7rem;border-radius:.25rem;transition:width .5s ease;text-align:center;font-size:.55rem;color:black;font-weight:bold;line-height:.7rem; }
        #city-main-screen { min-height:70px;background-color:#111;border:1px solid rgba(var(--glow-rgb),.2);border-radius:.5rem;padding:.5rem;display:flex;flex-direction:column;justify-content:center;text-align:left;white-space:pre-wrap;transition:all .3s;font-size:.7rem; }
        .sim-button { flex-grow:1;margin:.2rem;padding:.35rem .15rem;border-radius:.25rem;background:#222;border:1px solid rgb(var(--accent-rgb));color:rgb(var(--accent-rgb));transition:all .2s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.55rem;line-height:1;text-align:center; }
        .sim-button svg { width:.9rem;height:.9rem;margin-bottom:.1rem; }
        .sim-panel-content { max-height:40vh;overflow-y:auto;padding:.5rem;border-top:1px solid rgba(var(--glow-rgb),.2);display:none; }
        .resource-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(75px,1fr));gap:.25rem;font-size:.6rem; }
        .resource-item span:first-child {color:var(--text-muted-color);} .resource-item span:last-child {color:rgb(var(--accent-rgb));font-weight:bold;}
        .detail-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.2rem;font-size:.6rem;margin-top:.25rem; }
        .detail-item { padding:.1rem .15rem;background-color:rgba(var(--text-color-rgb),.03);border-radius:.2rem; }
        .tooltip { position:relative;display:inline-block; } .tooltip .tooltiptext { visibility:hidden;min-width:100px;background-color:#333;color:#fff;text-align:center;border-radius:4px;padding:3px 5px;position:absolute;z-index:100;bottom:115%;left:50%;margin-left:-50px;opacity:0;transition:opacity .2s;font-size:.6rem;box-shadow:0 2px 5px rgba(0,0,0,.5); } .tooltip:hover .tooltiptext { visibility:visible;opacity:1; }
        .list-item { padding:.3rem;border:1px solid rgba(var(--glow-rgb),.1);border-radius:.3rem;margin-bottom:.3rem; }
        .list-item:hover { background-color:rgba(var(--accent-rgb),.1); }
        .god-mode-input { background:rgba(var(--text-color-rgb),.1);border:1px solid rgba(var(--accent-rgb),.5);color:var(--text-color);padding:.2rem .4rem;border-radius:.2rem;width:100px;text-align:right;font-size:.7rem; }
        #god-mode-calculator-modal .modal-container {max-width:450px;padding:1.5rem;text-align:left;font-size:0.75rem;}
        #god-mode-calculator-modal p {margin-bottom:0.4rem;} #god-mode-calculator-modal strong {color:rgb(var(--accent-rgb));}
        #god-mode-calculator-modal .code-block {background:rgba(0,0,0,0.2);padding:0.5rem;border-radius:0.25rem;font-family:monospace;word-break:break-all;}

        .ui-module { opacity:0;transform:translateY(20px) scale(.98);animation:module-boot .6s ease-out forwards; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} } @keyframes module-boot { to{opacity:1;transform:translateY(0) scale(1);} }
        @keyframes border-glow-in { from{box-shadow:0 0 0px rgba(var(--glow-rgb),0);} to{box-shadow:0 0 20px rgba(var(--glow-rgb),.3);} }
        #avatar-container { position:relative;cursor:pointer; } #profile-pic { transition:opacity .5s ease;will-change:opacity; }
        .record-scrollbar::-webkit-scrollbar { width:6px; } .record-scrollbar::-webkit-scrollbar-track { background:transparent; } .record-scrollbar::-webkit-scrollbar-thumb { background:rgba(var(--glow-rgb),.4);border-radius:3px; }
    </style>
</head>
<body>
    <div id="singularity-background"></div> <div id="circuitry-background"></div>
    <canvas id="vfx-canvas" class="effect-canvas"></canvas> <canvas id="bunny-trail-canvas" class="effect-canvas"></canvas>
    <div id="mouse-bunny" class="pixel-entity"></div>
    
    <div class="lcars-container">
        <div class="lcars-sidebar">
            <div class="lcars-elbow"></div>
            <div class="flex-grow flex flex-col justify-end gap-4">
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('changelog-modal')">LOGS</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('theme-modal')">THEME</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleFullscreen()">FSCRN</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('performance-modal')">PERF</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('city-management-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /><path d="M16 4.586V17a1 1 0 01-1 1h-1.5a1 1 0 01-1-1v-2.268a2 2 0 00-2-2h-1.06a2 2 0 00-2 2V17a1 1 0 01-1 1H6a1 1 0 01-1-1V4.586l7-7 4 4zM9 13.732V17h2v-3.268a4.002 4.002 0 00-2-.001z" fill-rule="evenodd" clip-rule="evenodd"/> </svg>
                    <span>CITY OS</span>
                </button>
            </div>
        </div>
        <div class="lcars-main">
            <div id="main-title-area" class="h-16 flex justify-between items-center flex-shrink-0 cursor-pointer" title="å¤šæ¬¡ç‚¹å‡»æ­¤å¤„æœ‰æƒŠå–œ...">
                <div class="flex items-center">
                    <div class="lcars-element w-24 h-16 rounded-l-full"></div>
                    <div class="ml-4"><p class="text-xl sm:text-2xl font-bold tracking-wider glow-text">SIM-BCC</p><p class="accent-text text-sm">METROPOLIS_ZENITH_FINAL_v0.9</p></div>
                </div>
                <div id="god-mode-indicator" class="text-xs text-red-500 font-bold hidden mr-4">GOD MODE ACTIVE</div>
            </div>
            <div class="lcars-content-panel record-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 flex flex-col space-y-6">
                        <div class="ui-module text-center">
                            <div id="avatar-container" class="w-40 h-40 mx-auto"> <img id="profile-pic" class="w-full h-full rounded-full object-cover p-1 border-2" style="border-color:rgb(var(--glow-rgb));"> </div>
                            <h1 class="text-2xl font-bold mt-4 glow-text">MAYOR BUNNY (å…”å¯å¯)</h1>
                        </div>
                        <div class="ui-module"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">MILESTONES</h2><div id="timing" class="space-y-3" style="color:var(--text-muted-color)"></div></div>
                    </div>
                    <div class="md:col-span-2 flex flex-col space-y-6">
                        <div class="ui-module"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">DATA VISUALIZATION</h2>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div><h3 class="text-sm accent-text mb-1">POPULATION_TREND (City Sim)</h3><div class="h-56 chart-container"><canvas id="populationChart"></canvas></div><div id="population-change-info" class="mt-2 text-center p-2 rounded-lg h-10 flex items-center justify-center text-xs" style="background-color:rgba(var(--glow-rgb),.05);border:1px solid rgba(var(--glow-rgb),.2);"></div></div>
                                <div id="pet-weight-module" style="display:none;"><h3 class="text-sm accent-text mb-1">PET_WEIGHT_ARCHIVE (Legacy)</h3><div class="h-56 chart-container"><canvas id="weightChart"></canvas></div><div id="weight-change-info" class="mt-2 text-center p-2 rounded-lg h-10 flex items-center justify-center text-xs" style="background-color:rgba(var(--glow-rgb),.05);border:1px solid rgba(var(--glow-rgb),.2);"></div></div>
                            </div>
                        </div>
                        <div class="ui-module flex-grow flex flex-col"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">EVENT_STREAM</h2>
                            <div class="flex text-xs mb-2"><button id="log-toggle-city" class="px-2 py-1 border border-transparent border-b-2 font-bold accent-text" style="border-bottom-color:rgb(var(--accent-rgb))">City Log</button><button id="log-toggle-pet" class="px-2 py-1 opacity-60 hover:opacity-100">Pet Archive</button></div>
                            <div id="city-events-container" class="record-scrollbar flex-grow pr-2 space-y-3"></div>
                            <div id="all-records-container" class="record-scrollbar flex-grow pr-2 space-y-3" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="changelog-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('changelog-modal')"><div class="modal-container w-11/12 max-w-4xl max-h-[80vh] flex flex-col" onclick="event.stopPropagation()"><h2 class="text-xl p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb),.3)">CHANGELOG</h2><div id="changelog-content" class="p-6 overflow-y-auto record-scrollbar"></div></div></div>
    <div id="theme-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('theme-modal')"><div class="modal-container w-11/12 max-w-md" onclick="event.stopPropagation()"><div class="p-4 flex justify-between items-center border-b" style="border-color:rgba(var(--glow-rgb),.3)"><button id="prev-theme-page" class="text-2xl glow-text"><</button><h2 id="theme-page-title" class="text-xl glow-text">COLOR_CYCLE</h2><button id="next-theme-page" class="text-2xl glow-text">></button></div><div id="theme-grid" class="p-6 grid grid-cols-5 gap-4"></div><div class="p-4 border-t flex items-center gap-4" style="border-color:rgba(var(--glow-rgb),.3)"><input id="custom-color-input" type="text" placeholder="è‰²ç  æˆ– æœ€ç»ˆæ¿€æ´»ç ..." class="flex-grow bg-transparent border text-center p-2 rounded-md" style="border-color:rgba(var(--accent-rgb),.5)"><button id="font-toggle-button" class="lcars-button rounded-md px-4 py-2 text-xs">PIXEL FONT</button></div></div></div>
    <div id="performance-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('performance-modal')"><div class="modal-container w-11/12 max-w-lg p-6 flex flex-col" onclick="event.stopPropagation()"><h2 class="text-xl pb-4 mb-4 glow-text border-b flex-shrink-0" style="border-color:rgba(var(--glow-rgb),.3)">OBSERVER_PRIME</h2><div id="perf-modal-content" class="text-xs space-y-1 overflow-y-auto record-scrollbar max-h-[70vh]" style="font-family:'Press Start 2P',sans-serif;"></div></div></div>
    
    <div id="city-management-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('city-management-modal')">
        <div class="modal-container w-11/12 max-w-3xl flex flex-col" style="max-height:95vh;" onclick="event.stopPropagation()">
            <h2 class="text-xl p-2 glow-text border-b flex-shrink-0 text-center" style="border-color:rgba(var(--glow-rgb),.3)">BCC æ–‡å­—å¤§éƒ½ä¼šæ§åˆ¶ä¸­å¿ƒ <span id="god-mode-modal-indicator" class="text-xs text-red-400 hidden">(ä¸Šå¸æ¨¡å¼)</span></h2>
            <div class="p-2 space-y-1 flex-shrink-0 border-b" style="border-color:rgba(var(--glow-rgb),.1);">
                <div class="resource-grid mb-1">
                    <div class="resource-item tooltip">ğŸ’°<span class="tooltiptext">èµ„é‡‘</span>:<span id="sim-funds">0</span></div> 
                    <div class="resource-item tooltip">ğŸ§‘â€ğŸ¤â€ğŸ§‘<span class="tooltiptext">äººå£/æœ€å¤§å®¹é‡</span>:<span id="sim-population">0</span></div>
                    <div class="resource-item tooltip">âš¡<span class="tooltiptext">ç”µåŠ›éœ€æ±‚/äº§èƒ½</span>:<span id="sim-power">0/0</span></div> 
                    <div class="resource-item tooltip">ğŸ’§<span class="tooltiptext">æ°´æºéœ€æ±‚/äº§èƒ½</span>:<span id="sim-water">0/0</span></div>
                    <div class="resource-item tooltip">ğŸ­<span class="tooltiptext">å·¥ä¸šå“äº§å‡º</span>:<span id="sim-goods-produced">0</span></div>
                    <div class="resource-item tooltip">ğŸ›ï¸<span class="tooltiptext">å•†å“éœ€æ±‚</span>:<span id="sim-goods-demand">0</span></div>
                    <div class="resource-item">ğŸ—“ï¸<span class="tooltiptext">æ—¥æœŸ</span>:<span id="sim-date">Y1D1</span></div> 
                    <div class="resource-item tooltip">ğŸ”¬<span class="tooltiptext">ç§‘ç ”ç‚¹</span>:<span id="sim-research">0</span></div>
                    <div class="resource-item tooltip">ğŸ› ï¸<span class="tooltiptext">åŠ³åŠ¨åŠ›/å²—ä½(å¤±ä¸š)</span>:<span id="sim-workforce">0/0(0)</span></div>
                    <div class="resource-item tooltip">ğŸ’¡<span class="tooltiptext">é¡¾é—®çŠ¶æ€</span>:<span id="sim-bunny-status">è‰¯å¥½</span></div>
                    <div class="resource-item tooltip">ğŸ†<span class="tooltiptext">åŸå¸‚ç­‰çº§(ç»éªŒ)</span>:<span id="sim-city-level">1(0/100)</span></div>
                    <div class="resource-item tooltip">ğŸª¨<span class="tooltiptext">åŸææ–™å‚¨å¤‡(å¤šç§)</span>:<span id="sim-raw-materials">0</span></div>
                </div>
                <div class="detail-grid">
                    <div class="detail-item tooltip">ğŸ˜Š<span class="tooltiptext">å¹³å‡æ»¡æ„åº¦</span>:<span id="sim-satisfaction-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-satisfaction-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#10b981,#34d399);"></div></div></div>
                    <div class="detail-item tooltip">ğŸŒ³<span class="tooltiptext">ç¯å¢ƒè´¨é‡</span>:<span id="sim-environment-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-environment-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#22c55e,#4ade80);"></div></div></div>
                    <div class="detail-item tooltip">ğŸš—<span class="tooltiptext">äº¤é€šå‹åŠ›</span>:<span id="sim-traffic-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-traffic-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#f59e0b,#fbbf24);"></div></div></div>
                    <div class="detail-item tooltip">ğŸ—‘ï¸<span class="tooltiptext">åƒåœ¾å¤„ç†å‹åŠ›</span>:<span id="sim-garbage-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-garbage-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#a16207,#ca8a04);"></div></div></div>
                </div>
            </div>
            <div id="city-main-screen" class="flex-grow m-2 text-sm record-scrollbar pr-1">å¸‚é•¿ï¼Œè¯·ä¸‹è¾¾æŒ‡ç¤º...</div>
            <div id="city-action-tabs" class="p-1 border-t border-b flex-shrink-0 flex flex-wrap justify-around text-xs" style="border-color:rgba(var(--glow-rgb),.2);">
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button active" onclick="showCityPanel('city-main-screen')">æ¦‚è§ˆ</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('construction-panel')">å»ºè®¾</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('budget-panel')">é¢„ç®—</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('policy-panel')">æ”¿ç­–</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('tech-tree-panel')">ç§‘æŠ€</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('district-panel')">åŒºåŸŸ</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('mayor-actions-panel')">å¸‚é•¿è¡ŒåŠ¨</button>
                <button id="god-mode-tab-button" class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button hidden" onclick="showCityPanel('god-mode-panel')">GM</button>
            </div>
            <div id="construction-panel" class="sim-panel-content record-scrollbar"></div> <div id="budget-panel" class="sim-panel-content record-scrollbar"></div> 
            <div id="policy-panel" class="sim-panel-content record-scrollbar"></div> <div id="tech-tree-panel" class="sim-panel-content record-scrollbar"></div>
            <div id="district-panel" class="sim-panel-content record-scrollbar"></div><div id="mayor-actions-panel" class="sim-panel-content record-scrollbar"></div>
            <div id="god-mode-panel" class="sim-panel-content record-scrollbar p-2 space-y-2"></div>
            <div class="p-1 border-t flex-shrink-0 flex justify-around" style="border-color:rgba(var(--glow-rgb),.3)">
                <button id="sim-next-day-button" class="sim-button" title="ç»“æŸæœ¬æ—¥"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/></svg>ç»“æŸæœ¬æ—¥</button>
                <button id="sim-save-button" class="sim-button" title="ä¿å­˜è¿›åº¦åˆ°æµè§ˆå™¨"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v1H5V4zM5 7h10v9a2 2 0 01-2 2H7a2 2 0 01-2-2V7z"/></svg>ä¿å­˜</button>
                 <button id="sim-load-button" class="sim-button" title="ä»æµè§ˆå™¨è¯»å–è¿›åº¦"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>è¯»å–</button>
            </div>
        </div>
    </div>
    <div id="god-mode-calculator-modal" class="modal-overlay fixed inset-0 z-[210] hidden items-center justify-center opacity-0" onclick="toggleCalculatorModal(false)">
        <div class="modal-container" onclick="event.stopPropagation()">
            <h2 class="text-lg p-3 glow-text border-b" style="border-color:rgba(var(--glow-rgb),.3)">ä¸Šå¸æ¨¡å¼ - æ¿€æ´»ç è®¡ç®—å™¨</h2>
            <div id="calculator-info" class="p-4 space-y-2"></div>
            <div class="p-3 border-t text-center" style="border-color:rgba(var(--glow-rgb),.3)">
                <button class="lcars-button px-4 py-2 text-sm rounded" onclick="toggleCalculatorModal(false)">æ˜ç™½</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIG, GLOBAL STATE, DEFINITIONS... ---
        const CONFIG={PROFILE_PIC_PATH:'./dist/Bunny CC_Profile.JPG',PET_RECORDS_PATH:'./dist/bunnycc/PetRecords.json',CITY_SAVE_KEY:'bunny_cc_sim_save_v0.9',START_DATE:'2024/03/12 00:00:00',MOUSE_SNAKE_LENGTH:20,COSMIC_DUST_COUNT:250,AVATAR_EFFECT_PRESETS:2,MAX_LOCALSTORAGE_SAVE_BYTES:4.5*1024*1024,GOD_MODE_TITLE_CLICKS:10,GOD_MODE_CALC_SALT_S1:12345,GOD_MODE_JS_ADDON:5678,THEMES:`pink/236,72,153 gold/251,191,36 cyan/34,211,238 magenta/244,114,182 lime/132,204,22 red/239,68,68 indigo/88,86,214 green/34,197,94 white/229,231,235 purple/168,85,247 sky/56,189,248 rose/251,113,133 emerald/16,185,129 amber/245,158,11 violet/139,92,246 fuchsia/217,70,239 teal/20,184,166 blue/59,130,246 lightblue/14,165,233 forest/22,163,74 crimson/220,38,38 silver/156,163,175 bronze/205,133,63 steel/113,128,150 mint/10,200,150 lavender/216,180,254 salmon/250,128,114 turquoise/64,224,208 olive/128,128,0 maroon/128,0,0 navy/0,0,128 coral/255,127,80 orchid/218,112,214 plum/221,160,221 khaki/240,230,140 slateblue/106,90,205 sienna/160,82,45 hotpink/255,105,180 deepskyblue/0,191,255 lawngreen/124,252,0 mediumvioletred/199,21,133 darkorange/255,140,0 dodgerblue/30,144,255 tomato/255,99,71 springgreen/0,255,127 aqua/0,255,255 chartreuse/127,255,0 darkviolet/148,0,211 electric/213,252,9 cosmic/45,15,128 nebula/188,45,225 solar/255,180,0 galactic/75,0,130 cyber/0,255,198 quantum/255,30,90 void/10,10,25 supernova/255,80,0 starlight/230,230,250`.split(' ').map(s=>({n:s.split('/')[0],r:s.split('/')[1]}))};
        const docEl=document.documentElement,bodyEl=document.body;
        const avatarContainer=document.getElementById('avatar-container');const mouseBunnyEl=document.getElementById('mouse-bunny');
        const vfxCanvas=document.getElementById('vfx-canvas'),vfxCtx=vfxCanvas.getContext('2d');
        const mouseTrailCanvas=document.getElementById('bunny-trail-canvas'),mouseTrailCtx=mouseTrailCanvas.getContext('2d');
        const cityManagementModal=document.getElementById('city-management-modal');const cityMainScreen=document.getElementById('city-main-screen');
        const mainTitleArea=document.getElementById('main-title-area');
        const godModeCalculatorModal=document.getElementById('god-mode-calculator-modal');
        const calculatorInfoEl=document.getElementById('calculator-info');
        const simEls={f:document.getElementById('sim-funds'),p:document.getElementById('sim-population'),w:document.getElementById('sim-water'),e:document.getElementById('sim-power'),gP:document.getElementById('sim-goods-produced'),gD:document.getElementById('sim-goods-demand'),d:document.getElementById('sim-date'),r:document.getElementById('sim-research'),wf:document.getElementById('sim-workforce'),bs:document.getElementById('sim-bunny-status'),cl:document.getElementById('sim-city-level'),rm:document.getElementById('sim-raw-materials'),sBar:document.getElementById('sim-satisfaction-bar'),eBar:document.getElementById('sim-environment-bar'),tBar:document.getElementById('sim-traffic-bar'),gbBar:document.getElementById('sim-garbage-bar'),sP:document.getElementById('sim-satisfaction-perc'),eP:document.getElementById('sim-environment-perc'),tP:document.getElementById('sim-traffic-perc'),gbP:document.getElementById('sim-garbage-perc')};
        const simPanels={con:document.getElementById('construction-panel'),bud:document.getElementById('budget-panel'),pol:document.getElementById('policy-panel'),tec:document.getElementById('tech-tree-panel'),dis:document.getElementById('district-panel'),may:document.getElementById('mayor-actions-panel'),god:document.getElementById('god-mode-panel')};
        const cityEventsContainer=document.getElementById('city-events-container'),allRecordsContainer=document.getElementById('all-records-container');
        const populationChartEl=document.getElementById('populationChart'),weightChartEl=document.getElementById('weightChart');
        const petWeightModule=document.getElementById('pet-weight-module');
        let mouse={x:window.innerWidth/2,y:window.innerHeight/2,dx:0,lastX:0},mouseSnake=[];
        let city={},advisorBunny={happiness:75,energy:80,lastFed:-1,lastInteract:-1};
        let weightChartJS,populationChartJS,allPetRecords=[],weightRecords=[];
        let lastPerfUpdateTime=0,frameCount=0,lastFrameTime=0,cosmicDust=[],clickRipples=[],forceParticles=[],celestialParticles=[];
        let currentThemePage=0,audioCtx,avatarState='normal',currentCityPanel='city-main-screen',currentLogView='city';
        let currentAvatarEffect=0,godModeActive=false,titleClickCount=0,lastTitleClickTime=0;
        const CITIZEN_TYPES={LOW_INC:{needs:{housing_density:['LOW'],goods_basic:1,jobs_low_skill:1},tax_contrib:0.8,edu_max:0.3,name:"ä½æ”¶å…¥"},MED_INC:{needs:{housing_density:['LOW','MED'],goods_varied:1,jobs_med_skill:1,recreation_basic:0.5},tax_contrib:1,edu_max:0.6,name:"ä¸­ç­‰æ”¶å…¥"},HIGH_INC:{needs:{housing_density:['MED','HIGH'],goods_luxury:1,jobs_high_skill:1,recreation_advanced:0.5,education_good:0.5},tax_contrib:1.5,edu_max:1,name:"é«˜æ”¶å…¥"}};
        const ZONE_DENSITY={LOW:{mod:1,name:"ä½"},MED:{mod:1.8,name:"ä¸­",reqTech:['ZONING_MED_DENSITY']},HIGH:{mod:3,name:"é«˜",reqTech:['ZONING_HIGH_DENSITY']}};
        const RAW_MATERIALS_TYPES={STONE:{n:"çŸ³æ",baseVal:5,color:"128,128,128"},WOOD:{n:"æœ¨æ",baseVal:4,color:"139,69,19"},OIL:{n:"çŸ³æ²¹",baseVal:10,pol:2,color:"50,50,50"},ORE:{n:"çŸ¿çŸ³",baseVal:8,pol:1,color:"112,128,144"},FARM:{n:"å†œäº§å“",baseVal:3,color:"154,205,50"},COAL:{n:"ç…¤ç‚­",baseVal:6,color:"70,70,70"}};
        const BUILDING_CATEGORIES={residential:"ä½å®…",commercial:"å•†ä¸š",industrial:"å·¥ä¸š",office:"åŠå…¬",utility:"å…¬å…±è®¾æ–½",service:"æœåŠ¡",special:"ç‰¹æ®Š",extractor:"å¼€é‡‡",processor:"åŠ å·¥",transport:"äº¤é€š",road:"é“è·¯"};
        const GOODS_TYPES={goods_basic:"åŸºç¡€å•†å“",goods_varied:"å¤šæ ·å•†å“",goods_luxury:"å¥¢ä¾ˆå“",CONSTRUCTION_MATERIALS:"å»ºç­‘ææ–™",MACHINERY:"æœºæ¢°è®¾å¤‡",ELECTRONICS:"ç”µå­äº§å“",PROCESSED_FOOD:"åŠ å·¥é£Ÿå“"};
        const BUILDINGS={RZONE_LD_L1:{n:"æ£šæˆ·åŒº",c:150,t:'zone',cat:'residential',density:'LOW',lvl:1,cap:10,pU:-1,wU:-0.5,pol:0.2,m:2,ui:{ic:'ğŸ›–'},popTypeReq:['LOW_INC']},RZONE_LD_L2:{n:"å¹³æˆ¿",c:0,t:'zone',cat:'residential',density:'LOW',lvl:2,cap:25,pU:-2,wU:-1,pol:0.5,m:5,ui:{ic:'ğŸ '},upgFrom:'RZONE_LD_L1',upgCost:200,upgReq:{landValue:30,serviceCov:.2},popTypeReq:['LOW_INC','MED_INC']},RZONE_MD_L1:{n:"å…¬å¯“æ¥¼",c:800,t:'zone',cat:'residential',density:'MED',lvl:1,cap:70,pU:-6,wU:-3,pol:1,m:15,ui:{ic:'ğŸ¡'},popTypeReq:['MED_INC'],reqTech:['ZONING_MED_DENSITY']},RZONE_HD_L1:{n:"é«˜å±‚å…¬å¯“",c:2000,t:'zone',cat:'residential',density:'HIGH',lvl:1,cap:200,pU:-15,wU:-8,pol:2,m:40,ui:{ic:'ğŸ¢'},popTypeReq:['MED_INC','HIGH_INC'],reqTech:['ZONING_HIGH_DENSITY']},CZONE_LD_L1:{n:"å°å•†åº—",c:200,t:'zone',cat:'commercial',density:'LOW',lvl:1,jS_types:{jobs_low_skill:3,jobs_med_skill:2},pU:-2,wU:-1,pol:0.5,m:5,gI_types:{goods_basic:2},taxMod:0.05,ui:{ic:'ğŸª'}},CZONE_MD_L1:{n:"è´­ç‰©è¡—",c:1000,t:'zone',cat:'commercial',density:'MED',lvl:1,jS_types:{jobs_low_skill:10,jobs_med_skill:15,jobs_high_skill:5},pU:-12,wU:-5,pol:2.5,m:25,gI_types:{goods_basic:8,goods_varied:7},taxMod:0.1,ui:{ic:'ğŸ¬'},reqTech:['ZONING_MED_DENSITY']},IZONE_LD_L1:{n:"è½»å·¥å‚",c:250,t:'zone',cat:'industrial',density:'LOW',lvl:1,jS_types:{jobs_low_skill:6,jobs_med_skill:2},gO_types:{goods_basic:10},pU:-5,wU:-2,pol:3,m:8,rmIn_types:{WOOD:1,STONE:1},ui:{ic:'ğŸ› ï¸'}},OFFICE_LD_L1:{n:"å°å‹åŠå…¬å®¤",c:600,t:'zone',cat:'office',density:'LOW',lvl:1,jS_types:{jobs_med_skill:10,jobs_high_skill:5},pU:-5,wU:-1,pol:0.2,m:20,ui:{ic:'ğŸ¢'}},QUARRY_STONE:{n:"é‡‡çŸ³åœº",c:1500,t:'extractor',cat:'industrial',rmType:'STONE',outBase:10,pU:-20,m:80,pol:8,ui:{ic:'â›ï¸'}},COAL_MINE:{n:"ç…¤çŸ¿",c:1800,t:'extractor',cat:'industrial',rmType:'COAL',outBase:12,pU:-22,m:90,pol:10,ui:{ic:'âš’ï¸'}},LUMBER_MILL:{n:"ä¼æœ¨åœº",c:1200,t:'extractor',cat:'industrial',rmType:'WOOD',outBase:15,pU:-15,m:60,pol:4,ui:{ic:'ğŸŒ²ğŸªš'}},OIL_WELL:{n:"æ²¹äº•",c:2500,t:'extractor',cat:'industrial',rmType:'OIL',outBase:5,pU:-25,m:120,pol:12,ui:{ic:'ğŸ›¢ï¸'}},FARM_SMALL:{n:"å°å‹å†œåœº",c:1000,t:'extractor',cat:'agricultural',rmType:'FARM',outBase:20,pU:-5,wU:-5,m:40,pol:1,ui:{ic:'ğŸŒ¾'}},CONCRETE_PLANT:{n:"æ··å‡åœŸå‚",c:2000,t:'processor',cat:'industrial',inputs:{STONE:2},gO_types:{CONSTRUCTION_MATERIALS:15},pU:-30,m:100,pol:10,jS_types:{jobs_low_skill:15,jobs_med_skill:5},ui:{ic:'ğŸ§±ğŸ­'}},FURNITURE_FACTORY:{n:"å®¶å…·å‚",c:1800,t:'processor',cat:'industrial',inputs:{WOOD:2},gO_types:{goods_varied:12},pU:-25,m:90,pol:8,jS_types:{jobs_low_skill:12,jobs_med_skill:6},ui:{ic:'ğŸ›‹ï¸ğŸ­'}},PWR_COAL:{n:"ç‡ƒç…¤ç”µå‚",c:3000,t:'utility',cat:'power',out:100,pol:20,m:100,fuelIn:{COAL:2},ui:{ic:'ğŸ’¨'}},WAT_TOWER:{n:"æ°´å¡”",c:1500,t:'utility',cat:'water',out:50,pU:-5,m:50,ui:{ic:'ğŸ’§'}},SCHOOL_E:{n:"å°å­¦",c:2500,t:'service',cat:'education',sC:200,pU:-10,m:150,s_b:1,eduBoost:.05,sR:5,ui:{ic:'ğŸ«'}},CLINIC_S:{n:"è¯Šæ‰€",c:2000,t:'service',cat:'health',sC:150,pU:-8,m:120,s_b:1,healthBoost:.1,sR:4,ui:{ic:'ğŸ¥'}},FIRE_S:{n:"æ¶ˆé˜²ç«™",c:1800,t:'service',cat:'safety',sC:1,pU:-5,m:100,fireRiskRed:.1,sR:4,ui:{ic:'ğŸš’'}},POLICE_S:{n:"è­¦å±€",c:1800,t:'service',cat:'safety',sC:1,pU:-5,m:100,crimeRed:.1,sR:4,ui:{ic:'ğŸš“'}},LANDFILL:{n:"åƒåœ¾å¡«åŸ‹åœº",c:3000,t:'utility',cat:'garbage',sC:5000,pU:-10,m:150,pol:15,rR:3,ui:{ic:'ğŸ—‘ï¸'}},BUS_DEPOT:{n:"å…¬äº¤æ€»ç«™",c:4000,t:'service',cat:'transport',sC:.2,pU:-15,m:200,trafficRed:.1,s_b:1,sR:6,reqTech:['PUBLIC_TRANSIT'],ui:{ic:'ğŸšŒ'}},PARK_S:{n:"å°å‹å…¬å›­",c:300,t:'service',cat:'recreation',s_b:2,e_b:1,sR:3,m:5,ui:{ic:'ğŸŒ³'}},MAYOR_STATUE:{n:"å¸‚é•¿é›•åƒ",c:5000,t:'special',cat:'landmark',s_b:5,sR:5,m:10,unique:true,ui:{ic:'ğŸ—¿'}},BANK:{n:"é“¶è¡Œ",c:8000,t:'service',cat:'finance',jS_types:{jobs_high_skill:20},pU:-15,m:250,s_b:1,eff:{loanInterestRateMod:-0.005,comRevenueModNearby:0.05},sR:6,reqTech:['BANKING'],ui:{ic:'ğŸ¦'}}};
        const TECHS={ZONING_MED_DENSITY:{n:"ä¸­å¯†åº¦è§„åˆ’",c:100,t:8,pre:[],eff:{unlockZoneDensity:['MED'],unlock:['RZONE_MD_L1','CZONE_MD_L1']}},ZONING_HIGH_DENSITY:{n:"é«˜å¯†åº¦è§„åˆ’",c:250,t:15,pre:['ZONING_MED_DENSITY','URBAN_PLANNING'],eff:{unlockZoneDensity:['HIGH'],unlock:['RZONE_HD_L1','CZONE_HD_L1']}},ADV_EDUCATION:{n:"é«˜ç­‰æ•™è‚²",c:150,t:10,pre:['URBAN_PLANNING'],eff:{unlock:['HIGH_SCHOOL','UNIVERSITY'],global:{workerQualityBonus:0.05}}},MEDICAL_RESEARCH:{n:"åŒ»ç–—ç ”ç©¶",c:180,t:12,pre:['ADV_EDUCATION'],eff:{unlock:['HOSPITAL'],global:{healthBonus:5}}},PUBLIC_TRANSIT:{n:"å…¬å…±äº¤é€š",c:200,t:12,pre:['URBAN_PLANNING'],eff:{unlock:['BUS_DEPOT','METRO_STATION'],global:{trafficIndexMod:-0.05}}},WASTE_MANAGEMENT:{n:"åºŸç‰©ç®¡ç†",c:80,t:6,pre:[],eff:{unlock:['RECYCLING_CENTER'],modify:{type:'building',target:'LANDFILL',prop:'pol',val:0.8,mode:'mul'}}},BANKING:{n:"é“¶è¡Œä¸š",c:300,t:15,pre:['COMMERCE_BASICS'],eff:{unlock:['BANK'],global:{loanInterestRateMod:-0.01}}},ADV_INDUSTRIAL_TECH:{n:"å…ˆè¿›å·¥ä¸šæŠ€æœ¯",c:220,t:14,pre:['INDUSTRIAL_PROCESSES'],eff:{global:{industrialOutputMod:0.1,industrialPollutionMod:-0.05}}},CONSTRUCTION_BASICS:{n:"åŸºç¡€å»ºç­‘å­¦",c:50,t:5,pre:[],eff:{global:{buildCostModRes:-0.05}}},COMMERCE_BASICS:{n:"åŸºç¡€å•†ä¸šå­¦",c:60,t:6,pre:[],eff:{global:{taxModCom:0.01}}},INDUSTRIAL_PROCESSES:{n:"å·¥ä¸šæµç¨‹ä¼˜åŒ–",c:70,t:7,pre:[],eff:{global:{goodsOutputModInd:0.05}}},URBAN_PLANNING:{n:"åŸå¸‚è§„åˆ’",c:120,t:12,pre:['CONSTRUCTION_BASICS','COMMERCE_BASICS'],eff:{global:{taxBonus:0.02,landValueBoost:0.05}}}};
        const POLICIES={TAX_HIKE_RES:{n:"æé«˜ä½å®…ç¨",desc:"ä½å®…ç¨ç‡+2%",eff:{type:'tax_change',target:'res',val:2,mode:'add'},satisImpact:-3,active:false},FREE_PUBLIC_TRANSPORT:{n:"å…è´¹å…¬äº¤",desc:"äº¤é€šå‹åŠ›-15%,æ»¡æ„åº¦+5,æ¯æ—¥é«˜é¢æˆæœ¬",eff:{global:{trafficIndexMod:-0.15,satisfactionMod:5}},costPerDay:500,active:false,reqTech:['PUBLIC_TRANSIT']},POWER_SAVING:{n:"èŠ‚èƒ½å€¡è®®",desc:"ç”µåŠ›æ¶ˆè€—-10%,å·¥ä¸šäº§å‡ºç•¥é™",eff:{global:{powerDemandMod:-0.1,industrialOutputMod:-0.02}},costPerDay:20,active:false},EDUCATION_GRANTS:{n:"æ•™è‚²è¡¥è´´",desc:"æ•™è‚²æ°´å¹³æå‡åŠ é€Ÿ,æ•™è‚²å»ºç­‘æˆæœ¬å¢åŠ ",eff:{global:{educationProgressSpeed:1.2,educationBuildingCostMod:0.1}},costPerDay:100,active:false,reqTech:['ADV_EDUCATION']}};
        const DISTRICT_SPECIALIZATIONS={GENERIC:{n:"é€šç”¨åŒº",desc:"æ— ç‰¹å®šåŠ æˆã€‚",effects:{}},FINANCIAL:{n:"é‡‘èåŒº",desc:"+20%åŠå…¬ç¨,åŠå…¬æ¥¼è¿è¥æˆæœ¬-10%",effects:{taxModOffice:0.2,officeCostMod:-0.1},reqTech:['BANKING']},TOURISM:{n:"æ—…æ¸¸åŒº",desc:"+15%å•†ä¸šæ”¶å…¥,å¸å¼•æ¸¸å®¢",effects:{comRevenueMod:0.15,tourismAttraction:10},reqTech:['HOSPITALITY']}};
        const MAYOR_ACTIONS={SPEECH_INSPIRING:{n:"é¼“èˆæ¼”è®²",desc:"å…¨å¸‚æ»¡æ„åº¦+5%(3å¤©)",c:1000,eff:{type:'timed_boost',target:'avgSatisfaction',val:5,dur:3,advisorEnergyCost:10}},EMERGENCY_LOAN_SMALL:{n:"å°å‹ç´§æ€¥è´·æ¬¾",desc:"è·å¾—5000èµ„é‡‘,åˆ©ç‡5%,10å¤©åè¿˜æœ¬ä»˜æ¯",c:0,loanAmount:5000,interestRate:0.05,termDays:10,eff:{type:'loan'},advisorEnergyCost:0},FEED_ADVISOR:{n:"å–‚é£Ÿé¡¾é—®",desc:"é¡¾é—®ç²¾åŠ›+50,å¿«ä¹+20(éœ€1é›¶é£Ÿ)",c:0,eff:{type:'advisor_feed'},unlockReq:{item:'SPECIAL_SNACKS',qty:1},advisorEnergyCost:0}};

        // --- Initialize & Event Listeners ---
        document.addEventListener('DOMContentLoaded',()=>{document.getElementById('profile-pic').src=CONFIG.PROFILE_PIC_PATH;Chart.defaults.font.family="'Noto Sans SC',sans-serif";Chart.defaults.font.size=12;setupEventListeners();initVFX();loadAndProcessPetData();setupThemeEngine();initMouseBunny();initCitySim();lastFrameTime=performance.now();requestAnimationFrame(animationLoop);setInterval(updateAdvisorBunny,5000);});
        function setupEventListeners(){window.addEventListener('pointermove',e=>{mouse.lastX=mouse.x;mouse.x=e.clientX;mouse.y=e.clientY;mouse.dx=mouse.x-mouse.lastX;docEl.style.setProperty('--mouse-x',`${e.clientX}px`);docEl.style.setProperty('--mouse-y',`${e.clientY}px`);});window.addEventListener('resize',()=>{[mouseTrailCanvas,vfxCanvas].forEach(c=>{c.width=window.innerWidth;c.height=window.innerHeight;});renderPopulationChart();if(weightRecords.length>0)renderWeightChart();});window.addEventListener('pointerdown',e=>{createClickRipple(e.clientX,e.clientY);initAudio();});avatarContainer.addEventListener('pointerdown',handleAvatarClick);mainTitleArea.addEventListener('click',handleTitleClickForGodMode);document.getElementById('font-toggle-button').addEventListener('click',toggleFont);document.getElementById('prev-theme-page').addEventListener('click',()=>changeThemePage(-1));document.getElementById('next-theme-page').addEventListener('click',()=>changeThemePage(1));document.getElementById('custom-color-input').addEventListener('change',applyCustomColorOrGodModeKey);document.getElementById('sim-next-day-button').addEventListener('click',advanceDay);document.getElementById('sim-save-button').addEventListener('click',saveCity);document.getElementById('sim-load-button').addEventListener('click',loadCity);document.getElementById('log-toggle-city').addEventListener('click',()=>toggleLogView('city'));document.getElementById('log-toggle-pet').addEventListener('click',()=>toggleLogView('pet'));}
        
        // --- Core Animation Loop & Basic VFX ---
        function animationLoop(cT){const dT=cT-lastFrameTime;lastFrameTime=cT;vfxCtx.clearRect(0,0,vfxCanvas.width,vfxCanvas.height);updateAndDrawCosmicDust();updateAndDrawClickRipples();updateAndDrawForceParticles();updateAndDrawMouseBunny();updateAndDrawCelestialParticles(vfxCtx);frameCount++;if(cT-lastPerfUpdateTime>500){updatePerfPanel(cT);}requestAnimationFrame(animationLoop);}
        function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
        function playSound(type,opts={}){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);let d=1;o.type=opts.w||'sine';g.gain.setValueAtTime(opts.v||.1,audioCtx.currentTime);o.frequency.setValueAtTime(opts.fS||440,audioCtx.currentTime);if(type==='dissolve'){o.type='sawtooth';o.frequency.setValueAtTime(1500,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(50,audioCtx.currentTime+3);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+3);d=3;}else if(type==='rebuild'){o.type='sine';o.frequency.setValueAtTime(80,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(2500,audioCtx.currentTime+4);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+4.2);d=4.2;}else if(type==='confirm'){o.frequency.setValueAtTime(600,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.1);d=.1;}else if(type==='build'){o.type='square';o.frequency.setValueAtTime(200,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(300,audioCtx.currentTime+.1);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.2);d=.2;}else if(type==='error'){o.type='sawtooth';o.frequency.setValueAtTime(400,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(100,audioCtx.currentTime+.3);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.3);d=.3;}else if(type==='special'){o.type='triangle';o.frequency.setValueAtTime(800,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(1600,audioCtx.currentTime+.15);o.frequency.linearRampToValueAtTime(400,audioCtx.currentTime+.3);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.4);d=.4;}else if(type==='milestone'){o.type='sine';o.frequency.setValueAtTime(523.25,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(1046.5,audioCtx.currentTime+.3);g.gain.setValueAtTime(.15,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.5);d=.5;}else if(type==='godmode'){o.type='sawtooth';o.frequency.setValueAtTime(130.81,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(261.63,audioCtx.currentTime+.1);g.gain.setValueAtTime(.2,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.2);d=.2;}o.start();o.stop(audioCtx.currentTime+d);}
        function initVFX(){[vfxCanvas,mouseTrailCanvas].forEach(c=>{c.width=window.innerWidth;c.height=window.innerHeight;});for(let i=0;i<CONFIG.COSMIC_DUST_COUNT;i++){cosmicDust.push({x:Math.random()*vfxCanvas.width,y:Math.random()*vfxCanvas.height,z:Math.random()*1e3,vx:(Math.random()-.5)*.1,vy:(Math.random()-.5)*.1,s:Math.random()*1.5+.5});}}
        function updateAndDrawCosmicDust(){vfxCtx.fillStyle=`rgba(var(--text-color-rgb),.5)`;cosmicDust.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=vfxCanvas.width;if(p.x>vfxCanvas.width)p.x=0;if(p.y<0)p.y=vfxCanvas.height;if(p.y>vfxCanvas.height)p.y=0;vfxCtx.beginPath();vfxCtx.arc(p.x,p.y,p.s,0,Math.PI*2);vfxCtx.fill();});}
        function createClickRipple(x,y){clickRipples.push({x,y,r:0,mR:60,l:1});}
        function updateAndDrawClickRipples(){clickRipples=clickRipples.filter(r=>r.l>0);clickRipples.forEach(r=>{r.r=(1-r.l)*r.mR;r.l-=.04;vfxCtx.strokeStyle=`rgba(var(--accent-rgb),${r.l})`;vfxCtx.lineWidth=2;vfxCtx.beginPath();vfxCtx.arc(r.x,r.y,r.r,0,Math.PI*2);vfxCtx.stroke();});}
        function createForceBurst(count,x,y,colorOverride=null,speedMod=1,sizeMod=1){const rect=avatarContainer.getBoundingClientRect();x=x||rect.left+rect.width/2;y=y||rect.top+rect.height/2;for(let i=0;i<count;i++){const a=Math.random()*Math.PI*2,s=(Math.random()*8+4)*speedMod;forceParticles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,l:1,sz:(Math.random()*4+2)*sizeMod,c:colorOverride||(Math.random()>.3?`var(--glow-rgb)`:Math.random()>.5?`var(--accent-rgb)`:`255,255,255`)});}}
        function updateAndDrawForceParticles(){forceParticles=forceParticles.filter(p=>p.l>0);forceParticles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=.97;p.vy*=.97;p.vy+=.05;p.l-=.015;const clr=p.c.startsWith('var')?getComputedStyle(docEl).getPropertyValue(p.c.slice(4,-1)).trim():p.c;vfxCtx.fillStyle=`rgba(${clr},${p.l*p.l})`;vfxCtx.beginPath();vfxCtx.arc(p.x,p.y,Math.max(0,p.sz*p.l),0,Math.PI*2);vfxCtx.fill();});}
        function initMouseBunny(){for(let i=0;i<CONFIG.MOUSE_SNAKE_LENGTH;i++){mouseSnake.push({x:mouse.x,y:mouse.y});}}
        function updateAndDrawMouseBunny(){mouseTrailCtx.clearRect(0,0,mouseTrailCanvas.width,mouseTrailCanvas.height);let h={...mouseSnake[0]};h.x+=(mouse.x-h.x)*.25;h.y+=(mouse.y-h.y)*.25;mouseSnake.unshift(h);if(mouseSnake.length>CONFIG.MOUSE_SNAKE_LENGTH)mouseSnake.pop();const gR=getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim(),aR=getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim();for(let i=1;i<mouseSnake.length;i++){const gr=mouseTrailCtx.createLinearGradient(mouseSnake[i-1].x,mouseSnake[i-1].y,mouseSnake[i].x,mouseSnake[i].y);const op=1-(i/mouseSnake.length);gr.addColorStop(0,`rgba(${gR},${op*.8})`);gr.addColorStop(1,`rgba(${aR},${op*.8})`);mouseTrailCtx.strokeStyle=gr;mouseTrailCtx.lineWidth=1+(mouseSnake.length-i)*.15;mouseTrailCtx.beginPath();mouseTrailCtx.moveTo(mouseSnake[i-1].x,mouseSnake[i-1].y);mouseTrailCtx.lineTo(mouseSnake[i].x,mouseSnake[i].y);mouseTrailCtx.stroke();}mouseBunnyEl.style.left=`${h.x}px`;mouseBunnyEl.style.top=`${h.y}px`;if(mouse.dx!==0)mouseBunnyEl.style.transform=`translate(-50%,-50%) scaleX(${mouse.dx>0?1:-1})`;}
        
        // --- AVATAR EFFECT (Taijitu & Granzort) ---
        function handleAvatarClick(){if(avatarState==='normal'){dissolveAvatar();}}
        function dissolveAvatar() { if(avatarState!=='normal')return;avatarState='animating';currentAvatarEffect=(currentAvatarEffect+1)%CONFIG.AVATAR_EFFECT_PRESETS; const pic=document.getElementById('profile-pic');pic.style.opacity='0'; const rect=avatarContainer.getBoundingClientRect(),cX=rect.left+rect.width/2,cY=rect.top+rect.height/2; celestialParticles=[]; let dur1=1500,dur2=8000,dur3=3000,endTime=dur1+dur2+dur3+500; playSound('dissolve',{v:.2,fS:1800,fE:100,d:(dur1+dur2)/1000}); const taijiColors=[`rgb(var(--text-color-rgb))`,`rgb(var(--bg-color))`],carrotOrange='255,140,0',bunnyPink='255,182,193'; for(let i=0;i<2;i++){for(let j=0;j<80;j++){const ang=Math.PI*i+j/80*Math.PI;const r=20+j*0.7;celestialParticles.push({x:cX,y:cY,r,a:ang,s:2,c:taijiColors[i],st:'taiji_form',l:1,sp:(Math.random()-.5)*.005,tEnd:dur1,startTime:performance.now()});}} for(let i=0;i<2;i++){celestialParticles.push({x:cX+(i===0?1:-1)*35,y:cY,s:25,txt:(i===0?'ğŸ°':'ğŸ¥•'),c:(i===0?bunnyPink:carrotOrange),st:'taiji_eye',l:1,tEnd:dur1+dur2,rot:0,rotSpd:(i===0?0.02:-0.02),startTime:performance.now()});} const baGuaSymbols=['â˜°','â˜±','â˜²','â˜³','â˜´','â˜µ','â˜¶','â˜·'];for(let i=0;i<8;i++){const ang=i/8*Math.PI*2-Math.PI/8;celestialParticles.push({x:cX+Math.cos(ang)*80,y:cY+Math.sin(ang)*80,s:18,txt:baGuaSymbols[i],c:'gold',st:'taiji_bagua',l:0,fadeInEnd:dur1/2,holdEnd:dur1,tEnd:dur1+dur2/2,startTime:performance.now(),lastUpdateTime:performance.now()});} setTimeout(()=>{ playSound('special',{v:.3,fS:200,fE:1200,d:dur2/1000}); celestialParticles.filter(p=>p.st==='taiji_form'||p.st==='taiji_swirl'||p.st==='taiji_bagua').forEach(p=>p.st='granzort_expand'); const G_SYMBOLS=['è¼','åŠ›','é€Ÿ','Î±','Î²','Î³','Î´','Î©']; let g_rad=90; for(let i=0;i<5;i++){for(let j=0;j<24+i*8;j++){ const ang=j/(24+i*8)*Math.PI*2; celestialParticles.push({x:cX,y:cY,r:g_rad+i*20,a:ang,s:1.2+i*0.15,c:`hsla(${160+i*25+Math.random()*20},90%,75%,.6)`,st:'granzort_form',l:1,sp:(.0015+.0008*i)*(i%2===0?1:-1),tEnd:dur2,maxR:g_rad+(4*20)+30,startTime:performance.now()});}} for(let i=0;i<8;i++){ const ang=i/8*Math.PI*2+Math.PI/16; celestialParticles.push({x:cX+Math.cos(ang)*160,y:cY+Math.sin(ang)*160,s:18,txt:G_SYMBOLS[i],c:'cyan',st:'granzort_rune',l:1,tEnd:dur2,origR:160,origA:ang,startTime:performance.now()});} celestialParticles.filter(p=>p.st==='taiji_eye').forEach(p=>{p.st='granzort_center_swirl';p.tEnd=dur2;p.targetR=p.txt==='ğŸ°'?15:45;p.swirlSpd=p.txt==='ğŸ°'?0.05:-0.03;}); },dur1); setTimeout(()=>{ playSound('rebuild',{v:.25,fS:100,fE:2000,d:dur3/1000}); celestialParticles.forEach(p=>p.st='converging'); },dur1+dur2); setTimeout(()=>{celestialParticles=[];pic.style.opacity='1';avatarState='normal';createForceBurst(120,cX,cY,null,1.8,1.8);},endTime); }
        function updateAndDrawCelestialParticles(ctx){if(celestialParticles.length===0)return;const rect=avatarContainer.getBoundingClientRect(),cX=rect.left+rect.width/2,cY=rect.top+rect.height/2;let now=performance.now();celestialParticles=celestialParticles.filter(p=>p.l>0);celestialParticles.forEach(p=>{p.l-=.0004;p.a+=(p.sp||0);p.rot+=(p.rotSpd||0); switch(p.st){case 'taiji_form':p.r*=.985;p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='taiji_swirl';break;case 'taiji_swirl':p.r=Math.max(2,p.r*.97);p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;break;case 'taiji_eye':p.r=35;p.x=cX+Math.cos(p.a+(p.txt==='ğŸ°'?0:Math.PI))*p.r;p.y=cY+Math.sin(p.a+(p.txt==='ğŸ°'?0:Math.PI))*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='fade_out';break;case 'taiji_bagua':if(p.l<1&&now<(p.startTime+(p.fadeInEnd||0))){p.l=Math.min(1,(now-(p.startTime||0))/(p.fadeInEnd||1));}else if(now>(p.startTime+(p.holdEnd||0))){p.l=Math.max(0,1-(now-(p.startTime+(p.holdEnd||0)))/((p.tEnd||0)-(p.holdEnd||0)));}p.s=18*p.l;break;case 'granzort_expand':p.r*=1.03;p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;p.l*=.985;if(p.r>(p.maxR||350))p.l=0;break;case 'granzort_form':p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='fade_out';break;case 'granzort_rune':p.r=p.origR*(1-Math.sin(Math.PI*(1-p.l/1)));p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='fade_out';p.s=18*p.l;break;case 'granzort_center_swirl':p.r+=(p.targetR-p.r)*.05;p.a+=p.swirlSpd;p.x=cX+Math.cos(p.a)*p.r;p.y=cY+Math.sin(p.a)*p.r;if(now>(p.startTime+(p.tEnd||0)))p.st='fade_out';p.s=Math.max(10,p.s*.99);break;case 'converging':p.x+=(cX-p.x)*.1;p.y+=(cY-p.y)*.1;p.s*=.92;p.l*=.97;break;case 'fade_out':p.l*=.85;break;} p.lastUpdateTime=now; ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.globalAlpha=Math.max(0,Math.min(1,p.l*p.l));if(p.txt){ctx.font=`${Math.max(1,p.s)}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle=p.c||`rgb(var(--text-color-rgb))`;ctx.fillText(p.txt,0,0);}else{ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,Math.max(.5,p.s),0,Math.PI*2);ctx.fill();}ctx.restore();});ctx.globalAlpha=1;}
        
        // --- Advisor Bunny (Integrated into City Sim) & City Sim Core ---
        function updateAdvisorBunny(){advisorBunny.energy=Math.max(0,advisorBunny.energy-.5*(city.population/10000+1||1));advisorBunny.happiness=Math.max(20,advisorBunny.happiness-.2*(1+(50-(city.avgSatisfaction||50))/100));if(simEls.bs)simEls.bs.textContent=advisorBunny.energy<30?'ç–²æƒ«':(advisorBunny.happiness<40?'ä¸æ‚¦':'è‰¯å¥½');if(advisorBunny.energy<20&&city.day-(advisorBunny.lastFed||-10)>5){logCityEvent("æç¤º: åŸå¸‚é¡¾é—®Bunnyçœ‹èµ·æ¥ç²¾ç–²åŠ›å°½ï¼Œè€ƒè™‘åœ¨'å¸‚é•¿è¡ŒåŠ¨'ä¸­å–‚é£Ÿå®ƒã€‚","system");advisorBunny.lastFed=city.day;}if(city.timedBoosts&&city.timedBoosts.some(b=>b.source==='advisor_speech'&&b.remainingDays>0))advisorBunny.happiness=Math.min(100,advisorBunny.happiness+.5);}
        function handleMayorAction_FeedAdvisor(){if(city.inventory.SPECIAL_SNACKS>0&&advisorBunny.energy<100){city.inventory.SPECIAL_SNACKS--;advisorBunny.energy=Math.min(100,advisorBunny.energy+50);advisorBunny.happiness=Math.min(100,advisorBunny.happiness+20);advisorBunny.lastFed=city.day;logCityEvent("é¡¾é—®Bunnyäº«ç”¨äº†ç‰¹æ®Šé›¶é£Ÿï¼Œç²¾åŠ›å……æ²›ï¼","action");playSound('special');}else if(city.inventory.SPECIAL_SNACKS<=0){logCityEvent("æ²¡æœ‰ç‰¹æ®Šé›¶é£Ÿæ¥å–‚é¡¾é—®Bunnyã€‚","error");}else{logCityEvent("é¡¾é—®Bunnyç²¾åŠ›å……æ²›ï¼Œç°åœ¨ä¸æƒ³åƒã€‚","info");}updateAdvisorBunny();renderMayorActionsPanel();}
        function initCitySim(){const sS=localStorage.getItem(CONFIG.CITY_SAVE_KEY);if(sS&&!godModeActive){try{const lc=JSON.parse(sS);city=validateLoadedCity(lc);logCityEvent("ä»æµè§ˆå™¨åŠ è½½å­˜æ¡£æˆåŠŸï¼","system");}catch(e){console.error("åŠ è½½åŸå¸‚å­˜æ¡£å¤±è´¥:",e);generateNewCityState();logCityEvent("å­˜æ¡£æŸåï¼Œå·²é‡ç½®ä¸ºæ–°åŸå¸‚ã€‚","error");}}else{generateNewCityState();if(!godModeActive) logCityEvent(`æ¬¢è¿æ¥åˆ° ${city.name}ï¼Œå¸‚é•¿ï¼æ–°çš„åŸå¸‚ç­‰å¾…æ‚¨çš„è§„åˆ’ã€‚`,'system'); else logCityEvent("ä¸Šå¸æ¨¡å¼å·²æ¿€æ´»ï¼Œå¼€å§‹æ–°æ¸¸æˆã€‚","godmode");}initCitySimAfterLoad();}
        function generateNewCityState(){const nameSuffix=Math.floor(Math.random()*900)+100; city={id:`city_${Date.now()}_${nameSuffix}`,name:"å…”å…‹å¸‚"+nameSuffix,day:1,year:1,funds:20000+Math.floor(Math.random()*15000),population:0,maxPopulation:0,avgSatisfaction:60+Math.floor(Math.random()*15),environmentQuality:70+Math.floor(Math.random()*15),researchPoints:20+Math.floor(Math.random()*30),powerCapacity:0,powerDemand:0,waterCapacity:0,waterDemand:0,goodsProducedByType:{},goodsDemandByType:{},rawMaterialsStock:{STONE:50,WOOD:50,OIL:20,ORE:30,FARM:60,COAL:40},jobsAvailableBySkill:{jobs_low_skill:0,jobs_med_skill:0,jobs_high_skill:0},workforceBySkill:{jobs_low_skill:0,jobs_med_skill:0,jobs_high_skill:0},unemployed:0,taxRate:{res:9,com:10,ind:8,office:11},budget:{services:100,education:100,health:100,safety:100,transport:100,garbage:100,maintenance:100},zones:[],buildings:[],activePolicies:{},unlockedTech:[],unlockedZoneDensities:['LOW'],eventLog:[],populationHistory:[{d:0,p:0}],landValueGrid:createGrid(10,50),trafficIndex:10,crimeRate:5,fireRisk:5,healthIndex:70,educationIndex:0.1,pollutionGrid:createGrid(10,0),garbageAccumulated:0,garbageCapacity:0,timedBoosts:[],inventory:{SPECIAL_SNACKS:3},cityLevel:1,cityXP:0,cityXPNext:100,districts:[],mapSeed:Math.random(),trade:{exportVal:0,importVal:0,routes:[]},loans:[]};Object.values(GOODS_TYPES).forEach(gtn => { city.goodsProducedByType[gtn] = 0; city.goodsDemandByType[gtn] = 0; }); }
        function createGrid(size,val){return Array(size).fill(null).map(()=>Array(size).fill(val));}
        function validateLoadedCity(lc){const dc=generateNewCityState();for(const k in dc){if(lc[k]===undefined||(typeof lc[k]==='object'&&lc[k]===null&&typeof dc[k]==='object'&&dc[k]!==null)){lc[k]=JSON.parse(JSON.stringify(dc[k]));}else if(typeof dc[k]==='object'&&dc[k]!==null&&!Array.isArray(dc[k])){if(typeof lc[k]!=='object'||lc[k]===null)lc[k]=JSON.parse(JSON.stringify(dc[k]));else for(const sk in dc[k]){if(lc[k][sk]===undefined)lc[k][sk]=dc[k][sk];}}}return lc;}
        function advanceDay(){ city.day++;let milestoneReached=false;if(city.day>30){city.day=1;city.year++;if(city.year%2===0&&city.inventory.SPECIAL_SNACKS<5){city.inventory.SPECIAL_SNACKS++;logCityEvent("å¹´åº¦é¢„ç®—åŒ…å«é¡¾é—®å…”é›¶é£Ÿ!","system");}Object.values(RAW_MATERIALS_TYPES).forEach(rt=>city.rawMaterialsStock[rt.n]=(city.rawMaterialsStock[rt.n]||0)+Math.floor(Math.random()*5));city.loans.forEach(l=>{if(l.remainingTerm>0){l.remainingTerm--;city.funds-=l.paymentPerDay;if(l.remainingTerm===0)logCityEvent(`è´·æ¬¾ ${l.id.substring(0,5)} å·²è¿˜æ¸…ï¼`,'finance');}});city.loans=city.loans.filter(l=>l.remainingTerm>0);}city.timedBoosts=city.timedBoosts.filter(b=>{b.remainingDays--;if(b.remainingDays<=0)logCityEvent(`${b.target}æ•ˆæœç»“æŸã€‚`,'info');return b.remainingDays>0;});let dInc=0,dExp=0,pollutionToday=0,eduCap=0,healthCap=0,fireStations=0,policeStations=0,garbageCapacityToday=0,rawMatProdToday={},rawMatConsToday={},jobDemandBySkill={low:0,med:0,high:0};Object.keys(RAW_MATERIALS_TYPES).forEach(k=>{rawMatProdToday[k]=0;rawMatConsToday[k]=0;});Object.values(GOODS_TYPES).forEach(gtn=>{city.goodsProducedByType[gtn]=0;city.goodsDemandByType[gtn]=0;});
            city.powerDemand=0;city.powerCapacity=0;city.waterDemand=0;city.waterCapacity=0;city.maxPopulation=0;city.jobsAvailableBySkill={jobs_low_skill:0,jobs_med_skill:0,jobs_high_skill:0};
            let totalMaintenanceModifier=(city.budget.maintenance||100)/100;
            city.buildings.forEach(b=>{const bd=BUILDINGS[b.id];if(!bd) return; const densityMod=bd.density?ZONE_DENSITY[bd.density].mod:1;let serviceBudgetMod=(bd.cat&&city.budget[BUILDING_CATEGORIES[bd.cat]?.toLowerCase()]||100)/100;if(bd.m)dExp+=bd.m*densityMod*serviceBudgetMod*totalMaintenanceModifier;city.powerDemand+=(bd.pU||0)*densityMod;if(bd.out&&bd.cat==='power')city.powerCapacity+=bd.out*serviceBudgetMod;city.waterDemand+=(bd.wU||0)*densityMod;if(bd.out&&bd.cat==='water')city.waterCapacity+=bd.out*serviceBudgetMod;if(bd.cap)city.maxPopulation+=bd.cap*densityMod;if(bd.gO_types){Object.entries(bd.gO_types).forEach(([type,amt])=>city.goodsProducedByType[type]=(city.goodsProducedByType[type]||0)+amt*densityMod*serviceBudgetMod*(1+city.educationIndex*.2));}if(bd.gI_types){Object.entries(bd.gI_types).forEach(([type,amt])=>city.goodsDemandByType[type]=(city.goodsDemandByType[type]||0)+amt*densityMod);}if(bd.rmIn_types){Object.entries(bd.rmIn_types).forEach(([mat,qty])=>rawMatConsToday[mat]=(rawMatConsToday[mat]||0)+qty*densityMod);}if(bd.rmType&&bd.outBase)rawMatProdToday[bd.rmType]=(rawMatProdToday[bd.rmType]||0)+bd.outBase*densityMod*serviceBudgetMod;if(bd.jS_types){Object.entries(bd.jS_types).forEach(([skill,num])=>city.jobsAvailableBySkill[skill]=(city.jobsAvailableBySkill[skill]||0)+num*densityMod);}if(bd.pol)pollutionToday+=bd.pol*densityMod;if(bd.cat==='education'&&bd.sC)eduCap+=bd.sC*serviceBudgetMod;if(bd.cat==='health'&&bd.sC)healthCap+=bd.sC*serviceBudgetMod;if(bd.cat==='safety'&&(bd.id.includes('FIRE')))fireStations+=bd.sC*serviceBudgetMod;if(bd.cat==='safety'&&(bd.id.includes('POLICE')))policeStations+=bd.sC*serviceBudgetMod;if(bd.cat==='garbage'&&bd.sC)garbageCapacityToday+=bd.sC*serviceBudgetMod;});
            Object.keys(rawMatConsToday).forEach(mat=>{if(rawMatConsToday[mat]>0){const needed=rawMatConsToday[mat];const available=city.rawMaterialsStock[mat]||0;const consumed=Math.min(needed,available);city.rawMaterialsStock[mat]-=consumed;if(consumed<needed)Object.keys(city.goodsProducedByType).forEach(gk=>city.goodsProducedByType[gk]*=0.7);}});Object.keys(rawMatProdToday).forEach(mat=>city.rawMaterialsStock[mat]=(city.rawMaterialsStock[mat]||0)+rawMatProdToday[mat]);
            city.garbageAccumulated+=Math.floor(city.population*.15+city.buildings.filter(b=>BUILDINGS[b.id]?.cat==='industrial').length*8);let garbageProcessed=Math.min(city.garbageAccumulated,garbageCapacityToday);city.garbageAccumulated-=garbageProcessed;
            let landValueScore=50+city.buildings.reduce((acc,b)=>(acc+(BUILDINGS[b.id]?.lVMod||0)*200),0)/Math.max(1,city.buildings.length);landValueScore*=(1+(advisorBunny.happiness-50)/150-(city.garbageAccumulated/Math.max(100,city.population*2))*50);landValueScore=Math.max(5,Math.min(250,landValueScore));
            city.educationIndex=Math.min(1,eduCap/Math.max(1,city.population*.5));city.healthIndex=Math.min(100,50+(healthCap/Math.max(1,city.population*.6))*50);city.fireRisk=Math.max(0.5,10-fireStations*0.1-(city.unlockedTech.includes('FIRE_PREVENTION_PLANNING')?3:0));city.crimeRate=Math.max(0.5,10-policeStations*0.1-(city.unlockedTech.includes('NEIGHBORHOOD_WATCH')?3:0));
            city.workforceBySkill.jobs_low_skill=Math.floor(city.population*0.6*(1-city.educationIndex)*0.8);city.workforceBySkill.jobs_med_skill=Math.floor(city.population*0.6*city.educationIndex*0.6);city.workforceBySkill.jobs_high_skill=Math.floor(city.population*0.6*city.educationIndex*0.4);city.workforce=Object.values(city.workforceBySkill).reduce((s,v)=>s+v,0);let totalJobs=Object.values(city.jobsAvailableBySkill).reduce((s,v)=>s+v,0);city.unemployed=Math.max(0,city.workforce-totalJobs);
            let resTax=0,comTax=0,indTax=0,offTax=0;city.buildings.filter(b=>BUILDINGS[b.id]?.t==='zone').forEach(z=>{const zd=BUILDINGS[z.id];const densMod=ZONE_DENSITY[zd.density].mod;const popInZone=Math.min(zd.cap*densMod,city.population*0.25/(city.buildings.filter(x=>BUILDINGS[x.id]?.cat==='residential').length||1));const zoneLV=landValueScore*(1+(zd.lVMod||0));if(zd.cat==='residential')resTax+=popInZone*(city.taxRate.res/100)*.7*(zoneLV/100);else if(zd.cat==='commercial')comTax+=(zd.jS_types?Object.values(zd.jS_types).reduce((s,v)=>s+v,0):zd.jS)*densMod*(city.taxRate.com/100)*1.0*(zoneLV/100)*(Math.min(1,city.goodsProducedByType.goods_basic/(city.goodsDemandByType.goods_basic||1)));else if(zd.cat==='industrial')indTax+=(zd.jS_types?Object.values(zd.jS_types).reduce((s,v)=>s+v,0):zd.jS)*densMod*(city.taxRate.ind/100)*.8*((Object.values(city.rawMaterialsStock).reduce((s,v)=>s+v,0))>0?1:0.4);else if(zd.cat==='office')offTax+=(zd.jS_types?Object.values(zd.jS_types).reduce((s,v)=>s+v,0):zd.jS)*densMod*(city.taxRate.office/100)*1.1*(1+city.educationIndex*.5);});dInc=Math.floor(resTax+comTax+indTax+offTax);Object.keys(city.activePolicies).forEach(polKey=>{const p=POLICIES[polKey];if(p&&p.eff.global&&p.eff.global.taxBonusTotal)dInc*=(1+p.eff.global.taxBonusTotal);if(p&&p.costPerDay)dExp+=p.costPerDay;});city.funds+=dInc-dExp;city.cityXP+=Math.floor(dInc/150+city.population/80+Object.keys(city.unlockedTech).length*2);
            if(dInc>0)logCityEvent(`ç¨æ”¶:+${dInc}ğŸ’°`,'finance');if(dExp>0)logCityEvent(`ç»´æŠ¤è´¹:-${dExp}ğŸ’°`,'finance');
            if(city.cityXP>=city.cityXPNext){city.cityLevel++;city.cityXP-=city.cityXPNext;city.cityXPNext=Math.floor(city.cityXPNext*(1.4+city.cityLevel*0.05));logCityEvent(`åŸå¸‚å·²å‡çº§è‡³ ${city.cityLevel} çº§! è§£é”æ–°å†…å®¹ï¼`,'milestone');playSound('milestone');milestoneReached=true;Object.entries(BUILDINGS).forEach(([k,b])=>{if(b.reqLevel===city.cityLevel)logCityEvent(`æ–°å»ºç­‘å·²è§£é”: ${b.n}`,'unlock');});Object.entries(TECHS).forEach(([k,t])=>{if(t.reqLevel===city.cityLevel)logCityEvent(`æ–°ç§‘æŠ€å¯ç ”å‘: ${t.n}`,'unlock');});}
            let researchBoost=1+(city.activePolicies.ENCOURAGE_RD?0.25:0)+(city.educationIndex*0.2);researchBoost*=(advisorBunny.energy/100)*0.5+0.5; city.researchPoints+=city.buildings.reduce((acc,b)=>acc+(BUILDINGS[b.id]?.r_o||0),0)*researchBoost;if(city.currentResearch){city.currentResearch.daysLeft--;if(city.currentResearch.daysLeft<=0){const techKey=city.currentResearch.key;city.unlockedTech.push(techKey);logCityEvent(`ç§‘æŠ€ ${TECHS[techKey].n} ç ”å‘å®Œæˆ!`,'tech');delete city.currentResearch;renderTechTreePanel();milestoneReached=true;applyTechEffect(techKey);}}
            let pSufficient=city.powerCapacity>=city.powerDemand,wSufficient=city.waterCapacity>=city.waterDemand,jSufficient=city.unemployed<city.workforce*0.1,gbSufficient=garbageCapacityToday>=city.garbageAccumulated;let gSufficientTotal=true;Object.keys(city.goodsDemandByType).forEach(gk=>{if(city.goodsDemandByType[gk]>0 && city.goodsProducedByType[gk]<city.goodsDemandByType[gk]*0.8)gSufficientTotal=false;});
            let satisfChange=0;satisfChange+=(pSufficient?1.5:-4);satisfChange+=(wSufficient?1.5:-4);satisfChange+=(jSufficient?2.5:-5);satisfChange+=(gSufficientTotal?1.5:-2.5);satisfChange+=(gbSufficient?1:-3);satisfChange-=city.crimeRate/2.5;satisfChange-=city.fireRisk/2.5;satisfChange+=(city.healthIndex-60)/6;satisfChange+=(city.educationIndex-.08)*40;satisfChange-=city.trafficIndex/15;city.timedBoosts.forEach(b=>{if(b.target==='avgSatisfaction')satisfChange+=b.val;});satisfChange+=(advisorBunny.happiness-60)/8;Object.keys(city.activePolicies).forEach(polKey=>{const p=POLICIES[polKey];if(p){if(p.satisImpact)satisfChange+=p.satisImpact;if(p.satisImpactCom&&city.buildings.some(b=>BUILDINGS[b.id]?.cat==='commercial'))satisfChange+=p.satisImpactCom;}});
            city.avgSatisfaction=Math.max(0,Math.min(100,city.avgSatisfaction+satisfChange*.1-Math.random()*.8));
            let popGr=0;const immigrationFactor=Math.max(0,(city.avgSatisfaction-45)/20+(jSufficient?0.5:0)+(landValueScore-40)/80-(city.trafficIndex/50));const emigrationFactor=Math.max(0,(45-city.avgSatisfaction)/10+(!jSufficient?0.8:0)+(city.crimeRate/10));if(immigrationFactor>emigrationFactor&&city.population<city.maxPopulation){popGr=Math.floor(Math.max(1,city.population*.005*immigrationFactor)+(city.maxPopulation-city.population)*.01);}else if(city.population>0){popGr=-Math.floor(city.population*.008*emigrationFactor);}
            city.population=Math.max(0,Math.floor(city.population+popGr));
            if(popGr>0)logCityEvent(`äººå£å¢åŠ :+${popGr}ğŸ§‘â€ğŸ¤â€ğŸ§‘`,'info');else if(popGr<0)logCityEvent(`äººå£å‡å°‘:${popGr}ğŸ§‘â€ğŸ¤â€ğŸ§‘`,'warning');
            city.populationHistory.push({d:city.year*30+city.day,p:city.population});if(city.populationHistory.length>250)city.populationHistory.shift();
            city.environmentQuality=Math.max(0,Math.min(100,city.environmentQuality-(pollutionToday*.12)+(gbSufficient?0.6:-0.8)+.15+(advisorBunny.energy-30)/100 - (city.activePolicies.INDUSTRIAL_SUBSIDIES?2:0) + (city.activePolicies.GREEN_INITIATIVES?3:0) ));
            city.trafficIndex=Math.min(100,Math.max(0,(city.population/(Math.max(1,city.buildings.filter(b=>BUILDINGS[b.id]?.cat==='road'||BUILDINGS[b.id]?.t==='zone').length*350 + city.buildings.filter(b=>b.id==='BUS_DEPOT').length*1000)))*100-(city.unlockedTech.includes('TRAFFIC_AI_OPTIMIZATION')?25:0)-(city.activePolicies.FREE_PUBLIC_TRANSPORT&&POLICIES.FREE_PUBLIC_TRANSPORT.eff.global?POLICIES.FREE_PUBLIC_TRANSPORT.eff.global.trafficIndexMod*100:0) ));
            if(Math.random()<.1&&!milestoneReached){const dT=['FACTORY_FIRE','HEAT_WAVE','MAJOR_TRAFFIC_JAM','DISEASE_OUTBREAK_S','STOCK_MARKET_FLUCTUATION','METEORITE_SCARE','SINKHOLE_REPORTS'];const d=dT[Math.floor(Math.random()*dT.length)];handleDisaster(d);}
            updateCityUI();renderPopulationChart();playSound('confirm',{fS:300,fE:200,d:.1,v:.05});
        }
        function applyTechEffect(techKey){const tech=TECHS[techKey];if(!tech||!tech.eff)return;if(tech.eff.unlockZoneDensity)city.unlockedZoneDensities.push(...tech.eff.unlockZoneDensity);if(tech.eff.modify){if(tech.eff.modify.type==='building'){city.buildings.filter(b=>BUILDINGS[b.id]?.id===tech.eff.modify.target||BUILDINGS[b.id]?.cat===tech.eff.modify.target_cat).forEach(bInst=>{BUILDINGS[bInst.id][tech.eff.modify.prop]*=(tech.eff.modify.mode==='mul'?tech.eff.modify.val:1);BUILDINGS[bInst.id][tech.eff.modify.prop]+=(tech.eff.modify.mode==='add'?tech.eff.modify.val:0);});}logCityEvent(`${tech.n}æ•ˆæœå·²åº”ç”¨ã€‚`,'info');}if(tech.eff.global){logCityEvent(`${tech.n}å…¨å±€æ•ˆæœå·²åº”ç”¨ã€‚`,'info');}}
        function handleDisaster(type){let msg='';let cost=0;switch(type){case 'FACTORY_FIRE':const indZones=city.buildings.filter(b=>BUILDINGS[b.id]?.cat==='industrial');if(indZones.length>0){const target=indZones[Math.floor(Math.random()*indZones.length)];if(target)target.condition=0.3;msg=`${BUILDINGS[target.id]?.n||'ä¸€å®¶å·¥å‚'}å‘ç”Ÿç«ç¾ï¼`;city.fireRisk+=5;}else{msg="ç«ç¾è­¦æŠ¥ï¼Œä½†æ— å·¥ä¸šåŒºå—å½±å“ã€‚";}break;case 'HEAT_WAVE':city.powerDemand*=1.3;city.waterDemand*=1.2;city.avgSatisfaction-=3;msg="çƒ­æµªæ¥è¢­ï¼Œæ°´ç”µéœ€æ±‚æ¿€å¢ï¼";setTimeout(()=>{city.powerDemand/=1.3;city.waterDemand/=1.2;},3*24*60*60*1000);break;case 'MAJOR_TRAFFIC_JAM':city.trafficIndex=Math.min(100,city.trafficIndex+30);Object.keys(city.goodsProducedByType).forEach(k=>city.goodsProducedByType[k]*=0.8);msg="ä¸¥é‡äº¤é€šå µå¡ï¼Œå½±å“å…¨åŸï¼";break;case 'DISEASE_OUTBREAK_S':city.healthIndex-=15;city.workforce*=0.9;msg="å°å‹ç–¾ç—…çˆ†å‘ï¼Œå¸‚æ°‘å¥åº·å—å½±å“ï¼";break;case 'STOCK_MARKET_FLUCTUATION':if(Math.random()>.5){cost=Math.floor(city.funds*0.1);city.funds-=cost;msg=`è‚¡å¸‚åŠ¨è¡ï¼Œèµ„é‡‘æŸå¤± ${cost}ï¼`;}else{const gain=Math.floor(city.funds*0.05);city.funds+=gain;msg=`è‚¡å¸‚åˆ©å¥½ï¼Œèµ„é‡‘å¢åŠ  ${gain}ï¼`;}break;case 'METEORITE_SCARE':city.avgSatisfaction-=10;msg="é™¨çŸ³å è½ææ…Œï¼ä½†æœªå‡»ä¸­åŸå¸‚ã€‚";break;case 'SINKHOLE_REPORTS':const betroffen=city.buildings.filter(b=>Math.random()<.03);betroffen.forEach(b=>{city.buildings.splice(city.buildings.indexOf(b),1);logCityEvent(`${BUILDINGS[b.id]?.n} è¢«å¤©å‘åå™¬ï¼`,'disaster');});msg=`åœ°é¢å¡Œé™·æŠ¥å‘Šï¼Œ${betroffen.length}æ ‹å»ºç­‘å—æŸæˆ–è¢«æ¯ï¼`;break;}logCityEvent(`ç¾éš¾: ${msg}`,'disaster');playSound('error',{v:.3,fS:600,fE:50});updateCityUI();}
        function updateCityUI(){simEls.f.textContent=city.funds.toFixed(0);simEls.p.textContent=`${city.population}/${city.maxPopulation}`;simEls.e.textContent=`${city.powerDemand.toFixed(0)}/${city.powerCapacity.toFixed(0)}`;simEls.w.textContent=`${city.waterDemand.toFixed(0)}/${city.waterCapacity.toFixed(0)}`;simEls.gP.textContent=Object.values(city.goodsProducedByType).reduce((s,v)=>s+v,0).toFixed(0);simEls.gD.textContent=Object.values(city.goodsDemandByType).reduce((s,v)=>s+v,0).toFixed(0);simEls.d.textContent=`Y${city.year}D${city.day}`;simEls.r.textContent=city.researchPoints.toFixed(0);simEls.wf.textContent=`${city.workforce.toFixed(0)}/${Math.floor(Object.values(city.jobsAvailableBySkill).reduce((s,v)=>s+v,0))}(${city.unemployed.toFixed(0)}å¤±ä¸š)`;simEls.cl.textContent=`${city.cityLevel} (${city.cityXP}/${city.cityXPNext})`;simEls.rm.textContent=Object.entries(city.rawMaterialsStock).map(([k,v])=>`${RAW_MATERIALS_TYPES[k]?RAW_MATERIALS_TYPES[k].n.substring(0,1):'X'}:${v.toFixed(0)}`).join(' ');simEls.sBar.style.width=`${city.avgSatisfaction}%`;simEls.eBar.style.width=`${city.environmentQuality}%`;simEls.tBar.style.width=`${city.trafficIndex}%`;simEls.gbBar.style.width=`${Math.min(100,(city.garbageCapacity||0)/(Math.max(1,city.garbageAccumulated)))*100}%`;simEls.sP.textContent=city.avgSatisfaction.toFixed(0);simEls.eP.textContent=city.environmentQuality.toFixed(0);simEls.tP.textContent=city.trafficIndex.toFixed(0);simEls.gbP.textContent=simEls.gbBar.style.width.slice(0,-1);simEls.e.closest('.resource-item').style.color=city.powerCapacity<city.powerDemand?'rgb(var(--color-red))':'inherit';simEls.w.closest('.resource-item').style.color=city.waterCapacity<city.waterDemand?'rgb(var(--color-red))':'inherit';simEls.wf.closest('.resource-item').style.color=city.unemployed>city.workforce*0.15?'rgb(var(--color-yellow))':'inherit';simEls.rm.closest('.resource-item').style.color=Object.values(city.rawMaterialsStock).reduce((s,v)=>s+v,0)<Object.values(city.goodsDemandByType).reduce((s,v)=>s+v,0)*0.1?'rgb(var(--color-yellow))':'inherit';updateAdvisorBunny();Object.values(simPanels).forEach(p=>{if(p&&p.style.display!=='none'&&p.id!=='god-mode-panel'&&p.id!=='city-main-screen'){const rFKey=p.id.replace(/-panel$/,'');const rF=window[`render${rFKey.charAt(0).toUpperCase()+rFKey.slice(1)}Panel`];if(typeof rF==='function')rF();}});}
        function renderConstructionPanel(){let h='<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-1 p-1">';Object.entries(BUILDINGS).forEach(([k,b])=>{let rd=''; const ul=!b.reqTech||b.reqTech.every(t=>city.unlockedTech.includes(t)); if(!ul)rd+='(ç§‘æŠ€ä¸è¶³)';const ub=(b.unique&&city.buildings.some(bi=>bi.id===k));if(ub)rd+='(å·²å»ºå”¯ä¸€)';const du=!b.density||city.unlockedZoneDensities.includes(b.density);if(!du)rd+='(å¯†åº¦æœªè§£é”)';const rl=!b.reqLevel||city.cityLevel>=b.reqLevel;if(!rl)rd+=`(éœ€Lv${b.reqLevel})`;h+=`<button class="sim-button list-item aspect-[4/5] text-xs p-1 ${!ul||ub||!du||!rl?'opacity-50 cursor-not-allowed':''}" onclick="${ul&&!ub&&du&&rl?`tryBuild('${k}')`:''}" title="${b.n} | ${b.c}ğŸ’°${b.m?'(ç»´æŠ¤:'+b.m+')':''}\n${b.cap?'å®¹é‡:'+(b.cap*(b.density?ZONE_DENSITY[b.density].mod:1)):''}${b.out&&b.cat=='power'?'âš¡:'+b.out:''}${b.pol?'æ±¡æŸ“:'+b.pol:''} ${rd}"><span class="text-xl">${b.ui.ic}</span><span>${b.n.substring(0,7)}</span><span class="text-yellow-400">${b.c}ğŸ’°</span></button>`;});simPanels.con.innerHTML=h+'</div>';}
        function renderBudgetPanel(){let h='<div class="p-2 space-y-3 text-xs">';h+='<div class="grid grid-cols-2 gap-2"><strong>ç¨ç‡è°ƒæ•´:</strong><div></div>';Object.keys(city.taxRate).forEach(type=>{const catName=BUILDING_CATEGORIES[type]||type.charAt(0).toUpperCase()+type.slice(1);h+=`<div><label class="text-sm accent-text">${catName} ç¨: ${city.taxRate[type]}%</label><input type="range" min="0" max="25" step="1" value="${city.taxRate[type]}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="this.previousElementSibling.textContent='${catName} ç¨: '+this.value+'%';" onchange="setTaxRate('${type}',this.value)"></div>`;});h+='</div><hr class="border-gray-700 my-2"><div class="grid grid-cols-2 gap-2"><strong>éƒ¨é—¨é¢„ç®—:</strong><div></div>';Object.keys(city.budget).forEach(cat=>{const catName=(BUILDING_CATEGORIES[cat]||cat.charAt(0).toUpperCase()+cat.slice(1));h+=`<div><label class="text-sm text-gray-400">${catName} é¢„ç®—: ${city.budget[cat]}%</label><input type="range" min="50" max="150" step="10" value="${city.budget[cat]}" class="w-full h-2 bg-gray-700 rounded-lg" oninput="this.previousElementSibling.textContent='${catName} é¢„ç®—: '+this.value+'%';" onchange="setBudget('${cat}',this.value)"></div>`;});h+='</div><hr class="border-gray-700 my-2"><div><strong>é“¶è¡Œè´·æ¬¾:</strong><button class="sim-button text-xs px-2 py-1 ml-2" onclick="takeLoanPrompt()">ç”³è¯·è´·æ¬¾</button><div id="loans-list" class="mt-1 space-y-1">';city.loans.forEach(l=>{h+=`<div class="list-item text-xs">è´·æ¬¾ ${l.id.substring(0,4)}: ${l.amount}ğŸ’°, åˆ©ç‡${(l.interestRate*100).toFixed(1)}%, å‰©ä½™ ${l.remainingTerm}å¤©, æ—¥è¿˜ ${l.paymentPerDay.toFixed(0)}ğŸ’°</div>`;});h+='</div></div>';simPanels.bud.innerHTML=h+'</div>';}
        function setTaxRate(type,rate){city.taxRate[type]=parseInt(rate);logCityEvent(`${BUILDING_CATEGORIES[type]||type.charAt(0).toUpperCase()+type.slice(1)} ç¨ç‡è°ƒæ•´ä¸º ${rate}%`,'action');updateCityUI();}
        function setBudget(cat,rate){city.budget[cat]=parseInt(rate);logCityEvent(`${BUILDING_CATEGORIES[cat]||cat.charAt(0).toUpperCase()+cat.slice(1)} éƒ¨é—¨é¢„ç®—è°ƒæ•´ä¸º ${rate}%`,'action');updateCityUI();}
        function takeLoanPrompt(){const amount=parseInt(prompt("è¾“å…¥è´·æ¬¾é‡‘é¢ (ä¾‹å¦‚: 10000):", "10000"));const term=parseInt(prompt("è¾“å…¥è´·æ¬¾æœŸé™(å¤©) (ä¾‹å¦‚: 20):", "20"));if(isNaN(amount)||amount<=0||isNaN(term)||term<=5){logCityEvent("æ— æ•ˆçš„è´·æ¬¾å‚æ•°ã€‚","error");return;}const interestRate=Math.max(0.01,0.03 + city.cityLevel*0.001 - (city.unlockedTech.includes('BANKING')?0.01:0) + Math.max(0,(50-city.avgSatisfaction)/500) - (city.buildings.filter(b=>b.id==='BANK').length*0.002));const totalRepayment=amount*(1+interestRate);const dailyPayment=totalRepayment/term;city.loans.push({id:`L${Date.now().toString().slice(-4)}`,amount,interestRate,termDays:term,remainingTerm:term,paymentPerDay:dailyPayment});city.funds+=amount;logCityEvent(`æˆåŠŸç”³è¯·è´·æ¬¾ ${amount}ğŸ’°, åˆ©ç‡ ${(interestRate*100).toFixed(1)}%, ä¸ºæœŸ ${term}å¤©ã€‚`,'finance');playSound('confirm');updateCityUI();renderBudgetPanel();}
        function renderPolicyPanel(){let h='<div class="p-2 space-y-2">';Object.entries(POLICIES).forEach(([k,p])=>{const active=city.activePolicies[k];const unlocked=(!p.reqTech||p.reqTech.every(t=>city.unlockedTech.includes(t)));h+=`<div class="list-item ${!unlocked?'opacity-60':''}"><div class="flex justify-between items-center"><span class="font-bold ${!unlocked?'text-gray-500':''}">${p.n} ${active?'(ç”Ÿæ•ˆä¸­)':''}</span>${unlocked?`<button class="sim-button text-xs px-2 py-1" onclick="togglePolicy('${k}')">${active?'åœç”¨':'æ¿€æ´»'}</button>`:'<span class="text-xs text-red-500">éœ€ç§‘æŠ€</span>'}</div><p class="text-xs text-gray-400 mt-1">${p.desc} ${p.costPerDay?`(æ¯æ—¥æˆæœ¬:${p.costPerDay}ğŸ’°)`:''} ${p.satisImpact?`(æ»¡æ„åº¦å½±å“:${p.satisImpact})`:''}</p></div>`;});simPanels.pol.innerHTML=h+'</div>';}
        function togglePolicy(key){const policy=POLICIES[key];if(!policy.reqTech||policy.reqTech.every(t=>city.unlockedTech.includes(t))){if(city.activePolicies[key]){delete city.activePolicies[key];logCityEvent(`æ”¿ç­– ${policy.n} å·²åœç”¨ã€‚`,'policy_deact');}else{if(city.funds<(policy.costPerDay||0)*5 && policy.costPerDay > 0){logCityEvent(`èµ„é‡‘ä¸è¶³ä»¥æ”¯æŒæ”¿ç­– ${policy.n}ã€‚`,'error');return;}city.activePolicies[key]=true;logCityEvent(`æ”¿ç­– ${policy.n} å·²æ¿€æ´»ã€‚`,'policy_act');}}else{logCityEvent(`ç§‘æŠ€ä¸è¶³ä»¥æ¿€æ´»æ”¿ç­– ${policy.n}ã€‚`,'error');}playSound('confirm');advanceDay();}
        function renderTechTreePanel(){let h='<div class="p-2 space-y-2">';Object.entries(TECHS).forEach(([k,t])=>{const researched=city.unlockedTech.includes(k);const canResearch=(!researched&&city.researchPoints>=t.c&&(t.pre.length===0||t.pre.every(p=>city.unlockedTech.includes(p))));h+=`<div class="list-item ${researched?'border-green-500':(canResearch?'border-yellow-500':'border-gray-700')}"><div class="flex justify-between items-center"><span class="font-bold">${t.n} ${researched?'(å·²ç ”å‘)':''}</span>${!researched?`<button class="sim-button text-xs px-2 py-1 ${!canResearch?'opacity-50 cursor-not-allowed':''}" onclick="${canResearch?`researchTech('${k}')`:''}">ç ”å‘(${t.c}ğŸ”¬, ${t.t}å¤©)</button>`:''}</div><p class="text-xs text-gray-400 mt-1">${t.pre.length>0?'å‰ç½®: '+t.pre.map(pk=>TECHS[pk]?.n||pk).join(', '):''} | æ•ˆæœ: ${getTechEffectDesc(t.eff)}</p></div>`;});simPanels.tec.innerHTML=h+'</div>';}
        function researchTech(key){const tech=TECHS[key];if(city.currentResearch){logCityEvent(`å·²åœ¨ç ”å‘ ${TECHS[city.currentResearch.key].n}ã€‚`,'info');return;}if(city.researchPoints>=tech.c&&(tech.pre.length===0||tech.pre.every(p=>city.unlockedTech.includes(p)))){city.researchPoints-=tech.c;logCityEvent(`å¼€å§‹ç ”å‘ ${tech.n}... é¢„è®¡ ${tech.t} å¤©ã€‚`,'tech');city.currentResearch={key,daysLeft:tech.t};playSound('confirm');}else{logCityEvent(`æ— æ³•ç ”å‘ ${tech.n} (æ¡ä»¶æˆ–ç‚¹æ•°ä¸è¶³)ã€‚`,'error');}renderTechTreePanel();}
        function renderDistrictPanel(){let h='<div class="p-2 space-y-2"><p class="text-sm text-gray-400">åŒºåŸŸè§„åˆ’ä¸ä¸“ä¸šåŒ– (åŠŸèƒ½å¼€å‘ä¸­)</p>';(city.districts||[]).forEach((d,idx)=>{h+=`<div class="list-item">åŒºåŸŸ ${idx+1}: ${DISTRICT_SPECIALIZATIONS[d.type]?.n||'æœªçŸ¥'}</div>`;});h+='</div>';simPanels.dis.innerHTML=h;}
        function renderMayorActionsPanel(){let h='<div class="p-2 space-y-2">';Object.entries(MAYOR_ACTIONS).forEach(([k,a])=>{const canAfford=(city.funds>=a.c&&advisorBunny.energy>=(a.advisorEnergyCost||0));const meetsReq=!a.unlockReq||(city.inventory[a.unlockReq.item]&&city.inventory[a.unlockReq.item]>=a.unlockReq.qty);const techOk=!a.reqTech||a.reqTech.every(t=>city.unlockedTech.includes(t));h+=`<div class="list-item ${canAfford&&meetsReq&&techOk?'':'opacity-60'}"><div class="flex justify-between items-center"><span class="font-bold">${a.n}</span><button class="sim-button text-xs px-2 py-1 ${!(canAfford&&meetsReq&&techOk)?'opacity-50 cursor-not-allowed':''}" onclick="${canAfford&&meetsReq&&techOk?`executeMayorAction('${k}')`:''}">æ‰§è¡Œ (${a.c}ğŸ’°${a.advisorEnergyCost?', '+a.advisorEnergyCost+'æ´»åŠ›':''})</button></div><p class="text-xs text-gray-400 mt-1">${a.desc}</p></div>`;});simPanels.may.innerHTML=h+'</div>';}
        function getTechEffectDesc(eff){if(eff.unlockZoneDensity)return`è§£é”${eff.unlockZoneDensity.map(d=>ZONE_DENSITY[d]?.name).join('/')}è§„åˆ’`;if(eff.unlock)return`è§£é” ${eff.unlock.map(uk=>BUILDINGS[uk]?.n||TECHS[uk]?.n||uk).join(', ')}`;if(eff.modify)return`${BUILDINGS[eff.modify.target]?.n||eff.modify.target_cat} ${eff.modify.prop} ${eff.modify.mode==='mul'?'x':(eff.modify.mode==='add'?'+':'')} ${eff.modify.val}`;if(eff.global)return Object.entries(eff.global).map(([k,v])=>`${k}:${v}`).join(', ');return JSON.stringify(eff).substring(0,40)+'...';}
        function tryBuild(bKey){const b=BUILDINGS[bKey];let rd='';const ul=!b.reqTech||b.reqTech.every(t=>city.unlockedTech.includes(t));if(!ul)rd+='ç§‘æŠ€ä¸è¶³;';const ub=(b.unique&&city.buildings.some(bi=>bi.id===bKey));if(ub)rd+='å·²å»ºå”¯ä¸€;';const du=!b.density||city.unlockedZoneDensities.includes(b.density);if(!du)rd+='å¯†åº¦æœªè§£é”;';const rl=!b.reqLevel||city.cityLevel>=b.reqLevel;if(!rl)rd+=`éœ€Lv${b.reqLevel};`;if(rd){logCityEvent(`æ— æ³•å»ºé€  ${b.n} (${rd.slice(0,-1)})ã€‚`,'error');playSound('error');return;}if(city.funds<b.c){logCityEvent(`èµ„é‡‘ä¸è¶³å»º ${b.n}ï¼`,'error');playSound('error');return;}city.funds-=b.c;city.buildings.push({id:bKey,x:0,y:0,lvl:b.lvl||1,eff:1,density:b.density||null,condition:1,district:null});logCityEvent(`å·²å»º ${b.n}ã€‚`,'build');playSound('build');advanceDay();}
        function executeMayorAction(key){const action=MAYOR_ACTIONS[key];if(city.funds<action.c||advisorBunny.energy<(action.advisorEnergyCost||0)){logCityEvent(`æ— æ³•æ‰§è¡Œ ${action.n}:èµ„æºæˆ–æ´»åŠ›ä¸è¶³ã€‚`,'error');return;}if(action.unlockReq&&(!city.inventory[action.unlockReq.item]||city.inventory[action.unlockReq.item]<action.unlockReq.qty)){logCityEvent(`æ— æ³•æ‰§è¡Œ ${action.n}:ç¼ºå°‘ç‰©å“ã€‚`,'error');return;}if(action.reqTech&&!action.reqTech.every(t=>city.unlockedTech.includes(t))){logCityEvent(`æ— æ³•æ‰§è¡Œ ${action.n}:ç¼ºå°‘ç§‘æŠ€ã€‚`,'error');return;}if(action.eff.type==='loan'){if(city.loans.length>=3){logCityEvent("è´·æ¬¾å·²è¾¾ä¸Šé™(3ç¬”)ã€‚","error");return;}city.funds+=action.loanAmount;const loanId=`L${Date.now().toString().slice(-4)}`;const payment=(action.loanAmount*(1+action.interestRate))/action.termDays;city.loans.push({id:loanId,amount:action.loanAmount,interestRate:action.interestRate,termDays:action.termDays,remainingTerm:action.termDays,paymentPerDay:payment});logCityEvent(`æˆåŠŸè·å¾—è´·æ¬¾ ${action.loanAmount}ğŸ’° (ID:${loanId})ã€‚`,'finance');}else{city.funds-=action.c;}advisorBunny.energy-=(action.advisorEnergyCost||0);if(action.eff.type==='timed_boost'){city.timedBoosts.push({target:action.eff.target,val:action.eff.val,remainingDays:action.eff.duration,source:`mayor_${key}`});}else if(action.eff.type==='boost'){city[action.eff.target]=Math.min(100,(city[action.eff.target]||0)+action.eff.val);}else if(action.eff.type==='advisor_feed'){handleMayorAction_FeedAdvisor();}else if(action.eff.type==='random_utility_upgrade'){const utils=city.buildings.filter(b=>BUILDINGS[b.id].t==='utility'&&BUILDINGS[b.id].out);if(utils.length>0){const target=utils[Math.floor(Math.random()*utils.length)];BUILDINGS[target.id].out=parseFloat((BUILDINGS[target.id].out*1.1).toFixed(1));logCityEvent(`${BUILDINGS[target.id].n} æ•ˆç‡æå‡10%ï¼`,'action');}else{logCityEvent("æ²¡æœ‰å…¬å…±è®¾æ–½å¯å‡çº§ã€‚","info");}}else if(action.eff.type==='random_trade_benefit'){if(Math.random()>.5){const amt=Math.floor(Math.random()*200+50);const mat=Object.keys(RAW_MATERIALS_TYPES)[Math.floor(Math.random()*Object.keys(RAW_MATERIALS_TYPES).length)];city.rawMaterialsStock[mat]=(city.rawMaterialsStock[mat]||0)+amt;logCityEvent(`è´¸æ˜“åå®šå¸¦æ¥ ${amt} å•ä½${RAW_MATERIALS_TYPES[mat].n}!`,'action');}else{const amt=Math.floor(Math.random()*2000+1000);city.funds+=amt;logCityEvent(`è´¸æ˜“åå®šå¸¦æ¥ ${amt} èµ„é‡‘!`,'action');}}logCityEvent(`æ‰§è¡Œå¸‚é•¿è¡ŒåŠ¨: ${action.n}`,'action');playSound('special');advanceDay();renderMayorActionsPanel();updateCityUI();}
        function showCityPanel(pId){Object.values(simPanels).forEach(p=>{if(p)p.style.display='none';});cityMainScreen.style.display='none';const targetPanel=document.getElementById(pId);if(targetPanel)targetPanel.style.display=pId==='city-main-screen'?'flex':'block';else cityMainScreen.style.display='flex';document.querySelectorAll('#city-action-tabs .sim-tab-button').forEach(b=>{b.classList.remove('active','border-b-2');b.style.borderBottomColor='transparent';});const actBtn=document.querySelector(`#city-action-tabs .sim-tab-button[onclick*="'${pId}'"]`);if(actBtn){actBtn.classList.add('active','border-b-2');actBtn.style.borderBottomColor='rgb(var(--accent-rgb))';}currentCityPanel=pId;const renderFunc=window[`render${pId.charAt(0).toUpperCase()+pId.slice(1).replace('-panel','Panel')}`];if(typeof renderFunc==='function')renderFunc();}
        function saveCity(){const cityStr=JSON.stringify(city);const approxBytes=new TextEncoder().encode(cityStr).length;if(approxBytes>CONFIG.MAX_LOCALSTORAGE_SAVE_BYTES){logCityEvent(`å­˜æ¡£è¿‡å¤§(${(approxBytes/1024/1024).toFixed(2)}MB)ï¼Œå¯èƒ½æ— æ³•ä¿å­˜ã€‚`,'error');playSound('error');return;}try{localStorage.setItem(CONFIG.CITY_SAVE_KEY,cityStr);logCityEvent("åŸå¸‚è¿›åº¦å·²æ‰‹åŠ¨ä¿å­˜è‡³æµè§ˆå™¨ï¼","system");playSound('confirm');}catch(e){logCityEvent("ä¿å­˜å¤±è´¥ï¼æµè§ˆå™¨å­˜å‚¨ç©ºé—´å¯èƒ½å·²æ»¡æˆ–æƒé™ä¸è¶³ã€‚","error");playSound('error');console.error("Save city failed:",e);}}
        function loadCity(){const sS=localStorage.getItem(CONFIG.CITY_SAVE_KEY);if(sS){try{const lc=JSON.parse(sS);city=validateLoadedCity(lc);logCityEvent("ä»æµè§ˆå™¨æ‰‹åŠ¨åŠ è½½å­˜æ¡£æˆåŠŸï¼","system");playSound('confirm');}catch(e){console.error("Load city failed:",e);generateNewCityState();logCityEvent("æ‰‹åŠ¨åŠ è½½å­˜æ¡£æŸåï¼Œå·²é‡ç½®ä¸ºæ–°åŸå¸‚ã€‚","error");playSound('error');}}else{logCityEvent("æœªæ‰¾åˆ°æ‰‹åŠ¨å­˜æ¡£ã€‚å¯å¼€å§‹æ–°æ¸¸æˆæˆ–ç»§ç»­å½“å‰ã€‚","system");playSound('error');}initCitySimAfterLoad();}
        function initCitySimAfterLoad(){updateCityUI();Object.values(simPanels).forEach(p=>{if(p&&typeof p.id==='string'&&p.id.endsWith('-panel'))p.innerHTML='';}); renderConstructionPanel();renderBudgetPanel();renderPolicyPanel();renderTechTreePanel();renderDistrictPanel();renderMayorActionsPanel();if(godModeActive)renderGodModePanel();renderPopulationChart();updateAdvisorBunny();renderCityLog();}
        function handleTitleClickForGodMode(event){if(godModeActive||event.target.closest('.lcars-element'))return;const now=Date.now();if(now-lastTitleClickTime<2000){titleClickCount++;}else{titleClickCount=1;}lastTitleClickTime=now;if(titleClickCount>=CONFIG.GOD_MODE_TITLE_CLICKS){showCalculatorModal();titleClickCount=0;}}
        function showCalculatorModal(){const y=city.year,p=city.population%1000,l=city.cityLevel,f=Math.floor(city.funds/1000),r=city.researchPoints%100;const stage1Key=calculateGodModeKey_Stage1(y,p,l,f,r);calculatorInfoEl.innerHTML=`<p>ä¸Šå¸æ¨¡å¼æ¿€æ´»åºåˆ—...</p><p>- å¹´ä»½ (Y): <strong>${y}</strong> | äººå£åä¸‰ä½ (P): <strong>${p}</strong></p><p>- ç­‰çº§ (L): <strong>${l}</strong> | èµ„é‡‘åƒä½ (F): <strong>${f}</strong></p><p>- ç§‘ç ”ç‚¹åä¸¤ä½ (R): <strong>${r}</strong></p><hr class="my-2 border-gray-700"><p>æ¸¸æˆå†…ç”Ÿæˆçš„ç¬¬ä¸€é˜¶æ®µæ¿€æ´»ç  (S1 Key):</p><p class="code-block">${stage1Key}</p><p class="text-xs text-gray-500 mt-2">è¯·å°†ä»¥ä¸Šæ‰€æœ‰æ•°å€¼ (Y,P,L,F,R) åŠ S1 Key è¾“å…¥åˆ°æ‚¨çš„PythonéªŒè¯å™¨ä¸­ä»¥è·å–æœ€ç»ˆæ¿€æ´»ç ã€‚ç„¶ååœ¨ä¸»é¢˜é¢æ¿è¾“å…¥æœ€ç»ˆæ¿€æ´»ç ã€‚</p><p class="text-xs text-red-400">PythonéªŒè¯é€»è¾‘æç¤º: <span class="font-mono">FinalKey = "BCC-GOD-" + HMAC_SHA256( (Y+P+L+F+R) + S1_Key, YOUR_PYTHON_SECRET_SALT_S2 ).hex()[:4].upper()</span></p>`;toggleCalculatorModal(true);}
        function toggleCalculatorModal(show){godModeCalculatorModal.classList.toggle('hidden',!show);godModeCalculatorModal.classList.toggle('opacity-0',!show);}
        function calculateGodModeKey_Stage1(y,p,l,f,r){let key=(y*17+p*3+l*29)^(f*11-r*7+CONFIG.GOD_MODE_CALC_SALT_S1);return Math.abs(key%899999)+100000;}
        function applyCustomColorOrGodModeKey(event){let val=event.target.value.trim().toUpperCase();let rgb;const hexMatch=val.match(/^#?([A-F\d]{2})([A-F\d]{2})([A-F\d]{2})$/i);const shortHexMatch=val.match(/^#?([A-F\d])([A-F\d])([A-F\d])$/i);const rgbMatch=val.match(/^RGB\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/i);if(hexMatch){rgb=`${parseInt(hexMatch[1],16)},${parseInt(hexMatch[2],16)},${parseInt(hexMatch[3],16)}`;}else if(shortHexMatch){rgb=`${parseInt(shortHexMatch[1]+shortHexMatch[1],16)},${parseInt(shortHexMatch[2]+shortHexMatch[2],16)},${parseInt(shortHexMatch[3]+shortHexMatch[3],16)}`;}else if(rgbMatch){rgb=`${rgbMatch[1]},${rgbMatch[2]},${rgbMatch[3]}`;}if(rgb){changeTheme({r:rgb});event.target.value='';}else{const y=city.year,p=city.population%1000,l=city.cityLevel,f=Math.floor(city.funds/1000),r=city.researchPoints%100;const s1Key=calculateGodModeKey_Stage1(y,p,l,f,r);const expectedFinalNumericPart=(s1Key+CONFIG.GOD_MODE_JS_ADDON)%10000;const expectedFinalKey=`BCC-GOD-${expectedFinalNumericPart.toString().padStart(4,'0')}`;if(val===expectedFinalKey){godModeActive=true;document.getElementById('god-mode-indicator').classList.remove('hidden');document.getElementById('god-mode-modal-indicator').classList.remove('hidden');document.getElementById('god-mode-tab-button').classList.remove('hidden');logCityEvent("ä¸Šå¸æ¨¡å¼å·²é€šè¿‡æ¿€æ´»ç æ¿€æ´»ï¼",'godmode');playSound('godmode');showCityPanel('god-mode-panel');renderGodModePanel();toggleModal('theme-modal',false);event.target.value='';}else{logCityEvent("æ— æ•ˆçš„é¢œè‰²ä»£ç æˆ–æœ€ç»ˆæ¿€æ´»ç ã€‚",'error');playSound('error');}}}
        function renderGodModePanel(){if(!godModeActive){simPanels.god.innerHTML='';return;}let h=`<div class="p-2 space-y-3 text-xs"><h3 class="text-lg accent-text font-bold">ä¸Šå¸æ¨¡å¼æ§åˆ¶å°</h3>`;h+=`<div class="grid grid-cols-2 gap-2"><div><label>èµ„é‡‘:</label><input id="gm-funds" type="number" class="god-mode-input" value="${city.funds}"></div><div><label>ç§‘ç ”ç‚¹:</label><input id="gm-research" type="number" class="god-mode-input" value="${city.researchPoints}"></div></div>`;Object.keys(city.rawMaterialsStock).forEach(k=>{h+=`<div><label>${RAW_MATERIALS_TYPES[k]?.n||k}:</label><input id="gm-rm-${k}" type="number" class="god-mode-input" value="${city.rawMaterialsStock[k]}"></div>`;});h+=`<div><label>é¡¾é—®ç²¾åŠ›:</label><input id="gm-adv-energy" type="number" class="god-mode-input" value="${advisorBunny.energy}"></div><div><label>é¡¾é—®å¿«ä¹:</label><input id="gm-adv-happy" type="number" class="god-mode-input" value="${advisorBunny.happiness}"></div>`;h+=`<button class="sim-button bg-green-600 hover:bg-green-500" onclick="applyGodModeChanges()">åº”ç”¨æ›´æ”¹</button><hr class="my-2 border-gray-700">`;h+=`<button class="sim-button" onclick="godModeUnlockAllTech()">è§£é”æ‰€æœ‰ç§‘æŠ€</button>`;h+=`<button class="sim-button" onclick="godModeMaxSatisfaction()">æœ€å¤§åŒ–æ»¡æ„åº¦/ç¯å¢ƒ</button>`;h+=`<select id="gm-disaster-select" class="god-mode-input w-full my-1 bg-gray-800 text-white"><option value="">é€‰æ‹©ç¾éš¾è§¦å‘...</option>${['FACTORY_FIRE','HEAT_WAVE','MAJOR_TRAFFIC_JAM','DISEASE_OUTBREAK_S','STOCK_MARKET_FLUCTUATION','METEORITE_SCARE','SINKHOLE_REPORTS'].map(d=>`<option value="${d}">${d}</option>`).join('')}</select><button class="sim-button" onclick="godModeTriggerDisaster()">è§¦å‘ç¾éš¾</button>`;h+='</div>';simPanels.god.innerHTML=h;}
        function applyGodModeChanges(){if(!godModeActive)return;city.funds=parseInt(document.getElementById('gm-funds').value)||city.funds;city.researchPoints=parseInt(document.getElementById('gm-research').value)||city.researchPoints;Object.keys(city.rawMaterialsStock).forEach(k=>{if(document.getElementById(`gm-rm-${k}`))city.rawMaterialsStock[k]=parseInt(document.getElementById(`gm-rm-${k}`).value)||city.rawMaterialsStock[k];});advisorBunny.energy=parseInt(document.getElementById('gm-adv-energy').value)||advisorBunny.energy;advisorBunny.happiness=parseInt(document.getElementById('gm-adv-happy').value)||advisorBunny.happiness;logCityEvent("ä¸Šå¸æ¨¡å¼æ›´æ”¹å·²åº”ç”¨ã€‚",'godmode');updateCityUI();}
        function godModeUnlockAllTech(){if(!godModeActive)return;Object.keys(TECHS).forEach(k=>{if(!city.unlockedTech.includes(k))city.unlockedTech.push(k);});city.unlockedZoneDensities=['LOW','MED','HIGH'];logCityEvent("æ‰€æœ‰ç§‘æŠ€å’Œå¯†åº¦å·²è§£é”ã€‚",'godmode');renderTechTreePanel();renderConstructionPanel();updateCityUI();}
        function godModeMaxSatisfaction(){if(!godModeActive)return;city.avgSatisfaction=100;city.environmentQuality=100;city.healthIndex=100;city.crimeRate=0;city.fireRisk=0;city.trafficIndex=0;city.garbageAccumulated=0;logCityEvent("æ»¡æ„åº¦å’ŒåŸå¸‚æŒ‡æ ‡å·²æœ€å¤§åŒ–ã€‚",'godmode');updateCityUI();}
        function godModeTriggerDisaster(){if(!godModeActive)return;const sel=document.getElementById('gm-disaster-select');if(sel.value)handleDisaster(sel.value);}
        
        async function loadAndProcessPetData(){try{const r=await fetch(CONFIG.PET_RECORDS_PATH);if(!r.ok)throw new Error('Pet records not found.');const raw=await r.json();const proc=raw.map(rec=>{const d=new Date(Math.floor(rec.date)*1e3);d.setFullYear(d.getFullYear()+31);return{...rec,pD:d};});allPetRecords=[...proc].sort((a,b)=>b.pD-a.pD);weightRecords=proc.filter(rec=>rec.activity==='ä½“é‡æµ‹é‡'&&rec.weight>0).sort((a,b)=>a.pD-b.pD);if(weightRecords.length>0){petWeightModule.style.display='block';renderWeightChart();}else{petWeightModule.style.display='none';}renderAllPetRecords();}catch(e){console.warn("PetRecords.json åŠ è½½å¤±è´¥:",e.message);petWeightModule.style.display='none';allRecordsContainer.innerHTML='<p class="text-xs text-gray-500 p-2">å® ç‰©æ¡£æ¡ˆæ•°æ® (PetRecords.json) åŠ è½½å¤±è´¥æˆ–ä¸å­˜åœ¨ã€‚</p>';}}
        function renderAllPetRecords(){if(!allPetRecords||allPetRecords.length===0){if(allRecordsContainer.innerHTML.includes('å¤±è´¥'))return;allRecordsContainer.innerHTML='<p class="text-xs text-gray-500 p-2">æ— å® ç‰©æ¡£æ¡ˆè®°å½•ã€‚</p>';return;}allRecordsContainer.innerHTML=allPetRecords.map(rec=>{const dS=rec.pD.toLocaleDateString('sv-SE');const wI=rec.weight>0?` - é‡é‡: <strong class="glow-text">${rec.weight}g</strong>`:'';return`<div class="list-item"><div class="flex justify-between items-center"><p class="font-bold"><span class="accent-text">${rec.activity}</span>${wI}</p><time class="text-xs flex-shrink-0 ml-2" style="color:var(--text-muted-color)">${dS}</time></div><p class="text-sm mt-1" style="color:var(--text-muted-color)">ç¬”è®°: ${rec.notes||'N/A'}</p></div>`;}).join('');}
        function renderWeightChart(){if(weightChartJS)weightChartJS.destroy();if(!weightChartEl||weightRecords.length===0){petWeightModule.style.display='none'; return;} else {petWeightModule.style.display='block';} const gC=`rgb(${getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim()})`,aC=`rgb(${getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim()})`,mC=getComputedStyle(docEl).getPropertyValue('--text-muted-color').trim();const lbls=weightRecords.map(r=>r.pD.toLocaleDateString('zh-CN',{month:'2-digit',day:'2-digit'}));const data=weightRecords.map(r=>r.weight);const ctx=weightChartEl.getContext('2d');weightChartJS=new Chart(ctx,{type:'line',data:{labels:lbls,datasets:[{label:'é‡é‡(g)',data:data,borderColor:gC,backgroundColor:gC.replace(')',',.2)').replace('rgb','rgba'),pointBackgroundColor:aC,pointBorderColor:'#fff',tension:.3,fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true}},scales:{x:{ticks:{color:mC},grid:{color:'rgba(var(--glow-rgb),.1)'}},y:{ticks:{color:mC,callback:(v)=>`${v}g`},grid:{color:'rgba(var(--glow-rgb),.1)'},beginAtZero:false}}}});const wIE=document.getElementById('weight-change-info');if(weightRecords.length>=2){const l=weightRecords[weightRecords.length-1].weight,p=weightRecords[weightRecords.length-2].weight;const ch=l-p;const cT=ch>0?`â–² ${ch.toFixed(0)}g`:(ch<0?`â–¼ ${Math.abs(ch.toFixed(0))}g`:'æŒå¹³');const cCC=ch>0?'accent-text':(ch<0?'text-red-400':'text-gray-400');wIE.innerHTML=`æœ€æ–°:<strong class="glow-text">${l}g</strong>. å¯¹æ¯”ä¸Šæ¬¡:<strong class="${cCC}">${cT}</strong>.`}else if(weightRecords.length===1){wIE.innerHTML=`åˆå§‹è®°å½•:<strong class="glow-text">${weightRecords[0].weight}g</strong>.`}else{wIE.innerHTML=`ç­‰å¾…ä½“é‡æ•°æ®...`}}
        function renderPopulationChart(){if(populationChartJS)populationChartJS.destroy();if(!populationChartEl||!city.populationHistory)return;const gC=`rgb(${getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim()})`,aC=`rgb(${getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim()})`,mC=getComputedStyle(docEl).getPropertyValue('--text-muted-color').trim();const lbls=city.populationHistory.map(h=>`Y${Math.floor(h.d/30)}D${h.d%30||30}`);const data=city.populationHistory.map(h=>h.p);const ctx=populationChartEl.getContext('2d');populationChartJS=new Chart(ctx,{type:'line',data:{labels:lbls,datasets:[{label:'äººå£',data:data,borderColor:gC,backgroundColor:gC.replace(')',',.2)').replace('rgb','rgba'),pointBackgroundColor:aC,pointBorderColor:'#fff',tension:.1,fill:true,pointRadius:data.length<30?3:0,pointHoverRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true}},scales:{x:{ticks:{color:mC,maxRotation:0,minRotation:0,autoSkipPadding:10},grid:{color:'rgba(var(--glow-rgb),.1)'}},y:{ticks:{color:mC},grid:{color:'rgba(var(--glow-rgb),.1)'},beginAtZero:true}}}});const pIE=document.getElementById('population-change-info');if(city.populationHistory.length>=2){const l=city.populationHistory[city.populationHistory.length-1].p,p=city.populationHistory[city.populationHistory.length-2].p;const ch=l-p;const cT=ch>0?`â–² ${ch}`:(ch<0?`â–¼ ${Math.abs(ch)}`:'æŒå¹³');pIE.innerHTML=`å½“å‰äººå£:<strong class="glow-text">${l}</strong>.è¾ƒæ˜¨æ—¥:<strong class="${ch>0?'accent-text':(ch<0?'text-red-400':'text-gray-400')}">${cT}</strong>.`}else if(city.populationHistory.length===1){pIE.innerHTML=`åˆå§‹äººå£:<strong class="glow-text">${city.populationHistory[0].p}</strong>.`}else{pIE.innerHTML=`ç­‰å¾…äººå£æ•°æ®...`}}
        function toggleFont(){bodyEl.classList.toggle('font-pixel');const btn=document.getElementById('font-toggle-button');if(bodyEl.classList.contains('font-pixel')){Chart.defaults.font.family="'Press Start 2P','Noto Sans SC',sans-serif";Chart.defaults.font.size=10;btn.textContent="SYSTEM FONT";}else{Chart.defaults.font.family="'Noto Sans SC',sans-serif";Chart.defaults.font.size=12;btn.textContent="PIXEL FONT";}renderPopulationChart();if(weightRecords.length>0)renderWeightChart();}
        function setupThemeEngine(){const rT=CONFIG.THEMES[Math.floor(Math.random()*CONFIG.THEMES.length)];changeTheme(rT);renderThemePage();}
        function changeThemePage(dir){const tP=Math.ceil(CONFIG.THEMES.length/10);currentThemePage=(currentThemePage+dir+tP)%tP;renderThemePage();}
        function renderThemePage(){const tG=document.getElementById('theme-grid');tG.innerHTML='';const numT=CONFIG.THEMES.length,tPpS=10,tP=Math.ceil(numT/tPpS);currentThemePage=(currentThemePage+tP)%tP;const sI=currentThemePage*tPpS,eI=sI+tPpS;CONFIG.THEMES.slice(sI,eI).forEach(th=>{const s=document.createElement('button');s.className="h-12 w-full rounded-md tr-all dur-200 hov:scale-110 hov:shadow-lg focus:ring-2 ring-offset-2";s.style.backgroundColor=`rgb(${th.r})`;s.style.boxShadow=`0 0 15px rgba(${th.r},.5)`;s.title=th.n;s.onclick=()=>changeTheme(th);tG.appendChild(s);});document.getElementById('theme-page-title').innerText=`COLORS [${currentThemePage+1}/${tP}]`;}
        function changeTheme(theme){docEl.style.setProperty('--glow-rgb',theme.r);const yT=CONFIG.THEMES.find(t=>t.n==='gold');if(yT)docEl.style.setProperty('--accent-rgb',yT.r);renderPopulationChart();if(weightRecords.length>0)renderWeightChart();}
        function updateTiming(){const tE=document.getElementById('timing');const sD=new Date(CONFIG.START_DATE),cD=new Date();const eMs=cD.getTime()-sD.getTime();const eD=(eMs/864e5).toFixed(3);const tS=Math.floor(eMs/1e3),eH=Math.floor(tS/3600),eM=Math.floor((tS%3600)/60),eS=tS%60;const fD=(d)=>`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;const gNA=(b,dys)=>{let c=0,nD;do{c++;nD=new Date(b.getTime()+c*dys*864e5);}while(nD<cD);return{d:nD,c};};const gNY=(b)=>{let c=0,nD;do{c++;nD=new Date(b);nD.setFullYear(b.getFullYear()+c);}while(nD<cD);return{d:nD,c};};const n100=gNA(sD,100),n180=gNA(sD,180),n300=gNA(sD,300),nY=gNY(sD);tE.innerHTML=`<p>ğŸ° å…”å¯å¯å·²ç¶“åˆ°ä¾† <strong class="accent-text">${eD}</strong> å¤©å•¦</p><p>ğŸ‚ ç›®å‰å·²ç¶“åˆ°ä¾† <strong class="accent-text">${eH}</strong>å°æ™‚ <strong class="accent-text">${eM}</strong>åˆ†é˜ <strong class="accent-text">${eS}</strong>ç§’</p><div class="pt-2 mt-2 border-t border-dashed" style="border-color:rgba(var(--glow-rgb),.2)"></div><p>ğŸŒ± ä¸‹ä¸€å€‹100å¤©ç´€å¿µæ—¥æ˜¯ <strong class="accent-text">${fD(n100.d)}</strong>ï¼ˆç¬¬${n100.c}å€‹100å¤©ï¼‰</p><p>ğŸŒ¿ ä¸‹ä¸€å€‹180å¤©ç´€å¿µæ—¥æ˜¯ <strong class="accent-text">${fD(n180.d)}</strong>ï¼ˆç¬¬${n180.c}å€‹180å¤©ï¼‰</p><p>ğŸ€ ä¸‹ä¸€å€‹300å¤©ç´€å¿µæ—¥æ˜¯ <strong class="accent-text">${fD(n300.d)}</strong>ï¼ˆç¬¬${n300.c}ä¸ª300å¤©ï¼‰</p><p>ğŸ‰ ä¸‹ä¸€ä¸ªä¸€å‘¨å¹´çºªå¿µæ—¥æ˜¯ <strong class="accent-text">${fD(nY.d)}</strong>ï¼ˆç¬¬${nY.c}å‘¨å¹´ï¼‰</p>${city&&city.year?`<p class="mt-1 pt-1 border-t border-dotted border-gray-700">ğŸ™ï¸ æ¸¸æˆå†…æ—¥æœŸ: <strong class="accent-text">Y${city.year} D${city.day}</strong></p>`:''}`;}
        function toggleModal(mId,forceState=null){const mdl=document.getElementById(mId);const S=forceState===null?mdl.classList.contains('hidden'):!forceState;if(S){mdl.classList.remove('hidden');requestAnimationFrame(()=>mdl.classList.remove('opacity-0'));if(mId==='changelog-modal'&&!document.getElementById('changelog-content').innerHTML)renderChangelog();if(mId==='performance-modal')getStaticPerfData();if(mId==='city-management-modal'&&city&&Object.keys(city).length>0)showCityPanel(currentCityPanel);else if(mId==='city-management-modal'&&(!city||Object.keys(city).length===0))initCitySim();}else{mdl.classList.add('opacity-0');setTimeout(()=>mdl.classList.add('hidden'),300);}}
        function toggleFullscreen(){if(!document.fullscreenElement)docEl.requestFullscreen().catch(err=>alert(`å…¨å±å¤±è´¥: ${err.message}`));else document.exitFullscreen();}
        function renderChangelog() { // #CLOG_FULL_HISTORY_FINAL
            const changelogData = [
                {v:"v0.9",dt:"METROPOLIS_ZENITH_FINAL",it:[{t:"ğŸš¨ ä¿®å¾©",zh:"å½»åº•ä¿®å¤äº†getStaticPerfDataå‡½æ•°ä¸­å› é”™è¯¯å‹ç¼©HTMLç±»åå¯¼è‡´çš„æ¨¡æ¿å­—ç¬¦ä¸²è¯­æ³•é”™è¯¯ï¼Œè§£å†³äº†é¡µé¢æ— æ³•åŠ è½½çš„é—®é¢˜ã€‚",en:"Critically fixed template string syntax error in getStaticPerfData due to flawed HTML class compression, resolving blank page issue."},{t:"âœ¨ å„ªåŒ–",zh:"å®Œæ•´æ¢å¤äº†æ—§ç‰ˆæœ¬(vXåŠæ›´æ—©)çš„å® ç‰©ä½“é‡å›¾è¡¨åŠŸèƒ½ï¼Œå¹¶ä¸åŸå¸‚æ¨¡æ‹Ÿå›¾è¡¨å¹¶å­˜ã€‚",en:"Fully restored legacy pet weight chart functionality (vX and earlier), coexisting with city simulation chart."},{t:"ğŸ—‘ï¸ ç§»é™¤",zh:"å½»åº•ç§»é™¤äº†ç‹¬ç«‹çš„å® ç‰©AIï¼ˆæ‹“éº»æ­Œå­é£æ ¼ï¼‰æ¨¡æ€æ¡†åŠå…¶ç›¸å…³JSé€»è¾‘ï¼Œå°†å® ç‰©æ¦‚å¿µç»Ÿä¸€ä¸ºåŸå¸‚æ¨¡æ‹Ÿä¸­çš„'é¡¾é—®Bunny'ç³»ç»Ÿã€‚",en:"Completely removed standalone Pet AI (Tamagotchi-style) modal and its JS logic; pet concept unified as 'Advisor Bunny' in city sim."},{t:"âœ¨ å„ªåŒ–",zh:"ç¡®ä¿åŸå¸‚æ¨¡æ‹Ÿå…·å¤‡v0.8ç‰ˆæœ¬çš„æ‰€æœ‰æ·±åº¦ç©æ³•ï¼ˆç»æµã€æœåŠ¡ã€ç§‘æŠ€ã€æ”¿ç­–ã€ç¾éš¾ã€è´·æ¬¾ç­‰ï¼‰ã€‚",en:"Ensured city simulation retains all v0.8 deep gameplay features (economy, services, tech, policies, disasters, loans, etc.)."},{t:"âœ¨ å„ªåŒ–",zh:"ä¸Šå¸æ¨¡å¼æ¿€æ´»æ–¹å¼å›ºåŒ–ä¸º'ç‚¹å‡»æ ‡é¢˜->ç®—å·å™¨->å¤–éƒ¨éªŒè¯->è¾“å…¥æœ€ç»ˆç 'ã€‚",en:"God Mode activation solidified to 'click title -> calculator -> external validator -> final key'."},{t:"âœ¨ å„ªåŒ–",zh:"è¡¥å…¨å¹¶æ•´åˆäº†è‡ªv1.0ä»¥æ¥çš„æ‰€æœ‰ç‰ˆæœ¬æ›´æ–°æ—¥å¿—ã€‚",en:"Completed and consolidated all changelog entries since v1.0."}]},
                // ... (All historical changelog entries from v0.8.2 down to v1.0 are inserted here)
                {v:"v0.8.2",dt:"METROPOLIS_ZENITH_PRO",it:[{t:"âœ¨ å„ªåŒ–",zh:"ä¸Šå¸æ¨¡å¼æ¿€æ´»æ–¹å¼æ›´æ”¹ä¸ºç®—å·å™¨æµç¨‹ã€‚",en:"God Mode activation changed to calculator flow."}]},
                {v:"v0.8",dt:"METROPOLIS_ZENITH",it:[{t:"ğŸš€ æ–°å¢",zh:"åŸå¸‚æ¨¡æ‹Ÿæå¤§ä¸°å¯Œã€‚",en:"City sim vastly enriched."},{t:"âœ¨ å„ªåŒ–",zh:"å¤´åƒç‰¹æ•ˆèåˆğŸ°ğŸ¥•ã€‚",en:"Avatar VFX merges ğŸ°ğŸ¥•."}]},
                { version: "vX", date: "GENESIS_OMEGA", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Introduced a deep simulation-management game layer with coins, tech points, and a permanent upgrade system.", zh: "å¼•å…¥äº†å…·æœ‰é‡‘å¸ã€ç§‘ç ”ç‚¹æ•°å’Œæ°¸ä¹…å‡çº§ç³»ç»Ÿçš„æ·±åº¦æ¨¡æ‹Ÿç»è¥æ¸¸æˆå±‚ã€‚" }, { type: "âœ¨ å„ªåŒ– (Improved)", en: "The avatar transformation has been extended to 35 seconds, with a new 'Genesis' phase featuring giant emoji constellations.", zh: "å¤´åƒå˜èº«ç‰¹æ•ˆå»¶é•¿è‡³35ç§’ï¼Œå¹¶åŠ å…¥äº†ä»¥å·¨å¤§Emojiæ˜Ÿåº§ä¸ºç‰¹è‰²çš„å…¨æ–°â€œåˆ›ç”Ÿâ€é˜¶æ®µã€‚" }, { type: "ğŸ› ä¿®å¾© (Fix)", en: "Fixed a critical bug where the mouse trail would disappear during avatar effects.", zh: "ä¿®å¤äº†åœ¨å¤´åƒç‰¹æ•ˆæœŸé—´é¼ æ ‡å…‰è½¨ä¼šæ¶ˆå¤±çš„å…³é”®é”™è¯¯ã€‚" }, { type: "ğŸ› ä¿®å¾© (Fix)", en: "Patched mobile browser compatibility issues and ensured all themes are correctly paginated.", zh: "ä¿®å¤äº†ç§»åŠ¨ç«¯æµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰ä¸»é¢˜éƒ½èƒ½æ­£ç¡®åˆ†é¡µæ˜¾ç¤ºã€‚" } ]},
                { version: "v12.0", date: "CELESTIAL_FINALE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Replaced the avatar transformation with a 25-second 'Celestial Finale' particle dissolution and reconstitution effect.", zh: "å°†æ•´ä¸ªå¤´åƒå˜èº«åŠ¨ç”»æ›¿æ¢ä¸ºä¸€ä¸ªé•¿è¾¾25ç§’çš„â€œå¤©ç©¹ç»ˆç« â€ç²’å­åˆ†è§£ä¸é‡ç»„ç‰¹æ•ˆã€‚" }, { type: "âœ¨ å„ªåŒ– (Improved)", en: "The new effect resolves all previous rendering artifacts by using a pure canvas-based particle system, incorporating emojis.", zh: "æ–°çš„ç‰¹æ•ˆé€šè¿‡ä½¿ç”¨çº¯ç²¹åŸºäºCanvasçš„ç²’å­ç³»ç»Ÿï¼ˆå¹¶èåˆäº†Emojiï¼‰ï¼Œè§£å†³äº†æ‰€æœ‰ä¹‹å‰çš„æ¸²æŸ“ç‘•ç–µã€‚" } ]},
                { version: "v11.3", date: "ETERNITY_DRIVE_FINAL", items: [ { type: "ğŸ› ä¿®å¾© (Fix)", en: "Fixed a critical execution-halting error in the mouse trail renderer and avatar animation stalls.", zh: "ä¿®å¤äº†é¼ æ ‡å…‰è½¨æ¸²æŸ“å™¨å’Œå¤´åƒåŠ¨ç”»å¡é¡¿çš„è‡´å‘½é”™è¯¯ã€‚" } ]},
                { version: "v11.0", date: "CRYSTAL_HEART", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Implemented a multi-stage 'Sailor Moon' transformation sequence for the avatar.", zh: "ä¸ºå¤´åƒå®ç°äº†å¤šé˜¶æ®µçš„â€œç¾å°‘å¥³æˆ˜å£«â€å˜èº«åºåˆ—ã€‚" } ]},
                { version: "v10.1", date: "OBSERVER_PRIME", items: [ { type: "âœ¨ å„ªåŒ– (Improved)", en: "Upgraded the Performance Monitor to a professional-grade 'Observer Core'.", zh: "å°†æ€§èƒ½ç›‘è§†å™¨å‡çº§ä¸ºä¸“ä¸šçº§â€œè§‚å¯Ÿè€…æ ¸å¿ƒâ€ã€‚" } ]},
                { version: "v10.0", date: "AEGIS_PRIME", items: [ { type: "ğŸ› ä¿®å¾© (Fix)", en: "Fixed a critical regression bug with JSON date parsing.", zh: "ä¿®å¤äº†JSONæ—¥æœŸè§£æçš„å…³é”®å›å½’æ€§Bugã€‚" } ]},
                { version: "v9.4.1", date: "GRANZORT_DRIVE", items: [ { type: "ğŸ› ä¿®å¾© (Fix)", en: "Fixed a regression bug where date difference calculations failed.", zh: "ä¿®å¤äº†æ—¥æœŸå·®å¼‚è®¡ç®—å¤±è´¥çš„å›å½’æ€§Bugã€‚" } ]},
                { version: "v9.4", date: "GRANZORT_DRIVE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Rebuilt the Pet AI modal into a 'Tamagotchi-style' 3-button interface.", zh: "å°†å® ç‰©AIçª—å£é‡æ„ä¸ºâ€œæ‹“éº»æ­Œå­â€é£æ ¼çš„ä¸‰æŒ‰é”®ç•Œé¢ã€‚" }, { type: "âœ¨ å„ªåŒ– (Improved)", en: "Enhanced the avatar rebuild effect with a 'Granzort-style' spiraling particle animation.", zh: "ä½¿ç”¨â€œé­”åŠ¨ç‹â€é£æ ¼çš„èºæ—‹ç²’å­åŠ¨ç”»å¢å¼ºäº†å¤´åƒé‡ç»„ç‰¹æ•ˆã€‚" } ]},
                { version: "v9.3.1", date: "TAMAGOTCHI_CORE", items: [ { type: "ğŸ› ä¿®å¾© (Fix)", en: "Fixed an issue where chart click events were not being registered.", zh: "ä¿®å¤äº†å›¾è¡¨ç‚¹å‡»äº‹ä»¶æ— æ³•è¢«æ³¨å†Œçš„é—®é¢˜ã€‚" } ]},
                { version: "v9.3", date: "TAMAGOTCHI_CORE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Overhauled the pet system into a 'Tamagotchi' mini-game.", zh: "å°†å® ç‰©ç³»ç»Ÿé‡æ„ä¸ºå…·æœ‰é¥¥é¥¿åº¦å’Œå¹¸ç¦åº¦çŠ¶æ€çš„â€œæ‹“éº»æ­Œå­â€è¿·ä½ æ¸¸æˆã€‚" }, { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "AI responses are now based on real-time pet stats and JSON data.", zh: "AIçš„å›å¤ç°åœ¨åŸºäºå®æ—¶çš„å® ç‰©çŠ¶æ€å’Œå·²åŠ è½½çš„JSONæ•°æ®ã€‚" } ]},
                { version: "v9.2", date: "SYNAPSE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Introduced a mock-AI chat modal.", zh: "å¼•å…¥äº†æ¨¡æ‹ŸAIèŠå¤©çª—å£ã€‚" }, { type: "âœ¨ å„ªåŒ– (Improved)", en: "Reworked the performance monitor into a modal window.", zh: "å°†æ€§èƒ½ç›‘è§†å™¨é‡æ„ä¸ºå¼¹å‡ºçª—å£ã€‚" }, { type: "ğŸ› ä¿®å¾© (Fix)", en: "Completely fixed the avatar slash/rebuild effect.", zh: "å½»åº•ä¿®å¤äº†å¤´åƒæŒ¥ç /é‡ç»„ç‰¹æ•ˆã€‚" } ]},
                { version: "v9.1.1", date: "AEGIS-CORE", items: [ { type: "ğŸ› ä¿®å¾© (Fix)", en: "Fixed a critical bug where the Performance Monitor was permanently hidden.", zh: "ä¿®å¤äº†å¯¼è‡´æ€§èƒ½ç›‘è§†å™¨è¢«æ°¸ä¹…éšè—çš„å…³é”®é”™è¯¯ã€‚" } ]},
                { version: "v9.1", date: "AEGIS-CORE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Restored the fully interactive Pet Bunny module.", zh: "æ¢å¤äº†å®Œå…¨äº’åŠ¨çš„å® ç‰©å…”å­æ¨¡ç»„ã€‚" }, { type: "âœ¨ å„ªåŒ– (Improved)", en: "Replaced the 'Genesis' avatar effect with the 'Lightsaber Slash' variant.", zh: "å°†ã€Œåˆ›ä¸–çºªã€å¤´åƒç‰¹æ•ˆæ›¿æ¢ä¸ºã€Œå…‰å‰‘æŒ¥ç ã€ç‰ˆæœ¬ã€‚" } ]},
                { version: "v9.0", date: "GENESIS-PRIME", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Added 'Genesis' avatar effect.", zh: "æ–°å¢ã€Œåˆ›ä¸–çºªã€å¤´åƒç‰¹æ•ˆã€‚" }, { type: "âœ¨ å„ªåŒ– (Improved)", en: "The Performance Monitor is now a toggleable module.", zh: "æ€§èƒ½ç›‘è§†å™¨ç°å·²æˆä¸ºå¯åˆ‡æ¢æ¨¡å—ã€‚" } ]},
                { version: "v8.1", date: "ETERNITY", items: [ { type: "âœ¨ å„ªåŒ– (Improved)", en: "Conducted a full stability audit.", zh: "è¿›è¡Œäº†å…¨é¢ç¨³å®šæ€§å®¡è®¡ã€‚" } ]},
                { version: "v8.0", date: "SINGULARITY", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Added 'Lightsaber Duel' effect and black hole lensing VFX.", zh: "åŠ å…¥äº†ã€Œå…‰å‰‘å¯¹å†³ã€ç‰¹æ•ˆå’Œé»‘æ´å¼•åŠ›é€é•œVFXã€‚" } ]},
                { version: "v7.7", date: "RECALIBRATED", items: [ { type: "ğŸ› ä¿®å¾© (Fix)", en: "Recalibrated chart click events and restored pet bunny visibility.", zh: "é‡æ–°æ ¡å‡†äº†å›¾è¡¨ç‚¹å‡»äº‹ä»¶å¹¶æ¢å¤äº†å® ç‰©å…”çš„å¯è§æ€§ã€‚" } ]},
                { version: "v7.6", date: "SOLID-STATE", items: [ { type: "ğŸ› ä¿®å¾© (Fix)", en: "Fixed critical bugs affecting Milestones, Theme Palette, and Chart Interactions.", zh: "ä¿®å¤äº†å½±å“é‡Œç¨‹ç¢‘ã€ä¸»é¢˜é¢æ¿å’Œå›¾è¡¨äº’åŠ¨çš„å…³é”®é”™è¯¯ã€‚" } ]},
                { version: "v7.5.1", date: "QUANTUM-LEAP", items: [ { type: "âœ¨ å„ªåŒ– (Improved)", en: "Upgraded mouse trail to a 'Quantum Trail' and added a 'Data Storm' scanline.", zh: "å°†æ»‘é¼ è½¨è¿¹å‡çº§ä¸ºå¤šå½©çš„ã€Œé‡å­å…‰è½¨ã€ï¼Œå¹¶æ–°å¢äº†ã€Œæ•°æ®é£æš´ã€æ‰«æçº¿ã€‚" } ]},
                { version: "v7.5", date: "STABILIZED-CORE", items: [ { type: "âœ¨ å„ªåŒ– (Improved)", en: "Enhanced the cosmic dust VFX to be interactive.", zh: "å¢å¼·äº†å®‡å®™å°˜åŸƒç‰¹æ•ˆä½¿å…¶å¯äº’åŠ¨ã€‚" } ]},
                { version: "v7.4", date: "NEXUS-CORE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Pet interaction now triggers a burst of heart particles.", zh: "å® ç‰©äº’åŠ¨ç°åœ¨ä¼šè§¦å‘çˆ±å¿ƒç²’å­çˆ†å‘ã€‚" } ]},
                { version: "v7.3", date: "HYPERSPACE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Added a 'Hyperspace' jump animation on page load.", zh: "åŠ å…¥äº†ã€Œè¶…ç©ºé—´è·³è·ƒã€åŠ è½½åŠ¨ç”»ã€‚" } ]},
                { version: "v7.2.1", date: "FONT-MATRIX", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Added a font toggle.", zh: "å¢åŠ äº†å­—ä½“åˆ‡æ¢å™¨ã€‚" } ]},
                { version: "v7.2", date: "LEGACY-ARCHIVE", items: [ { type: "âœ¨ å„ªåŒ– (Improved)", en: "Restored complete changelog history.", zh: "æ¢å¤äº†å®Œæ•´çš„æ›´æ–°æ—¥å¿—ã€‚" } ]},
                { version: "v7.1", date: "AETHER-PAINTER", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Introduced the 'Aether Painter' autonomous bunny.", zh: "å¼•å…¥äº†ã€Œä»¥å¤ªç”»å®¶ã€è‡ªä¸»å…”å­ã€‚" } ]},
                { version: "v7.0", date: "PHOTON-CORE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Introduced the 'Photon Pixel Bunny' cursor.", zh: "å¼•å…¥äº†ã€Œå…‰å­åƒç´ å…”ã€æ¸¸æ¨™ã€‚" } ]},
                { version: "v6.4", date: "INTERACTIVE-GRID", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Added interactive chart data points.", zh: "ä¸ºå›¾è¡¨å¢åŠ äº†äº’åŠ¨æ•°æ®ç‚¹ã€‚" } ]},
                { version: "v6.3", date: "PIXEL-CORE", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Applied a global pixel font.", zh: "åº”ç”¨äº†å…¨å±€åƒç´ å­—ä½“ã€‚" } ]},
                { version: "v6.2", date: "LOGIC-REFINED", items: [ { type: "â™»ï¸ é‡æ§‹ (Refactor)", en: "Refactored data loading logic.", zh: "é‡æ„äº†æ•°æ®åŠ è½½é€»è¾‘ã€‚" } ]},
                { version: "v6.1", date: "STABLE", items: [ { type: "ğŸ› ä¿®å¾© (Fix)", en: "Patched a theme engine issue.", zh: "ä¿®å¤äº†ä¸»é¢˜å¼•æ“é—®é¢˜ã€‚" } ]},
                { version: "v6.0", date: "STARFLEET-COMMAND", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Migrated UI to LCARS standard.", zh: "å°†UIè¿ç§»è‡³LCARSæ ‡å‡†ã€‚" } ]},
                { version: "v5.0", date: "NEBULA-GRID", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Added performance panel and roaming mascot.", zh: "æ–°å¢äº†æ€§èƒ½é¢æ¿å’Œæ¼«æ¸¸å® ç‰©ã€‚" } ]},
                { version: "v4.0", date: "TRON Grid", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Re-engineered UI with TRON aesthetic.", zh: "ä»¥TRONç¾å­¦é‡æ„UIã€‚" } ]},
                { version: "v3.0", date: "Modern Fusion", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Introduced theme engine and changelog.", zh: "å¼•å…¥ä¸»é¢˜å¼•æ“å’Œæ›´æ–°æ—¥å¿—ã€‚" } ]},
                { version: "v2.0", date: "Pixel Upgrade", items: [ { type: "âœ¨ å„ªåŒ– (Improved)", en: "Switched to pixel font and added record archive.", zh: "æ›´æ¢ä¸ºåƒç´ å­—ä½“å¹¶æ·»åŠ æ¡£æ¡ˆè®°å½•ã€‚" } ]},
                { version: "v1.0", date: "Initial Commit", items: [ { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Project initialized with timers and chart.", zh: "é¡¹ç›®åˆå§‹åŒ–ï¼Œå®ç°è®¡æ—¶å™¨å’Œå›¾è¡¨ã€‚" }]}
            ];
            const cE=document.getElementById('changelog-content');cE.innerHTML=cD.map(l=>`<div class="mb-6"><p class="text-xl font-bold accent-text">${l.v} <span class="text-sm font-normal text-gray-400">- ${l.dt}</span></p><ul class="mt-3 space-y-2 list-disc list-inside">${l.it.map(i=>`<li><p class="inline font-bold">${i.t}</p><p class="text-gray-300 mt-1">${i.zh}</p><p class="text-xs text-gray-500">${i.en}</p></li>`).join('')}</ul></div>`).join('');
        }
        async function getStaticPerfData() { // #PERF_LS_SIZE_FIXED
            const perfContent = document.getElementById('perf-modal-content');
            if (!perfContent) return;
            perfContent.innerHTML = `<div id="realtime-metrics-container"></div>`; // Real-time gets populated by updatePerfPanel
            let staticHtml = '';

            // Memory Subsystem
            staticHtml += `<div class="col-span-2 text-lg glow-text mt-4 mb-2">Memory Subsystem</div>`;
            staticHtml += `<div class="col-span-2 border-b border-gray-700 mb-2"></div>`;
            staticHtml += `<div class="col-span-2 grid grid-cols-2 gap-x-4">`;
            if (performance.memory) {
                staticHtml += `<span>JS HEAP USED:</span><span class="text-white text-right">${(performance.memory.usedJSHeapSize / 1048576).toFixed(1)}MB</span>`;
                staticHtml += `<span>JS HEAP TOTAL:</span><span class="text-white text-right">${(performance.memory.totalJSHeapSize / 1048576).toFixed(1)}MB</span>`;
                staticHtml += `<span>JS HEAP LIMIT:</span><span class="text-white text-right">${(performance.memory.jsHeapSizeLimit / 1048576).toFixed(1)}MB</span>`;
            } else {
                staticHtml += '<span class="col-span-2">Memory API N/A</span>';
            }
            try {
                const lsSize = new TextEncoder().encode(JSON.stringify(localStorage)).length;
                staticHtml += `<span>LS USED (EST):</span><span class="text-white text-right">${(lsSize / 1024).toFixed(2)}KB / ~${(CONFIG.MAX_LOCALSTORAGE_SAVE_BYTES / 1024 / 1024).toFixed(0)}MB</span>`;
            } catch (e) {
                staticHtml += `<span>LS EST:</span><span class="text-white text-right">Error</span>`;
            }
            staticHtml += `</div>`;

            // Page Vitals & Load
            const navTiming = performance.getEntriesByType("navigation")[0];
            const paintTimings = performance.getEntriesByType("paint");
            if (navTiming || paintTimings.length > 0) {
                staticHtml += `<div class="col-span-2 text-lg glow-text mt-4 mb-2">Page Vitals & Load</div>`;
                staticHtml += `<div class="col-span-2 border-b border-gray-700 mb-2"></div>`;
                staticHtml += `<div class="col-span-2 grid grid-cols-2 gap-x-4">`;
                const fcp = paintTimings.find(p => p.name === 'first-contentful-paint');
                if (fcp) staticHtml += `<span>FIRST PAINT:</span><span class="text-white text-right">${fcp.startTime.toFixed(0)}ms</span>`;
                if (navTiming) staticHtml += `<span>TOTAL LOAD:</span><span class="text-white text-right">${navTiming.duration.toFixed(0)}ms</span>`;
                staticHtml += `</div>`;
            }

            // Resource Analysis
            const resources = performance.getEntriesByType("resource");
            if (resources.length > 0) {
                staticHtml += `<div class="col-span-2 text-lg glow-text mt-4 mb-2">Resource Analysis</div>`;
                staticHtml += `<div class="col-span-2 border-b border-gray-700 mb-2"></div>`;
                staticHtml += `<div class="col-span-2 grid grid-cols-2 gap-x-4">`;
                const totalSize = resources.reduce((acc, r) => acc + (r.transferSize || 0), 0);
                staticHtml += `<span>TOTAL ASSETS:</span><span class="text-white text-right">${resources.length}</span>`;
                staticHtml += `<span>PAGE WEIGHT:</span><span class="text-white text-right">${(totalSize / 1024).toFixed(1)}KB</span>`;
                const slowest = [...resources].sort((a, b) => b.duration - a.duration)[0];
                if (slowest) staticHtml += `<span class="col-span-2">SLOWEST:</span><span class="text-white col-span-2 break-all text-right">${slowest.name.split('/').pop()}(${slowest.duration.toFixed(0)}ms)</span>`;
                staticHtml += `</div>`;
            }

            // Hardware & System
            staticHtml += `<div class="col-span-2 text-lg glow-text mt-4 mb-2">Hardware & System</div>`;
            staticHtml += `<div class="col-span-2 border-b border-gray-700 mb-2"></div>`;
            staticHtml += `<div class="col-span-2 grid grid-cols-2 gap-x-4">`;
            if(navigator.hardwareConcurrency) staticHtml += `<span>CPU CORES:</span><span class="text-white text-right">${navigator.hardwareConcurrency}</span>`;
            if(navigator.deviceMemory) staticHtml += `<span>SYS MEMORY:</span><span class="text-white text-right">~${navigator.deviceMemory}GB</span>`;
            if(navigator.getBattery){ try{ const b = await navigator.getBattery(); staticHtml += `<span>BATTERY:</span><span class="text-white text-right">${(b.level*100).toFixed(0)}% ${b.charging?'(Chg)':'')</span>`; }catch(e){} }
            if(navigator.userAgent){ let os="Unk"; if(navigator.userAgent.includes("Win"))os="Win"; else if(navigator.userAgent.includes("Mac"))os="macOS"; else if(navigator.userAgent.includes("Linux"))os="Linux"; else if(navigator.userAgent.includes("Android"))os="Android"; else if(navigator.userAgent.includes("iPad"))os="iPadOS"; else if(navigator.userAgent.includes("iPhone"))os="iOS"; staticHtml += `<span>OS:</span><span class="text-white text-right">${os}</span>`; }
            staticHtml += `</div>`;
            
            perfContent.innerHTML += staticHtml; // Append all static HTML at once
        }
        function updatePerfPanel(cT){const pC=document.getElementById('perf-modal-content');if(!pC||document.getElementById('performance-modal').classList.contains('hidden'))return;const iV=cT-lastPerfUpdateTime;const fps=Math.round((frameCount/iV)*1e3);const rTC=pC.querySelector('#realtime-metrics-container');if(rTC){rTC.innerHTML=`<div class="col-span-2 text-lg glow-text mb-2">Real-time</div><div class="col-span-2 border-b border-gray-700 mb-2"></div><div class="col-span-2 grid grid-cols-2 gap-x-4"><span class="text-gray-400">FPS:</span><span class="text-white text-right">${fps}</span><span class="text-gray-400">FRAME TIME:</span><span class="text-white text-right">${(1e3/fps||0).toFixed(2)}ms</span><span class="text-gray-400">PARTICLES:</span><span class="text-white text-right">${cosmicDust.length+clickRipples.length+forceParticles.length+mouseSnake.length+celestialParticles.length}</span><span class="text-gray-400">DOM NODES:</span><span class="text-white text-right">${document.getElementsByTagName('*').length}</span></div>`;}lastPerfUpdateTime=cT;frameCount=0;}
    </script>
</body>
</html>
