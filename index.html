<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兔可可檔案：Bunny CC v4.0 [TRON GRID]</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for TRON Theming */
        :root {
            --glow-rgb: 34, 211, 238; /* Cyan */
            --glow-light-rgb: 103, 232, 249;
            --bg-color: #010409;
            --surface-color: rgba(13, 27, 42, 0.5);
            --grid-color: rgba(var(--glow-rgb), 0.15);
            --text-color: #e6edf3;
            --text-muted-color: #8b949e;
        }

        /* Base styles */
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 1s ease 0.5s forwards;
        }
        
        .font-pixel { font-family: 'Press Start 2P', cursive; }
        .glow-text { color: rgb(var(--glow-light-rgb)); text-shadow: 0 0 8px rgba(var(--glow-rgb), 0.8); }
        .glow-border { border: 1px solid rgba(var(--glow-rgb), 0.4); box-shadow: 0 0 12px rgba(var(--glow-rgb), 0.2), inset 0 0 8px rgba(var(--glow-rgb), 0.15); }
        
        /* Animated Grid Background */
        #grid-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-image:
                linear-gradient(rgba(var(--glow-rgb), 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(var(--glow-rgb), 0.15) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: pan-grid 20s linear infinite;
        }

        /* Scanline Overlay */
        #scanline-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(18, 18, 18, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(to bottom, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.08));
            background-size: 100% 4px, 100% 1px;
            animation: scanline-move 10s linear infinite;
        }

        /* Pac-Man Profile Image Container */
        .pacman-container {
            position: relative;
            width: 160px; height: 160px;
            transition: transform 0.3s ease;
        }
        .pacman-container:hover { transform: scale(1.05); }
        .pacman-mouth {
            position: absolute;
            width: 100%; height: 100%;
            clip-path: polygon(0% 0%, 100% 0%, 100% 40%, 50% 50%, 100% 60%, 100% 100%, 0% 100%);
            transition: clip-path 0.3s ease-in-out;
        }
        .pacman-container:hover .pacman-mouth {
            clip-path: polygon(0% 0%, 100% 0%, 100% 0%, 50% 50%, 100% 100%, 100% 100%, 0% 100%);
        }

        /* Main container and UI elements */
        .main-container {
            background-color: var(--surface-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .ui-module { transition: all 0.5s; opacity: 0; transform: translateY(20px); animation: module-boot 0.5s ease forwards; }
        .list-pellet li::before {
            content: '•';
            color: rgb(var(--glow-light-rgb));
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
            animation: pellet-glow 1.5s infinite alternate;
        }

        /* Modals */
        .modal-overlay { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pan-grid { from { background-position: 0 0; } to { background-position: -50px -50px; } }
        @keyframes scanline-move { from { background-position: 0 0; } to { background-position: 0 100%; } }
        @keyframes pellet-glow { from { text-shadow: 0 0 2px; } to { text-shadow: 0 0 10px rgba(var(--glow-light-rgb), 1); } }
        @keyframes module-boot { to { opacity: 1; transform: translateY(0); } }

        /* Custom scrollbar */
        .record-scrollbar::-webkit-scrollbar { width: 8px; }
        .record-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .record-scrollbar::-webkit-scrollbar-thumb { background: rgba(var(--glow-rgb), 0.5); border-radius: 4px; }
        .record-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(var(--glow-rgb), 0.8); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="grid-background"></div>
    <div id="scanline-overlay"></div>

    <!-- Main Container -->
    <div class="main-container w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden transition-all duration-500 glow-border">
        <!-- Header -->
        <div class="px-4 py-2 flex items-center justify-between border-b" style="border-color: rgba(var(--glow-rgb), 0.3)">
            <p class="font-pixel text-xs sm:text-sm tracking-widest glow-text">BCC_SYS_v4.0_TRON</p>
            <!-- Controls -->
            <div class="flex items-center space-x-3 text-gray-400">
                 <button title="更新日誌" onclick="toggleModal('changelog-modal')" class="transition-colors hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></button>
                <button title="主題面板" onclick="toggleModal('theme-modal')" class="transition-colors hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg></button>
                <button title="全螢幕" onclick="toggleFullscreen()" class="transition-colors hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" /></svg></button>
            </div>
        </div>

        <!-- Main content grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
            <!-- Left Panel -->
            <div class="lg:col-span-1 p-6 flex flex-col space-y-8">
                <div class="ui-module text-center" style="animation-delay: 0.2s;">
                     <div class="pacman-container mx-auto">
                        <div class="pacman-mouth glow-border rounded-full">
                            <img id="profile-pic" src="https://placehold.co/160x160/010409/22d3ee?text=Loading..." 
                                 onerror="this.onerror=null; this.src='https://placehold.co/160x160/010409/22d3ee?text=Error';"
                                 class="w-full h-full rounded-full object-cover">
                        </div>
                    </div>
                    <h1 class="font-pixel text-2xl font-bold mt-4 glow-text">BUNNY CC</h1>
                    <p class="text-sm font-pixel" style="color: var(--text-muted-color)">ID: B-20240312</p>
                </div>
                <div class="ui-module" style="animation-delay: 0.4s;">
                    <h2 class="font-pixel text-base pb-2 mb-4 glow-text" style="border-bottom: 1px solid rgba(var(--glow-rgb), 0.3)">MILESTONES</h2>
                    <div id="timing" class="space-y-2 text-sm whitespace-pre-line leading-relaxed list-pellet" style="color: var(--text-muted-color)"></div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="lg:col-span-2 p-6 space-y-6">
                <div class="ui-module" style="animation-delay: 0.6s;">
                    <h2 class="font-pixel text-base pb-2 mb-4 glow-text" style="border-bottom: 1px solid rgba(var(--glow-rgb), 0.3)">WEIGHT_GRID</h2>
                    <div class="h-64"><canvas id="weightChart"></canvas></div>
                    <div id="weight-change-info" class="mt-4 text-center p-3 rounded-lg h-12 flex items-center justify-center text-sm" style="background-color: rgba(var(--glow-rgb), 0.05); border: 1px solid rgba(var(--glow-rgb), 0.2)"></div>
                </div>
                <div class="ui-module" style="animation-delay: 0.8s;">
                    <h2 class="font-pixel text-base pb-2 mb-4 glow-text" style="border-bottom: 1px solid rgba(var(--glow-rgb), 0.3)">DATA_STREAM</h2>
                    <div id="all-records-container" class="record-scrollbar h-56 overflow-y-auto pr-2 space-y-3 text-sm"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="changelog-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center" onclick="toggleModal('changelog-modal')">
        <div class="main-container glow-border w-11/12 max-w-2xl" onclick="event.stopPropagation()">
            <h2 class="font-pixel text-lg p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb), 0.3)">CHANGELOG</h2>
            <div class="p-6 max-h-[70vh] overflow-y-auto record-scrollbar list-pellet">
                <div class="mb-4">
                    <p class="font-bold text-lg glow-text">Version 4.0 <span class="text-sm font-normal text-gray-400">- TRON Grid</span></p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>引入TRON風格UI，霓虹光暈、向量線條、動態光柵背景。</li>
                        <li>新增PAC-MAN風格動態頭像框。</li>
                        <li>新增CRT掃描線和雜訊視覺效果。</li>
                        <li>UI元素載入時增加啟動動畫序列。</li>
                    </ul>
                </div>
                <div class="mb-4 pt-4 border-t" style="border-color:rgba(var(--glow-rgb), 0.2)">
                    <p class="font-bold text-lg glow-text">Version 3.0 <span class="text-sm font-normal text-gray-400">- Modern Fusion</span></p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>引入全新UI，融合現代、像素、二次元風格。</li>
                        <li>加入強大的主題引擎，支持日夜模式和20種主題配色。</li>
                        <li>新增“更新日誌”彈窗。</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="theme-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center" onclick="toggleModal('theme-modal')">
        <div class="main-container glow-border w-11/12 max-w-md" onclick="event.stopPropagation()">
            <h2 class="font-pixel text-lg p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb), 0.3)">COLOR_CYCLE</h2>
            <div id="theme-grid" class="p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            PROFILE_PIC_PATH: './dist/Bunny CC_Profile.JPG',
            PET_RECORDS_PATH: './dist/bunnycc/PetRecords.json',
            START_DATE: '2024/03/12 00:00:00',
            THEMES: [
                { name: 'Cyan', rgb: '34, 211, 238', light_rgb: '103, 232, 249'},
                { name: 'Magenta', rgb: '244, 114, 182', light_rgb: '249, 168, 212'},
                { name: 'Lime', rgb: '132, 204, 22', light_rgb: '163, 230, 53'},
                { name: 'Orange', rgb: '249, 115, 22', light_rgb: '251, 146, 60'},
                { name: 'Yellow', rgb: '251, 191, 36', light_rgb: '252, 211, 77'},
                { name: 'Red', rgb: '239, 68, 68', light_rgb: '248, 113, 113'},
                { name: 'Indigo', rgb: '88, 86, 214', light_rgb: '129, 140, 248'},
                { name: 'Green', rgb: '34, 197, 94', light_rgb: '74, 222, 128'},
                { name: 'White', rgb: '229, 231, 235', light_rgb: '243, 244, 246'},
                { name: 'Purple', rgb: '168, 85, 247', light_rgb: '192, 132, 252'},
            ]
        };

        // --- GLOBAL STATE & DOM ELEMENTS ---
        let weightChart = null;
        const docEl = document.documentElement;
        const timingEl = document.getElementById('timing');
        const profilePicEl = document.getElementById('profile-pic');
        const weightChangeInfoEl = document.getElementById('weight-change-info');
        const chartCanvas = document.getElementById('weightChart');
        const allRecordsContainer = document.getElementById('all-records-container');
        const themeGrid = document.getElementById('theme-grid');
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            profilePicEl.src = CONFIG.PROFILE_PIC_PATH;
            setInterval(updateTiming, 100);
            loadAndProcessData();
            generateThemeSwatches();
        });

        // --- UI FUNCTIONS ---
        function toggleModal(modalId) {
            document.getElementById(modalId).classList.toggle('hidden');
            document.getElementById(modalId).classList.toggle('flex');
        }

        function changeTheme(theme) {
            docEl.style.setProperty('--glow-rgb', theme.rgb);
            docEl.style.setProperty('--glow-light-rgb', theme.light_rgb);
            renderWeightChart(); // Re-render chart with new colors
        }

        function generateThemeSwatches() {
            CONFIG.THEMES.forEach(theme => {
                const swatch = document.createElement('button');
                swatch.className = "h-12 w-full rounded-md transition-all duration-200 hover:scale-110 hover:shadow-lg focus:ring-2 ring-offset-2";
                swatch.style.backgroundColor = `rgb(${theme.rgb})`;
                swatch.style.boxShadow = `0 0 15px rgba(${theme.rgb}, 0.5)`;
                swatch.style.ringColor = `rgb(${theme.rgb})`;
                swatch.style.ringOffsetColor = `var(--bg-color)`;
                swatch.title = theme.name;
                swatch.onclick = () => changeTheme(theme);
                themeGrid.appendChild(swatch);
            });
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) docEl.requestFullscreen().catch(err => alert(`全螢幕失敗: ${err.message}`));
            else document.exitFullscreen();
        }

        // --- DATA & TIMING LOGIC ---
        function updateTiming() {
            const startDate = new Date(CONFIG.START_DATE);
            const currentDate = new Date();
            const elapsedMs = currentDate.getTime() - startDate.getTime();

            const elapsedDays = (elapsedMs / 86400000).toFixed(3);
            const totalSeconds = Math.floor(elapsedMs / 1000);
            const elapsedHours = Math.floor(totalSeconds / 3600);
            const elapsedMinutes = Math.floor((totalSeconds % 3600) / 60);
            const elapsedSeconds = totalSeconds % 60;
            
            const formatDate = (d) => `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
            const getNextAnniversary = (base, days) => {
                let count = 0, nextDate;
                do { count++; nextDate = new Date(base.getTime() + count * days * 86400000); } while (nextDate < currentDate);
                return { date: nextDate, count };
            };
            const getNextYearly = (base) => {
                let count = 0, nextDate;
                do { count++; nextDate = new Date(base); nextDate.setFullYear(base.getFullYear() + count); } while (nextDate < currentDate);
                return { date: nextDate, count };
            };
            
            const next100 = getNextAnniversary(startDate, 100);
            const next180 = getNextAnniversary(startDate, 180);
            const next300 = getNextAnniversary(startDate, 300);
            const nextYear = getNextYearly(startDate);
            
            timingEl.innerHTML = `<ul>
                <li>🐰兔可可已經到來 ${elapsedDays} 天啦</li>
                <li>🌱下一個100天紀念日是 ${formatDate(next100.date)}（第${next100.count}個100天）</li>
                <li>🌿下一個180天紀念日是 ${formatDate(next180.date)}（第${next180.count}個180天）</li>
                <li>🍀下一個300天紀念日是 ${formatDate(next300.date)}（第${next300.count}個300天）</li>
                <li>🎉下一個一周年紀念日是 ${formatDate(nextYear.date)}（第${nextYear.count}周年）</li>
                <li>🎂目前已經到來 ${elapsedHours}小時${elapsedMinutes}分鐘${elapsedSeconds}秒</li>
            </ul>`;
        }
        
        let allRecordsData = [];
        let weightChartData = [];

        async function loadAndProcessData() {
            try {
                const res = await fetch(CONFIG.PET_RECORDS_PATH);
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                const records = await res.json();
                
                allRecordsData = records.map(r => {
                    const d = new Date(Math.floor(r.date) * 1000);
                    d.setFullYear(d.getFullYear() + 31);
                    return { ...r, processedDate: d };
                }).sort((a, b) => b.processedDate - a.processedDate);

                weightChartData = allRecordsData
                    .filter(r => r.activity === '体重测量' && r.weight > 0)
                    .sort((a, b) => a.processedDate - b.processedDate);

                renderAllRecords(allRecordsData);
                renderWeightChart();
            } catch (error) {
                console.error("Data load error:", error);
                allRecordsContainer.innerHTML = `<p class="text-red-400">錯誤: 檔案記錄載入失敗。</p>`;
            }
        }
        
        function renderAllRecords(records) {
            allRecordsContainer.innerHTML = records.map(rec => {
                const dateStr = rec.processedDate.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
                return `<div class="p-3 rounded-md" style="background: rgba(var(--glow-rgb), 0.05); border-left: 3px solid rgba(var(--glow-rgb), 0.5)">
                            <div class="flex justify-between items-center">
                                <strong class="font-bold glow-text text-sm">${rec.activity}</strong>
                                <time class="text-xs" style="color:var(--text-muted-color)">${dateStr}</time>
                            </div>
                            <p class="mt-1" style="color: var(--text-color)">${rec.notes || '無備註'}</p>
                        </div>`;
            }).join('');
        }

        function renderWeightChart() {
            if (!weightChartData.length) return;
            if (weightChart) weightChart.destroy();
            
            const style = getComputedStyle(docEl);
            const primaryColor = `rgb(${style.getPropertyValue('--glow-rgb').trim()})`;
            const textColor = style.getPropertyValue('--text-muted-color').trim();
            const gridColor = `rgba(${style.getPropertyValue('--glow-rgb').trim()}, 0.1)`;

            weightChart = new Chart(chartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: weightChartData.map(d => d.processedDate.toLocaleDateString('zh-CN')),
                    datasets: [{
                        label: '體重 (g)',
                        data: weightChartData.map(d => d.weight),
                        borderColor: primaryColor,
                        backgroundColor: `rgba(${style.getPropertyValue('--glow-rgb').trim()}, 0.2)`,
                        borderWidth: 2,
                        pointBackgroundColor: primaryColor,
                        pointBorderColor: 'var(--bg-color)',
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        tension: 0.4,
                        fill: true,
                        shadowOffsetX: 0,
                        shadowOffsetY: 0,
                        shadowBlur: 10,
                        shadowColor: primaryColor,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: gridColor, drawBorder: false }, ticks: { color: textColor, font: { family: "'Noto Sans SC', sans-serif" }} },
                        x: { grid: { display: false }, ticks: { color: textColor, font: { family: "'Noto Sans SC', sans-serif" }} }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            if (index > 0) {
                                const diff = weightChartData[index].weight - weightChartData[index - 1].weight;
                                const sign = diff >= 0 ? '+' : '-';
                                const color = diff >= 0 ? 'text-lime-400' : 'text-red-400';
                                weightChangeInfoEl.innerHTML = `<p>與上次相比: <span class="font-bold ${color}">${sign}${Math.abs(diff.toFixed(1))}g</span></p>`;
                            } else {
                                weightChangeInfoEl.innerHTML = `<p>這是第一次測量記錄</p>`;
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
