<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æª”æ¡ˆï¼šBunny CC v6.2 [STABLE]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-rgb: 88, 86, 214; /* Default: LCARS Purple */
            --accent-rgb: 255, 140, 0; /* Default: LCARS Orange */
            --bg-color: #000000;
            --text-color: #e6edf3;
            --text-muted-color: #8b949e;
            --mouse-x: 50%; --mouse-y: 50%;
        }
        /* Base styles */
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden; /* Prevent full page scroll */
            opacity: 0;
            animation: fadeIn 1.5s ease 0.5s forwards;
            cursor: none;
            position: relative;
            z-index: 0;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                linear-gradient(rgba(var(--glow-rgb), 0.05) 1px, transparent 1px),
                linear-gradient(to right, rgba(var(--glow-rgb), 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: grid-scroll 20s linear infinite;
            z-index: -2;
            opacity: 0.5;
        }
        @keyframes grid-scroll {
            from { background-position: 0 0; }
            to { background-position: 50px 100px; }
        }

        #mouse-cursor-glow {
            position: fixed;
            width: 800px; height: 800px;
            left: var(--mouse-x); top: var(--mouse-y);
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(var(--glow-rgb), 0.15) 0%, rgba(var(--glow-rgb), 0) 50%);
            pointer-events: none;
            z-index: -1;
            transition: left 0.1s linear, top 0.1s linear;
        }

        .font-pixel { font-family: 'Press+Start+2P', 'Noto Sans SC', sans-serif; }
        .glow-text { color: rgb(var(--glow-rgb)); text-shadow: 0 0 8px rgba(var(--glow-rgb), 0.8); }
        .accent-text { color: rgb(var(--accent-rgb)); text-shadow: 0 0 8px rgba(var(--accent-rgb), 0.8); }
        
        /* LCARS UI Elements */
        .lcars-container { display: flex; height: 100vh; padding: 1rem; gap: 1rem; }
        .lcars-sidebar { width: 150px; display: flex; flex-direction: column; gap: 1rem; flex-shrink: 0; }
        .lcars-main { flex-grow: 1; display: flex; flex-direction: column; gap: 1rem; min-width: 0; } /* min-width:0 for flexbox fix */
        .lcars-element { background: rgb(var(--glow-rgb)); transition: all 0.3s ease; }
        .lcars-elbow {
            width: 100%; height: 60px;
            background: rgb(var(--glow-rgb));
            border-top-left-radius: 30px;
            border-bottom-left-radius: 30px;
        }
        .lcars-content-panel {
            flex-grow: 1;
            background: #080808;
            border: 2px solid rgb(var(--glow-rgb));
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto; /* CHANGE: Enable scrolling for this panel */
            min-height: 0; /* Important for flex-grow with overflow */
        }
        .lcars-button {
            background: #080808;
            border: 2px solid rgb(var(--accent-rgb));
            color: rgb(var(--accent-rgb));
            text-shadow: 0 0 8px rgba(var(--accent-rgb), 0.8);
            transition: all 0.2s ease;
        }
        .lcars-button:hover { background: rgb(var(--accent-rgb)); color: #000; }
        
        /* Profile Pic Hover Effects */
        .profile-container { position: relative; }
        .profile-overlay { position: absolute; inset:0; pointer-events: none; z-index: 10; opacity: 0; transition: opacity 0.3s; }
        .profile-container:hover .profile-overlay { opacity: 1; }
        .profile-overlay.glitch { animation: glitch 0.5s infinite; }
        .profile-overlay.pixelate { animation: pixelate 1s infinite; }
        .profile-overlay.scan { background: linear-gradient(to bottom, rgba(var(--glow-rgb), 0.5) 0%, transparent 3%); background-size: 100% 100px; animation: scan-effect 2s linear infinite; }

        @keyframes glitch { 0%,100% { clip-path: inset(20% 0 70% 0); } 20% { clip-path: inset(80% 0 10% 0); } 40% { clip-path: inset(30% 0 40% 0); } 60% { clip-path: inset(50% 0 20% 0); } 80% { clip-path: inset(10% 0 75% 0); } }
        @keyframes pixelate { 0%,100% { filter: blur(0px); } 50% { filter: blur(5px); } }
        @keyframes scan-effect { from { background-position: 0 -100px; } to { background-position: 0 100%; } }

        /* General UI & Animations */
        .ui-module { opacity: 0; transform: translateY(20px); animation: module-boot 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes module-boot { to { opacity: 1; transform: translateY(0); } }
        .record-scrollbar::-webkit-scrollbar { width: 8px; }
        .record-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .record-scrollbar::-webkit-scrollbar-thumb { background: rgba(var(--glow-rgb), 0.5); border-radius: 4px; }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        
        /* Modal Styles */
        .modal-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-container { background: #080808; border: 2px solid rgb(var(--glow-rgb)); box-shadow: 0 0 30px rgba(var(--glow-rgb), 0.5); }
    </style>
</head>
<body>
    <div id="mouse-cursor-glow"></div>
    <canvas id="bunny-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

    <div class="lcars-container">
        <!-- LCARS Sidebar -->
        <div class="lcars-sidebar">
            <div class="lcars-elbow"></div>
            <div class="flex-grow flex flex-col justify-end gap-4">
                <button class="lcars-button p-2 rounded-r-full font-pixel text-xs has-tooltip relative" onclick="toggleModal('changelog-modal')">LOGS<div class="tooltip absolute left-full ml-2 whitespace-nowrap bg-black/80 text-white text-xs rounded py-1 px-2">æ›´æ–°æ—¥èªŒ</div></button>
                <button class="lcars-button p-2 rounded-r-full font-pixel text-xs has-tooltip relative" onclick="toggleModal('theme-modal')">THEME<div class="tooltip absolute left-full ml-2 whitespace-nowrap bg-black/80 text-white text-xs rounded py-1 px-2">ä¸»é¡Œé¢æ¿</div></button>
                <button class="lcars-button p-2 rounded-r-full font-pixel text-xs has-tooltip relative" onclick="toggleFullscreen()">FSCRN<div class="tooltip absolute left-full ml-2 whitespace-nowrap bg-black/80 text-white text-xs rounded py-1 px-2">å…¨è¢å¹•</div></button>
            </div>
        </div>

        <!-- LCARS Main Content -->
        <div class="lcars-main">
            <div class="h-16 flex justify-between items-center flex-shrink-0">
                <div class="flex items-center">
                    <div class="lcars-element w-24 h-16 rounded-l-full"></div>
                    <div class="ml-4"><p class="font-pixel text-xl sm:text-2xl tracking-widest glow-text">BCC_SYS_v6.2</p><p class="accent-text text-sm">Starfleet Command Archives</p></div>
                </div>
                <div id="performance-panel" class="hidden md:flex items-center text-xs font-pixel space-x-4 text-gray-400"></div>
            </div>
            <!-- ADDED record-scrollbar class here -->
            <div class="lcars-content-panel record-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Left Panel -->
                    <div class="md:col-span-1 flex flex-col space-y-6">
                        <div class="ui-module text-center" style="animation-delay: 0.2s;">
                            <div class="profile-container w-40 h-40 mx-auto">
                                <img id="profile-pic" class="w-full h-full rounded-full object-cover p-1 border-2" style="border-color:rgb(var(--glow-rgb));">
                                <div class="profile-overlay rounded-full" style="background-color:rgba(var(--glow-rgb), 0.2)"></div>
                            </div>
                            <h1 class="font-pixel text-2xl font-bold mt-4 glow-text">BUNNY CC</h1>
                        </div>
                        <div class="ui-module" style="animation-delay: 0.4s;">
                            <h2 class="font-pixel text-base pb-2 mb-4 accent-text" style="border-bottom: 1px solid rgba(var(--accent-rgb), 0.3)">MILESTONES</h2>
                            <div id="timing" class="space-y-2 text-sm whitespace-pre-line leading-relaxed" style="color: var(--text-muted-color)"></div>
                        </div>
                    </div>
                    <!-- Right Panel -->
                    <div class="md:col-span-2 flex flex-col space-y-6">
                        <div class="ui-module" style="animation-delay: 0.6s;"><h2 class="font-pixel text-base pb-2 mb-4 accent-text" style="border-bottom: 1px solid rgba(var(--accent-rgb), 0.3)">WEIGHT_GRID</h2><div class="h-64"><canvas id="weightChart"></canvas></div><div id="weight-change-info" class="mt-4 text-center p-3 rounded-lg h-12 flex items-center justify-center text-sm" style="background-color: rgba(var(--glow-rgb), 0.05); border: 1px solid rgba(var(--glow-rgb), 0.2)"></div></div>
                        <div class="ui-module flex-grow flex flex-col" style="animation-delay: 0.8s;"><h2 class="font-pixel text-base pb-2 mb-4 accent-text" style="border-bottom: 1px solid rgba(var(--accent-rgb), 0.3)">DATA_STREAM</h2><div id="all-records-container" class="record-scrollbar flex-grow pr-2 space-y-3 text-sm"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="changelog-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center" onclick="toggleModal('changelog-modal')"><div class="modal-container w-11/12 max-w-4xl max-h-[80vh] flex flex-col" onclick="event.stopPropagation()"><h2 class="font-pixel text-lg p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb), 0.3)">CHANGELOG</h2><div id="changelog-content" class="p-6 overflow-y-auto record-scrollbar"></div></div></div>
    <div id="theme-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center" onclick="toggleModal('theme-modal')"><div class="modal-container w-11/12 max-w-md" onclick="event.stopPropagation()"><div class="p-4 flex justify-between items-center border-b" style="border-color:rgba(var(--glow-rgb), 0.3)"><button id="prev-theme-page" class="font-pixel text-xl glow-text"><</button><h2 id="theme-page-title" class="font-pixel text-lg glow-text">COLOR_CYCLE</h2><button id="next-theme-page" class="font-pixel text-xl glow-text">></button></div><div id="theme-grid" class="p-6 grid grid-cols-5 gap-4"></div><div class="p-4 border-t" style="border-color:rgba(var(--glow-rgb), 0.3)"><input id="custom-color-input" type="text" placeholder="#224294 or rgb(34,66,148)" class="w-full bg-transparent border text-center p-2 rounded-md font-pixel text-xs" style="border-color:rgba(var(--accent-rgb), 0.5)"></div></div></div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            PROFILE_PIC_PATH: './dist/Bunny CC_Profile.JPG',
            PET_RECORDS_PATH: './dist/bunnycc/PetRecords.json',
            START_DATE: '2024/03/12 00:00:00',
            THEMES: `cyan/34,211,238 magenta/244,114,182 lime/132,204,22 orange/249,115,22 yellow/251,191,36 red/239,68,68 indigo/88,86,214 green/34,197,94 white/229,231,235 purple/168,85,247 sky/56,189,248 rose/251,113,133 emerald/16,185,129 amber/245,158,11 violet/139,92,246 fuchsia/217,70,239 teal/20,184,166 blue/59,130,246 lightblue/14,165,233 pink/236,72,153 forest/22,163,74 crimson/220,38,38 gold/202,165,89 silver/156,163,175 bronze/205,133,63 steel/113,128,150 mint/10,200,150 lavender/216,180,254 salmon/250,128,114 turquoise/64,224,208 olive/128,128,0 maroon/128,0,0 navy/0,0,128 coral/255,127,80 orchid/218,112,214 plum/221,160,221 khaki/240,230,140 slateblue/106,90,205 sienna/160,82,45 hotpink/255,105,180 deepskyblue/0,191,255 lawngreen/124,252,0 mediumvioletred/199,21,133 darkorange/255,140,0 dodgerblue/30,144,255 tomato/255,99,71 springgreen/0,255,127 aqua/0,255,255 chartreuse/127,255,0 darkviolet/148,0,211 electric/213,252,9 cosmic/45,15,128 nebula/188,45,225 solar/255,180,0 galactic/75,0,130 cyber/0,255,198 quantum/255,30,90 void/10,10,25 supernova/255,80,0 starlight/230,230,250`.split(' ').map(s => ({n:s.split('/')[0],r:s.split('/')[1]}))
        };

        // --- GLOBAL STATE & DOM ELEMENTS ---
        const docEl = document.documentElement;
        const profilePicEl = document.getElementById('profile-pic');
        const profileOverlayEl = document.querySelector('.profile-overlay');
        const bunnyCanvas = document.getElementById('bunny-canvas');
        const bunnyCtx = bunnyCanvas.getContext('2d');
        let mouse = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
        let snake = [];
        const SNAKE_LENGTH = 20;
        let chart; // Chart instance
        let allRecords = [], weightRecords = []; // Store processed data globally

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            profilePicEl.src = CONFIG.PROFILE_PIC_PATH;
            setupEventListeners();
            loadAndProcessData();
            setupThemeEngine();
            initBunnySnake();
            requestAnimationFrame(animationLoop);
            updateTiming();
            setInterval(updateTiming, 1000);
        });
        
        // --- DATA LOGIC (REFINED) ---
        async function loadAndProcessData() {
            try {
                const response = await fetch(CONFIG.PET_RECORDS_PATH);
                if (!response.ok) throw new Error('Network response was not ok.');
                const rawRecords = await response.json();

                // Process all records: floor timestamp, convert to ms, add 31 years
                const processedRecords = rawRecords.map(r => {
                    const d = new Date(Math.floor(r.date) * 1000);
                    d.setFullYear(d.getFullYear() + 31);
                    return { ...r, processedDate: d };
                });

                // Sort all records for DATA_STREAM (newest first)
                allRecords = [...processedRecords].sort((a, b) => b.processedDate - a.processedDate);

                // Filter and sort records for WEIGHT_GRID (oldest first for charting)
                weightRecords = processedRecords
                    .filter(r => r.activity === 'ä½“é‡æµ‹é‡' && r.weight > 0)
                    .sort((a, b) => a.processedDate - b.processedDate);
                
            } catch (error) {
                console.error("ç„¡æ³•å¾æª”æ¡ˆåŠ è¼‰æ•¸æ“šï¼Œå°‡ä½¿ç”¨å…§ç½®ç¤ºä¾‹æ•¸æ“š:", error);
                // Fallback to sample data if fetch fails
                const fallbackData = [
                    { "date": 1678838400, "activity": "é¦–æ¬¡ä½“æ£€", "notes": "ä¸€åˆ‡æ­£å¸¸", "weight": 0 },
                    { "date": 1679443200, "activity": "ä½“é‡æµ‹é‡", "notes": "é£Ÿæ…¾å¾ˆå¥½ï¼Œé–‹å§‹ç†Ÿæ‚‰ç’°å¢ƒ", "weight": 510 },
                    { "date": 1680048000, "activity": "ä½“é‡æµ‹é‡", "notes": "å­¸æœƒä½¿ç”¨é£²æ°´å™¨", "weight": 580 },
                    { "date": 1680652800, "activity": "è¡Œä¸ºè§‚å¯Ÿ", "notes": "éå¸¸æ´»æ½‘ï¼Œå–œæ­¡è·³èº" },
                    { "date": 1681257600, "activity": "ä½“é‡æµ‹é‡", "notes": "æ›æ¯›æœŸï¼Œéœ€è¦å¤šæ¢³ç†", "weight": 720 },
                    { "date": 1681862400, "activity": "é¥®é£Ÿè®°å½•", "notes": "å˜—è©¦äº†æ–°å£å‘³çš„ç‰§è‰" },
                    { "date": 1682467200, "activity": "ä½“é‡æµ‹é‡", "notes": "é«”é‡æ¥è¿‘æˆå¹´æ¨™æº–", "weight": 870 }
                ];
                const processedFallback = fallbackData.map(r => {
                    const d = new Date(Math.floor(r.date) * 1000);
                    d.setFullYear(d.getFullYear() + 31);
                    return { ...r, processedDate: d };
                });
                allRecords = [...processedFallback].sort((a, b) => b.processedDate - a.processedDate);
                weightRecords = processedFallback.filter(r => r.activity === 'ä½“é‡æµ‹é‡' && r.weight > 0).sort((a, b) => a.processedDate - b.processedDate);
            }
            
            renderAllRecords(allRecords);
            renderWeightChart(weightRecords);
        }

        function renderAllRecords(records) {
            const container = document.getElementById('all-records-container');
            if (!records || records.length === 0) {
                container.innerHTML = '<p>ç„¡æ•¸æ“šæµè¨˜éŒ„ã€‚</p>';
                return;
            }
            container.innerHTML = records.map(rec => {
                const dateStr = rec.processedDate.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const weightInfo = rec.weight > 0 ? ` - é«”é‡: <span class="glow-text">${rec.weight}g</span>` : '';
                return `<div class="p-2 rounded" style="background-color: rgba(var(--glow-rgb), 0.05); border-left: 2px solid rgba(var(--glow-rgb), 0.4);">
                            <div class="flex justify-between items-center">
                                <p class="font-bold"><span class="accent-text">${rec.activity}</span>${weightInfo}</p>
                                <time class="text-xs flex-shrink-0 ml-2" style="color:var(--text-muted-color)">${dateStr}</time>
                            </div>
                            <p class="text-xs mt-1" style="color: var(--text-muted-color)">å‚™è¨»: ${rec.notes || 'ç„¡'}</p>
                        </div>`;
            }).join('');
        }
        
        function renderWeightChart(records) {
            if (chart) chart.destroy();

            const glowColor = `rgb(${getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim()})`;
            const accentColor = `rgb(${getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim()})`;
            
            const labels = records.map(r => r.processedDate.toLocaleDateString('zh-CN'));
            const data = records.map(r => r.weight);

            const ctx = document.getElementById('weightChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é«”é‡ (å…‹)',
                        data: data,
                        borderColor: glowColor,
                        backgroundColor: glowColor.replace(')', ', 0.2)').replace('rgb', 'rgba'),
                        pointBackgroundColor: accentColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: accentColor,
                        tension: 0.3,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: 'rgba(var(--text-muted-color), 0.7)' }, grid: { color: 'rgba(var(--glow-rgb), 0.1)' } },
                        y: { ticks: { color: 'rgba(var(--text-muted-color), 0.7)', callback: (value) => `${value}g` }, grid: { color: 'rgba(var(--glow-rgb), 0.1)' } }
                    }
                }
            });
            
            const weightInfoEl = document.getElementById('weight-change-info');
            if (records.length >= 2) {
                const latest = records[records.length - 1].weight;
                const previous = records[records.length - 2].weight;
                const change = latest - previous;
                const changeText = change > 0 ? `å¢åŠ  ${change}g` : (change < 0 ? `æ¸›å°‘ ${Math.abs(change)}g` : 'æŒå¹³');
                const changeColorClass = change > 0 ? 'accent-text' : (change < 0 ? 'text-red-500' : 'text-gray-400');
                weightInfoEl.innerHTML = `æœ€æ–°è¨˜éŒ„: <strong class="glow-text">${latest}g</strong>. èˆ‡ä¸Šæ¬¡ç›¸æ¯”: <strong class="${changeColorClass}">${changeText}</strong>.`;
            } else if (records.length === 1) {
                weightInfoEl.innerHTML = `åˆå§‹è¨˜éŒ„: <strong class="glow-text">${records[0].weight}g</strong>. ç­‰å¾…ä¸‹ä¸€æ¬¡æ¸¬é‡.`;
            } else {
                weightInfoEl.innerHTML = `ç­‰å¾…é«”é‡æ•¸æ“š...`;
            }
        }
        
        // --- MOUSE & ANIMATION LOOP (Unchanged) ---
        function setupEventListeners() {
            window.addEventListener('mousemove', e => {
                mouse.x = e.clientX;
                mouse.y = e.clientY;
                docEl.style.setProperty('--mouse-x', `${e.clientX}px`);
                docEl.style.setProperty('--mouse-y', `${e.clientY}px`);
            });
            profilePicEl.parentElement.addEventListener('mouseenter', () => {
                const effects = ['glitch', 'pixelate', 'scan'];
                const randomEffect = effects[Math.floor(Math.random() * effects.length)];
                profileOverlayEl.className = 'profile-overlay rounded-full ' + randomEffect;
            });
            document.getElementById('prev-theme-page').addEventListener('click', () => changeThemePage(-1));
            document.getElementById('next-theme-page').addEventListener('click', () => changeThemePage(1));
            document.getElementById('custom-color-input').addEventListener('change', applyCustomColor);
        }
        let lastTime = 0;
        function animationLoop(currentTime) {
            if(!lastTime) lastTime = currentTime;
            const deltaTime = currentTime - lastTime;
            bunnyCtx.clearRect(0, 0, bunnyCanvas.width, bunnyCanvas.height);
            updateAndDrawBunnySnake();
            lastTime = currentTime;
            requestAnimationFrame(animationLoop);
        }
        function initBunnySnake() {
            bunnyCanvas.width = window.innerWidth;
            bunnyCanvas.height = window.innerHeight;
            for (let i = 0; i < SNAKE_LENGTH; i++) {
                snake.push({ x: mouse.x, y: mouse.y });
            }
        }
        function updateAndDrawBunnySnake() {
            let head = { ...snake[0] };
            head.x += (mouse.x - head.x) * 0.2;
            head.y += (mouse.y - head.y) * 0.2;
            snake.unshift(head);
            if (snake.length > SNAKE_LENGTH) snake.pop();
            for(let i = snake.length - 1; i > 0; i--) {
                const segment = snake[i];
                const prevSegment = snake[i-1];
                const opacity = 1 - (i / snake.length) * 0.8;
                const radius = 2 + (snake.length - i) * 0.2;
                bunnyCtx.beginPath();
                bunnyCtx.moveTo(prevSegment.x, prevSegment.y);
                bunnyCtx.lineTo(segment.x, segment.y);
                bunnyCtx.strokeStyle = `rgba(var(--glow-rgb), ${opacity})`;
                bunnyCtx.lineWidth = radius;
                bunnyCtx.lineCap = 'round';
                bunnyCtx.stroke();
            }
            bunnyCtx.beginPath();
            bunnyCtx.arc(snake[0].x, snake[0].y, 5, 0, Math.PI * 2);
            bunnyCtx.fillStyle = `rgb(var(--glow-rgb))`;
            bunnyCtx.shadowColor = `rgb(var(--glow-rgb))`;
            bunnyCtx.shadowBlur = 15;
            bunnyCtx.fill();
            bunnyCtx.shadowBlur = 0;
        }

        // --- UI & THEME (Mostly Unchanged) ---
        function toggleModal(modalId) {
            document.getElementById(modalId).classList.toggle('hidden');
            document.getElementById(modalId).classList.toggle('flex');
            if (modalId === 'changelog-modal' && !document.getElementById('changelog-content').innerHTML) {
                 renderChangelog();
            }
        }
        function toggleFullscreen() {
            if (!document.fullscreenElement) docEl.requestFullscreen().catch(err => alert(`å…¨è¢å¹•å¤±æ•—: ${err.message}`));
            else document.exitFullscreen();
        }
        let currentThemePage = 0;
        const themeGrid = document.getElementById('theme-grid');
        function setupThemeEngine() {
            const randomTheme = CONFIG.THEMES[Math.floor(Math.random() * CONFIG.THEMES.length)];
            changeTheme(randomTheme);
            renderThemePage();
        }
        function changeThemePage(direction) {
            const totalPages = Math.ceil(CONFIG.THEMES.length / 10);
            currentThemePage = (currentThemePage + direction + totalPages) % totalPages;
            renderThemePage();
        }
        function renderThemePage() {
            themeGrid.innerHTML = '';
            const startIndex = currentThemePage * 10;
            const endIndex = startIndex + 10;
            CONFIG.THEMES.slice(startIndex, endIndex).forEach(theme => {
                const swatch = document.createElement('button');
                swatch.className = "h-12 w-full rounded-md transition-all duration-200 hover:scale-110 hover:shadow-lg focus:ring-2 ring-offset-2";
                swatch.style.backgroundColor = `rgb(${theme.r})`;
                swatch.style.boxShadow = `0 0 15px rgba(${theme.r}, 0.5)`;
                swatch.title = theme.n;
                swatch.onclick = () => changeTheme(theme);
                themeGrid.appendChild(swatch);
            });
            const totalPages = Math.ceil(CONFIG.THEMES.length / 10);
            document.getElementById('theme-page-title').innerText = `COLORS [${currentThemePage+1}/${totalPages}]`;
        }
        function applyCustomColor(event) {
            let input = event.target.value.trim();
            let rgb;
            if (input.startsWith('#')) {
                const hex = input.substring(1).padEnd(6, 'f');
                const bigint = parseInt(hex.slice(0,6), 16);
                rgb = `${(bigint >> 16) & 255},${(bigint >> 8) & 255},${bigint & 255}`;
            } else if (input.startsWith('rgb')) {
                rgb = input.match(/\d+/g).join(',');
            }
            if (rgb) changeTheme({ r: rgb });
        }
        function changeTheme(theme) {
            docEl.style.setProperty('--glow-rgb', theme.r);
            const orangeTheme = CONFIG.THEMES.find(t => t.n === 'orange');
            if(orangeTheme) docEl.style.setProperty('--accent-rgb', orangeTheme.r);
            if (chart) renderWeightChart(weightRecords); // Re-render chart with new colors
        }
        
        // --- TIMING & CHANGELOG (Unchanged) ---
        const timingEl = document.getElementById('timing');
        function updateTiming() {
             const startDate = new Date(CONFIG.START_DATE);
            const currentDate = new Date();
            const elapsedMs = currentDate.getTime() - startDate.getTime();
            const elapsedDays = (elapsedMs / 86400000).toFixed(3);
            const totalSeconds = Math.floor(elapsedMs / 1000);
            const elapsedHours = Math.floor(totalSeconds / 3600);
            const elapsedMinutes = Math.floor((totalSeconds % 3600) / 60);
            const elapsedSeconds = totalSeconds % 60;
            const formatDate = (d) => `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
            const getNextAnniversary = (base, days) => { let count = 0, nextDate; do { count++; nextDate = new Date(base.getTime() + count * days * 86400000); } while (nextDate < currentDate); return { date: nextDate, count }; };
            const getNextYearly = (base) => { let count = 0, nextDate; do { count++; nextDate = new Date(base); nextDate.setFullYear(base.getFullYear() + count); } while (nextDate < currentDate); return { date: nextDate, count }; };
            const next100 = getNextAnniversary(startDate, 100);
            const next180 = getNextAnniversary(startDate, 180);
            const next300 = getNextAnniversary(startDate, 300);
            const nextYear = getNextYearly(startDate);
            timingEl.innerHTML = `
                <div class="space-y-2 text-sm">
                    <p>ğŸ° å…”å¯å¯å·²ç¶“åˆ°ä¾† <strong class="accent-text">${elapsedDays}</strong> å¤©å•¦</p>
                    <p>ğŸ‚ ç›®å‰å·²ç¶“åˆ°ä¾† <strong class="accent-text">${elapsedHours}</strong>å°æ™‚ <strong class="accent-text">${elapsedMinutes}</strong>åˆ†é˜ <strong class="accent-text">${elapsedSeconds}</strong>ç§’</p>
                    <div class="pt-2 mt-2 border-t border-dashed" style="border-color: rgba(var(--glow-rgb), 0.2)"></div>
                    <p>ğŸŒ± ä¸‹ä¸€å€‹100å¤©ç´€å¿µæ—¥æ˜¯ <strong class="accent-text">${formatDate(next100.date)}</strong>ï¼ˆç¬¬${next100.count}å€‹100å¤©ï¼‰</p>
                    <p>ğŸŒ¿ ä¸‹ä¸€å€‹180å¤©ç´€å¿µæ—¥æ˜¯ <strong class="accent-text">${formatDate(next180.date)}</strong>ï¼ˆç¬¬${next180.count}å€‹180å¤©ï¼‰</p>
                    <p>ğŸ€ ä¸‹ä¸€å€‹300å¤©ç´€å¿µæ—¥æ˜¯ <strong class="accent-text">${formatDate(next300.date)}</strong>ï¼ˆç¬¬${next300.count}å€‹300å¤©ï¼‰</p>
                    <p>ğŸ‰ ä¸‹ä¸€å€‹ä¸€å‘¨å¹´ç´€å¿µæ—¥æ˜¯ <strong class="accent-text">${formatDate(nextYear.date)}</strong>ï¼ˆç¬¬${nextYear.count}å‘¨å¹´ï¼‰</p>
                </div>`;
        }
        function renderChangelog() {
            const changelogData = [
                { version: "v6.2", date: "LOGIC-REFINED", items: [
                    { type: "ğŸ› ä¿®å¾© (Fix)", en: "Fixed an issue where timing counters and data sections (chart, log) were not loading due to uninitialized function calls.", zh: "ä¿®å¾©äº†å› å‡½æ•¸æœªåˆå§‹åŒ–èª¿ç”¨è€Œå°è‡´è¨ˆæ™‚å™¨å’Œæ•¸æ“šå€å¡Šï¼ˆåœ–è¡¨ã€æ—¥èªŒï¼‰ç„¡æ³•åŠ è¼‰çš„å•é¡Œã€‚" },
                    { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Implemented a fallback mechanism with sample data to ensure the UI is populated even if the primary JSON data source fails to load.", zh: "å¯¦ç¾äº†ç¤ºä¾‹æ•¸æ“šå›é€€æ©Ÿåˆ¶ï¼Œç¢ºä¿åœ¨ä¸»JSONæ•¸æ“šæºåŠ è¼‰å¤±æ•—æ™‚UIä¾ç„¶èƒ½å¤ å¡«å……å…§å®¹ã€‚" },
                    { type: "âœ¨ å„ªåŒ– (Improved)", en: "Added a dynamic, theme-aware animated grid to the background for enhanced visual depth.", zh: "ç‚ºèƒŒæ™¯æ·»åŠ äº†èˆ‡ä¸»é¡Œè¯å‹•çš„å‹•æ…‹ç¶²æ ¼å‹•ç•«ï¼Œä»¥å¢å¼·è¦–è¦ºæ·±åº¦ã€‚" },
                    { type: "â™»ï¸ é‡æ§‹ (Refactor)", en: "Refactored data loading logic to precisely match specifications: +31 years to timestamps, DATA_STREAM shows all records, WEIGHT_GRID shows only weight measurements.", zh: "é‡æ§‹äº†æ•¸æ“šåŠ è¼‰é‚è¼¯ä»¥ç²¾ç¢ºåŒ¹é…è¦ç¯„ï¼šæ™‚é–“æˆ³å¢åŠ 31å¹´ï¼ŒDATA_STREAMé¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„ï¼ŒWEIGHT_GRIDåƒ…é¡¯ç¤ºé«”é‡æ¸¬é‡è¨˜éŒ„ã€‚" },
                    { type: "âœ¨ å„ªåŒ– (Improved)", en: "Made the main content panel scrollable on smaller viewports to prevent layout clipping and improve responsiveness.", zh: "åœ¨è¼ƒå°çš„è¦–çª—ä¸Šä½¿ä¸»å…§å®¹é¢æ¿å¯æ»¾å‹•ï¼Œä»¥é˜²æ­¢ä½ˆå±€è¢«è£åˆ‡ä¸¦æé«˜éŸ¿æ‡‰æ€§ã€‚" },
                ]},
                { version: "v6.1", date: "STABLE", items: [
                    { type: "ğŸ› ä¿®å¾© (Fix)", en: "Patched a case-sensitive issue in theme engine causing a TypeError when finding the default accent color.", zh: "ä¿®å¾©äº†ä¸»é¡Œå¼•æ“ä¸­å› å¤§å°å¯«æ•æ„Ÿè€Œå°è‡´å°‹æ‰¾é è¨­è¼”åŠ©è‰²æ™‚å‡ºç¾çš„TypeErrorã€‚" },
                    { type: "âœ¨ å„ªåŒ– (Improved)", en: "Expanded the changelog archive to include all historical versions from v1.0.", zh: "æ“´å±•äº†æ›´æ–°æ—¥èªŒåº«ï¼ŒåŒ…å«äº†å¾v1.0é–‹å§‹çš„æ‰€æœ‰æ­·å²ç‰ˆæœ¬ã€‚" },
                ]},
                { version: "v6.0", date: "STARFLEET-COMMAND", items: [
                    { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Migrated entire UI to the Starfleet LCARS standard for an authentic Star Trek archive experience.", zh: "å°‡æ•´é«”UIé·ç§»è‡³æ˜Ÿè‰¦LCARSæ¨™æº–ï¼Œæä¾›çœŸå¯¦çš„æ˜Ÿéš›è¿·èˆªæª”æ¡ˆé«”é©—ã€‚" },
                    { type: "ğŸš€ æ–°åŠŸèƒ½ (New)", en: "Implemented an interactive 'photon snake' bunny that follows the mouse cursor with a fluid tail.", zh: "å¯¦ç¾äº†äº’å‹•å¼ã€Œå…‰å­è›‡ã€å…”å­ï¼Œå…¶æµæš¢çš„å°¾å·´æœƒè·Ÿéš¨æ»‘é¼ æ¸¸æ¨™ã€‚" },
                    { type: "âœ¨ å„ªåŒ– (Improved)", en: "Added multiple random hover effects to the profile picture, such as glitch and holographic scan.", zh: "ç‚ºé ­åƒå¢åŠ äº†å¤šç¨®éš¨æ©Ÿæ‡¸æµ®ç‰¹æ•ˆï¼Œå¦‚æ•¸ä½é›œè¨Šå’Œå…¨æ¯æƒæã€‚" },
                ]},
            ];
            const contentEl = document.getElementById('changelog-content');
            contentEl.innerHTML = changelogData.map(log => `<div class="mb-6 p-4 border rounded-lg" style="border-color:rgba(var(--accent-rgb), 0.5)"><p class="font-pixel text-lg accent-text">${log.version} <span class="text-sm font-normal text-gray-400">- ${log.date}</span></p><ul class="mt-3 space-y-2 text-sm">${log.items.map(item => `<li class="pl-2 border-l-2" style="border-color: rgba(var(--glow-rgb), 0.5)"><p class="font-bold">${item.type}</p><p class="text-gray-300">${item.zh}</p><p class="text-xs text-gray-500">${item.en}</p></li>`).join('')}</ul></div>`).join('');
        }
    </script>
</body>
</html>
