<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- VERSION: v1.0.3 -->
    <title>檔案：Bunny CC vX [PERFECTIONIS_FINAL_v1.0.3]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-rgb: 236,72,153; --accent-rgb: 251,191,36; --bg-color: #0c0a1d;
            --text-color: #e6edf3; --text-color-rgb: 230,237,243; --text-muted-color: #8b949e;
            --mouse-x: 50%; --mouse-y: 50%;
            --color-red: 239,68,68; --color-green: 34,197,94; --color-yellow: 251,191,36; --color-blue:59,130,246;
        }
        body { font-family:'Noto Sans SC',sans-serif;font-size:14px;background-color:var(--bg-color);color:var(--text-color);overflow:hidden;opacity:0;animation:fadeIn 1s ease forwards;cursor:none;position:relative;z-index:0; }
        body.font-pixel { font-family:'Press Start 2P','Noto Sans SC',sans-serif;font-size:12px; }
        body.font-pixel .lcars-button,body.font-pixel .accent-text,body.font-pixel .glow-text,body.font-pixel h1,body.font-pixel h2,body.font-pixel #theme-page-title,body.font-pixel .modal-container h2,body.font-pixel .sim-button{letter-spacing:1px;}

        #singularity-background { position:fixed;inset:0;z-index:-5;background:#0c0a1d; }
        #circuitry-background { position:fixed;inset:0;z-index:-4;background-image:linear-gradient(rgba(var(--glow-rgb),.03) 1px,transparent 1px),linear-gradient(90deg,rgba(var(--glow-rgb),.03) 1px,transparent 1px);background-size:25px 25px;animation:hue-cycle 30s linear infinite; }
        @keyframes hue-cycle { from{filter:hue-rotate(0deg);} to{filter:hue-rotate(360deg);} }
        body::before { content:'';position:fixed;inset:0;z-index:-3;background-image:linear-gradient(rgba(var(--glow-rgb),.08) 1px,transparent 1px),linear-gradient(to right,rgba(var(--glow-rgb),.08) 1px,transparent 1px);background-size:75px 75px;animation:grid-scroll 15s linear infinite;opacity:.7; }
        @keyframes grid-scroll { from{background-position:0 0;} to{background-position:75px 150px;} }
        body::after { content:'';position:fixed;inset:0;z-index:-2;background:radial-gradient(800px at var(--mouse-x) var(--mouse-y),rgba(var(--glow-rgb),.18),transparent 80%);pointer-events:none; }
        
        .effect-canvas { position:fixed;inset:0;pointer-events:none; } #vfx-canvas { z-index:11; } #bunny-trail-canvas { z-index:9998; }
        .pixel-entity { position:fixed;width:32px;height:32px;background-size:contain;pointer-events:none;transform:translate(-50%,-50%);transition:filter .5s,opacity .5s;will-change:transform,left,top; }
        #mouse-bunny { z-index:9999;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3 4h1v1h1v1h4v-1h1v-1h1v3h1v1h-1v1h-1v1h-1v1h-2v-1h-1v-1h-1v-1h-1v-1h-1v-2z' fill='rgb(var(--glow-rgb))'/%3E%3Cpath d='M7 6h1v1h-1z' fill='%23000'/%3E%3Cpath d='M4 4h1v1h-1zM10 4h1v1h-1zM5 6h1v1h-1z' fill='rgb(var(--accent-rgb))'/%3E%3C/svg%3E");filter:drop-shadow(0 0 8px rgba(var(--glow-rgb),.8)); }
        
        .lcars-container { display:flex;height:100vh;padding:1rem;gap:1rem;position:relative;z-index:10; }
        .lcars-sidebar { width:150px;display:flex;flex-direction:column;gap:1rem;flex-shrink:0; }
        .lcars-main { flex-grow:1;display:flex;flex-direction:column;gap:1rem;min-width:0; }
        .lcars-element { background:rgb(var(--glow-rgb));transition:all .3s ease; }
        .lcars-elbow { width:100%;height:60px;background:rgb(var(--glow-rgb));border-top-left-radius:30px;border-bottom-left-radius:30px; }
        .lcars-content-panel { flex-grow:1;background:rgba(8,8,8,.8);backdrop-filter:blur(2px);border:2px solid rgb(var(--glow-rgb));padding:1.5rem;display:flex;flex-direction:column;gap:1.5rem;overflow-y:auto;min-height:0;animation:border-glow-in 2s ease-out forwards; }
        .lcars-button { background:#080808;border:2px solid rgb(var(--accent-rgb));color:rgb(var(--accent-rgb));text-shadow:0 0 8px rgba(var(--accent-rgb),.8);transition:all .2s ease;display:flex;align-items:center;justify-content:center;gap:.5rem; }
        .lcars-button:hover, .sim-button:hover:not(:disabled) { background:rgb(var(--accent-rgb));color:#000;box-shadow:0 0 15px rgba(var(--accent-rgb),.7); }
        .sim-button:disabled { filter:grayscale(80%);cursor:not-allowed;opacity:.5; }

        .modal-overlay { display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);transition:opacity .3s ease; }
        .modal-container { background:#080808;border:2px solid rgb(var(--glow-rgb));box-shadow:0 0 30px rgba(var(--glow-rgb),.5);transition:transform .3s ease; }
        .modal-overlay.hidden { pointer-events:none; } .modal-overlay.hidden .modal-container { transform:scale(.95); }
        
        #city-management-modal .status-bar-container { background:#222;border-radius:.25rem;overflow:hidden;border:1px solid #333;height:.7rem; }
        #city-management-modal .status-bar-fill { height:.7rem;border-radius:.25rem;transition:width .5s ease;text-align:center;font-size:.55rem;color:black;font-weight:bold;line-height:.7rem; }
        #city-main-screen { min-height:70px;background-color:#111;border:1px solid rgba(var(--glow-rgb),.2);border-radius:.5rem;padding:.5rem;display:flex;flex-direction:column;justify-content:center;text-align:left;white-space:pre-wrap;transition:all .3s;font-size:.7rem; }
        .sim-button { flex-grow:1;margin:.2rem;padding:.35rem .15rem;border-radius:.25rem;background:#222;border:1px solid rgb(var(--accent-rgb));color:rgb(var(--accent-rgb));transition:all .2s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.55rem;line-height:1;text-align:center; }
        .sim-button svg { width:.9rem;height:.9rem;margin-bottom:.1rem; }
        .sim-panel-content { max-height:40vh;overflow-y:auto;padding:.5rem;border-top:1px solid rgba(var(--glow-rgb),.2);display:none; }
        .resource-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(75px,1fr));gap:.25rem;font-size:.6rem; }
        .resource-item span:first-child {color:var(--text-muted-color);} .resource-item span:last-child {color:rgb(var(--accent-rgb));font-weight:bold;}
        .detail-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.2rem;font-size:.6rem;margin-top:.25rem; }
        .detail-item { padding:.1rem .15rem;background-color:rgba(var(--text-color-rgb),.03);border-radius:.2rem; }
        .tooltip { position:relative;display:inline-block; } .tooltip .tooltiptext { visibility:hidden;min-width:100px;background-color:#333;color:#fff;text-align:center;border-radius:4px;padding:3px 5px;position:absolute;z-index:100;bottom:115%;left:50%;margin-left:-50px;opacity:0;transition:opacity .2s;font-size:.6rem;box-shadow:0 2px 5px rgba(0,0,0,.5); } .tooltip:hover .tooltiptext { visibility:visible;opacity:1; }
        .list-item { padding:.3rem;border:1px solid rgba(var(--glow-rgb),.1);border-radius:.3rem;margin-bottom:.3rem; }
        .list-item:hover { background-color:rgba(var(--accent-rgb),.1); }
        .list-item.abandoned { border-color: rgb(var(--color-red)); background-color: rgba(var(--color-red), 0.1); }
        .god-mode-input { background:rgba(var(--text-color-rgb),.1);border:1px solid rgba(var(--accent-rgb),.5);color:var(--text-color);padding:.2rem .4rem;border-radius:.2rem;width:auto;text-align:right;font-size:.7rem; }
        .rci-demand-container { display: flex; gap: 0.5rem; align-items: center; font-size: 0.7rem; font-weight: bold; }
        .rci-bar { flex-grow: 1; height: 1rem; background-color: #333; border-radius: 0.25rem; overflow: hidden; }
        .rci-bar-fill { height: 100%; transition: width 0.5s ease; text-shadow: 1px 1px 1px #000; color: white; text-align: right; padding-right: 4px; font-size: 0.6rem; line-height: 1rem; }
        .rci-res { background-color: #22c55e; } .rci-com { background-color: #3b82f6; } .rci-ind { background-color: #f59e0b; }
        #sim-delete-button { border-color: rgb(var(--color-red)); color: rgb(var(--color-red)); }
        #sim-delete-button:hover:not(:disabled) { background-color: rgb(var(--color-red)); color: #000; box-shadow:0 0 15px rgba(var(--color-red),.7); }

        .ui-module { opacity:0;transform:translateY(20px) scale(.98);animation:module-boot .6s ease-out forwards; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} } @keyframes module-boot { to{opacity:1;transform:translateY(0) scale(1);} }
        @keyframes border-glow-in { from{box-shadow:0 0 0px rgba(var(--glow-rgb),0);} to{box-shadow:0 0 20px rgba(var(--glow-rgb),.3);} }
        #avatar-container { position:relative;cursor:pointer; } #profile-pic { transition:opacity .5s ease;will-change:opacity; }
        .record-scrollbar::-webkit-scrollbar { width:6px; } .record-scrollbar::-webkit-scrollbar-track { background:transparent; } .record-scrollbar::-webkit-scrollbar-thumb { background:rgba(var(--glow-rgb),.4);border-radius:3px; }
    </style>
</head>
<body>
    <div id="singularity-background"></div> <div id="circuitry-background"></div>
    <canvas id="vfx-canvas" class="effect-canvas"></canvas> <canvas id="bunny-trail-canvas" class="effect-canvas"></canvas>
    <div id="mouse-bunny" class="pixel-entity"></div>
    
    <div class="lcars-container">
        <div class="lcars-sidebar">
            <div class="lcars-elbow"></div>
            <div class="flex-grow flex flex-col justify-end gap-4">
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('changelog-modal')">LOGS</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('theme-modal')">THEME</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleFullscreen()">FSCRN</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('performance-modal')">PERF</button>
                <button class="lcars-button p-2 rounded-r-full text-xs" onclick="toggleModal('city-management-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /><path d="M16 4.586V17a1 1 0 01-1 1h-1.5a1 1 0 01-1-1v-2.268a2 2 0 00-2-2h-1.06a2 2 0 00-2 2V17a1 1 0 01-1 1H6a1 1 0 01-1-1V4.586l7-7 4 4zM9 13.732V17h2v-3.268a4.002 4.002 0 00-2-.001z" fill-rule="evenodd" clip-rule="evenodd"/> </svg>
                    <span>CITY OS</span>
                </button>
            </div>
        </div>
        <div class="lcars-main">
            <div id="main-title-area" class="h-16 flex justify-between items-center flex-shrink-0 cursor-pointer" title="多次点击此处有惊喜...">
                <div class="flex items-center">
                    <div class="lcars-element w-24 h-16 rounded-l-full"></div>
                    <div class="ml-4"><p class="text-xl sm:text-2xl font-bold tracking-wider glow-text">SIM-BCC</p><p class="accent-text text-sm">PERFECTIONIS_FINAL_v1.0.3</p></div>
                </div>
                <div id="god-mode-indicator" class="text-xs text-red-500 font-bold hidden mr-4">GOD MODE ACTIVE</div>
            </div>
            <div class="lcars-content-panel record-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 flex flex-col space-y-6">
                        <div class="ui-module text-center">
                            <div id="avatar-container" class="w-40 h-40 mx-auto"> <img id="profile-pic" class="w-full h-full rounded-full object-cover p-1 border-2" style="border-color:rgb(var(--glow-rgb));"> </div>
                            <h1 class="text-2xl font-bold mt-4 glow-text">MAYOR BUNNY (兔可可)</h1>
                        </div>
                        <div class="ui-module"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">MILESTONES</h2><div id="timing" class="space-y-3" style="color:var(--text-muted-color)"></div></div>
                    </div>
                    <div class="md:col-span-2 flex flex-col space-y-6">
                        <div class="ui-module"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">DATA VISUALIZATION</h2>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div><h3 class="text-sm accent-text mb-1">POPULATION_TREND (City Sim)</h3><div class="h-56 chart-container"><canvas id="populationChart"></canvas></div><div id="population-change-info" class="mt-2 text-center p-2 rounded-lg h-10 flex items-center justify-center text-xs" style="background-color:rgba(var(--glow-rgb),.05);border:1px solid rgba(var(--glow-rgb),.2);"></div></div>
                                <div id="pet-weight-module" style="display:none;"><h3 class="text-sm accent-text mb-1">PET_WEIGHT_ARCHIVE (Legacy)</h3><div class="h-56 chart-container"><canvas id="weightChart"></canvas></div><div id="weight-change-info" class="mt-2 text-center p-2 rounded-lg h-10 flex items-center justify-center text-xs" style="background-color:rgba(var(--glow-rgb),.05);border:1px solid rgba(var(--glow-rgb),.2);"></div></div>
                            </div>
                        </div>
                        <div class="ui-module flex-grow flex flex-col"><h2 class="text-lg font-bold pb-2 mb-4 accent-text" style="border-bottom:1px solid rgba(var(--accent-rgb),.3)">EVENT_STREAM</h2>
                            <div class="flex text-xs mb-2"><button id="log-toggle-city" class="px-2 py-1 border border-transparent border-b-2 font-bold accent-text" style="border-bottom-color:rgb(var(--accent-rgb))">City Log</button><button id="log-toggle-pet" class="px-2 py-1 opacity-60 hover:opacity-100">Pet Archive</button></div>
                            <div id="city-events-container" class="record-scrollbar flex-grow pr-2 space-y-3"></div>
                            <div id="all-records-container" class="record-scrollbar flex-grow pr-2 space-y-3" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="changelog-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('changelog-modal')"><div class="modal-container w-11/12 max-w-4xl max-h-[80vh] flex flex-col" onclick="event.stopPropagation()"><h2 class="text-xl p-4 glow-text border-b" style="border-color:rgba(var(--glow-rgb),.3)">CHANGELOG</h2><div id="changelog-content" class="p-6 overflow-y-auto record-scrollbar"></div></div></div>
    <div id="theme-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('theme-modal')"><div class="modal-container w-11/12 max-w-md" onclick="event.stopPropagation()"><div class="p-4 flex justify-between items-center border-b" style="border-color:rgba(var(--glow-rgb),.3)"><button id="prev-theme-page" class="text-2xl glow-text"><</button><h2 id="theme-page-title" class="text-xl glow-text">COLOR_CYCLE</h2><button id="next-theme-page" class="text-2xl glow-text">></button></div><div id="theme-grid" class="p-6 grid grid-cols-5 gap-4"></div><div class="p-4 border-t flex items-center gap-4" style="border-color:rgba(var(--glow-rgb),.3)"><input id="custom-color-input" type="text" placeholder="色码 或 最终激活码..." class="flex-grow bg-transparent border text-center p-2 rounded-md" style="border-color:rgba(var(--accent-rgb),.5)"><button id="font-toggle-button" class="lcars-button rounded-md px-4 py-2 text-xs">PIXEL FONT</button></div></div></div>
    <div id="performance-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('performance-modal')"><div class="modal-container w-11/12 max-w-lg p-6 flex flex-col" onclick="event.stopPropagation()"><h2 class="text-xl pb-4 mb-4 glow-text border-b flex-shrink-0" style="border-color:rgba(var(--glow-rgb),.3)">OBSERVER_PRIME</h2><div id="perf-modal-content" class="text-xs space-y-1 overflow-y-auto record-scrollbar max-h-[70vh]" style="font-family:'Press Start 2P',sans-serif;"></div></div></div>
    
    <div id="city-management-modal" class="modal-overlay fixed inset-0 z-[200] hidden items-center justify-center opacity-0" onclick="toggleModal('city-management-modal')">
        <div class="modal-container w-11/12 max-w-3xl flex flex-col" style="max-height:95vh;" onclick="event.stopPropagation()">
            <h2 class="text-xl p-2 glow-text border-b flex-shrink-0 text-center" style="border-color:rgba(var(--glow-rgb),.3)">BCC 文字大都会控制中心 <span id="god-mode-modal-indicator" class="text-xs text-red-400 hidden">(上帝模式)</span></h2>
            <div class="p-2 space-y-1 flex-shrink-0 border-b" style="border-color:rgba(var(--glow-rgb),.1);">
                <div id="rci-demand" class="rci-demand-container mb-2">
                    <div class="rci-bar" title="住宅需求"><div id="rci-res-bar" class="rci-bar-fill rci-res">R</div></div>
                    <div class="rci-bar" title="商业需求"><div id="rci-com-bar" class="rci-bar-fill rci-com">C</div></div>
                    <div class="rci-bar" title="工业/办公需求"><div id="rci-ind-bar" class="rci-bar-fill rci-ind">I</div></div>
                </div>
                <div class="resource-grid mb-1">
                    <div class="resource-item tooltip">💰<span class="tooltiptext">资金</span>:<span id="sim-funds">0</span></div> 
                    <div class="resource-item tooltip">🧑‍🤝‍🧑<span class="tooltiptext">人口 (低/中/高)</span>:<span id="sim-population">0</span></div>
                    <div class="resource-item tooltip">⚡<span class="tooltiptext">电力需求/产能</span>:<span id="sim-power">0/0</span></div> 
                    <div class="resource-item tooltip">💧<span class="tooltiptext">水源需求/产能</span>:<span id="sim-water">0/0</span></div>
                    <div class="resource-item tooltip">🏭<span class="tooltiptext">工业品产出</span>:<span id="sim-goods-produced">0</span></div>
                    <div class="resource-item tooltip">🛍️<span class="tooltiptext">商品需求</span>:<span id="sim-goods-demand">0</span></div>
                    <div class="resource-item">🗓️<span class="tooltiptext">日期</span>:<span id="sim-date">Y1D1</span></div> 
                    <div class="resource-item tooltip">🔬<span class="tooltiptext">科研点</span>:<span id="sim-research">0</span></div>
                    <div class="resource-item tooltip">🛠️<span class="tooltiptext">失业率</span>:<span id="sim-unemployment">0%</span></div>
                    <div class="resource-item tooltip">💡<span class="tooltiptext">顾问状态</span>:<span id="sim-bunny-status">良好</span></div>
                    <div class="resource-item tooltip">🏆<span class="tooltiptext">城市等级(经验)</span>:<span id="sim-city-level">1(0/100)</span></div>
                    <div class="resource-item tooltip">🪨<span class="tooltiptext">原材料储备(多种)</span>:<span id="sim-raw-materials">0</span></div>
                </div>
                <div class="detail-grid">
                    <div class="detail-item tooltip">😊<span class="tooltiptext">平均满意度</span>:<span id="sim-satisfaction-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-satisfaction-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#10b981,#34d399);"></div></div></div>
                    <div class="detail-item tooltip">🌳<span class="tooltiptext">环境质量</span>:<span id="sim-environment-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-environment-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#22c55e,#4ade80);"></div></div></div>
                    <div class="detail-item tooltip">🚗<span class="tooltiptext">交通压力</span>:<span id="sim-traffic-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-traffic-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#f59e0b,#fbbf24);"></div></div></div>
                    <div class="detail-item tooltip">🎓<span class="tooltiptext">教育水平</span>:<span id="sim-education-perc" class="ml-1">0</span>% <div class="status-bar-container mt-px"><div id="sim-education-bar" class="status-bar-fill" style="background:linear-gradient(90deg,#3b82f6,#60a5fa);"></div></div></div>
                </div>
            </div>
            <div id="city-main-screen" class="flex-grow m-2 text-sm record-scrollbar pr-1">市长，请下达指示...</div>
            <div id="city-action-tabs" class="p-1 border-t border-b flex-shrink-0 flex flex-wrap justify-around text-xs" style="border-color:rgba(var(--glow-rgb),.2);">
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button active" onclick="showCityPanel('city-main-screen')">概览</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('construction-panel')">建设</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('budget-panel')">预算</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('policy-panel')">政策</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('tech-tree-panel')">科技</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('district-panel')">区域</button>
                <button class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button" onclick="showCityPanel('mayor-actions-panel')">市长行动</button>
                <button id="god-mode-tab-button" class="flex-grow sm:flex-1 py-1 px-1 opacity-75 hover:opacity-100 focus:opacity-100 sim-tab-button hidden" onclick="showCityPanel('god-mode-panel')">GM</button>
            </div>
            <div id="construction-panel" class="sim-panel-content record-scrollbar"></div> <div id="budget-panel" class="sim-panel-content record-scrollbar"></div> 
            <div id="policy-panel" class="sim-panel-content record-scrollbar"></div> <div id="tech-tree-panel" class="sim-panel-content record-scrollbar"></div>
            <div id="district-panel" class="sim-panel-content record-scrollbar"></div><div id="mayor-actions-panel" class="sim-panel-content record-scrollbar"></div>
            <div id="god-mode-panel" class="sim-panel-content record-scrollbar p-2 space-y-2"></div>
            <div class="p-1 border-t flex-shrink-0 flex justify-around" style="border-color:rgba(var(--glow-rgb),.3)">
                <button id="sim-next-day-button" class="sim-button" title="结束本日"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/></svg>结束本日</button>
                <button id="sim-save-button" class="sim-button" title="保存进度到浏览器"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v1H5V4zM5 7h10v9a2 2 0 01-2 2H7a2 2 0 01-2-2V7z"/></svg>保存</button>
                <button id="sim-load-button" class="sim-button" title="从浏览器读取进度"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>读取</button>
                <button id="sim-delete-button" class="sim-button" title="删除存档并重新开始"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>删除</button>
            </div>
        </div>
    </div>
    <div id="god-mode-calculator-modal" class="modal-overlay fixed inset-0 z-[210] hidden items-center justify-center opacity-0" onclick="toggleCalculatorModal(false)">
        <div class="modal-container" onclick="event.stopPropagation()">
            <h2 class="text-lg p-3 glow-text border-b" style="border-color:rgba(var(--glow-rgb),.3)">上帝模式 - 激活码计算器</h2>
            <div id="calculator-info" class="p-4 space-y-2"></div>
            <div class="p-3 border-t text-center" style="border-color:rgba(var(--glow-rgb),.3)">
                <button class="lcars-button px-4 py-2 text-sm rounded" onclick="toggleCalculatorModal(false)">明白</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIG & GLOBAL VARIABLES ---
        const CONFIG={PROFILE_PIC_PATH:'./dist/Bunny CC_Profile.JPG',PET_RECORDS_PATH:'./dist/bunnycc/PetRecords.json',CITY_SAVE_KEY:'bunny_cc_sim_save_v1.0.2',START_DATE:'2024/03/12 00:00:00',MOUSE_SNAKE_LENGTH:20,COSMIC_DUST_COUNT:800,AVATAR_EFFECT_PRESETS:5,MAX_LOCALSTORAGE_SAVE_BYTES:4.5*1024*1024,GOD_MODE_TITLE_CLICKS:10,GOD_MODE_CALC_SALT_S1:12345,GOD_MODE_JS_ADDON:5678,THEMES:`pink/236,72,153 gold/251,191,36 cyan/34,211,238 magenta/244,114,182 lime/132,204,22 red/239,68,68 indigo/88,86,214 green/34,197,94 white/229,231,235 purple/168,85,247 sky/56,189,248 rose/251,113,133 emerald/16,185,129 amber/245,158,11 violet/139,92,246 fuchsia/217,70,239 teal/20,184,166 blue/59,130,246 lightblue/14,165,233 forest/22,163,74 crimson/220,38,38 silver/156,163,175 bronze/205,133,63 steel/113,128,150 mint/10,200,150 lavender/216,180,254 salmon/250,128,114 turquoise/64,224,208 olive/128,128,0 maroon/128,0,0 navy/0,0,128 coral/255,127,80 orchid/218,112,214 plum/221,160,221 khaki/240,230,140 slateblue/106,90,205 sienna/160,82,45 hotpink/255,105,180 deepskyblue/0,191,255 lawngreen/124,252,0 mediumvioletred/199,21,133 darkorange/255,140,0 dodgerblue/30,144,255 tomato/255,99,71 springgreen/0,255,127 aqua/0,255,255 chartreuse/127,255,0 darkviolet/148,0,211 electric/213,252,9 cosmic/45,15,128 nebula/188,45,225 solar/255,180,0 galactic/75,0,130 cyber/0,255,198 quantum/255,30,90 void/10,10,25 supernova/255,80,0 starlight/230,230,250`.split(' ').map(s=>({n:s.split('/')[0],r:s.split('/')[1]}))};
        const docEl=document.documentElement,bodyEl=document.body;
        const avatarContainer=document.getElementById('avatar-container');const mouseBunnyEl=document.getElementById('mouse-bunny');
        const vfxCanvas=document.getElementById('vfx-canvas'),vfxCtx=vfxCanvas.getContext('2d');
        const mouseTrailCanvas=document.getElementById('bunny-trail-canvas'),mouseTrailCtx=mouseTrailCanvas.getContext('2d');
        const cityManagementModal=document.getElementById('city-management-modal');const cityMainScreen=document.getElementById('city-main-screen');
        const mainTitleArea=document.getElementById('main-title-area');
        const godModeCalculatorModal=document.getElementById('god-mode-calculator-modal');
        const calculatorInfoEl=document.getElementById('calculator-info');
        const simEls={f:document.getElementById('sim-funds'),p:document.getElementById('sim-population'),w:document.getElementById('sim-water'),e:document.getElementById('sim-power'),gP:document.getElementById('sim-goods-produced'),gD:document.getElementById('sim-goods-demand'),d:document.getElementById('sim-date'),r:document.getElementById('sim-research'),ue:document.getElementById('sim-unemployment'),bs:document.getElementById('sim-bunny-status'),cl:document.getElementById('sim-city-level'),rm:document.getElementById('sim-raw-materials'),sBar:document.getElementById('sim-satisfaction-bar'),eBar:document.getElementById('sim-environment-bar'),tBar:document.getElementById('sim-traffic-bar'),edBar:document.getElementById('sim-education-bar'),sP:document.getElementById('sim-satisfaction-perc'),eP:document.getElementById('sim-environment-perc'),tP:document.getElementById('sim-traffic-perc'),edP:document.getElementById('sim-education-perc'), rciRes: document.getElementById('rci-res-bar'), rciCom: document.getElementById('rci-com-bar'), rciInd: document.getElementById('rci-ind-bar') };
        const simPanels={con:document.getElementById('construction-panel'),bud:document.getElementById('budget-panel'),pol:document.getElementById('policy-panel'),tec:document.getElementById('tech-tree-panel'),dis:document.getElementById('district-panel'),may:document.getElementById('mayor-actions-panel'),god:document.getElementById('god-mode-panel')};
        const cityEventsContainer=document.getElementById('city-events-container'),allRecordsContainer=document.getElementById('all-records-container');
        const populationChartEl=document.getElementById('populationChart'),weightChartEl=document.getElementById('weightChart');
        const petWeightModule=document.getElementById('pet-weight-module');
        let mouse={x:window.innerWidth/2,y:window.innerHeight/2,dx:0,lastX:0},mouseSnake=[];
        let city={},advisorBunny={happiness:75,energy:80,lastFed:-1,lastInteract:-1};
        let weightChartJS,populationChartJS,allPetRecords=[],weightRecords=[];
        let lastPerfUpdateTime=0,frameCount=0,lastFrameTime=0,cosmicDust=[],clickRipples=[],forceParticles=[],celestialParticles=[];
        let currentThemePage=0,audioCtx,avatarState='normal',currentCityPanel='city-main-screen',currentLogView='city', selectedDistrict = 0;
        let currentAvatarEffect=0,godModeActive=false,titleClickCount=0,lastTitleClickTime=0;

        // FIXED: All game data constants are defined globally.
        const CITIZEN_TYPES={LOW_INC:{name:"低收入", wealth:1},MED_INC:{name:"中等收入", wealth:2},HIGH_INC:{name:"高收入", wealth:3}};
        const BUILDING_CATEGORIES={residential:"住宅",commercial:"商业",industrial:"工业",office:"办公",utility:"公共设施",service:"服务",special:"特殊",extractor:"开采",processor:"加工",transport:"交通",road:"道路"};
        const RAW_MATERIALS_TYPES={STONE:{n:"石材",baseVal:5,color:"128,128,128"},WOOD:{n:"木材",baseVal:4,color:"139,69,19"},OIL:{n:"石油",baseVal:10,pol:2,color:"50,50,50"},ORE:{n:"矿石",baseVal:8,pol:1,color:"112,128,144"},FARM:{n:"农产品",baseVal:3,color:"154,205,50"},COAL:{n:"煤炭",baseVal:6,color:"70,70,70"}};

        const BUILDINGS={
            RZONE_LD_L1:{n:"棚户区",c:150,cat:'residential',lvl:1,cap:10,pU:-1,wU:-0.5,pol:0.2,m:2,ui:{ic:'🛖'},jobs:{}, upgTo:'RZONE_LD_L2'},
            RZONE_LD_L2:{n:"平房",c:0,cat:'residential',lvl:2,cap:25,pU:-2,wU:-1,pol:0.1,m:5,ui:{ic:'🏠'},jobs:{},upgFrom:'RZONE_LD_L1',upgReq:{landValue:30,serviceSat:0.3}, upgTo:'RZONE_MD_L1'},
            RZONE_MD_L1:{n:"公寓楼",c:800,cat:'residential',lvl:3,cap:70,pU:-6,wU:-3,pol:1,m:15,ui:{ic:'🏡'},jobs:{},reqTech:['ZONING_MED_DENSITY'],upgReq:{landValue:60,serviceSat:0.6}, upgTo:'RZONE_HD_L1'},
            RZONE_HD_L1:{n:"高层公寓",c:2000,cat:'residential',lvl:4,cap:200,pU:-15,wU:-8,pol:2,m:40,ui:{ic:'🏢'},jobs:{},reqTech:['ZONING_HIGH_DENSITY'],upgReq:{landValue:100,serviceSat:0.8}},
            CZONE_LD_L1:{n:"小商店",c:200,cat:'commercial',lvl:1,pU:-2,wU:-1,pol:0.5,m:5,ui:{ic:'🏪'},jobs:{LOW_INC:5},goodsConsumed:{goods_basic:5}},
            CZONE_MD_L1:{n:"购物街",c:1000,cat:'commercial',lvl:2,pU:-12,wU:-5,pol:2.5,m:25,ui:{ic:'🏬'},reqTech:['ZONING_MED_DENSITY'],jobs:{LOW_INC:10, MED_INC: 10},goodsConsumed:{goods_basic:10, goods_varied: 5}},
            IZONE_LD_L1:{n:"轻工厂",c:250,cat:'industrial',lvl:1,pU:-5,wU:-2,pol:3,m:8,ui:{ic:'🏭'},jobs:{LOW_INC:8},goodsProduced:{goods_basic:10}, rawMaterialsConsumed:{WOOD:1,STONE:1}},
            OFFICE_LD_L1:{n:"小型办公室",c:600,cat:'office',lvl:1,pU:-5,wU:-1,pol:0.2,m:20,ui:{ic:'🏢'},jobs:{MED_INC:10, HIGH_INC:5}},
            QUARRY_STONE:{n:"采石场",c:1500,cat:'extractor',pU:-20,m:80,pol:8,ui:{ic:'⛏️'},jobs:{LOW_INC:10},rawMaterialsProduced:{STONE:10}},
            PWR_COAL:{n:"燃煤电厂",c:3000,cat:'utility',pOut:100,pol:20,m:100,ui:{ic:'💨'},jobs:{LOW_INC:5, MED_INC:2},rawMaterialsConsumed:{COAL:2}},
            WAT_TOWER:{n:"水塔",c:1500,cat:'utility',wOut:50,pU:-5,m:50,ui:{ic:'💧'},jobs:{LOW_INC:2}},
            SCHOOL_E:{n:"小学",c:2500,cat:'service',pU:-10,m:150,ui:{ic:'🏫'},jobs:{MED_INC:10},serviceValue:{education:0.1,leisure: 5}, serviceRadius:5},
            CLINIC_S:{n:"诊所",c:2000,cat:'service',pU:-8,m:120,ui:{ic:'🏥'},jobs:{MED_INC:8},serviceValue:{health:0.1}, serviceRadius:4},
            FIRE_S:{n:"消防站",c:1800,cat:'service',pU:-5,m:100,ui:{ic:'🚒'},jobs:{LOW_INC:10},serviceValue:{fireSafety:0.2}, serviceRadius:6},
            POLICE_S:{n:"警局",c:1800,cat:'service',pU:-5,m:100,ui:{ic:'🚓'},jobs:{LOW_INC:10},serviceValue:{police:0.2}, serviceRadius:6},
            LANDFILL:{n:"垃圾填埋场",c:3000,cat:'utility',pU:-10,m:150,pol:15,ui:{ic:'🗑️'},jobs:{LOW_INC:15},serviceValue:{garbage:5000}},
            PARK_S:{n:"小型公园",c:300,cat:'service',m:5,ui:{ic:'🌳'},serviceValue:{leisure: 10, landValue: 5}},
            MAYOR_STATUE:{n:"市长雕像",c:5000,cat:'special',m:10,unique:true,ui:{ic:'🗿'},serviceValue:{leisure: 25, landValue: 20}},
            BANK:{n:"银行",c:8000,cat:'service',pU:-15,m:250,ui:{ic:'🏦'},jobs:{HIGH_INC:20},reqTech:['BANKING'],eff:{loanInterestRateMod:-0.005}}
        };
        const TECHS={ZONING_MED_DENSITY:{n:"中密度规划",c:100,t:8,pre:[],eff:{unlock:['CZONE_MD_L1']}},ZONING_HIGH_DENSITY:{n:"高密度规划",c:250,t:15,pre:['ZONING_MED_DENSITY','URBAN_PLANNING']},ADV_EDUCATION:{n:"高等教育",c:150,t:10,pre:['URBAN_PLANNING'],eff:{unlock:['HIGH_SCHOOL','UNIVERSITY'],global:{citizenUpgradeChance:0.05}}},BANKING:{n:"银行业",c:300,t:15,pre:[],eff:{unlock:['BANK'],global:{loanInterestRateMod:-0.01}}}};
        const POLICIES={TAX_HIKE_RES:{n:"提高住宅税",desc:"住宅税率+2%",eff:{type:'tax_change',target:'res',val:2,mode:'add'},satisImpact:-3,active:false},FREE_PUBLIC_TRANSPORT:{n:"免费公交",desc:"交通压力-15%,满意度+5,每日高额成本",eff:{global:{trafficIndexMod:-0.15,satisfactionMod:5}},costPerDay:500,active:false,reqTech:['PUBLIC_TRANSIT']},POWER_SAVING:{n:"节能倡议",desc:"电力消耗-10%,工业产出略降",eff:{global:{powerDemandMod:-0.1,industrialOutputMod:-0.02}},costPerDay:20,active:false}};
        const DISTRICT_SPECIALIZATIONS={GENERIC:{n:"通用区",desc:"无特定加成。",effects:{}},FINANCIAL:{n:"金融区",desc:"+20%办公税,办公楼运营成本-10%",effects:{taxModOffice:0.2,officeCostMod:-0.1},reqTech:['BANKING']},TOURISM:{n:"旅游区",desc:"+15%商业收入,吸引游客",effects:{comRevenueMod:0.15,tourismAttraction:10},reqTech:[]}};
        const MAYOR_ACTIONS={SPEECH_INSPIRING:{n:"鼓舞演讲",desc:"全市满意度+5%(3天)",c:1000,eff:{type:'timed_boost',target:'avgSatisfaction',val:5,dur:3,advisorEnergyCost:10}},FEED_ADVISOR:{n:"喂食顾问",desc:"顾问精力+50,快乐+20(需1零食)",c:0,eff:{type:'advisor_feed'},unlockReq:{item:'SPECIAL_SNACKS',qty:1},advisorEnergyCost:0}};
        
        // --- Initialize & Event Listeners ---
        document.addEventListener('DOMContentLoaded',()=>{document.getElementById('profile-pic').src=CONFIG.PROFILE_PIC_PATH;Chart.defaults.font.family="'Noto Sans SC',sans-serif";Chart.defaults.font.size=12;setupEventListeners();initVFX();initMouseBunny();initCitySim();updateTiming();setInterval(updateTiming,1000);loadAndProcessPetData();lastFrameTime=performance.now();requestAnimationFrame(animationLoop);setInterval(updateAdvisorBunny,5000);});
        function setupEventListeners(){window.addEventListener('pointermove',e=>{mouse.lastX=mouse.x;mouse.x=e.clientX;mouse.y=e.clientY;mouse.dx=mouse.x-mouse.lastX;docEl.style.setProperty('--mouse-x',`${e.clientX}px`);docEl.style.setProperty('--mouse-y',`${e.clientY}px`);});window.addEventListener('resize',()=>{[mouseTrailCanvas,vfxCanvas].forEach(c=>{c.width=window.innerWidth;c.height=window.innerHeight;});renderPopulationChart();if(weightRecords.length>0)renderWeightChart();});window.addEventListener('pointerdown',e=>{createClickRipple(e.clientX,e.clientY);initAudio();});avatarContainer.addEventListener('pointerdown',handleAvatarClick);mainTitleArea.addEventListener('click',handleTitleClickForGodMode);document.getElementById('font-toggle-button').addEventListener('click',toggleFont);document.getElementById('prev-theme-page').addEventListener('click',()=>changeThemePage(-1));document.getElementById('next-theme-page').addEventListener('click',()=>changeThemePage(1));document.getElementById('custom-color-input').addEventListener('change',applyCustomColorOrGodModeKey);document.getElementById('sim-next-day-button').addEventListener('click',advanceDay);document.getElementById('sim-save-button').addEventListener('click',saveCity);document.getElementById('sim-load-button').addEventListener('click',loadCity);document.getElementById('sim-delete-button').addEventListener('click',deleteCity);document.getElementById('log-toggle-city').addEventListener('click',()=>toggleLogView('city'));document.getElementById('log-toggle-pet').addEventListener('click',()=>toggleLogView('pet'));}
        
        // --- Core Animation Loop & VFX ... ---
        function animationLoop(cT){const dT=cT-lastFrameTime;lastFrameTime=cT;vfxCtx.clearRect(0,0,vfxCanvas.width,vfxCanvas.height);updateAndDrawCosmicDust();updateAndDrawClickRipples();updateAndDrawForceParticles();updateAndDrawMouseBunny();updateAndDrawCelestialParticles(vfxCtx);frameCount++;if(cT-lastPerfUpdateTime>500){updatePerfPanel(cT);}requestAnimationFrame(animationLoop);}
        function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
        function playSound(type,opts={}){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);let d=1;o.type=opts.w||'sine';g.gain.setValueAtTime(opts.v||.1,audioCtx.currentTime);o.frequency.setValueAtTime(opts.fS||440,audioCtx.currentTime);if(type==='dissolve'){o.type='sawtooth';o.frequency.setValueAtTime(1500,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(50,audioCtx.currentTime+3);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+3);d=3;}else if(type==='rebuild'){o.type='sine';o.frequency.setValueAtTime(80,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(2500,audioCtx.currentTime+4);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+4.2);d=4.2;}else if(type==='confirm'){o.frequency.setValueAtTime(600,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.1);d=.1;}else if(type==='special'){o.type='triangle';o.frequency.setValueAtTime(800,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(1600,audioCtx.currentTime+.15);o.frequency.linearRampToValueAtTime(400,audioCtx.currentTime+.3);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.4);d=.4;}else if(type==='milestone'){o.type='sine';o.frequency.setValueAtTime(523.25,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(1046.5,audioCtx.currentTime+.3);g.gain.setValueAtTime(.15,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+.5);d=.5;}o.start();o.stop(audioCtx.currentTime+d);}
        function initVFX(){[vfxCanvas,mouseTrailCanvas].forEach(c=>{c.width=window.innerWidth;c.height=window.innerHeight;});for(let i=0;i<CONFIG.COSMIC_DUST_COUNT;i++){cosmicDust.push({x:Math.random()*vfxCanvas.width,y:Math.random()*vfxCanvas.height,z:Math.random()*1e3,vx:(Math.random()-.5)*.1,vy:(Math.random()-.5)*.1,s:Math.random()*1.5+.5});}}
        function updateAndDrawCosmicDust(){vfxCtx.fillStyle=`rgba(var(--text-color-rgb),.5)`;cosmicDust.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=vfxCanvas.width;if(p.x>vfxCanvas.width)p.x=0;if(p.y<0)p.y=vfxCanvas.height;if(p.y>vfxCanvas.height)p.y=0;vfxCtx.beginPath();vfxCtx.arc(p.x,p.y,p.s,0,Math.PI*2);vfxCtx.fill();});}
        function createClickRipple(x,y){clickRipples.push({x,y,r:0,mR:60,l:1});}
        function updateAndDrawClickRipples(){clickRipples=clickRipples.filter(r=>r.l>0);clickRipples.forEach(r=>{r.r=(1-r.l)*r.mR;r.l-=.04;vfxCtx.strokeStyle=`rgba(var(--accent-rgb),${r.l})`;vfxCtx.lineWidth=2;vfxCtx.beginPath();vfxCtx.arc(r.x,r.y,r.r,0,Math.PI*2);vfxCtx.stroke();});}
        function createForceBurst(count,x,y,colorOverride=null,speedMod=1,sizeMod=1){const rect=avatarContainer.getBoundingClientRect();x=x||rect.left+rect.width/2;y=y||rect.top+rect.height/2;for(let i=0;i<count;i++){const a=Math.random()*Math.PI*2,s=(Math.random()*8+4)*speedMod;forceParticles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,l:1,sz:(Math.random()*4+2)*sizeMod,c:colorOverride||(Math.random()>.3?`var(--glow-rgb)`:Math.random()>.5?`var(--accent-rgb)`:`255,255,255`)});}}
        function updateAndDrawForceParticles(){forceParticles=forceParticles.filter(p=>p.l>0);forceParticles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=.97;p.vy*=.97;p.vy+=.05;p.l-=.015;const clr=p.c.startsWith('var')?getComputedStyle(docEl).getPropertyValue(p.c.slice(4,-1)).trim():p.c;vfxCtx.fillStyle=`rgba(${clr},${p.l*p.l})`;vfxCtx.beginPath();vfxCtx.arc(p.x,p.y,Math.max(0,p.sz*p.l),0,Math.PI*2);vfxCtx.fill();});}
        function initMouseBunny(){for(let i=0;i<CONFIG.MOUSE_SNAKE_LENGTH;i++){mouseSnake.push({x:mouse.x,y:mouse.y});}}
        function updateAndDrawMouseBunny(){mouseTrailCtx.clearRect(0,0,mouseTrailCanvas.width,mouseTrailCanvas.height);let h={...mouseSnake[0]};h.x+=(mouse.x-h.x)*.25;h.y+=(mouse.y-h.y)*.25;mouseSnake.unshift(h);if(mouseSnake.length>CONFIG.MOUSE_SNAKE_LENGTH)mouseSnake.pop();const gR=getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim(),aR=getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim();for(let i=1;i<mouseSnake.length;i++){const gr=mouseTrailCtx.createLinearGradient(mouseSnake[i-1].x,mouseSnake[i-1].y,mouseSnake[i].x,mouseSnake[i].y);const op=1-(i/mouseSnake.length);gr.addColorStop(0,`rgba(${gR},${op*.8})`);gr.addColorStop(1,`rgba(${aR},${op*.8})`);mouseTrailCtx.strokeStyle=gr;mouseTrailCtx.lineWidth=1+(mouseSnake.length-i)*.15;mouseTrailCtx.beginPath();mouseTrailCtx.moveTo(mouseSnake[i-1].x,mouseSnake[i-1].y);mouseTrailCtx.lineTo(mouseSnake[i].x,mouseSnake[i].y);mouseTrailCtx.stroke();}mouseBunnyEl.style.left=`${h.x}px`;mouseBunnyEl.style.top=`${h.y}px`;if(mouse.dx!==0)mouseBunnyEl.style.transform=`translate(-50%,-50%) scaleX(${mouse.dx>0?1:-1})`;}
        function handleAvatarClick(){if(avatarState==='normal'){currentAvatarEffect=(currentAvatarEffect+1)%CONFIG.AVATAR_EFFECT_PRESETS;dissolveAvatar(currentAvatarEffect);}}
        function dissolveAvatar(effectType){if(avatarState!=='normal')return;avatarState='animating';const pic=document.getElementById('profile-pic');pic.style.opacity='0';const rect=avatarContainer.getBoundingClientRect(),cX=rect.left+rect.width/2,cY=rect.top+rect.height/2;celestialParticles=[];let totalDuration=10000;playSound('dissolve',{v:.2,fS:1800,fE:100,d:4});const effects=[()=>{const t=['☰','☱','☲','☳','☴','☵','☶','☷'],e="255,140,0",o="255,182,193";for(let a=0;a<2;a++)for(let r=0;r<120;r++){const s=Math.PI*a+r/120*Math.PI,c=20+0.7*r;celestialParticles.push({x:cX,y:cY,r:c,a:s,s:2,c:a===0?`rgb(var(--text-color-rgb))`: `rgb(var(--bg-color))`,st:"taiji_form",l:1,sp:0.005*(Math.random()-0.5)})}for(let a=0;a<2;a++)celestialParticles.push({x:cX,y:cY,s:25,txt:a===0?"🐰":"🥕",c:a===0?o:e,st:"taiji_eye",l:1,tEnd:7e3,rot:0,rotSpd:a===0?0.02:-0.02,radius:35,angleOffset:a*Math.PI});for(let a=0;a<8;a++){const r=a/8*2*Math.PI-Math.PI/8;celestialParticles.push({x:cX,y:cY,s:18,txt:t[a],c:"gold",st:"taiji_bagua",l:0,tEnd:6e3,radius:80,angle:r})}},()=>{const t=['輝','力','速','α','β','γ','δ','Ω'];for(let a=0;a<5;a++)for(let r=0;r<24+8*a;r++){const s=r/(24+8*a)*2*Math.PI;celestialParticles.push({x:cX,y:cY,r:40+20*a,a:s,s:1.2+0.15*a,c:`hsla(${160+25*a+20*Math.random()},90%,75%,.6)`,st:"granzort_form",l:0,sp:(0.0015+8e-4*a)*(a%2==0?1:-1),tEnd:7e3})}for(let a=0;a<8;a++){const r=a/8*2*Math.PI+Math.PI/16;celestialParticles.push({x:cX,y:cY,s:18,txt:t[a],c:"cyan",st:"granzort_rune",l:0,tEnd:7e3,radius:160,angle:r,sparkle:0})}celestialParticles.push({x:cX,y:cY,s:30,txt:"🐰",c:"255,182,193",st:"granzort_center",l:1,tEnd:7e3,rot:0});celestialParticles.push({x:cX,y:cY,s:25,txt:"🥕",c:"255,140,0",st:"granzort_swirl",l:1,tEnd:7e3,radius:50,angle:0,rotSpd:0.05})},()=>{for(let t=0;t<200;t++)celestialParticles.push({x:cX,y:cY,vx:15*(Math.random()-0.5),vy:15*(Math.random()-0.5),l:1,s:Math.random()*3+1,c:`hsl(${60*Math.random()+180},100%,70%)`,st:"crystal_burst"});for(let t=0;t<5;t++)celestialParticles.push({x:cX,y:cY,st:"crystal_ribbon",l:1,len:150,points:[],angle:2*Math.random()*Math.PI,speed:(2*Math.random()+1)*(t%2==0?1:-1),c1:`hsl(${60*Math.random()+280},100%,70%)`,c2:`hsl(${60*Math.random()},100%,70%)`});celestialParticles.push({x:cX,y:cY,s:40,txt:"🐰",c:"255,182,193",st:"crystal_core",l:0,tEnd:7e3})},()=>{for(let t=0;t<400;t++){const a=2*Math.random()*Math.PI,r=100*Math.random()+50;celestialParticles.push({x:cX+Math.cos(a)*r,y:cY+Math.sin(a)*r,s:Math.random()*2,l:1,st:"singularity_disk",angle:a,radius:r,speed:0.01/r})}celestialParticles.push({x:cX,y:cY,s:20,txt:"🐰",c:"255,182,193",st:"singularity_core",l:1,tEnd:8e3,scale:1});celestialParticles.push({x:cX,y:cY,s:20,txt:"🥕",c:"255,140,0",st:"singularity_core",l:1,tEnd:8e3,scale:1})},()=>{for(let t=0;t<500;t++)celestialParticles.push({x:cX,y:cY,vx:12*(Math.random()-0.5),vy:25*(Math.random()-0.5),l:1,s:Math.random()+0.5,c:Math.random()>0.1?"#0f0":`rgb(var(--glow-rgb))`,st:"overload_rain"});for(let t=0;t<2;t++)celestialParticles.push({x:cX,y:cY,s:30,txt:t===0?"🐰":"🥕",c:t===0?"#fff":"#f80",st:"overload_glitch",l:1,tEnd:8e3,ox:0,oy:0})}];(effects[effectType]||effects[0])();setTimeout(()=>{playSound('rebuild',{v:.25,fS:100,fE:2000,d:3});celestialParticles.forEach(p=>p.st='converging');},7500);setTimeout(()=>{celestialParticles=[];pic.style.opacity='1';avatarState='normal';createForceBurst(120,cX,cY,null,1.8,1.8);},totalDuration);}
        function updateAndDrawCelestialParticles(ctx){if(celestialParticles.length===0)return;const rect=avatarContainer.getBoundingClientRect(),cX=rect.left+rect.width/2,cY=rect.top+rect.height/2;celestialParticles=celestialParticles.filter(p=>p.l>0);celestialParticles.forEach(p=>{p.l=Math.max(0,p.l-0.001);p.angle=(p.angle||0)+(p.sp||0);p.rot=(p.rot||0)+(p.rotSpd||0);switch(p.st){case'taiji_form':p.r*=.98;p.x=cX+Math.cos(p.angle)*p.r;p.y=cY+Math.sin(p.angle)*p.r;break;case'taiji_eye':p.angle+=p.rotSpd;p.x=cX+Math.cos(p.angle+p.angleOffset)*p.radius;p.y=cY+Math.sin(p.angle+p.angleOffset)*p.radius;break;case'taiji_bagua':p.l=Math.min(1,p.l+0.05);p.radius=Math.max(80,p.radius-0.1);p.x=cX+Math.cos(p.angle)*p.radius;p.y=cY+Math.sin(p.angle)*p.radius;break;case'granzort_form':p.l=Math.min(1,p.l+0.03);p.angle+=p.sp;p.r+=0.1;p.x=cX+Math.cos(p.angle)*p.r;p.y=cY+Math.sin(p.angle)*p.r;break;case'granzort_rune':p.l=Math.min(1,p.l+0.04);if(Math.random()<0.1)p.sparkle=1;p.x=cX+Math.cos(p.angle)*p.radius;p.y=cY+Math.sin(p.angle)*p.radius;break;case'granzort_center':break;case'granzort_swirl':p.angle+=p.rotSpd;p.x=cX+Math.cos(p.angle)*p.radius;p.y=cY+Math.sin(p.angle)*p.radius;break;case'crystal_burst':p.x+=p.vx;p.y+=p.vy;p.vx*=.98;p.vy*=.98;p.l-=0.01;break;case'crystal_ribbon':p.angle+=p.speed*0.01;let head={x:p.x+Math.cos(p.angle)*p.len,y:p.y+Math.sin(p.angle)*p.len};p.points.unshift(head);if(p.points.length>50)p.points.pop();p.l-=0.005;break;case'crystal_core':p.l=Math.min(1,p.l+0.02);p.s=40*p.l;break;case'singularity_disk':p.radius-=0.2;p.angle+=p.speed;p.x=cX+Math.cos(p.angle)*p.radius;p.y=cY+Math.sin(p.angle)*p.radius;if(p.radius<1)p.l=0;break;case'singularity_core':p.scale*=.99;p.s*=p.scale;break;case'overload_rain':p.y+=p.vy;p.vy+=0.1;if(p.y>cY*2)p.l=0;break;case'overload_glitch':p.ox=10*(Math.random()-.5);p.oy=10*(Math.random()-.5);p.l-=0.005;break;case'converging':p.x+=(cX-p.x)*.08;p.y+=(cY-p.y)*.08;p.s=Math.max(0,(p.s||1)-0.1);p.l-=0.02;break;}ctx.save();ctx.globalAlpha=Math.max(0,Math.min(1,p.l));if(p.txt){ctx.font=`${Math.max(1,p.s||12)}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle=p.c||`rgb(var(--text-color-rgb))`;ctx.save();ctx.translate(p.ox||0,p.oy||0);ctx.fillText(p.txt,p.x,p.y);ctx.restore();}else if(p.st==='crystal_ribbon'){if(p.points.length>1){ctx.beginPath();ctx.moveTo(p.points[0].x,p.points[0].y);for(let i=1;i<p.points.length;i++){ctx.lineWidth=i/p.points.length*10;let grad=ctx.createLinearGradient(p.points[i-1].x,p.points[i-1].y,p.points[i].x,p.points[i].y);grad.addColorStop(0,p.c1);grad.addColorStop(1,p.c2);ctx.strokeStyle=grad;ctx.lineTo(p.points[i].x,p.points[i].y);ctx.stroke();}}}else{ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,Math.max(.5,p.s||1),0,Math.PI*2);ctx.fill();if(p.sparkle>0){ctx.fillStyle=`rgba(255,255,255,${p.sparkle})`;ctx.beginPath();ctx.arc(p.x,p.y,p.s*2,0,2*Math.PI);ctx.fill();p.sparkle-=0.1;}}ctx.restore();});ctx.globalAlpha=1;}
        
        // --- City Simulation Core ---
        function initCitySim(){try{const sS=localStorage.getItem(CONFIG.CITY_SAVE_KEY);if(sS&&!godModeActive){city=validateLoadedCity(JSON.parse(sS));logCityEvent("从浏览器加载存档成功！","system");}else{generateNewCityState();if(!godModeActive)logCityEvent(`欢迎来到 ${city.name}，市长！`,'system');}}catch(e){console.error("加载或初始化城市失败:",e);generateNewCityState();logCityEvent("存档损坏或发生错误，已重置为新城市。","error");}initCitySimAfterLoad();}
        function generateNewCityState(){city={id:`city_${Date.now()}_${Math.floor(Math.random()*900)+100}`,name:"兔克市"+(Math.floor(Math.random()*900)+100),day:1,year:1,funds:20000,population:0,citizensByWealth:{LOW_INC:0,MED_INC:0,HIGH_INC:0},taxRate:{res:9,com:10,ind:8,office:11},budget:{services:100,education:100,health:100,safety:100,transport:100,garbage:100,maintenance:100},buildings:[],districts:[{name:"市中心",type:"GENERIC"}],activePolicies:{},unlockedTech:[],eventLog:[],populationHistory:[{d:0,p:0}],timedBoosts:[],inventory:{SPECIAL_SNACKS:3},cityLevel:1,cityXP:0,cityXPNext:100,loans:[],stats:{avgSatisfaction:60,environmentQuality:80,landValue:50,educationLevel:0,healthLevel:70,crimeRate:5,fireRisk:5,trafficIndex:10,unemploymentRate:0,powerSatisfaction:1,waterSatisfaction:1,goodsSatisfaction:1,leisureSatisfaction:1},demand:{res:50,com:30,ind:40},rawMaterialsStock:{STONE:50,WOOD:50,OIL:20,ORE:30,FARM:60,COAL:40}}; }
        
        function validateLoadedCity(loadedCity) {
            const defaultCity = generateNewCityState(); 
            // This function recursively ensures that every key from the default city exists in the loaded city.
            function deepMerge(target, source) {
                for (const key in source) {
                    if (source[key] instanceof Object && !Array.isArray(source[key])) {
                        if (!target[key] || typeof target[key] !== 'object') {
                            target[key] = {};
                        }
                        deepMerge(target[key], source[key]);
                    } else if (target[key] === undefined) {
                        target[key] = source[key];
                    }
                }
                return target;
            }
            return deepMerge(loadedCity, defaultCity);
        }

        function advanceDay(){city.day++;if(city.day>30){city.day=1;city.year++;logCityEvent(`新的一年，Y${city.year}，开始了！`,'milestone');}city.timedBoosts=city.timedBoosts.filter(b=>{b.remainingDays--;return b.remainingDays>0;});let dailyExpenses=0;Object.values(city.buildings).forEach(b=>{dailyExpenses+=(BUILDINGS[b.id]?.m||0)*(city.budget.maintenance/100);});Object.keys(city.activePolicies).forEach(pKey=>{dailyExpenses+=(POLICIES[pKey]?.costPerDay||0);});(city.loans||[]).forEach(l=>{if(l.remainingTerm>0){l.remainingTerm--;dailyExpenses+=l.paymentPerDay;if(l.remainingTerm===0)logCityEvent(`贷款已还清！`,'finance');}});city.loans=(city.loans||[]).filter(l=>l.remainingTerm>0);city.funds-=dailyExpenses;if(dailyExpenses>0)logCityEvent(`每日支出: ${dailyExpenses.toFixed(0)}💰`,'finance');let cityTotals={powerCapacity:0,waterCapacity:0,powerDemand:0,waterDemand:0,jobs:{},goodsProduced:{},goodsConsumed:{},rawMaterialsProduced:{},rawMaterialsConsumed:{},serviceValues:{garbage:0,education:0,health:0,fireSafety:0,police:0,leisure:0,landValue:0}};(city.buildings||[]).forEach(b=>{const bd=BUILDINGS[b.id];if(!bd||b.isAbandoned)return;let efficiency=(b.hasPower&&b.hasWater)?1:0.3;cityTotals.powerDemand+=bd.pU||0;cityTotals.waterDemand+=bd.wU||0;if(bd.pOut)cityTotals.powerCapacity+=bd.pOut*(city.budget.services/100);if(bd.wOut)cityTotals.waterCapacity+=bd.wOut*(city.budget.services/100);Object.entries(bd.jobs||{}).forEach(([type,num])=>cityTotals.jobs[type]=(cityTotals.jobs[type]||0)+num);if(efficiency>0.5){Object.entries(bd.goodsProduced||{}).forEach(([type,num])=>cityTotals.goodsProduced[type]=(cityTotals.goodsProduced[type]||0)+num*efficiency);Object.entries(bd.rawMaterialsProduced||{}).forEach(([type,num])=>cityTotals.rawMaterialsProduced[type]=(cityTotals.rawMaterialsProduced[type]||0)+num*efficiency);}Object.entries(bd.goodsConsumed||{}).forEach(([type,num])=>cityTotals.goodsConsumed[type]=(cityTotals.goodsConsumed[type]||0)+num);Object.entries(bd.rawMaterialsConsumed||{}).forEach(([type,num])=>cityTotals.rawMaterialsConsumed[type]=(cityTotals.rawMaterialsConsumed[type]||0)+num);Object.entries(bd.serviceValue||{}).forEach(([type,val])=>cityTotals.serviceValues[type]+=val*(city.budget.services/100));});let productionHalted=false;Object.entries(cityTotals.rawMaterialsConsumed).forEach(([type,num])=>{if(city.rawMaterialsStock[type]<num)productionHalted=true;city.rawMaterialsStock[type]=Math.max(0,city.rawMaterialsStock[type]-num);});if(productionHalted){logCityEvent("原材料不足，部分工厂停产！","warning");Object.keys(cityTotals.goodsProduced).forEach(k=>cityTotals.goodsProduced[k]*=0.5);}Object.entries(cityTotals.rawMaterialsProduced).forEach(([type,num])=>city.rawMaterialsStock[type]+=num);city.population=Object.values(city.citizensByWealth).reduce((a,b)=>a+b,0);const totalJobs=Object.values(cityTotals.jobs).reduce((a,b)=>a+b,0);city.stats.unemploymentRate=Math.max(0,1-totalJobs/Math.max(1,city.population*0.6));let canUpgrade=Math.floor(city.citizensByWealth.LOW_INC*city.stats.educationLevel*0.02);city.citizensByWealth.LOW_INC-=canUpgrade;city.citizensByWealth.MED_INC+=canUpgrade;city.stats.powerSatisfaction=Math.min(1,cityTotals.powerCapacity/Math.max(1,cityTotals.powerDemand));city.stats.waterSatisfaction=Math.min(1,cityTotals.waterCapacity/Math.max(1,cityTotals.waterDemand));city.stats.goodsSatisfaction=Math.min(1,(cityTotals.goodsProduced.goods_basic||0)/Math.max(1,cityTotals.goodsConsumed.goods_basic||0));city.stats.healthLevel=Math.min(100,50+(cityTotals.serviceValues.health/Math.max(1,city.population))*100);city.stats.crimeRate=Math.max(0,10-(cityTotals.serviceValues.police/Math.max(1,city.population))*200-city.stats.unemploymentRate*10);city.stats.fireRisk=Math.max(0,10-(cityTotals.serviceValues.fireSafety/Math.max(1,city.population))*200);city.stats.educationLevel=Math.min(1,cityTotals.serviceValues.education/Math.max(1,city.population*0.4));city.stats.leisureSatisfaction=Math.min(1,cityTotals.serviceValues.leisure/Math.max(1,city.population));let satisfactionFactors=[city.stats.powerSatisfaction,city.stats.waterSatisfaction,city.stats.goodsSatisfaction,city.stats.healthLevel/100,1-city.stats.crimeRate/10,1-city.stats.fireRisk/10,city.stats.leisureSatisfaction,1-city.stats.unemploymentRate];city.stats.avgSatisfaction=satisfactionFactors.reduce((a,b)=>a+b,0)/satisfactionFactors.length*100;const housingCapacity=(city.buildings||[]).filter(b=>BUILDINGS[b.id]?.cat==='residential').reduce((acc,b)=>acc+(BUILDINGS[b.id]?.cap||0),1);city.demand.res=Math.max(0,Math.min(100,(city.stats.avgSatisfaction-40)*2-(city.population/housingCapacity)*50));city.demand.com=Math.max(0,Math.min(100,20+(city.population/500)*city.stats.goodsSatisfaction));city.demand.ind=Math.max(0,Math.min(100,(city.stats.unemploymentRate*200)-20));let popChange=0;if(city.stats.avgSatisfaction>55&&city.demand.res>30){popChange=Math.floor(city.stats.avgSatisfaction/100*(1-city.stats.unemploymentRate)*(city.population*0.01+5));}else if(city.stats.avgSatisfaction<45){popChange=-Math.floor((1-city.stats.avgSatisfaction/100)*(city.population*0.01));}popChange=Math.min(popChange,housingCapacity-city.population);city.citizensByWealth.LOW_INC=Math.max(0,city.citizensByWealth.LOW_INC+popChange);if(popChange>0)logCityEvent(`人口增加: +${popChange} (低收入) 🧑‍🤝‍🧑`,'info');else if(popChange<0)logCityEvent(`人口减少: ${popChange} 🧑‍🤝‍🧑`,'warning');(city.populationHistory||[]).push({d:city.year*30+city.day,p:city.population});if(city.populationHistory.length>250)city.populationHistory.shift();city.buildings.forEach(b=>{const bd=BUILDINGS[b.id];b.hasPower=city.stats.powerSatisfaction>0.8;b.hasWater=city.stats.waterSatisfaction>0.8;let buildingServiceSat=(b.hasPower+b.hasWater+(1-city.stats.fireRisk/10)+(1-city.stats.crimeRate/10))/4;if(bd.upgTo&&bd.upgReq&&city.stats.landValue>bd.upgReq.landValue&&buildingServiceSat>bd.upgReq.serviceSat){b.id=bd.upgTo;logCityEvent(`${bd.n} 升级为 ${BUILDINGS[b.id].n}!`,'build');}else if(!b.hasPower&&!b.hasWater&&city.stats.unemploymentRate>0.5){b.isAbandoned=true;logCityEvent(`${bd.n} 已被废弃！`,'warning');}});let dailyIncome=0;const taxEfficiency=(city.stats.avgSatisfaction/100)*0.5+0.5;dailyIncome+=city.citizensByWealth.LOW_INC*1*(city.taxRate.res/100);dailyIncome+=city.citizensByWealth.MED_INC*2*(city.taxRate.res/100);dailyIncome+=city.citizensByWealth.HIGH_INC*4*(city.taxRate.res/100);dailyIncome+=(city.buildings||[]).filter(b=>BUILDINGS[b.id].cat==='commercial'&&!b.isAbandoned).length*100*(city.taxRate.com/100);dailyIncome+=(city.buildings||[]).filter(b=>BUILDINGS[b.id].cat==='industrial'&&!b.isAbandoned).length*80*(city.taxRate.ind/100);dailyIncome=Math.floor(dailyIncome*taxEfficiency);city.funds+=dailyIncome;if(dailyIncome>0)logCityEvent(`每日税收: +${dailyIncome}💰`,'finance');city.cityXP+=Math.floor(dailyIncome/10+city.population/10);if(city.cityXP>=city.cityXPNext){city.cityLevel++;city.cityXP-=city.cityXPNext;city.cityXPNext=Math.floor(city.cityXPNext*1.5);logCityEvent(`城市已升级至 ${city.cityLevel} 级!`,'milestone');playSound('milestone');}updateCityUI();}
        function updateCityUI(){const{funds,population,year,day,researchPoints,cityLevel,cityXP,cityXPNext,citizensByWealth,stats,demand,rawMaterialsStock}=city||{};const safeCitizens=citizensByWealth||{LOW_INC:0,MED_INC:0,HIGH_INC:0};const safeStats=stats||{};const safeDemand=demand||{};const safeBuildings=city?.buildings||[];simEls.f.textContent=(funds||0).toFixed(0);simEls.p.textContent=`${population||0} (${safeCitizens.LOW_INC}/${safeCitizens.MED_INC}/${safeCitizens.HIGH_INC})`;const powerCapacity=safeBuildings.reduce((a,b)=>a+(BUILDINGS[b.id]?.pOut||0),0);const powerDemand=safeBuildings.reduce((a,b)=>a+(BUILDINGS[b.id]?.pU||0),0);simEls.e.textContent=`${powerDemand.toFixed(0)}/${powerCapacity.toFixed(0)}`;const waterCapacity=safeBuildings.reduce((a,b)=>a+(BUILDINGS[b.id]?.wOut||0),0);const waterDemand=safeBuildings.reduce((a,b)=>a+(BUILDINGS[b.id]?.wU||0),0);simEls.w.textContent=`${waterDemand.toFixed(0)}/${waterCapacity.toFixed(0)}`;simEls.d.textContent=`Y${year||1}D${day||1}`;simEls.r.textContent=(researchPoints||0).toFixed(0);simEls.ue.textContent=`${((safeStats.unemploymentRate||0)*100).toFixed(1)}%`;simEls.cl.textContent=`${cityLevel||1} (${cityXP||0}/${cityXPNext||100})`;simEls.rm.textContent=Object.entries(rawMaterialsStock||{}).map(([k,v])=>`${(RAW_MATERIALS_TYPES[k]||{n:'X'}).n.substring(0,1)}:${(v||0).toFixed(0)}`).join(' ');simEls.sBar.style.width=`${safeStats.avgSatisfaction||0}%`;simEls.sP.textContent=(safeStats.avgSatisfaction||0).toFixed(1);simEls.eBar.style.width=`${safeStats.environmentQuality||0}%`;simEls.eP.textContent=(safeStats.environmentQuality||0).toFixed(1);simEls.tBar.style.width=`${safeStats.trafficIndex||0}%`;simEls.tP.textContent=(safeStats.trafficIndex||0).toFixed(1);simEls.edBar.style.width=`${((safeStats.educationLevel||0)*100)}%`;simEls.edP.textContent=(((safeStats.educationLevel||0)*100)).toFixed(1);simEls.rciRes.style.width=`${safeDemand.res||0}%`;simEls.rciCom.style.width=`${safeDemand.com||0}%`;simEls.rciInd.style.width=`${safeDemand.ind||0}%`;simEls.e.closest('.resource-item').style.color=(safeStats.powerSatisfaction||1)<0.95?'rgb(var(--color-red))':'inherit';simEls.w.closest('.resource-item').style.color=(safeStats.waterSatisfaction||1)<0.95?'rgb(var(--color-red))':'inherit';simEls.ue.closest('.resource-item').style.color=(safeStats.unemploymentRate||0)>0.1?'rgb(var(--color-yellow))':'inherit';}
        
        // --- UI Panel Rendering & Interaction ---
        function renderConstructionPanel(){let h=`<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-1 p-1">`;Object.entries(BUILDINGS).forEach(([k,b])=>{if(b.upgFrom)return;let rd='';const ul=!b.reqTech||(city.unlockedTech||[]).every(t=>b.reqTech.includes(t));if(!ul)rd+='(科技不足)';const ub=(b.unique&&(city.buildings||[]).some(bi=>bi.id===k));if(ub)rd+='(已建唯一)';const rl=!b.reqLevel||city.cityLevel>=b.reqLevel;if(!rl)rd+=`(需Lv${b.reqLevel})`;h+=`<button class="sim-button list-item aspect-[4/5] text-xs p-1 ${!ul||ub||!rl?'opacity-50 cursor-not-allowed':''}" onclick="${ul&&!ub&&rl?`tryBuild('${k}')`:''}" title="${b.n} | ${b.c}💰\n${b.m?'维护:'+b.m:''} | ${Object.entries(b.jobs||{}).map(([jt,jn])=>`${CITIZEN_TYPES[jt].name}:${jn}`).join(', ')}"><span class="text-xl">${b.ui.ic}</span><span>${b.n.substring(0,7)}</span><span class="text-yellow-400">${b.c}💰</span></button>`;});simPanels.con.innerHTML=h+'</div>';}
        function tryBuild(bKey){const b=BUILDINGS[bKey];if(city.funds<b.c){logCityEvent(`资金不足建 ${b.n}！`,'error');return;}city.funds-=b.c;(city.buildings||[]).push({id:bKey,instanceId:Date.now()+Math.random(),lvl:b.lvl||1,district:selectedDistrict,hasPower:false,hasWater:false,isAbandoned:false});logCityEvent(`在区域 ${city.districts[selectedDistrict].name} 建造了 ${b.n}。`,'build');advanceDay();}
        function renderDistrictPanel(){let h=`<div class="p-2 space-y-2">`;h+=`<div class="flex justify-between items-center mb-2"><div class="text-sm text-gray-400">当前建设区域: <strong class="accent-text">${(city.districts||[])[selectedDistrict].name}</strong></div><button class="sim-button text-xs px-2 py-1" onclick="createDistrict()">创建新区 (5000💰)</button></div>`;(city.districts||[]).forEach((d,idx)=>{h+=`<div class="list-item ${selectedDistrict===idx?'border-yellow-400':''}"><div class="flex justify-between items-center"><span class="font-bold cursor-pointer" onclick="selectDistrictForBuilding(${idx})">区域 ${idx+1}: ${d.name}</span><select class="god-mode-input bg-gray-800 text-xs w-auto py-1" onchange="specializeDistrict(${idx},this.value)">${Object.entries(DISTRICT_SPECIALIZATIONS).map(([key,spec])=>{const unlocked=!spec.reqTech||(city.unlockedTech||[]).every(t=>spec.reqTech.includes(t));return`<option value="${key}" ${d.type===key?'selected':''} ${!unlocked?'disabled':''}>${spec.n} ${!unlocked?'(需科技)':''}</option>`;}).join('')}</select></div></div>`;});h+='</div>';simPanels.dis.innerHTML=h;}
        function selectDistrictForBuilding(index){selectedDistrict=index;logCityEvent(`已选择在区域 "${(city.districts||[])[index].name}" 进行建设。`,'system');renderDistrictPanel();}
        function createDistrict(){if(city.funds>=5000){city.funds-=5000;const newIndex=(city.districts||[]).length;city.districts.push({name:`新区 ${newIndex+1}`,type:'GENERIC'});logCityEvent(`成功创建了新区 ${newIndex+1}！`,'build');renderDistrictPanel();}else{logCityEvent('资金不足以创建新区。','error');}}
        function specializeDistrict(index,type){const spec=DISTRICT_SPECIALIZATIONS[type];if(!spec.reqTech||(city.unlockedTech||[]).every(t=>spec.reqTech.includes(t))){city.districts[index].type=type;logCityEvent(`区域 ${index+1} 已被指定为 ${spec.n}。`,'action');renderDistrictPanel();advanceDay();}else{logCityEvent(`无法指定为 ${spec.n}，需要科技。`,'error');renderDistrictPanel();}}
        function renderBudgetPanel(){let h='<div class="p-2 space-y-3 text-xs">';h+=`<div class="grid grid-cols-2 gap-2"><strong>税率调整:</strong><div></div>`;Object.keys(city.taxRate).forEach(type=>{const catName=type.charAt(0).toUpperCase()+type.slice(1);h+=`<div><label class="text-sm accent-text">${catName} 税: ${city.taxRate[type]}%</label><input type="range" min="0" max="25" step="1" value="${city.taxRate[type]}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="this.previousElementSibling.textContent='${catName} 税: '+this.value+'%';" onchange="setTaxRate('${type}',this.value)"></div>`;});h+='</div><hr class="border-gray-700 my-2"><div class="grid grid-cols-2 gap-2"><strong>部门预算:</strong><div></div>';Object.keys(city.budget).forEach(cat=>{const catName=(cat.charAt(0).toUpperCase()+cat.slice(1));h+=`<div><label class="text-sm text-gray-400">${catName} 预算: ${city.budget[cat]}%</label><input type="range" min="50" max="150" step="10" value="${city.budget[cat]}" class="w-full h-2 bg-gray-700 rounded-lg" oninput="this.previousElementSibling.textContent='${catName} 预算: '+this.value+'%';" onchange="setBudget('${cat}',this.value)"></div>`;});h+='</div></div>';simPanels.bud.innerHTML=h;}
        function setTaxRate(type,rate){city.taxRate[type]=parseInt(rate);logCityEvent(`${type.charAt(0).toUpperCase()+type.slice(1)} 税率调整为 ${rate}%`,'action');updateCityUI();}
        function setBudget(cat,rate){city.budget[cat]=parseInt(rate);logCityEvent(`${cat.charAt(0).toUpperCase()+cat.slice(1)} 部门预算调整为 ${rate}%`,'action');updateCityUI();}
        function renderPolicyPanel(){let h='<div class="p-2 space-y-2">';Object.entries(POLICIES).forEach(([k,p])=>{const active=city.activePolicies[k];const unlocked=(!p.reqTech||(city.unlockedTech||[]).every(t=>p.reqTech.includes(t)));h+=`<div class="list-item ${!unlocked?'opacity-60':''}"><div class="flex justify-between items-center"><span class="font-bold ${!unlocked?'text-gray-500':''}">${p.n} ${active?'(生效中)':''}</span>${unlocked?`<button class="sim-button text-xs px-2 py-1" onclick="togglePolicy('${k}')">${active?'停用':'激活'}</button>`:'<span class="text-xs text-red-500">需科技</span>'}</div><p class="text-xs text-gray-400 mt-1">${p.desc}</p></div>`;});simPanels.pol.innerHTML=h+'</div>';}
        function togglePolicy(key){const policy=POLICIES[key];if(!policy.reqTech||(city.unlockedTech||[]).every(t=>p.reqTech.includes(t))){if(city.activePolicies[key]){delete city.activePolicies[key];logCityEvent(`政策 ${policy.n} 已停用。`,'policy_deact');}else{if(city.funds<(policy.costPerDay||0)*5&&policy.costPerDay>0){logCityEvent(`资金不足以支持政策 ${policy.n}。`,'error');return;}city.activePolicies[key]=true;logCityEvent(`政策 ${policy.n} 已激活。`,'policy_act');}}else{logCityEvent(`科技不足以激活政策 ${policy.n}。`,'error');}advanceDay();}
        function renderTechTreePanel(){let h='<div class="p-2 space-y-2">';Object.entries(TECHS).forEach(([k,t])=>{const researched=(city.unlockedTech||[]).includes(k);const canResearch=(!researched&&city.researchPoints>=t.c&&((t.pre||[]).length===0||(t.pre||[]).every(p=>(city.unlockedTech||[]).includes(p))));h+=`<div class="list-item ${researched?'border-green-500':(canResearch?'border-yellow-500':'border-gray-700')}"><div class="flex justify-between items-center"><span class="font-bold">${t.n} ${researched?'(已研发)':''}</span>${!researched?`<button class="sim-button text-xs px-2 py-1 ${!canResearch?'opacity-50 cursor-not-allowed':''}" onclick="${canResearch?`researchTech('${k}')`:''}">研发(${t.c}🔬, ${t.t}天)</button>`:''}</div><p class="text-xs text-gray-400 mt-1">${(t.pre||[]).length>0?'前置: '+t.pre.map(pk=>TECHS[pk]?.n||pk).join(', '):''}</p></div>`;});simPanels.tec.innerHTML=h+'</div>';}
        function researchTech(key){const tech=TECHS[key];if(city.currentResearch){logCityEvent(`已在研发 ${TECHS[city.currentResearch.key].n}。`,'info');return;}if(city.researchPoints>=tech.c&&((tech.pre||[]).length===0||(tech.pre||[]).every(p=>(city.unlockedTech||[]).includes(p)))){city.researchPoints-=tech.c;logCityEvent(`开始研发 ${tech.n}... 预计 ${tech.t} 天。`,'tech');city.currentResearch={key,daysLeft:tech.t};}else{logCityEvent(`无法研发 ${tech.n} (条件或点数不足)。`,'error');}renderTechTreePanel();}
        function renderMayorActionsPanel(){let h='<div class="p-2 space-y-2">';Object.entries(MAYOR_ACTIONS).forEach(([k,a])=>{const canAfford=(city.funds>=a.c&&advisorBunny.energy>=(a.advisorEnergyCost||0));const meetsReq=!a.unlockReq||(city.inventory[a.unlockReq.item]&&city.inventory[a.unlockReq.item]>=a.unlockReq.qty);h+=`<div class="list-item ${canAfford&&meetsReq?'':'opacity-60'}"><div class="flex justify-between items-center"><span class="font-bold">${a.n}</span><button class="sim-button text-xs px-2 py-1 ${!(canAfford&&meetsReq)?'opacity-50 cursor-not-allowed':''}" onclick="${canAfford&&meetsReq?`executeMayorAction('${k}')`:''}">执行 (${a.c}💰${a.advisorEnergyCost?', '+a.advisorEnergyCost+'活力':''})</button></div><p class="text-xs text-gray-400 mt-1">${a.desc}</p></div>`;});simPanels.may.innerHTML=h+'</div>';}
        function executeMayorAction(key){const action=MAYOR_ACTIONS[key];if(city.funds<action.c||advisorBunny.energy<(action.advisorEnergyCost||0)){logCityEvent(`无法执行 ${action.n}:资源或活力不足。`,'error');return;}city.funds-=action.c;advisorBunny.energy-=(action.advisorEnergyCost||0);if(action.eff.type==='timed_boost'){city.timedBoosts.push({target:action.eff.target,val:action.eff.val,remainingDays:action.eff.duration,source:`mayor_${key}`});}else if(action.eff.type==='advisor_feed'){advisorBunny.energy=Math.min(100,advisorBunny.energy+50);advisorBunny.happiness=Math.min(100,advisorBunny.happiness+20);city.inventory.SPECIAL_SNACKS--;}logCityEvent(`执行市长行动: ${action.n}`,'action');advanceDay();renderMayorActionsPanel();updateCityUI();}
        function showCityPanel(pId){Object.values(simPanels).forEach(p=>{if(p)p.style.display='none';});cityMainScreen.style.display='none';const targetPanel=document.getElementById(pId);if(targetPanel)targetPanel.style.display=pId==='city-main-screen'?'flex':'block';else cityMainScreen.style.display='flex';document.querySelectorAll('#city-action-tabs .sim-tab-button').forEach(b=>{b.classList.remove('active','border-b-2');b.style.borderBottomColor='transparent';});const actBtn=document.querySelector(`#city-action-tabs .sim-tab-button[onclick*="'${pId}'"]`);if(actBtn){actBtn.classList.add('active','border-b-2');actBtn.style.borderBottomColor='rgb(var(--accent-rgb))';}currentCityPanel=pId;const renderFunc=window[`render${pId.charAt(0).toUpperCase()+pId.slice(1).replace('-panel','Panel')}`];if(typeof renderFunc==='function')renderFunc();}
        function saveCity(){try{localStorage.setItem(CONFIG.CITY_SAVE_KEY,JSON.stringify(city));logCityEvent("城市进度已保存！","system");}catch(e){logCityEvent("保存失败！","error");}}
        function loadCity(){const sS=localStorage.getItem(CONFIG.CITY_SAVE_KEY);if(sS){try{city=validateLoadedCity(JSON.parse(sS));logCityEvent("加载存档成功！","system");}catch(e){generateNewCityState();logCityEvent("存档损坏，已重置。","error");}}else{logCityEvent("未找到存档。","system");}initCitySimAfterLoad();}
        function deleteCity(){if(confirm("您确定要删除所有城市数据并重新开始吗？此操作无法撤销。")){localStorage.removeItem(CONFIG.CITY_SAVE_KEY);generateNewCityState();logCityEvent("存档已删除，新游戏开始！","system");initCitySimAfterLoad();}}
        function initCitySimAfterLoad(){updateCityUI();Object.values(simPanels).forEach(p=>{if(p&&p.id.endsWith('-panel'))p.innerHTML='';});renderConstructionPanel();renderBudgetPanel();renderPolicyPanel();renderTechTreePanel();renderDistrictPanel();renderMayorActionsPanel();if(godModeActive)renderGodModePanel();renderPopulationChart();renderCityLog();}
        function handleTitleClickForGodMode(event){if(godModeActive||event.target.closest('.lcars-element'))return;const now=Date.now();if(now-lastTitleClickTime<2000){titleClickCount++;}else{titleClickCount=1;}lastTitleClickTime=now;if(titleClickCount>=CONFIG.GOD_MODE_TITLE_CLICKS){showCalculatorModal();titleClickCount=0;}}
        function showCalculatorModal(){const y=city.year,p=city.population%1000,l=city.cityLevel,f=Math.floor(city.funds/1000),r=city.researchPoints%100;const stage1Key=calculateGodModeKey_Stage1(y,p,l,f,r);calculatorInfoEl.innerHTML=`<p>上帝模式激活序列...</p><p>- 年份 (Y): <strong>${y}</strong> | 人口后三位 (P): <strong>${p}</strong></p><p>- 等级 (L): <strong>${l}</strong> | 资金千位 (F): <strong>${f}</strong></p><p>- 科研点后两位 (R): <strong>${r}</strong></p><hr class="my-2 border-gray-700"><p>游戏内生成的第一阶段激活码 (S1 Key):</p><p class="code-block">${stage1Key}</p>`;toggleCalculatorModal(true);}
        function toggleCalculatorModal(show){godModeCalculatorModal.classList.toggle('hidden',!show);godModeCalculatorModal.classList.toggle('opacity-0',!show);}
        function calculateGodModeKey_Stage1(y,p,l,f,r){let key=(y*17+p*3+l*29)^(f*11-r*7+CONFIG.GOD_MODE_CALC_SALT_S1);return Math.abs(key%899999)+100000;}
        function applyCustomColorOrGodModeKey(event){let val=event.target.value.trim().toUpperCase();let rgb;const hexMatch=val.match(/^#?([A-F\d]{2})([A-F\d]{2})([A-F\d]{2})$/i);if(hexMatch){rgb=`${parseInt(hexMatch[1],16)},${parseInt(hexMatch[2],16)},${parseInt(hexMatch[3],16)}`;}if(rgb){changeTheme({r:rgb});event.target.value='';}else{const y=city.year,p=city.population%1000,l=city.cityLevel,f=Math.floor(city.funds/1000),r=city.researchPoints%100;const s1Key=calculateGodModeKey_Stage1(y,p,l,f,r);const expectedFinalNumericPart=(s1Key+CONFIG.GOD_MODE_JS_ADDON)%10000;const expectedFinalKey=`BCC-GOD-${expectedFinalNumericPart.toString().padStart(4,'0')}`;if(val===expectedFinalKey){godModeActive=true;document.getElementById('god-mode-indicator').classList.remove('hidden');document.getElementById('god-mode-modal-indicator').classList.remove('hidden');document.getElementById('god-mode-tab-button').classList.remove('hidden');logCityEvent("上帝模式已通过激活码激活！",'godmode');showCityPanel('god-mode-panel');renderGodModePanel();toggleModal('theme-modal',false);event.target.value='';}else{logCityEvent("无效的颜色代码或最终激活码。",'error');}}}
        function renderGodModePanel(){if(!godModeActive)return;let h=`<div class="p-2 space-y-3 text-xs"><h3 class="text-lg accent-text font-bold">上帝模式控制台</h3><div class="grid grid-cols-2 gap-2"><div><label>资金:</label><input id="gm-funds" type="number" class="god-mode-input" value="${city.funds}"></div><div><label>科研点:</label><input id="gm-research" type="number" class="god-mode-input" value="${city.researchPoints}"></div></div><button class="sim-button bg-green-600 hover:bg-green-500" onclick="applyGodModeChanges()">应用更改</button></div>`;simPanels.god.innerHTML=h;}
        function applyGodModeChanges(){if(!godModeActive)return;city.funds=parseInt(document.getElementById('gm-funds').value)||city.funds;city.researchPoints=parseInt(document.getElementById('gm-research').value)||city.researchPoints;logCityEvent("上帝模式更改已应用。",'godmode');updateCityUI();}
        async function loadAndProcessPetData(){try{const r=await fetch(CONFIG.PET_RECORDS_PATH);if(!r.ok)return;const raw=await r.json();const proc=raw.map(rec=>{const d=new Date(Math.floor(rec.date)*1e3);d.setFullYear(d.getFullYear()+31);return{...rec,pD:d};});allPetRecords=[...proc].sort((a,b)=>b.pD-a.pD);weightRecords=proc.filter(rec=>rec.activity==='体重测量'&&rec.weight>0).sort((a,b)=>a.pD-b.pD);if(weightRecords.length>0){petWeightModule.style.display='block';renderWeightChart();}else{petWeightModule.style.display='none';}renderAllPetRecords();}catch(e){allRecordsContainer.innerHTML='<p class="text-xs text-gray-500 p-2">宠物档案数据 (PetRecords.json) 加载失败。</p>';}}
        function renderAllPetRecords(){if(!allRecordsContainer)return; if(!allPetRecords||allPetRecords.length===0){allRecordsContainer.innerHTML='<p class="text-xs text-gray-500 p-2">无宠物档案记录。</p>';return;}allRecordsContainer.innerHTML=allPetRecords.map(rec=>{const dS=rec.pD.toLocaleDateString('sv-SE');const wI=rec.weight>0?` - 重量: <strong class="glow-text">${rec.weight}g</strong>`:'';return`<div class="list-item"><div class="flex justify-between items-center"><p class="font-bold"><span class="accent-text">${rec.activity}</span>${wI}</p><time class="text-xs flex-shrink-0 ml-2" style="color:var(--text-muted-color)">${dS}</time></div><p class="text-sm mt-1" style="color:var(--text-muted-color)">笔记: ${rec.notes||'N/A'}</p></div>`;}).join('');}
        function renderWeightChart(){if(weightChartJS)weightChartJS.destroy();if(!weightChartEl||weightRecords.length===0){petWeightModule.style.display='none';return;}else{petWeightModule.style.display='block';}const gC=`rgb(${getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim()})`,aC=`rgb(${getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim()})`,mC=getComputedStyle(docEl).getPropertyValue('--text-muted-color').trim();const lbls=weightRecords.map(r=>r.pD.toLocaleDateString('zh-CN',{month:'2-digit',day:'2-digit'}));const data=weightRecords.map(r=>r.weight);const wIE=document.getElementById('weight-change-info');const updateInfoBox=(index)=>{if(index<0||index>=weightRecords.length)return;const currentRecord=weightRecords[index];let displayText=`选中: <strong class="glow-text">${currentRecord.weight}g</strong>`;if(index>0){const prevRecord=weightRecords[index-1];const diff=currentRecord.weight-prevRecord.weight;const diffText=diff>0?`▲ ${diff.toFixed(0)}g`:`▼ ${Math.abs(diff).toFixed(0)}g`;const diffColor=diff>0?'text-green-400':'text-red-400';displayText+=` | 较上次: <strong class="${diffColor}">${diffText}</strong>`;}else{displayText+=` (初始记录)`;}wIE.innerHTML=displayText;};updateInfoBox(weightRecords.length-1);const ctx=weightChartEl.getContext('2d');weightChartJS=new Chart(ctx,{type:'line',data:{labels:lbls,datasets:[{label:'重量(g)',data:data,borderColor:gC,backgroundColor:gC.replace(')',',.2)').replace('rgb','rgba'),pointBackgroundColor:aC,pointBorderColor:'#fff',tension:.3,fill:true,pointHitRadius:20}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true}},scales:{x:{ticks:{color:mC},grid:{color:'rgba(var(--glow-rgb),.1)'}},y:{ticks:{color:mC,callback:(v)=>`${v}g`},grid:{color:'rgba(var(--glow-rgb),.1)'},beginAtZero:false}},onClick:(e)=>{const points=weightChartJS.getElementsAtEventForMode(e,'point',{intersect:true},true);if(points.length){updateInfoBox(points[0].index);}}}});}
        function renderPopulationChart(){if(populationChartJS)populationChartJS.destroy();if(!populationChartEl||!(city?.populationHistory))return;const gC=`rgb(${getComputedStyle(docEl).getPropertyValue('--glow-rgb').trim()})`,aC=`rgb(${getComputedStyle(docEl).getPropertyValue('--accent-rgb').trim()})`,mC=getComputedStyle(docEl).getPropertyValue('--text-muted-color').trim();const lbls=(city.populationHistory||[]).map(h=>`Y${Math.floor(h.d/30)}D${h.d%30||30}`);const data=(city.populationHistory||[]).map(h=>h.p);const ctx=populationChartEl.getContext('2d');populationChartJS=new Chart(ctx,{type:'line',data:{labels:lbls,datasets:[{label:'人口',data:data,borderColor:gC,backgroundColor:gC.replace(')',',.2)').replace('rgb','rgba'),pointBackgroundColor:aC,pointBorderColor:'#fff',tension:.1,fill:true,pointRadius:data.length<30?3:0,pointHoverRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true}},scales:{x:{ticks:{color:mC,maxRotation:0,minRotation:0,autoSkipPadding:10},grid:{color:'rgba(var(--glow-rgb),.1)'}},y:{ticks:{color:mC},grid:{color:'rgba(var(--glow-rgb),.1)'},beginAtZero:true}}}});const pIE=document.getElementById('population-change-info');if((city.populationHistory||[]).length>=2){const l=city.populationHistory[city.populationHistory.length-1].p,p=city.populationHistory[city.populationHistory.length-2].p;const ch=l-p;const cT=ch>0?`▲ ${ch}`:(ch<0?`▼ ${Math.abs(ch)}`:'持平');pIE.innerHTML=`当前人口:<strong class="glow-text">${l}</strong>.较昨日:<strong class="${ch>0?'accent-text':(ch<0?'text-red-400':'text-gray-400')}">${cT}</strong>.`}else if((city.populationHistory||[]).length===1){pIE.innerHTML=`初始人口:<strong class="glow-text">${city.populationHistory[0].p}</strong>.`}else{pIE.innerHTML=`等待人口数据...`}}
        function toggleFont(){bodyEl.classList.toggle('font-pixel');const btn=document.getElementById('font-toggle-button');if(bodyEl.classList.contains('font-pixel')){Chart.defaults.font.family="'Press Start 2P','Noto Sans SC',sans-serif";Chart.defaults.font.size=10;btn.textContent="SYSTEM FONT";}else{Chart.defaults.font.family="'Noto Sans SC',sans-serif";Chart.defaults.font.size=12;btn.textContent="PIXEL FONT";}renderPopulationChart();if(weightRecords.length>0)renderWeightChart();}
        function setupThemeEngine(){renderThemePage();}
        function changeThemePage(dir){const tP=Math.ceil(CONFIG.THEMES.length/10);currentThemePage=(currentThemePage+dir+tP)%tP;renderThemePage();}
        function renderThemePage(){const tG=document.getElementById('theme-grid');tG.innerHTML='';const numT=CONFIG.THEMES.length,tPpS=10,tP=Math.ceil(numT/tPpS);currentThemePage=(currentThemePage+tP)%tP;const sI=currentThemePage*tPpS,eI=sI+tPpS;CONFIG.THEMES.slice(sI,eI).forEach(th=>{const s=document.createElement('button');s.className="h-12 w-full rounded-md tr-all dur-200 hov:scale-110 hov:shadow-lg focus:ring-2 ring-offset-2";s.style.backgroundColor=`rgb(${th.r})`;s.style.boxShadow=`0 0 15px rgba(${th.r},.5)`;s.title=th.n;s.onclick=()=>changeTheme(th);tG.appendChild(s);});document.getElementById('theme-page-title').innerText=`COLORS [${currentThemePage+1}/${tP}]`;}
        function changeTheme(theme){docEl.style.setProperty('--glow-rgb',theme.r);const yT=CONFIG.THEMES.find(t=>t.n==='gold');if(yT)docEl.style.setProperty('--accent-rgb',yT.r);renderPopulationChart();if(weightRecords.length>0)renderWeightChart();}
        function updateTiming(){const tE=document.getElementById('timing');if(!tE)return;const sD=new Date(CONFIG.START_DATE),cD=new Date();const eMs=cD.getTime()-sD.getTime();const eD=(eMs/864e5).toFixed(3);const tS=Math.floor(eMs/1e3),eH=Math.floor(tS/3600),eM=Math.floor((tS%3600)/60),eS=tS%60;const fD=(d)=>`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;const gNA=(b,dys)=>{let c=0,nD;do{c++;nD=new Date(b.getTime()+c*dys*864e5);}while(nD<cD);return{d:nD,c};};const gNY=(b)=>{let c=0,nD;do{c++;nD=new Date(b);nD.setFullYear(b.getFullYear()+c);}while(nD<cD);return{d:nD,c};};const n100=gNA(sD,100),nY=gNY(sD);let cityDateText = city && city.year ? `<p class="mt-1 pt-1 border-t border-dotted border-gray-700">🏙️ 游戏内日期: <strong class="accent-text">Y${city.year} D${city.day}</strong></p>` : '';tE.innerHTML=`<p>🐰 兔可可已經到來 <strong class="accent-text">${eD}</strong> 天啦</p><p>🎂 目前已經到來 <strong class="accent-text">${eH}</strong>小時 <strong class="accent-text">${eM}</strong>分鐘 <strong class="accent-text">${eS}</strong>秒</p><div class="pt-2 mt-2 border-t border-dashed" style="border-color:rgba(var(--glow-rgb),.2)"></div><p>🌱 下一個100天紀念日是 <strong class="accent-text">${fD(n100.d)}</strong></p><p>🎉 下一个一周年纪念日是 <strong class="accent-text">${fD(nY.d)}</strong></p>${cityDateText}`}
        function toggleModal(mId,forceState=null){const mdl=document.getElementById(mId);const S=forceState===null?mdl.classList.contains('hidden'):!forceState;if(S){mdl.classList.remove('hidden');requestAnimationFrame(()=>{if(mdl)mdl.classList.remove('opacity-0')});if(mId==='changelog-modal'&&!document.getElementById('changelog-content').innerHTML)renderChangelog();if(mId==='performance-modal')setTimeout(getStaticPerfData,100);if(mId==='theme-modal'&&!document.getElementById('theme-grid').innerHTML)renderThemePage();}else{if(mdl)mdl.classList.add('opacity-0');setTimeout(()=>{if(mdl)mdl.classList.add('hidden');},300);}}
        function toggleFullscreen(){if(!document.fullscreenElement)docEl.requestFullscreen().catch(err=>alert(`全屏失败: ${err.message}`));else document.exitFullscreen();}
        function logCityEvent(message,type='info'){if(!city||!city.eventLog)return;const timestamp=`Y${city.year||1}D${city.day||1}`;city.eventLog.unshift({message,type,timestamp});if(city.eventLog.length>150)city.eventLog.pop();renderCityLog();}
        function renderCityLog(){if(!cityEventsContainer||!city||!city.eventLog)return;const typeColors={'system':'text-cyan-400','info':'text-gray-300','warning':'text-yellow-400','error':'text-red-500','build':'text-green-400','milestone':'glow-text accent-text font-bold','tech':'text-blue-400','finance':'text-lime-400','policy_act':'text-purple-400','policy_deact':'text-purple-300 opacity-80','disaster':'bg-red-900/50 text-red-300 font-bold','godmode':'text-fuchsia-500 animate-pulse','action':'text-indigo-400'};cityEventsContainer.innerHTML=(city.eventLog||[]).map(log=>{const colorClass=typeColors[log.type]||'text-gray-400';return`<div class="text-xs p-1 rounded ${log.type==='disaster'?colorClass:''}"><span class="text-gray-500">[${log.timestamp}]</span> <span class="${colorClass}">${log.message}</span></div>`;}).join('');}
        function toggleLogView(view){const cityButton=document.getElementById('log-toggle-city'),petButton=document.getElementById('log-toggle-pet');const applyStyle=(btn,isActive)=>{btn.classList.toggle('accent-text',isActive);btn.classList.toggle('border-b-2',isActive);btn.style.borderBottomColor=isActive?'rgb(var(--accent-rgb))':'transparent';btn.classList.toggle('opacity-60',!isActive);};cityEventsContainer.style.display=(view==='city')?'block':'none';allRecordsContainer.style.display=(view==='pet')?'block':'none';applyStyle(cityButton,view==='city');applyStyle(petButton,view==='pet');currentLogView=view;}
        function getStaticPerfData(){const pC=document.getElementById('perf-modal-content');if(!pC)return;pC.innerHTML=`<div id="realtime-metrics-container"></div>`;let sS=[];let memHtml=`<div class="text-lg glow-text mt-4 mb-2">Memory</div>`;if(performance.memory){memHtml+=`<span>JS HEAP:</span><span class="text-white text-right">${(performance.memory.usedJSHeapSize/1048576).toFixed(1)}MB / ${(performance.memory.totalJSHeapSize/1048576).toFixed(1)}MB</span>`;}try{const lsSize=new TextEncoder().encode(JSON.stringify(localStorage)).length;memHtml+=`<span>LS USED:</span><span class="text-white text-right">${(lsSize/1024).toFixed(2)}KB</span>`;}catch(e){}sS.push(memHtml);const nT=performance.getEntriesByType("navigation")[0],pT=performance.getEntriesByType("paint");if(nT||pT.length>0){let pgH=`<div class="text-lg glow-text mt-4 mb-2">Page Load</div>`;const fcp=pT.find(p=>p.name==='first-contentful-paint');if(fcp)pgH+=`<span>FCP:</span><span class="text-white text-right">${fcp.startTime.toFixed(0)}ms</span>`;if(nT)pgH+=`<span>TOTAL:</span><span class="text-white text-right">${nT.duration.toFixed(0)}ms</span>`;sS.push(pgH);}const res=performance.getEntriesByType("resource");if(res.length>0){let resH=`<div class="text-lg glow-text mt-4 mb-2">Resources</div>`;const totalSize=res.reduce((acc,r)=>acc+(r.transferSize||0),0);resH+=`<span>ASSETS:</span><span class="text-white text-right">${res.length}</span><span>WEIGHT:</span><span class="text-white text-right">${(totalSize/1024).toFixed(1)}KB</span>`;sS.push(resH);}const sCC=document.createElement('div');sCC.className="grid grid-cols-2 gap-x-4 gap-y-1";sCC.innerHTML=sS.join('');pC.appendChild(sCC);}
        function updatePerfPanel(cT){const pC=document.getElementById('perf-modal-content')?.querySelector('#realtime-metrics-container');if(!pC||document.getElementById('performance-modal').classList.contains('hidden'))return;const iV=cT-lastPerfUpdateTime;const fps=Math.round((frameCount/iV)*1e3);pC.innerHTML=`<div class="text-lg glow-text mb-2">Real-time</div><div class="grid grid-cols-2 gap-x-4"><span>FPS:</span><span class="text-white text-right">${fps}</span><span>FRAME TIME:</span><span class="text-white text-right">${(1e3/fps||0).toFixed(2)}ms</span><span>PARTICLES:</span><span class="text-white text-right">${cosmicDust.length+clickRipples.length+forceParticles.length+celestialParticles.length}</span><span>DOM NODES:</span><span class="text-white text-right">${document.getElementsByTagName('*').length}</span></div>`;lastPerfUpdateTime=cT;frameCount=0;}
        function updateAdvisorBunny(){}
        function renderChangelog(){const cD=[{v:"v1.0.3",dt:"PERFECTIONIS",it:[{t:"✨ 视觉升华",zh:"头像特效系统究极进化，在原有基础上增强细节并加入了两种全新的极稀有特效：'过载模式'与'奇点坍缩'。",en:"Avatar VFX has been evolved, enhancing details of existing effects and adding two new ultra-rare effects: 'Overload' and 'Singularity Collapse'."},{t:"🐛 细节修复",zh:"修复了性能监视器和主题选择面板在首次加载时可能出现空白的问题。",en:"Fixed an issue where the Performance Monitor and Theme Selector could appear blank on initial load."},{t:"✅ 最终打磨",zh:"对整体代码进行了最终审查和微调，确保所有功能稳定、流畅且完美呈现。",en:"Conducted a final review and micro-tuning of the entire codebase to ensure all features are stable, smooth, and perfectly presented."}]}, {v:"v1.0.2",dt:"PHOENIX_RISE",it:[{t:"🚀 新增",zh:"在城市管理面板中加入了“删除存档”功能，并有二次确认防止误触。",en:"Added a 'Delete Save' feature with a confirmation prompt to the city management panel."}]}];const cE=document.getElementById('changelog-content');cE.innerHTML=cD.map(logEntry=>{const items=logEntry.it||logEntry.items;if(!items)return'';return`<div class="mb-6"><p class="text-xl font-bold accent-text">${logEntry.v||logEntry.version} <span class="text-sm font-normal text-gray-400">- ${logEntry.dt||logEntry.date}</span></p><ul class="mt-3 space-y-2 list-disc list-inside">${items.map(item=>`<li><p class="inline font-bold">${item.t||item.type}</p><p class="text-gray-300 mt-1">${item.zh}</p><p class="text-xs text-gray-500">${item.en}</p></li>`).join('')}</ul></div>`;}).join('');}
    </script>
</body>
</html>
